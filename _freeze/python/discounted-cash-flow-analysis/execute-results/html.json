{
  "hash": "bb380339d47b657eafd63b833e73a030",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: Discounted Cash Flow Analysis\nmetadata:\n  pagetitle: DCF with Python\n  description-meta: Learn how to use the programming language Python to value companies using discounted cash flow analysis.\nexecute: \n  cache: true\n---\n\n\n\n::: {.callout-note}\nYou are reading **Tidy Finance with Python**. You can find the equivalent chapter for the sibling **Tidy Finance with R** [here](../r/discounted-cash-flow-analysis.qmd).\n:::\n\nIn this chapter, we address a fundamental question: What is the value of a company? Company valuation is a critical tool that helps us determine the economic value of a business. Understanding a company's value is essential, whether it is for investment decisions, mergers and acquisitions, or financial reporting. Valuation is not just about assigning a number, as it is also a framework for making informed decisions. For example, investors use valuation to identify whether a stock is under- or overvalued, and companies rely on valuation for strategic decisions, like pricing an acquisition or preparing for an IPO.\n\nCompany valuation methods broadly fall into three categories:\\index{Valuation methods}\n\n- Market-based approaches compare companies using relative metrics like Price-to-Earnings ratios.\n- Asset-based methods focus on the net value of a company's tangible and intangible assets.\n- Income-based techniques value companies based on their ability to generate future cash flows.\n\nWe focus on Discounted Cash Flow (DCF) analysis, an income-based approach, because it captures three crucial aspects of valuation:\\index{Discounted Cash Flow}\\index{DCF} First, DCF explicitly accounts for the time value of money - the principle that a dollar today is worth more than a dollar in the future. By discounting future cash flows to present value with the appropriate discount rate, we incorporate both time preferences and risk.\\index{Time value of money} Second, DCF is inherently forward-looking, making it particularly suitable for companies where historical performance may not reflect future potential. This characteristic is especially relevant when valuing growth companies or analyzing new business opportunities. Third, DCF analysis is flexible enough to accommodate various business models and capital structures, making it applicable across different industries and company sizes.\n\nIn our exposition of the DCF valuation framework, we focus on its three key components:\\index{DCF structure}\n\n- Free Cash Flow (FCF) forecasts represent the expected future cash available for distribution to investors after accounting for operating expenses, taxes, and investments.\\index{Free Cash Flow}\n- Terminal value captures the company's value beyond the explicit forecast period, often representing a significant portion of the total valuation.\\index{Terminal value}\n- Discount rate, typically the Weighted Average Cost of Capital (WACC), adjusts future cash flows to present value by incorporating risk and capital structure considerations.\\index{WACC}\n\nWe make a few simplifying assumptions due to the diverse nature of businesses, which a simple model cannot cover. After all, there are entire textbooks written just on valuation. In particular, we assume that firms only conduct operating activities (i.e., financial statements do not include non-operating items), implying that firms do not own any assets that do not produce operating cash flows. Otherwise, you must value these non-operating activities separately for many real-world examples. \n\nIn this chapter, we rely on the following packages to build a simple DCF analysis:\n\n::: {#4b9d6ac4 .cell execution_count=2}\n``` {.python .cell-code}\nimport pandas as pd\nimport numpy as np\nimport statsmodels.formula.api as smf\n\nfrom fmpapi import fmp_get\nfrom plotnine import *\nfrom mizani.formatters import percent_format, comma_format\nfrom itertools import product\n```\n:::\n\n\n\n\n::: {.callout-tip}\nThe `fmpapi` package is developed by Christoph Scheuch and is not sponsored by or affiliated with FMP. However, you can get 15% off your FMP subscription by using this [affiliate link](https://site.financialmodelingprep.com/pricing-plans?couponCode=tidyfinance). By signing up through this link, you also support the development of this package at no extra cost to you.\n:::\n\n## Prepare Data\n\nBefore we can perform a DCF analysis, we need historical financial data to inform our forecasts. We use the Financial Modeling Prep (FMP) API to download financial statements. The `fmpapi` package provides a convenient interface for accessing this data in a tidy format.\\index{Data!FMP API}\n\n::: {#6a7004a5 .cell execution_count=4}\n``` {.python .cell-code}\nsymbol = \"MSFT\"\n\nincome_statements = fmp_get(\n  \"income-statement\", symbol, {\"period\": \"annual\", \"limit\": 5}, to_pandas = True\n)\n\ncash_flow_statements = fmp_get(\n  \"cash-flow-statement\", symbol, {\"period\": \"annual\", \"limit\": 5}, to_pandas = True\n)\n```\n:::\n\n\nOur analysis centers on Free Cash Flow (FCF), which represents the cash available to all investors after the company has covered its operational needs and capital investments.\\index{Free Cash Flow} We calculate FCF using the following formula:\n\n$$\\text{FCF} = \\text{EBIT} + \\text{Depreciation \\& Amortization} - \\text{Taxes} + \\Delta \\text{Working Capital} - \\text{CAPEX}$$\n\nEach component of this formula serves a specific purpose in capturing the company's cash-generating ability:\\index{Free Cash Flow components}\n\n- EBIT (Earnings Before Interest and Taxes) measures core operating profit\n- Depreciation & Amortization accounts for non-cash expenses\n- Taxes reflect actual cash payments to tax authorities\n- Changes in Working Capital capture cash tied up in operations\n- Capital Expenditures (CAPEX) represent investments in long-term assets\n\nWe can implement this calculation by combining and transforming our financial statement data. Note that we also arrange by year, which is important for some of the following code chunks.\n\n::: {#9a8a71ae .cell execution_count=5}\n``` {.python .cell-code}\ndcf_data = (income_statements\n  .assign(\n    fiscal_year=lambda x: x[\"fiscal_year\"].astype(int),\n    ebit=lambda x: x[\"net_income\"] + x[\"income_tax_expense\"] + x[\"interest_expense\"] - x[\"interest_income\"]\n  )\n  .get([\"fiscal_year\", \"ebit\", \"revenue\", \"depreciation_and_amortization\", \"income_tax_expense\"])\n  .rename(columns={\n      \"fiscal_year\": \"year\",\n      \"income_tax_expense\": \"taxes\"\n  })\n  .merge(\n    (cash_flow_statements\n      .get([\"fiscal_year\", \"change_in_working_capital\", \"capital_expenditure\"])\n      .assign(fiscal_year=lambda x: x[\"fiscal_year\"].astype(int))\n      .rename(columns={\n        \"fiscal_year\": \"year\",\n        \"change_in_working_capital\": \"delta_working_capital\",\n        \"capital_expenditure\": \"capex\"\n      })\n    ), on=\"year\", how=\"left\"\n  )\n  .assign(\n    fcf=lambda x: x[\"ebit\"] + x[\"depreciation_and_amortization\"] - x[\"taxes\"] + x[\"delta_working_capital\"] - x[\"capex\"]\n  )\n  .sort_values(\"year\")\n)\n```\n:::\n\n\n## Forecasting Free Cash Flow\n\nAfter calculating historical FCF, we need to project it into the future. While historical data provides a foundation, forecasting requires both quantitative analysis and qualitative judgment. We use a ratio-based approach that links all FCF components to revenue growth, making our forecasts more tractable.\\index{Free Cash Flow!Forecasting} This is another crucial assumption for our exposition that will not hold in reality. Thus, you must put more thought into these forecast ratios and their dynamics over time.\n\nFirst, we express each FCF component as a ratio relative to revenue. This standardization helps identify trends and makes forecasting more systematic. @fig-500 shows the historical evolution of these key financial ratios.\n\n::: {#cell-fig-500 .cell execution_count=6}\n``` {.python .cell-code}\ndcf_data = (dcf_data\n  .assign(\n    revenue_growth=lambda x: x[\"revenue\"] / x[\"revenue\"].shift(1) - 1,\n    operating_margin=lambda x: x[\"ebit\"] / x[\"revenue\"],\n    da_margin=lambda x: x[\"depreciation_and_amortization\"] / x[\"revenue\"],\n    taxes_to_revenue=lambda x: x[\"taxes\"] / x[\"revenue\"],\n    delta_working_capital_to_revenue=lambda x: x[\"delta_working_capital\"] / x[\"revenue\"],\n    capex_to_revenue=lambda x: x[\"capex\"] / x[\"revenue\"]\n  )\n)\n\ndcf_data_long = (dcf_data\n  .melt(\n    id_vars=\"year\",\n    value_vars=[\n      \"operating_margin\", \"da_margin\", \"taxes_to_revenue\",\n      \"delta_working_capital_to_revenue\", \"capex_to_revenue\"\n    ],\n    var_name=\"name\",\n    value_name=\"value\"\n  )\n)\n\nratios_figure = (\n  ggplot(\n    dcf_data_long, \n    aes(x=\"year\", y=\"value\", color=\"name\")\n  )\n  + geom_line()\n  + scale_y_continuous(labels=percent_format())\n  + labs(\n      x=\"\", y=\"\", color=\"\",\n      title=\"Key financial ratios of Microsoft between 2021 and 2025\"\n    )\n)\nratios_figure.show()\n```\n\n::: {.cell-output .cell-output-display}\n![Ratios are based on financial statements provided through the FMP API.](discounted-cash-flow-analysis_files/figure-html/fig-500-output-1.png){#fig-500 width=2100 height=1500 fig-alt='Title: Key forecast ratios of Microsoft between 2021 and 2025. The figure shows a line chart with years on the horizontal axis and financial ratios on the vertical axis.'}\n:::\n:::\n\n\nThe operating margin, for instance, represents how much of each revenue dollar translates into operating profit (EBIT), while the CAPEX-to-revenue ratio indicates the company's investment intensity.\\index{Financial ratios}\n\nFor our DCF analysis, we need to project these ratios into the future. These projections should reflect both historical patterns and forward-looking considerations such as: Industry trends and competitive dynamics, company-specific growth initiatives, expected operational efficiency improvements, planned capital investments, or working capital management strategies. Overall, there is a lot to consider in practice. However, forecast ratios make this process tractable.\n\nAnother crucial question is the length of the forecast period. We use five years below ad-hoc, but you want to make detailed projections for each year when the company undergoes significant changes. As long as forecast ratios change, you need to make explicit forecasts. Once the company reaches a steady state, you can switch to computing the continuation value discussed later.\n\nWe demonstrate this forecasting approach in @fig-501. Note that our forecast ratio dynamics just serve as an example and are not grounded in deeper economic analysis.\n\n::: {#cell-fig-501 .cell execution_count=7}\n``` {.python .cell-code}\nforecast_ratios = pd.DataFrame({\n    \"year\": [2026, 2027, 2028, 2029, 2030],\n    \"operating_margin\": [0.41, 0.42, 0.43, 0.44, 0.45],\n    \"da_margin\": [0.09, 0.09, 0.09, 0.09, 0.09],\n    \"taxes_to_revenue\": [0.08, 0.07, 0.06, 0.06, 0.06],\n    \"delta_working_capital_to_revenue\": [0.001, 0.001, 0.001, 0.001, 0.001],\n    \"capex_to_revenue\": [-0.2, -0.22, -0.2, -0.18, -0.16]\n})\nforecast_ratios[\"type\"] = \"Forecast\"\n\ndcf_data[\"type\"] = \"Realized\"\ndcf_data = pd.concat([dcf_data, forecast_ratios], ignore_index=True)\n\ndcf_data_long = (dcf_data\n  .melt(\n    id_vars=[\"year\", \"type\"],\n    value_vars=[\n      \"operating_margin\", \"da_margin\", \"taxes_to_revenue\",\n      \"delta_working_capital_to_revenue\", \"capex_to_revenue\"\n    ],\n    var_name=\"name\",\n    value_name=\"value\"\n  )\n)\n\ndcf_data_long[\"type\"] = pd.Categorical(\n  dcf_data_long[\"type\"], categories=[\"Realized\", \"Forecast\"]\n)\n\nratios_forecast_figure = (\n  ggplot(\n    dcf_data_long,\n    aes(x=\"year\", y=\"value\", color=\"name\", linetype=\"type\")\n  )\n  + geom_line()\n  + scale_x_continuous(breaks=range(2021, 2030))\n  + scale_y_continuous(labels=percent_format())\n  + labs(\n      x=\"\", y=\"\", color=\"\", linetype=\"\",\n      title=\"Key financial ratios and ad-hoc forecasts of Microsoft between 2021 and 2030\"\n    )\n  + theme(legend_position=\"right\")\n)\nratios_forecast_figure.show()\n```\n\n::: {.cell-output .cell-output-display}\n![Historical ratios are based on financial statements provided through the FMP API, while forecasts are manually defined.](discounted-cash-flow-analysis_files/figure-html/fig-501-output-1.png){#fig-501 width=2100 height=1500 fig-alt='Title: Key forecast ratios and ad-hoc forecasts of Microsoft between 2021 and 2030. The figure shows a line chart with years on the horizontal axis and financial ratios and their projections on the vertical axis.'}\n:::\n:::\n\n\nThe final step in our FCF forecast is projecting revenue growth. While there are multiple approaches to this task, we demonstrate a GDP-based method that links company growth to macroeconomic forecasts.\\index{Revenue growth}\n\nWe use GDP growth forecasts from the [IMF World Economic Outlook (WEO)](https://www.imf.org/en/Publications/WEO/weo-database/2024/October/weo-report?c=111,&s=NGDP_RPCH,&sy=2020&ey=2029&ssm=0&scsm=1&scc=0&ssd=1&ssc=0&sic=1&sort=country&ds=.&br=1) database as our baseline. The WEO provides comprehensive economic projections, though it is important to note that these forecasts are periodically revised as new data becomes available.\\index{Data!IMF WEO} We manually collect these forecasts and store them in a tibble.\n\n::: {#c1c67b84 .cell execution_count=8}\n``` {.python .cell-code}\ngdp_growth = pd.DataFrame({\n  \"year\": list(range(2021, 2031)),\n  \"gdp_growth\": [\n    0.06055, 0.02512, 0.02887, 0.02765, 0.02153,\n    0.02028, 0.02120, 0.02122, 0.02122, 0.02122\n  ]\n})\n\ndcf_data = (dcf_data\n  .merge(gdp_growth, on=\"year\", how=\"left\")\n)\n```\n:::\n\n\nOur approach models revenue growth as a linear function of GDP growth. This relation captures the intuition that company revenues often move in tandem with broader economic activity, though usually with different sensitivity.\\index{Growth modeling} Let us estimate the model with historical data.\n\n::: {#50b21f3e .cell execution_count=9}\n``` {.python .cell-code}\nrevenue_growth_model = smf.ols(\"revenue_growth ~ gdp_growth\", data=dcf_data).fit().params\n\ndcf_data = (dcf_data\n  .assign(\n    revenue_growth_modeled=lambda x: (\n      revenue_growth_model[\"Intercept\"] + revenue_growth_model[\"gdp_growth\"] * x[\"gdp_growth\"]\n    ),\n    revenue_growth=lambda x: (\n      np.where(x[\"type\"] == \"Forecast\", x[\"revenue_growth_modeled\"], x[\"revenue_growth\"])\n    )\n  )\n)\n```\n:::\n\n\nThe model estimates two parameters: (i) an intercept that captures the company's baseline growth, and (ii) a slope coefficient that measures the company's sensitivity to GDP changes. Then, we can use the model and the growth forecasts to make revenue growth projections. We visualize the historical and projected growth rates using this approach in @fig-502:\n\n::: {#cell-fig-502 .cell execution_count=10}\n``` {.python .cell-code}\nrevenue_growth = (dcf_data\n  .query(\"year >= 2021\")\n  .melt(\n    id_vars=[\"year\", \"type\"],\n    value_vars=[\"revenue_growth\", \"gdp_growth\"], \n    var_name=\"name\",\n    value_name=\"value\"\n  )\n)\n\nrevenue_growth[\"type\"] = pd.Categorical(\n  revenue_growth[\"type\"], categories=[\"Realized\", \"Forecast\"]\n)\n\nrevenue_growth_figure = (\n  ggplot(\n    revenue_growth,\n    aes(x=\"year\", y=\"value\", color=\"name\", linetype=\"type\")\n  )\n  + geom_line()\n  + scale_x_continuous(breaks=range(2021, 2030))\n  + scale_y_continuous(labels=percent_format())\n  + labs(\n      x=\"\", y=\"\", color=\"\", linetype=\"\",\n      title=\"GDP growth and Microsoft's revenue growth and forecasts between 2021 and 2030\"\n    )\n  + theme(legend_position=\"right\")\n)\nrevenue_growth_figure.show()\n```\n\n::: {.cell-output .cell-output-display}\n![Realized revenue growth rates are based on financial statements provided through the FMP API, while forecasts are modeled unsing IMF WEO forecasts.](discounted-cash-flow-analysis_files/figure-html/fig-502-output-1.png){#fig-502 width=2100 height=1500 fig-alt='Title: GDP growth and Microsoft\\'s revenue growth and modeled forecasts between 2021 and 2030. The figure shows a line chart with years on the horizontal axis and GDP growth, revenue growth, and their projections on the vertical axis.'}\n:::\n:::\n\n\nWhile more sophisticated approaches exist (e.g., proprietary analyst forecasts or bottom-up market analyses), this method provides a transparent and data-driven starting point for revenue projections.\\index{Forecasting methods}\n\nWith all components in place - revenue growth projections and forecast ratios - we can now calculate our FCF forecasts. We must first convert our growth rates into revenue projections and then apply our forecast ratios to compute each FCF component.\\index{Free Cash Flow!Computation}\n\n::: {#c7a4df17 .cell execution_count=11}\n``` {.python .cell-code}\ndcf_data.loc[0, \"revenue_growth\"] = 0\ndcf_data[\"revenue\"] = dcf_data[\"revenue\"].iloc[0] * (1 + dcf_data[\"revenue_growth\"]).cumprod()\n\ndcf_data = (dcf_data\n  .assign(\n    ebit=lambda x: x[\"operating_margin\"] * x[\"revenue\"],\n    depreciation_and_amortization=lambda x: x[\"da_margin\"] * x[\"revenue\"],\n    taxes=lambda x: x[\"taxes_to_revenue\"] * x[\"revenue\"],\n    delta_working_capital=lambda x: x[\"delta_working_capital_to_revenue\"] * x[\"revenue\"],\n    capex=lambda x: x[\"capex_to_revenue\"] * x[\"revenue\"],\n    fcf=lambda x: x[\"ebit\"] + x[\"depreciation_and_amortization\"] - x[\"taxes\"] + x[\"delta_working_capital\"] - x[\"capex\"]\n  )\n)\n```\n:::\n\n\nWe visualize the resulting FCF projections in @fig-503.\n\n::: {#cell-fig-503 .cell execution_count=12}\n``` {.python .cell-code}\ncash_flows_figure = (\n  ggplot(\n    dcf_data,\n    aes(x=\"year\", y=\"fcf / 1e9\", fill=\"type\")\n  )\n  + geom_col()\n  + scale_x_continuous(breaks=range(2021, 2030))\n  + labs(\n      x=\"\", y=\"Free Cash Flow (in B USD)\", fill=\"\",\n      title=\"Actual and predicted free cash flow for Microsoft from 2021 to 2030\"\n    )\n)\ncash_flows_figure.show()\n```\n\n::: {.cell-output .cell-output-display}\n![Realized growth rates are based on financial statements provided through the FMP API, while forecasts are manually defined.](discounted-cash-flow-analysis_files/figure-html/fig-503-output-1.png){#fig-503 width=2100 height=1500 fig-alt='Title: Actual and predicted free cash flow for Microsoft from 2021 to 2030. The figure shows a bar chart with years on the horizontal axis and Microsoft\\'s historical and projected free cash flows on the vertical axis.'}\n:::\n:::\n\n\n## Continuation Value\n\nA key component of DCF analysis is the continuation value (or terminal value), representing the company's value beyond the explicit forecast period. This value often constitutes the majority of the total valuation, making its estimation particularly important.\\index{Continuation value} You can compute the continuation value once the company has reached its steady state.\n\nThe most common approach is the Perpetuity Growth Model (or Gordon Growth Model), which assumes FCF grows at a constant rate indefinitely.\\index{Perpetuity Growth Model}\\index{Gordon Growth Model} The formula for this model is:\n\n$$TV_{T} = \\frac{FCF_{T+1}}{r - g},$$\n\nwhere $TV_{T}$ is the terminal value at time $T$, $FCF_{T+1}$ is the free cash flow in the first year after our forecast period, $r$ is the discount rate (typically WACC, see below), and $g$ is the perpetual growth rate. A common mistake is to ignore the time shift in the model. You must compute $FCF_{T+1}$, which is equal to $FCF_{T}\\cdot(1+g)$\n\nThe perpetual growth rate $g$ should reflect the long-term economic growth potential. A common benchmark is the long-term GDP growth rate, as few companies can sustainably grow faster than the overall economy indefinitely.\\index{Growth rate!Perpetual} Exceeding GDP growth indefinitely also implies that the whole economy eventually consists of one company. For example, the last 20 years of GDP growth is a sensible assumption (the nominal growth rate is 4% for the US).\n\nLet us implement the Perpetuity Growth Model:\n\n::: {#2b92a5a3 .cell execution_count=13}\n``` {.python .cell-code}\ndef compute_terminal_value(last_fcf, growth_rate, discount_rate):\n    return last_fcf * (1 + growth_rate) / (discount_rate - growth_rate)\n\nlast_fcf = dcf_data['fcf'].iloc[-1]\nterminal_value = compute_terminal_value(\n  last_fcf, growth_rate=0.04, discount_rate=0.08\n)\n\nprint(np.round(terminal_value / 1e9))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n10607.0\n```\n:::\n:::\n\n\nNote that while we use the Perpetuity Growth Model here, practitioners often cross-check their estimates with alternative methods like the exit multiple approach, which bases the terminal value on comparable company valuations.^[See (corporatefinanceinstitute.com/)[https://corporatefinanceinstitute.com/resources/valuation/exit-multiple/)] for an intuitive explanation of the exit multiple approach.]\n\\index{Valuation methods!Exit multiple}\n\n## Discount Rate\n\nThe final component of our DCF analysis involves discounting future cash flows to present value. We typically use the Weighted Average Cost of Capital (WACC) as the discount rate, representing the blended cost of financing for all company stakeholders.\\index{WACC} The WACC is the correct rate to discount cash flows distributed to both debt and equity holders, which is the case in our model as we use free cash flows.\n\nThe WACC formula combines the costs of equity and debt financing:\n\n$$WACC = \\frac{E}{D+E} \\cdot r^E + \\frac{D}{D+E} \\cdot r^D \\cdot (1 - \\tau),$$\n\nwhere $E$ is the market value of the company's equity with required return $r^E$, $D$ is the market value of the company's debt with pre-tax return $r^D$, and $\\tau$ is the tax rate.\n\nWhile you can often find estimates of WACC from financial databases or analysts' reports, you may need to calculate it yourself. Let us walk through the practical steps to estimate WACC using real-world data: \n\n- $E$ is typically measured as the market value of the company's equity. One common approach is to use market capitalization from the stock exchange.\n- $D$ is often measured using the book value of the company's debt. While this might not perfectly reflect market conditions, it is a practical starting point when market data is unavailable. Moreover, it is close to correct without default.\n- The Capital Asset Pricing Model (CAPM) is a popular method to estimate the cost of equity $r^E$. It considers the risk-free rate, the equity risk premium, and the company's risk exposure (i.e., beta). For a detailed guide estimating the CAPM, we refer to Chapter [Capital Asset Pricing Model](capital-asset-pricing-model.qmd).\n- The return on debt $r^D$ can also be estimated in different ways. For instance, effective interest rates can be calculated as the ratio of interest expense to total debt from financial statements. This gives you a real-world measure of what the company is currently paying. Alternatively, you can look up corporate bond spreads for companies in the same rating group. \n\nIf you would rather not estimate WACC manually, resources are available to help you find industry-specific discount rates. One of the most widely used sources is Aswath Damodaranâ€™s [database](https://pages.stern.nyu.edu/~adamodar/New_Home_Page/datacurrent.html). He maintains an extensive database that provides a wealth of financial data, including estimated discount rates, cash flows, growth rates, multiples, and more. For example, if you are analyzing a company in the Computer Services sector, as we do here, you can look up the industry's average WACC and use it as a benchmark for your analysis. The following code chunk downloads the WACC data and extracts the value for this industry:\n\n::: {#1fb087f0 .cell execution_count=14}\n``` {.python .cell-code}\nimport requests\n\nurl = \"https://pages.stern.nyu.edu/~adamodar/pc/datasets/wacc.xls\"\nresponse = requests.get(url)\n\nwith open(\"wacc.xls\", \"wb\") as file:\n    file.write(response.content)\n    \nwacc_raw = pd.read_excel(\"wacc.xls\", sheet_name=1, skiprows=18)\n\nimport os\nos.remove(\"wacc.xls\")\n\nwacc = wacc_raw.loc[\n  wacc_raw[\"Industry Name\"] == \"Computer Services\", \"Cost of Capital\"\n].values[0]\n```\n:::\n\n\n::: {.callout-tip}\nYou need the `xlrd` package to use `pd.read_excel()`, so make sure to install it via, e.g., `pip install xlrd`\n:::\n\n## Computing Enterprise Value\n\nHaving established all components, we can now compute the total company value (given that there are no non-operating activities). The enterprise value combines two elements:\\index{DCF!Computation}\\index{DCF!Enterprise value}\n\n- The present value of cash flows during the explicit forecast period and\n- The present value of the continuation (or terminal) value.\n\nThis is expressed mathematically as:\n\n$$\n\\text{Total DCF Value} = \\sum_{t=1}^{T} \\frac{\\text{FCF}t}{(1 + \\text{WACC})^t} + \\frac{\\text{TV}_{T}}{(1 + \\text{WACC})^T},\n$$\n\nwhere $T$ is the length of our forecast period. Let us implement this calculation in a simple function that takes the WACC and growth rate as input. Then, we present an example at the values discussed above.\n\n::: {#24720448 .cell execution_count=15}\n``` {.python .cell-code}\ndef compute_dcf(wacc, growth_rate):\n    free_cash_flow = dcf_data[\"fcf\"].values\n    last_fcf = free_cash_flow[-1]\n    terminal_value = compute_terminal_value(last_fcf, growth_rate, wacc)\n    \n    years = len(free_cash_flow)\n    present_value_fcf = free_cash_flow / ((1 + wacc) ** np.arange(1, years + 1))\n    present_value_tv = terminal_value / ((1 + wacc) ** years)\n    \n    return present_value_fcf.sum() + present_value_tv\n\ndcf_value = compute_dcf(wacc, 0.04)\n\nprint(np.round(dcf_value / 1e9))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n5169.0\n```\n:::\n:::\n\n\nNote that this valuation represents an enterprise value - the total value of the company's operations. To arrive at the equity value, we need to subtract net debt (total debt minus cash and equivalents).\\index{Enterprise value}\\index{DCF!Equity value}\n\n## Sensitivity Analysis\n\nDCF valuation is only as robust as its underlying assumptions. Given the inherent uncertainty in forecasting, it is crucial to understand how changes in key inputs affect our valuation.\\index{Sensitivity analysis}\n\nWhile we could examine sensitivity to various inputs like operating margins or capital expenditure ratios, we focus on two critical drivers for our exposition:\n\n- The perpetual growth rate, which determines long-term value creation and\n- The WACC, which affects how we value future cash flows.\n\nLet us implement a sensitivity analysis that varies these two parameters:\n\n::: {#cell-fig-504 .cell execution_count=16}\n``` {.python .cell-code}\nwacc_range = np.arange(0.06, 0.08 + 0.01, 0.01)\ngrowth_rate_range = np.arange(0.02, 0.04 + 0.01, 0.01)\n\nsensitivity = pd.DataFrame(\n  product(wacc_range, growth_rate_range),\n  columns=[\"wacc\", \"growth_rate\"]\n)\n\nsensitivity[\"value\"] = (sensitivity\n  .apply(\n    lambda x: np.round(compute_dcf(x[\"wacc\"], x[\"growth_rate\"]) / 1e9, 0), axis=1\n  )\n)\n\nsensitivity_figure = (\n  ggplot(\n    sensitivity,\n    aes(x=\"wacc\", y=\"growth_rate\", fill=\"value\", label=\"value\")\n  )\n  + geom_tile()\n  + geom_text(color=\"white\")\n  + scale_x_continuous(labels=percent_format()) \n  + scale_y_continuous(labels=percent_format())\n  + scale_fill_continuous(labels=comma_format())\n  + labs(\n      x=\"WACC\", y=\"Perpetual growth rate\", fill=\"Enterprise value\",\n      title=\"Enterprise value of Microsoft for different WACC and growth rate scenarios\",\n    )\n)\nsensitivity_figure.show()\n```\n\n::: {.cell-output .cell-output-display}\n![The enterprise values combine data from FMP API, ad-hoc forecasts of financial ratios, and IMF WEO growth forecasts.](discounted-cash-flow-analysis_files/figure-html/fig-504-output-1.png){#fig-504 width=2100 height=1500 fig-alt='Title: Enterprise value of Microsoft for different WACC and growth rate scenarios. The figure shows a tile chart with different WACC values on the horizontal axis and perpetual growth rates on the vertical axis. Each tile shows a corresponding DCF value, illustrating the sensitivity of the DCF analysis to assumptions.'}\n:::\n:::\n\n\n@fig-504 reveals several key insights about our valuation:\\index{Visualization!Sensitivity}\\index{Visualization!Tile chart} The valuation is highly sensitive to both WACC and growth assumptions, as small changes in either parameter can lead to substantial changes in enterprise value. Moreover, the relation between these parameters and company value is non-linear as the impact of growth rate changes becomes more pronounced at lower WACCs.\n\n## From Enterprise to Equity Value\n\nAs we have discussed, our DCF analysis yields the value of the company's operations. We have assumed that there are no non-operating assets. Now, we explicitly consider their existence and show you how to compute the equity value belonging to shareholders.\n\nNon-operating assets are not essential to operations but could, in some cases, generate income (e.g., marketable securities, vacant land, idle equipment). If they exist, you must restate the financial statements to exclude the impact of these non-operating assets. With their effects removed, you can conduct the DCF analysis presented above. Afterwards, you value these non-operating assets and add them to the DCF value to arrive at the company's enterprise value.\n\nSecond, we want to discuss equity value. As you saw in the computation of the WACC, free cash flows go to both debt and equity holders. Hence, we must consider the share of the enterprise value that goes to debt. In theory, the value of debt is the market value of total debt, but in practice, typically book debt. This value has to be subtracted from enterprise value.\n\nCombining these adjustments, we can compute the equity value that belongs to shareholders as:\\index{Equity value}\n\n$$\\text{Equity Value} = \\text{DCF Value} + \\text{Non-Operating Assets} - \\text{Value of Debt}$$\n\nWe leave it as an exercise to calculate the equity value using the DCF value from above. \n\n## Key takeaways\n\n- Free Cash Flow can be calculated by transforming financial statement data into standardized ratios linked to company revenue.\n- Forecasting future cash flows requires both historical financial data and macroeconomic projections such as GDP growth rates.\n- The terminal value represents long-term company value and can be estimated using the perpetuity growth model.\n- The WACC is used as the discount rate and reflects the cost of financing from both equity and debt.\n- A DCF model combines present values of projected free cash flows and terminal value to estimate enterprise value.\n- Sensitivity analysis reveals how small changes in WACC or growth assumptions can significantly impact company valuation.\n- To determine equity value, subtract net debt from enterprise value and adjust for any non-operating assets or liabilities.\n\n## Exercises\n\n1. Download financial statements for another company of your choice and compute its historical Free Cash Flow. Compare the results with the Microsoft example from this chapter.\n1. Create a function that automatically generates FCF forecasts using different sets of ratio assumptions. Use it to create alternative scenarios for Microsoft.\n1. Implement an exit multiple approach for terminal value calculation and compare the results with the perpetuity growth method.\n1. Extend the sensitivity analysis to include operating margin assumptions. Create a visualization showing how changes in margins affect the final valuation.\n1. Calculate Microsoft's equity value by adjusting the DCF value as described above. \n\n",
    "supporting": [
      "discounted-cash-flow-analysis_files"
    ],
    "filters": [],
    "includes": {}
  }
}