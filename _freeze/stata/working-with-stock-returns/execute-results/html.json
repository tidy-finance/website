{
  "hash": "063c1fe7017f6788cb43025551f089f8",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: Working with Stock Returns\nmetadata:\n  pagetitle: Working with Stock Returns in Stata\n  description-meta: Learn how to use Stata for downloading and analyzing stock market data.\n---\n\n::: callout-note\nYou are reading the work-in-progress version of **Tidy Finance with Stata**. If you discover an error or have a suggestion, please consider opening an [issue](https://github.com/tidy-finance/website/issues). \n:::\n\nThe main aim of this chapter is to familiarize yourself with Stata for working with stock market data. We focus on downloading and visualizing stock data from Yahoo Finance.\n\nAt the start of each session, we ensure we have the required Stata packages installed. Throughout this chapter, we use several user-written commands that extend Stata's functionality for financial data analysis.\n\nYou typically have to install a package once before you can use it. In case you have not done this yet, you can install packages from SSC or GitHub. For downloading stock data from Yahoo Finance, we'll use a combination of Stata's Python integration and potentially user-written commands.\n\n::: {#b2f532e0 .cell execution_count=1}\n``` {.stata .cell-code}\nclear all\nset more off\n```\n\n::: {.cell-output .cell-output-display}\n```{=html}\n<style>div.jp-Notebook .datagrid-container {min-height: 448px; }</style>\n```\n:::\n:::\n\n\n## Downloading Data\n\nWe first download daily prices for one stock symbol, e.g., the Apple stock (*AAPL*), directly from the data provider Yahoo Finance. Since Stata doesn't have a native Yahoo Finance connector, we have several options: use Stata's Python integration, use a user-written command, or import pre-downloaded CSV files.\n\nIn the following code, we demonstrate using Stata's Python integration to download data. We request daily data from the beginning of 2000 to the end of 2024, which is a period of more than 20 years.\n\n::: {#dd18413a .cell execution_count=2}\n``` {.stata .cell-code}\npython:\nimport pandas as pd\nimport numpy as np\nimport tidyfinance as tf\nfrom sfi import Data, Macro\n\nprices = tf.download_data(\n  domain=\"stock_prices\", \n  symbols=\"AAPL\",\n  start_date=\"2000-01-01\", \n  end_date=\"2024-12-31\"\n)\n\nn = len(prices)\nData.setObsTotal(n)\n\nData.addVarStr(\"date_str\", 10)\nData.addVarStr(\"symbol\", 5)\nData.addVarDouble(\"open\")\nData.addVarDouble(\"high\")\nData.addVarDouble(\"low\")\nData.addVarDouble(\"close\")\nData.addVarDouble(\"volume\")\nData.addVarDouble(\"adjusted_close\")\n\nfor i in range(n):\n    Data.storeAt(\"date_str\", i, str(prices['date'].iloc[i].date()))\n    Data.storeAt(\"symbol\", i, str(prices['symbol'].iloc[i]))\n    Data.storeAt(\"open\", i, float(prices['open'].iloc[i]))\n    Data.storeAt(\"high\", i, float(prices['high'].iloc[i]))\n    Data.storeAt(\"low\", i, float(prices['low'].iloc[i]))\n    Data.storeAt(\"close\", i, float(prices['close'].iloc[i]))\n    Data.storeAt(\"volume\", i, float(prices['volume'].iloc[i]))\n    Data.storeAt(\"adjusted_close\", i, float(prices['adjusted_close'].iloc[i]))\nend\n\ngen date = date(date_str, \"YMD\")\nformat date %td\ndrop date_str\n\norder symbol date open high low close adjusted_close volume\n\ndescribe\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n\nContains data\n Observations:         6,288                  \n    Variables:             8                  \n-------------------------------------------------------------------------------\nVariable      Storage   Display    Value\n    name         type    format    label      Variable label\n-------------------------------------------------------------------------------\nsymbol          str5    %9s                   \ndate            float   %td                   \nopen            double  %10.0g                \nhigh            double  %10.0g                \nlow             double  %10.0g                \nclose           double  %10.0g                \nadjusted_close  double  %10.0g                \nvolume          double  %10.0g                \n-------------------------------------------------------------------------------\nSorted by: \n     Note: Dataset has changed since last saved.\n```\n:::\n:::\n\n\nThe downloaded data contains daily market data with self-explanatory columns: `symbol`, `date`, the daily `volume` (in the number of traded shares), the market prices at the `open`, `high`, `low`, `close`, and the `adjusted_close` price in USD. The adjusted prices are corrected for anything that might affect the stock price after the market closes, e.g., stock splits and dividends. These actions affect the quoted prices, but they have no direct impact on the investors who hold the stock. Therefore, we often rely on adjusted prices when it comes to analyzing the returns an investor would have earned by holding the stock continuously.\n\nNext, we use Stata's graphics capabilities to visualize the time series of adjusted prices in @fig-100. Stata's `twoway` command provides flexible options for creating publication-quality graphs.\n\n::: {#cell-fig-100 .cell execution_count=3}\n``` {.stata .cell-code}\ntwoway (line adjusted_close date), ///\n    title(\"Apple stock prices between beginning of 2000 and end of 2024\") ///\n    xtitle(\"\") ytitle(\"\")\n```\n\n::: {.cell-output .cell-output-display}\n![Prices are in USD, adjusted for dividend payments and stock splits.](working-with-stock-returns_files/figure-html/fig-100-output-1.png){#fig-100 fig-alt='Title: Apple stock prices between beginning of 2000 and end of 2024. The figure shows that the stock price of Apple increased from about 1 USD to around 125 USD.'}\n:::\n:::\n\n\n## Computing Returns\n\nInstead of analyzing prices, we compute daily returns defined as $r_t = p_t / p_{t-1} - 1$, where $p_t$ is the adjusted price at the end of day $t$. In that context, indexing with `[_n-1]` is helpful by returning the previous value.\n\n::: {#b3436cc1 .cell execution_count=4}\n``` {.stata .cell-code}\nsort date\ngen ret = adjusted_close / adjusted_close[_n-1] - 1\nkeep symbol date ret\n\ndescribe\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n(1 missing value generated)\n\nContains data\n Observations:         6,288                  \n    Variables:             3                  \n-------------------------------------------------------------------------------\nVariable      Storage   Display    Value\n    name         type    format    label      Variable label\n-------------------------------------------------------------------------------\nsymbol          str5    %9s                   \ndate            float   %td                   \nret             float   %9.0g                 \n-------------------------------------------------------------------------------\nSorted by: date\n     Note: Dataset has changed since last saved.\n```\n:::\n:::\n\n\nThe resulting dataset has three columns, the last of which contains the daily returns (`ret`). Note that the first entry naturally contains a missing value (`.`) because there is no previous price. Obviously, the use of `[_n-1]` would be meaningless if the time series is not ordered by ascending dates. The command `sort` provides a convenient way to order observations in the correct way for our application. If you want to order observations by descending values, you could use `gsort -ret`. Always check that your data has the desired structure before using lag operators.\n\nFor the upcoming examples, we remove missing values as these would require separate treatment for many applications. For example, missing values can affect sums and averages by reducing the number of valid data points if not properly accounted for. In general, always ensure you understand why missing values occur and carefully examine if you can simply get rid of these observations.\n\n::: {#d16e6f51 .cell execution_count=5}\n``` {.stata .cell-code}\ndrop if missing(ret)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n(1 observation deleted)\n```\n:::\n:::\n\n\nNext, we visualize the distribution of daily returns in a histogram in @fig-101. Additionally, we draw a dashed line that indicates the historical five percent quantile of the daily returns, which is a crude proxy for the worst possible return of the stock with a probability of at most five percent. This quantile is closely connected to the (historical) value-at-risk, a risk measure commonly monitored by regulators.\n\n::: {#cell-fig-101 .cell execution_count=6}\n``` {.stata .cell-code}\nquietly summarize ret, detail\nlocal quantile_05 = r(p5)\n\nhistogram ret, bins(100) ///\n    xline(`quantile_05', lpattern(dash)) ///\n    title(\"Distribution of daily Apple stock returns\") ///\n    xtitle(\"\") ytitle(\"\") ///\n    xlabel(, format(%9.2f))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n(bin=100, start=-.51869202, width=.00657741)\n```\n:::\n\n::: {.cell-output .cell-output-display}\n![The dotted vertical line indicates the historical five percent quantile.](working-with-stock-returns_files/figure-html/fig-101-output-2.png){#fig-101 fig-alt='Title: Distribution of daily Apple stock returns in percent. The figure shows a histogram of daily returns. The range indicates a few large negative values, while the remaining returns are distributed around zero. The vertical line indicates that the historical five percent quantile of daily returns was around negative three percent.'}\n:::\n:::\n\n\nHere, `bins(100)` determines the number of bins used in the illustration and, hence, implicitly sets the width of the bins. Before proceeding, make sure you understand how to use the `xline()` option to add a dashed line that indicates the historical five percent quantile of the daily returns. Before proceeding with *any* data, a typical task is to compute and analyze the summary statistics for the main variables of interest.\n\n::: {#16897a4c .cell execution_count=7}\n``` {.stata .cell-code}\nsummarize ret, detail\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n                             ret\n-------------------------------------------------------------\n      Percentiles      Smallest\n 1%    -.0625777       -.518692\n 5%     -.035905      -.1791949\n10%    -.0244798      -.1717124       Obs               6,287\n25%    -.0098355       -.158088       Sum of wgt.       6,287\n\n50%     .0009476                      Mean           .0012173\n                        Largest       Std. dev.      .0244037\n75%     .0126837       .1285666\n90%     .0265984       .1315727       Variance       .0005955\n95%     .0385078       .1368585       Skewness      -1.469063\n99%     .0678064       .1390493       Kurtosis       39.62447\n```\n:::\n:::\n\n\nWe see that the maximum *daily* return was substantial. Perhaps not surprisingly, the average daily return is close to but slightly above 0. In line with the illustration above, the large losses on the day with the minimum returns indicate a strong asymmetry in the distribution of returns.\n\nYou can also compute these summary statistics for each year individually by using `bysort`. More specifically, the few lines of code below compute the summary statistics from above for individual groups of data defined by the values of the year variable. The summary statistics, therefore, allow an eyeball analysis of the time-series dynamics of the daily return distribution.\n\n::: {#ab6fc364 .cell execution_count=8}\n``` {.stata .cell-code}\ngen year = year(date)\n\npreserve\ncollapse (mean) daily_mean=ret (sd) daily_sd=ret ///\n         (min) daily_min=ret (max) daily_max=ret, by(year)\nlist year daily_mean daily_sd daily_min daily_max, noobs\nrestore\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n(Note: Below code run with echo to enable preserve/restore functionality.)\n\n\n\n\n\n  +----------------------------------------------------+\n  | year   daily_~an   daily_sd   daily_min   daily_~x |\n  |----------------------------------------------------|\n  | 2000   -.0034569   .0549403    -.518692   .1368585 |\n  | 2001    .0023291   .0393377   -.1717124   .1285666 |\n  | 2002   -.0012124   .0305259   -.1503716   .0845584 |\n  | 2003    .0018569   .0233596     -.08142   .1134915 |\n  | 2004    .0047023   .0254697   -.0557849   .1315727 |\n  |----------------------------------------------------|\n  | 2005      .00349   .0244782   -.0921051   .0911673 |\n  | 2006    .0009495   .0242648   -.0633266   .1182997 |\n  | 2007     .003664   .0237573   -.0702059   .1053589 |\n  | 2008   -.0026458   .0366656   -.1791949   .1390493 |\n  | 2009    .0038188   .0213688   -.0501639   .0675916 |\n  |----------------------------------------------------|\n  | 2010    .0018318   .0168564   -.0495987    .076868 |\n  | 2011    .0010398   .0165394   -.0559394   .0588885 |\n  | 2012    .0012987   .0185663   -.0643569   .0887412 |\n  | 2013    .0004717   .0179865   -.1235576   .0513614 |\n  | 2014    .0014465   .0136429   -.0799275   .0819824 |\n  |----------------------------------------------------|\n  | 2015    .0000199   .0168429   -.0611631   .0573546 |\n  | 2016    .0005747   .0147017   -.0657066   .0649628 |\n  | 2017    .0016366   .0110906   -.0387768   .0609807 |\n  | 2018   -.0000573   .0181058   -.0663306   .0704219 |\n  | 2019    .0026646   .0164656   -.0996073   .0683342 |\n  |----------------------------------------------------|\n  | 2020    .0028069   .0293865   -.1286469   .1198083 |\n  | 2021    .0013057   .0158127   -.0416734   .0538514 |\n  | 2022   -.0009696   .0224866   -.0586793   .0889746 |\n  | 2023     .001678   .0127879     -.04802   .0469269 |\n  | 2024    .0011971   .0143064   -.0481671   .0726491 |\n  +----------------------------------------------------+\n\n\n\n```\n:::\n:::\n\n\n## Scaling Up the Analysis\n\nAs a next step, we generalize the previous code so that all computations can handle an arbitrary number of symbols (e.g., all constituents of an index). Following tidy principles, it is quite easy to download the data, plot the price time series, and tabulate the summary statistics for an arbitrary number of assets.\n\nThis is where the power of Stata's data management starts: Panel data structures make it extremely easy to generalize the computations from before to as many assets or groups as you like. The following code takes any number of symbols, e.g., all current constituents of the Dow Jones Industrial Average index, and automates the download as well as the plot of the price time series. In the end, we create the table of summary statistics for all assets at once.\n\n::: {#fa9a1363 .cell execution_count=9}\n``` {.stata .cell-code}\nclear all\n\npython:\nimport pandas as pd\nimport tidyfinance as tf\nfrom sfi import Data\n\nsymbols = tf.download_data(\n  domain=\"constituents\", \n  index=\"Dow Jones Industrial Average\"\n)\n\nprices = tf.download_data(\n  domain=\"stock_prices\",\n  symbols=symbols['symbol'].tolist(),\n  start_date=\"2000-01-01\",\n  end_date=\"2023-12-31\"\n)\n\nn = len(prices)\nData.setObsTotal(n)\n\nData.addVarStr(\"symbol\", 10)\nData.addVarStr(\"date_str\", 10)\nData.addVarDouble(\"open\")\nData.addVarDouble(\"high\")\nData.addVarDouble(\"low\")\nData.addVarDouble(\"close\")\nData.addVarDouble(\"volume\")\nData.addVarDouble(\"adjusted_close\")\n\nfor i in range(n):\n    Data.storeAt(\"symbol\", i, str(prices['symbol'].iloc[i]))\n    Data.storeAt(\"date_str\", i, str(prices['date'].iloc[i].date()))\n    Data.storeAt(\"open\", i, float(prices['open'].iloc[i]))\n    Data.storeAt(\"high\", i, float(prices['high'].iloc[i]))\n    Data.storeAt(\"low\", i, float(prices['low'].iloc[i]))\n    Data.storeAt(\"close\", i, float(prices['close'].iloc[i]))\n    Data.storeAt(\"volume\", i, float(prices['volume'].iloc[i]))\n    Data.storeAt(\"adjusted_close\", i, float(prices['adjusted_close'].iloc[i]))\n\nend\n\ngen date = date(date_str, \"YMD\")\nformat date %td\ndrop date_str\norder symbol date open high low close adjusted_close volume\nsave \"data-stata/prices_daily.dta\", replace\n\ndescribe\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nfile data-stata/prices_daily.dta saved\n\nContains data from data-stata/prices_daily.dta\n Observations:       177,925                  \n    Variables:             8                  3 Feb 2026 20:36\n-------------------------------------------------------------------------------\nVariable      Storage   Display    Value\n    name         type    format    label      Variable label\n-------------------------------------------------------------------------------\nsymbol          str10   %10s                  \ndate            float   %td                   \nopen            double  %10.0g                \nhigh            double  %10.0g                \nlow             double  %10.0g                \nclose           double  %10.0g                \nadjusted_close  double  %10.0g                \nvolume          double  %10.0g                \n-------------------------------------------------------------------------------\nSorted by: \n```\n:::\n:::\n\n\nConveniently, `tidyfinance` provides the functionality to get all stock prices from an index for a specific point in time with a single call.\n\nThe resulting dataset contains daily observations for all different stocks in the Dow Jones index. @fig-102 illustrates the time series of the downloaded *adjusted* prices for each of the constituents of the Dow index overlayed on a single plot.\n\n::: {#cell-fig-102 .cell execution_count=10}\n``` {.stata .cell-code}\nencode symbol, gen(symbol_id)\nxtset symbol_id date\nxtline adjusted_close, overlay legend(off) ///\n    title(\"Stock prices of Dow Jones index constituents\") ///\n    xtitle(\"\") ytitle(\"\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nPanel variable: symbol_id (unbalanced)\n Time variable: date, 03jan2000 to 29dec2023, but with gaps\n         Delta: 1 day\n```\n:::\n\n::: {.cell-output .cell-output-display}\n![Prices in USD, adjusted for dividend payments and stock splits.](working-with-stock-returns_files/figure-html/fig-102-output-2.png){#fig-102 fig-alt='Title: Stock prices of Dow Jones index constituents. The figure shows many time series with daily prices. The general trend seems positive for most stocks in the Dow Jones index.'}\n:::\n:::\n\n\nDo you notice the differences relative to the code we used before? All we needed to do to illustrate all stock symbols simultaneously is to use panel data commands. Of course, there are simply too many lines on the overlay graph to identify the individual stocks properly, but it illustrates our point of how to generalize a specific analysis to an arbitrary number of subjects quite well.\n\nThe same holds for stock returns. Before computing the returns, we use `bysort symbol` such that the return calculation is performed for each symbol individually. The same logic also applies to the computation of summary statistics: `bysort symbol` is the key to aggregating the time series into symbol-specific variables of interest.\n\n::: {#9322c375 .cell execution_count=11}\n``` {.stata .cell-code}\nbysort symbol (date): gen ret = adjusted_close / adjusted_close[_n-1] - 1\nkeep symbol date ret\ndrop if missing(ret)\n\nsave \"data-stata/returns_daily.dta\", replace\n\npreserve\ncollapse (mean) daily_mean=ret (sd) daily_sd=ret ///\n         (min) daily_min=ret (max) daily_max=ret, by(symbol)\nlist symbol daily_mean daily_sd daily_min daily_max, noobs abbreviate(12)\nrestore\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n(Note: Below code run with echo to enable preserve/restore functionality.)\n\n(30 missing values generated)\n\n\n(30 observations deleted)\n\nfile data-stata/returns_daily.dta saved\n\n\n\n\n  +--------------------------------------------------------+\n  | symbol   daily_mean   daily_sd   daily_min   daily_max |\n  |--------------------------------------------------------|\n  |   AAPL     .0012181   .0247352    -.518692    .1390495 |\n  |   AMGN     .0004931   .0194263   -.1341241    .1510205 |\n  |   AMZN      .001073    .031528   -.2476607    .3447136 |\n  |    AXP     .0005436    .022702   -.1759496    .2188221 |\n  |     BA     .0006285   .0221708   -.2384841    .2431861 |\n  |--------------------------------------------------------|\n  |    CAT     .0007241   .0202978   -.1451755    .1472297 |\n  |    CRM     .0011896   .0265993   -.2714819     .260449 |\n  |   CSCO     .0003222   .0233581   -.1621072    .2438836 |\n  |    CVX     .0005106   .0175301   -.2212475    .2274072 |\n  |    DIS     .0004137   .0193803   -.1836302    .1597222 |\n  |--------------------------------------------------------|\n  |     GS     .0005568   .0228646   -.1895958     .264679 |\n  |     HD     .0005438   .0191592   -.2873564     .140667 |\n  |    HON     .0004967   .0191035   -.1736692    .2822295 |\n  |    IBM     .0002966   .0163122   -.1554204    .1202328 |\n  |    JNJ     .0003787   .0121364   -.1584557    .1222912 |\n  |--------------------------------------------------------|\n  |    JPM     .0006059   .0238462   -.2072745    .2509675 |\n  |     KO     .0003183    .013062   -.1006097    .1387947 |\n  |    MCD     .0005361   .0145301   -.1587537    .1812544 |\n  |    MMM     .0003632   .0151373   -.1294507    .1259862 |\n  |    MRK     .0003714   .0166078   -.2678061    .1303294 |\n  |--------------------------------------------------------|\n  |   MSFT     .0005734    .019255   -.1559778    .1956521 |\n  |    NKE     .0007083   .0193034   -.1981272    .1553142 |\n  |   NVDA     .0017487   .0375833   -.3523358    .4241472 |\n  |     PG     .0003615   .0132529   -.3023592    .1200904 |\n  |    SHW     .0008602   .0179564   -.2078788    .1525693 |\n  |--------------------------------------------------------|\n  |    TRV     .0005553   .0181391   -.2080036    .2555562 |\n  |    UNH     .0009483   .0195592   -.1863617    .3475502 |\n  |      V     .0009328   .0185385   -.1364343    .1499734 |\n  |     VZ     .0002382   .0150844   -.1184611    .1463237 |\n  |    WMT     .0003229    .014832   -.1137576    .1170849 |\n  +--------------------------------------------------------+\n\n\n\n```\n:::\n:::\n\n\nNote that you are now also equipped with all tools to download price data for *each* symbol listed in the S&P 500 index with the same number of lines of code. Just change the index name to \"S&P 500\" in the Python download call. However, don't try this if you are not prepared to wait for a couple of minutes because this is quite some data to download!\n\n## Different Frequencies\n\nFinancial data often exists at different frequencies due to varying reporting schedules, trading calendars, and economic data releases. For example, stock prices are typically recorded daily, while macroeconomic indicators such as GDP or inflation are reported monthly or quarterly. Additionally, some datasets are recorded only when transactions occur, resulting in irregular timestamps. To compare data meaningfully, we have to align different frequencies appropriately. For example, to compare returns across different frequencies, we use annualization techniques.\n\nSo far, we have worked with daily returns, but we can easily convert our data to other frequencies. Let's create monthly returns from our daily data:\n\n::: {#2e3a0caf .cell execution_count=12}\n``` {.stata .cell-code}\ngen monthly_date = mofd(date)\nformat monthly_date %tm\n\nbysort symbol monthly_date: gen temp = 1 + ret\nbysort symbol monthly_date: gen ret_monthly = exp(sum(ln(temp))) - 1\nbysort symbol monthly_date: keep if _n == _N\n\nkeep symbol monthly_date ret_monthly\nrename monthly_date date\n\nsave \"data-stata/returns_monthly.dta\", replace\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n(169,406 observations deleted)\nfile data-stata/returns_monthly.dta saved\n```\n:::\n:::\n\n\nTo visualize how return characteristics change across different frequencies, we can compare histograms as in @fig-103:\n\n::: {#cell-fig-103 .cell execution_count=13}\n``` {.stata .cell-code}\nuse \"data-stata/returns_daily.dta\", clear\nkeep if symbol == \"AAPL\"\ngen frequency = \"Daily\"\nrename ret return\ntempfile daily\nsave `daily'\n\nuse \"data-stata/returns_monthly.dta\", clear\nkeep if symbol == \"AAPL\"\ngen frequency = \"Monthly\"\nrename ret_monthly return\ntempfile monthly\nsave `monthly'\n\nuse `daily', clear\nappend using `monthly'\n\ntwoway (histogram return if frequency == \"Daily\", bins(50) color(blue%50)) ///\n       (histogram return if frequency == \"Monthly\", bins(50) color(red%50)), ///\n    by(frequency, cols(2) note(\"\") title(\"Distribution of Apple returns across different frequencies\")) ///\n    legend(off) ///\n    xtitle(\"\") ytitle(\"\") ///\n    xlabel(, format(%9.2f))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n(171,859 observations deleted)\nfile /var/folders/g1/87g_4bg57y97pcsk73ydb99c0000gn/T//St75510.00000g saved\n    as .dta format\n(8,201 observations deleted)\nfile /var/folders/g1/87g_4bg57y97pcsk73ydb99c0000gn/T//St75510.00000h saved\n    as .dta format\n(variable frequency was str5, now str7 to accommodate using data's values)\n```\n:::\n\n::: {.cell-output .cell-output-display}\n![Returns are based on prices adjusted for dividend payments and stock splits.](working-with-stock-returns_files/figure-html/fig-103-output-2.png){#fig-103 fig-alt='Title: Distribution of Apple returns across different frequencies. The figure shows the distribution of daily and monthly returns in two separate facets.'}\n:::\n:::\n\n\n## Other Forms of Data Aggregation\n\nOf course, aggregation across variables other than `symbol` or `date` can also make sense. For instance, suppose you are interested in answering questions like: Are days with high aggregate trading volume likely followed by days with high aggregate trading volume? To provide some initial analysis on this question, we take the downloaded data and compute aggregate daily trading volume for all Dow index constituents in USD. Recall that the column `volume` is denoted in the number of traded shares. Thus, we multiply the trading volume with the daily adjusted closing price to get a proxy for the aggregate trading volume in USD. Scaling by `1e9` denotes daily trading volume in billion USD.\n\n::: {#cell-fig-104 .cell execution_count=14}\n``` {.stata .cell-code}\nuse \"data-stata/prices_daily\", clear\n\ngen trading_volume_usd = volume * adjusted_close\ncollapse (sum) trading_volume = trading_volume_usd, by(date)\nreplace trading_volume = trading_volume / 1e9\n\ntwoway (line trading_volume date), ///\n    title(\"Aggregate daily trading volume of Dow Jones index constituents\") ///\n    xtitle(\"\") ytitle(\"Billion USD\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n(6,037 real changes made)\n```\n:::\n\n::: {.cell-output .cell-output-display}\n![Total daily trading volume in billion USD.](working-with-stock-returns_files/figure-html/fig-104-output-2.png){#fig-104 fig-alt='Title: Aggregate daily trading volume of Dow Jones index constituents. The figure shows a volatile time series of daily trading volume, ranging from 15 in 2000 to 20.5 in 2023, with a maximum of more than 100.'}\n:::\n:::\n\n\n@fig-104 indicates a clear upward trend in aggregated daily trading volume. In particular, since the outbreak of the COVID-19 pandemic, markets have processed substantial trading volumes. One way to illustrate the persistence of trading volume would be to plot volume on day $t$ against volume on day $t-1$ as in the example below. In @fig-105, we add a dotted 45Â°-line to indicate a hypothetical one-to-one relation, addressing potential differences in the axes' scales.\n\n::: {#cell-fig-105 .cell execution_count=15}\n``` {.stata .cell-code}\nsort date\ngen lag_trading_volume = trading_volume[_n-1]\n\ntwoway (scatter trading_volume lag_trading_volume, msize(tiny)) ///\n       (function y=x, range(0 150) lpattern(dash)), ///\n    title(\"Persistence in daily trading volume of Dow Jones index constituents\") ///\n    xtitle(\"Previous day aggregate trading volume (Billion USD)\") ///\n    ytitle(\"Aggregate trading volume (Billion USD)\") ///\n    legend(off)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n(1 missing value generated)\n```\n:::\n\n::: {.cell-output .cell-output-display}\n![Total daily trading volume in billion USD.](working-with-stock-returns_files/figure-html/fig-105-output-2.png){#fig-105 fig-alt='Title: Persistence in daily trading volume of Dow Jones index constituents. The figure shows a scatterplot where aggregate trading volume and previous-day aggregate trading volume neatly line up along a 45-degree line.'}\n:::\n:::\n\n\nDo you understand where the message about missing values comes from when creating the lag? Purely eye-balling reveals that days with high trading volume are often followed by similarly high trading volume days.\n\n## Key Takeaways\n\n- You can use Stata's data management commands and Python integration to efficiently analyze stock market data.\n- The `tidyfinance` Python package allows seamless downloading of historical stock prices and index data directly from Yahoo Finance.\n- Panel data structures in Stata enable efficient analysis of financial data across multiple securities.\n- Adjusted stock prices provide a more accurate reflection of investor returns by accounting for dividends and stock splits.\n- Summary statistics such as mean, standard deviation, and quantiles offer insights into stock return behavior over time.\n- Visualizations created with Stata's graphics commands help identify trends, volatility, and return distributions in financial time series.\n- Stata's `bysort` and `collapse` commands make it easy to scale financial analyses from a single stock to entire indices like the Dow Jones or S&P 500.\n- Consistent workflows form the foundation for advanced financial analysis.\n\n## Exercises\n\n1.  Download daily prices for another stock market symbol of your choice from Yahoo Finance using the Python integration shown in this chapter. Plot two time series of the symbol's un-adjusted and adjusted closing prices. Explain any visible differences.\n2.  Compute daily net returns for an asset of your choice and visualize the distribution of daily returns in a histogram using 100 bins. Also, use `xline()` to add a dashed red vertical line that indicates the 5 percent quantile of the daily returns. Compute summary statistics (mean, standard deviation, minimum, and maximum) for the daily returns.\n3.  Take your code from the previous exercises and generalize it such that you can perform all the computations for an arbitrary number of symbols (e.g., `\"AAPL\" \"MMM\" \"BA\"`). Automate the download, the plot of the price time series, and create a table of return summary statistics for this arbitrary number of assets.\n4.  To facilitate the computation of the annualization factor, write a Stata program that takes a variable of return dates as input and determines the frequency before returning the appropriate annualization factor.\n5.  Are days with high aggregate trading volume often also days with large absolute returns? Find an appropriate visualization to analyze the question using the symbol `AAPL`.\n\n",
    "supporting": [
      "working-with-stock-returns_files"
    ],
    "filters": [],
    "includes": {
      "include-in-header": [
        "<script src=\"https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js\" integrity=\"sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx\" crossorigin=\"anonymous\"></script>\n<script src=\"https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js\" integrity=\"sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2\" crossorigin=\"anonymous\" data-relocate-top=\"true\"></script>\n<script type=\"application/javascript\">define('jquery', [],function() {return window.jQuery;})</script>\n"
      ]
    }
  }
}