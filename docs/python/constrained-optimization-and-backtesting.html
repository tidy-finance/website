<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Conduct portfolio backtesting with transaction costs and no-shortselling constraints using the programming language Python.">

<title>Constrained Optimization and Backtesting with Python – Tidy Finance</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../python/wrds-dummy-data.html" rel="next">
<link href="../python/parametric-portfolio-policies.html" rel="prev">
<link href="../assets/img/favicon.png" rel="icon" type="image/png">
<script src="../site_libs/cookie-consent/cookie-consent.js"></script>
<link href="../site_libs/cookie-consent/cookie-consent.css" rel="stylesheet">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-9c5d9ace2f4fc3d608099a0da644ebba.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-DH3KZSMJ5W"></script>

<script type="text/plain" cookie-consent="tracking">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-DH3KZSMJ5W', { 'anonymize_ip': true});
</script>

<script type="text/javascript" charset="UTF-8">
document.addEventListener('DOMContentLoaded', function () {
cookieconsent.run({
  "notice_banner_type":"interstitial",
  "consent_type":"express",
  "palette":"light",
  "language":"en",
  "page_load_consent_levels":["strictly-necessary"],
  "notice_banner_reject_button_hide":false,
  "preferences_center_close_button_hide":false,
  "website_name":""
  ,
"language":"en"
  });
});
</script> 
  
<style>html{ scroll-behavior: smooth; }</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../assets/css/global.css">
<meta property="og:title" content="Constrained Optimization and Backtesting with Python">
<meta property="og:description" content="An opinionated approach on empirical research in financial economics">
<meta property="og:image" content="https://www.tidy-finance.org/python/constrained-optimization-and-backtesting_files/figure-html/fig-1701-output-1.png">
<meta property="og:site_name" content="Tidy Finance">
<meta property="og:image:alt" content="Title: Portfolio weights for different risk aversion and transaction cost. The figure shows four lines that indicate that rebalancing from the initial portfolio decreases for higher transaction costs and for higher risk aversion.">
<meta property="og:image:height" content="800">
<meta property="og:image:width" content="1280">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../assets/img/logo-website-white.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Tidy Finance</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../r/index.html"> 
<span class="menu-text">R</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../python/index.html" aria-current="page"> 
<span class="menu-text">Python</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../blog.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../contribute.html"> 
<span class="menu-text">Contribute</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../support.html"> 
<span class="menu-text">Support</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.etsy.com/shop/tidyswag/?etsrc=sdt&amp;utm_source=tidy-finance.org"> 
<span class="menu-text">Swag</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://talks.tidy-finance.org"> 
<span class="menu-text">Talks</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../workshops/reproducible-research-workflows.html"> 
<span class="menu-text">Workshops</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <a class="flex-grow-1 no-decor" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
          <h1 class="quarto-secondary-nav-title">Constrained Optimization and Backtesting</h1>
        </a>     
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Tidy Finance with Python</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tidy Finance with Python</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Getting Started</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/working-with-stock-returns.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Working with Stock Returns</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/modern-portfolio-theory.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Modern Portfolio Theory</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/capital-asset-pricing-model.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">The Capital Asset Pricing Model</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/financial-statement-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Financial Statement Analysis</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/discounted-cash-flow-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Discounted Cash Flow Analysis</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Financial Data</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/accessing-and-managing-financial-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Accessing and Managing Financial Data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/wrds-crsp-and-compustat.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">WRDS, CRSP, and Compustat</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/trace-and-fisd.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">TRACE and FISD</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/other-data-providers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Other Data Providers</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Asset Pricing</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/beta-estimation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Beta Estimation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/univariate-portfolio-sorts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Univariate Portfolio Sorts</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/size-sorts-and-p-hacking.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Size Sorts and p-Hacking</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/value-and-bivariate-sorts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Value and Bivariate Sorts</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/replicating-fama-and-french-factors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Replicating Fama-French Factors</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/fama-macbeth-regressions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Fama-MacBeth Regressions</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Modeling and Machine Learning</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/fixed-effects-and-clustered-standard-errors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Fixed Effects and Clustered Standard Errors</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/difference-in-differences.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Difference in Differences</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/factor-selection-via-machine-learning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Factor Selection via Machine Learning</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/option-pricing-via-machine-learning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Option Pricing via Machine Learning</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true">
 <span class="menu-text">Portfolio Optimization</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/parametric-portfolio-policies.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Parametric Portfolio Policies</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/constrained-optimization-and-backtesting.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Constrained Optimization and Backtesting</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true">
 <span class="menu-text">Appendix</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/wrds-dummy-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">WRDS Dummy Data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/cover-image.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Cover Image</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/clean-enhanced-trace-with-python.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Clean Enhanced TRACE with Python</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/proofs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Proofs</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/colophon.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Colophon</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/changelog.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Changelog</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#data-preparation" id="toc-data-preparation" class="nav-link active" data-scroll-target="#data-preparation">Data Preparation</a></li>
  <li><a href="#recap-of-portfolio-choice" id="toc-recap-of-portfolio-choice" class="nav-link" data-scroll-target="#recap-of-portfolio-choice">Recap of Portfolio Choice</a></li>
  <li><a href="#estimation-uncertainty-and-transaction-costs" id="toc-estimation-uncertainty-and-transaction-costs" class="nav-link" data-scroll-target="#estimation-uncertainty-and-transaction-costs">Estimation Uncertainty and Transaction Costs</a></li>
  <li><a href="#optimal-portfolio-choice" id="toc-optimal-portfolio-choice" class="nav-link" data-scroll-target="#optimal-portfolio-choice">Optimal Portfolio Choice</a></li>
  <li><a href="#constrained-optimization" id="toc-constrained-optimization" class="nav-link" data-scroll-target="#constrained-optimization">Constrained Optimization</a></li>
  <li><a href="#out-of-sample-backtesting" id="toc-out-of-sample-backtesting" class="nav-link" data-scroll-target="#out-of-sample-backtesting">Out-of-Sample Backtesting</a></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises">Exercises</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/tidy-finance/website/blob/main/python/constrained-optimization-and-backtesting.qmd" class="toc-action"><i class="bi bi-github"></i>View source</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">Constrained Optimization and Backtesting</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>You are reading <strong>Tidy Finance with Python</strong>. You can find the equivalent chapter for the sibling <strong>Tidy Finance with R</strong><a href="../r/constrained-optimization-and-backtesting.html">here</a>.</p>
</div>
</div>
<p> In this chapter, we conduct portfolio backtesting in a realistic setting by including transaction costs and investment constraints such as no-short-selling rules. We start with standard mean-variance efficient portfolios and introduce constraints in a step-by-step manner. To do so, we rely on numerical optimization procedures in Python. We conclude the chapter by providing an out-of-sample backtesting procedure for the different strategies that we introduce in this chapter.</p>
<p>Throughout this chapter, we use the following Python packages:</p>
<div id="f360e629" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sqlite3</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> plotnine <span class="im">import</span> <span class="op">*</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mizani.formatters <span class="im">import</span> percent_format</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> itertools <span class="im">import</span> product</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> expon</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.optimize <span class="im">import</span> minimize</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Compared to previous chapters, we introduce <code>expon</code> from <code>scipy.stats</code> to calculate exponential continuous random variables.</p>
<section id="data-preparation" class="level2">
<h2 class="anchored" data-anchor-id="data-preparation">Data Preparation</h2>
<p>We start by loading the required data from our SQLite database introduced in <a href="../python/accessing-and-managing-financial-data.html">Accessing and Managing Financial Data</a> and <a href="../python/wrds-crsp-and-compustat.html">WRDS, CRSP, and Compustat</a>. For simplicity, we restrict our investment universe to the monthly Fama-French industry portfolio returns in the following application. </p>
<div id="433358fd" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>tidy_finance <span class="op">=</span> sqlite3.<span class="ex">connect</span>(database<span class="op">=</span><span class="st">"data/tidy_finance_python.sqlite"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>industry_returns <span class="op">=</span> (pd.read_sql_query(</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    sql<span class="op">=</span><span class="st">"SELECT * FROM industries_ff_monthly"</span>,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    parse_dates<span class="op">=</span>{<span class="st">"date"</span>})</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  .drop(columns<span class="op">=</span>[<span class="st">"date"</span>])</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="recap-of-portfolio-choice" class="level2">
<h2 class="anchored" data-anchor-id="recap-of-portfolio-choice">Recap of Portfolio Choice</h2>
<p>A common objective for portfolio optimization is to find mean-variance efficient portfolio weights, i.e., the allocation that delivers the lowest possible return variance for a given minimum level of expected returns. In the most extreme case, where the investor is only concerned about portfolio variance, they may choose to implement the minimum variance portfolio (MVP) weights which are given by the solution to <span id="eq-recap-mvp"><span class="math display">\[\omega_\text{mvp} = \arg\min \omega'\Sigma \omega \text{ s.t. } \omega'\iota = 1 \tag{1}\]</span></span> where <span class="math inline">\(\Sigma\)</span> is the <span class="math inline">\((N \times N)\)</span> covariance matrix of the returns. The optimal weights <span class="math inline">\(\omega_\text{mvp}\)</span> can be found analytically and are <span class="math inline">\(\omega_\text{mvp} = \frac{\Sigma^{-1}\iota}{\iota'\Sigma^{-1}\iota}\)</span>. In terms of code, the math is equivalent to the following chunk. </p>
<div id="a54327b7" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>n_industries <span class="op">=</span> industry_returns.shape[<span class="dv">1</span>]</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>mu <span class="op">=</span> np.array(industry_returns.mean()).T</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>sigma <span class="op">=</span> np.array(industry_returns.cov())</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>w_mvp <span class="op">=</span> np.linalg.inv(sigma) <span class="op">@</span> np.ones(n_industries)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>w_mvp <span class="op">=</span> w_mvp<span class="op">/</span>w_mvp.<span class="bu">sum</span>()</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>weights_mvp <span class="op">=</span> pd.DataFrame({</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Industry"</span>: industry_returns.columns.tolist(),</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Minimum variance"</span>: w_mvp</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>weights_mvp.<span class="bu">round</span>(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Industry</th>
<th data-quarto-table-cell-role="th">Minimum variance</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>nodur</td>
<td>0.256</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>durbl</td>
<td>0.000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>manuf</td>
<td>0.048</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>enrgy</td>
<td>0.082</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>hitec</td>
<td>0.014</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>telcm</td>
<td>0.235</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>shops</td>
<td>0.089</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>hlth</td>
<td>0.161</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>utils</td>
<td>0.469</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>other</td>
<td>-0.355</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Next, consider an investor who aims to achieve minimum variance <em>given a required expected portfolio return</em> <span class="math inline">\(\bar{\mu}\)</span> such that she chooses <span id="eq-recap-efficient-portfolio"><span class="math display">\[\omega_\text{eff}({\bar{\mu}}) =\arg\min \omega'\Sigma \omega \text{ s.t. } \omega'\iota = 1 \text{ and } \omega'\mu \geq \bar{\mu}. \tag{2}\]</span></span> We leave it as an exercise below to show that the portfolio choice problem can equivalently be formulated for an investor with mean-variance preferences and risk aversion factor <span class="math inline">\(\gamma\)</span>. That means the investor aims to choose portfolio weights as the solution to <span id="eq-recap-mean-variance"><span class="math display">\[ \omega^*_\gamma = \arg\max \omega' \mu - \frac{\gamma}{2}\omega'\Sigma \omega\quad \text{ s.t. } \omega'\iota = 1. \tag{3}\]</span></span> The solution to the optimal portfolio choice problem is: <span id="eq-analytical-solution-mv"><span class="math display">\[\omega^*_{\gamma} = \frac{1}{\gamma}\left(\Sigma^{-1} - \frac{1}{\iota' \Sigma^{-1}\iota }\Sigma^{-1}\iota\iota' \Sigma^{-1} \right) \mu + \frac{1}{\iota' \Sigma^{-1} \iota }\Sigma^{-1} \iota. \tag{4}\]</span></span> To proof this statement, we refer to the derivations in <a href="../python/proofs.html">Proofs</a>. Empirically, this classical solution imposes many problems. In particular, the estimates of <span class="math inline">\(\mu\)</span> are noisy over short horizons, the (<span class="math inline">\(N \times N\)</span>) matrix <span class="math inline">\(\Sigma\)</span> contains <span class="math inline">\(N(N-1)/2\)</span> distinct elements and thus, estimation error is huge. Seminal papers on the effect of ignoring estimation uncertainty, among others, are <span class="citation" data-cites="Brown1976">Brown (<a href="#ref-Brown1976" role="doc-biblioref">1976</a>)</span>, <span class="citation" data-cites="Jobson1980">Jobson and Korkie (<a href="#ref-Jobson1980" role="doc-biblioref">1980</a>)</span>, <span class="citation" data-cites="Jorion1986">Jorion (<a href="#ref-Jorion1986" role="doc-biblioref">1986</a>)</span>, and <span class="citation" data-cites="Chopra1993">Chopra and Ziemba (<a href="#ref-Chopra1993" role="doc-biblioref">1993</a>)</span>.</p>
<p>Even worse, if the asset universe contains more assets than available time periods <span class="math inline">\((N &gt; T)\)</span>, the sample covariance matrix is no longer positive definite such that the inverse <span class="math inline">\(\Sigma^{-1}\)</span> does not exist anymore. To address estimation issues for vast-dimensional covariance matrices, regularization techniques <span class="citation" data-cites="Ledoit2003 Ledoit2004 Ledoit2012 Fan2008">(see, e.g., <a href="#ref-Ledoit2003" role="doc-biblioref">Ledoit and Wolf 2003</a>, <a href="#ref-Ledoit2004" role="doc-biblioref">2004</a>, <a href="#ref-Ledoit2012" role="doc-biblioref">2012</a>; <a href="#ref-Fan2008" role="doc-biblioref">Fan, Fan, and Lv 2008</a>)</span> and the parametric approach from the previous chapter are popular tools.</p>
<p>While the uncertainty associated with estimated parameters is challenging, the data-generating process is also unknown to the investor. In other words, model uncertainty reflects that it is ex-ante not even clear which parameters require estimation (for instance, if returns are driven by a factor model, selecting the universe of relevant factors imposes model uncertainty). <span class="citation" data-cites="Wang2005">Wang (<a href="#ref-Wang2005" role="doc-biblioref">2005</a>)</span> and <span class="citation" data-cites="Garlappi2007">Garlappi, Uppal, and Wang (<a href="#ref-Garlappi2007" role="doc-biblioref">2007</a>)</span> provide theoretical analysis on optimal portfolio choice under model <em>and</em> estimation uncertainty. In the most extreme case, <span class="citation" data-cites="Pflug2012">Pflug, Pichler, and Wozabal (<a href="#ref-Pflug2012" role="doc-biblioref">2012</a>)</span> shows that the naive portfolio, which allocates equal wealth to all assets, is the optimal choice for an investor averse to model uncertainty.</p>
<p>On top of the estimation uncertainty, <em>transaction costs</em> are a major concern. Rebalancing portfolios is costly, and, therefore, the optimal choice should depend on the investor’s current holdings. In the presence of transaction costs, the benefits of reallocating wealth may be smaller than the costs associated with turnover. This aspect has been investigated theoretically, among others, for one risky asset by <span class="citation" data-cites="Magill1976">Magill and Constantinides (<a href="#ref-Magill1976" role="doc-biblioref">1976</a>)</span> and <span class="citation" data-cites="Davis1990">Davis and Norman (<a href="#ref-Davis1990" role="doc-biblioref">1990</a>)</span>. Subsequent extensions to the case with multiple assets have been proposed by <span class="citation" data-cites="Balduzzi1999">Balduzzi and Lynch (<a href="#ref-Balduzzi1999" role="doc-biblioref">1999</a>)</span> and <span class="citation" data-cites="Balduzzi2000">Balduzzi and Lynch (<a href="#ref-Balduzzi2000" role="doc-biblioref">2000</a>)</span>. More recent papers on empirical approaches that explicitly account for transaction costs include <span class="citation" data-cites="Garleanu2013">Gârleanu and Pedersen (<a href="#ref-Garleanu2013" role="doc-biblioref">2013</a>)</span>, <span class="citation" data-cites="DeMiguel2014">DeMiguel, Nogales, and Uppal (<a href="#ref-DeMiguel2014" role="doc-biblioref">2014</a>)</span>, and <span class="citation" data-cites="DeMiguel2015">DeMiguel, Martín-Utrera, and Nogales (<a href="#ref-DeMiguel2015" role="doc-biblioref">2015</a>)</span>.</p>
</section>
<section id="estimation-uncertainty-and-transaction-costs" class="level2">
<h2 class="anchored" data-anchor-id="estimation-uncertainty-and-transaction-costs">Estimation Uncertainty and Transaction Costs</h2>
<p>The empirical evidence regarding the performance of a mean-variance optimization procedure in which you simply plug in some sample estimates <span class="math inline">\(\hat \mu\)</span> and <span class="math inline">\(\hat \Sigma\)</span> can be summarized rather briefly: mean-variance optimization performs poorly! The literature discusses many proposals to overcome these empirical issues. For instance, one may impose some form of regularization of <span class="math inline">\(\Sigma\)</span>, rely on Bayesian priors inspired by theoretical asset pricing models <span class="citation" data-cites="Kan2007">(<a href="#ref-Kan2007" role="doc-biblioref">Kan and Zhou 2007</a>)</span>, or use high-frequency data to improve forecasting <span class="citation" data-cites="Hautsch2015">(<a href="#ref-Hautsch2015" role="doc-biblioref">Hautsch, Kyj, and Malec 2015</a>)</span>. One unifying framework that works easily, effectively (even for large dimensions), and is purely inspired by economic arguments is an ex-ante adjustment for transaction costs <span class="citation" data-cites="Hautsch2019">(<a href="#ref-Hautsch2019" role="doc-biblioref">Hautsch and Voigt 2019</a>)</span>.</p>
<p>Assume that returns are from a multivariate normal distribution with mean <span class="math inline">\(\mu\)</span> and variance-covariance matrix <span class="math inline">\(\Sigma\)</span>, <span class="math inline">\(N(\mu,\Sigma)\)</span>. Additionally, we assume quadratic transaction costs which penalize rebalancing such that <span id="eq-definition-transaction-costs"><span class="math display">\[
\begin{aligned}
\nu\left(\omega_{t+1},\omega_{t^+}, \beta\right) = \frac{\beta}{2} \left(\omega_{t+1} - \omega_{t^+}\right)'\left(\omega_{t+1}- \omega_{t^+}\right),\end{aligned} \tag{5}\]</span></span> with cost parameter <span class="math inline">\(\beta&gt;0\)</span> and <span class="math inline">\(\omega_{t^+} = {\omega_t \circ (1 +r_{t})}/{\iota' (\omega_t \circ (1 + r_{t}))}\)</span>, where <span class="math inline">\(\circ\)</span> is the element-wise Hadamard product. <span class="math inline">\(\omega_{t^+}\)</span> denotes the portfolio weights just before rebalancing. Note that <span class="math inline">\(\omega_{t^+}\)</span> differs mechanically from <span class="math inline">\(\omega_t\)</span> due to the returns in the past period. Intuitively, transaction costs penalize portfolio performance when the portfolio is shifted from the current holdings <span class="math inline">\(\omega_{t^+}\)</span> to a new allocation <span class="math inline">\(\omega_{t+1}\)</span>. In this setup, transaction costs do not increase linearly. Instead, larger rebalancing is penalized more heavily than small adjustments. Then, the optimal portfolio choice for an investor with mean variance preferences is <span id="eq-tc-optimization-problem"><span class="math display">\[\begin{aligned}\omega_{t+1} ^* &amp;= \arg\max \omega'\mu - \nu_t (\omega,\omega_{t^+}, \beta) - \frac{\gamma}{2}\omega'\Sigma\omega \text{ s.t. } \iota'\omega = 1\\
&amp;=\arg\max
\omega'\mu^* - \frac{\gamma}{2}\omega'\Sigma^* \omega \text{ s.t.} \iota'\omega=1,\end{aligned} \tag{6}\]</span></span> where <span id="eq-tc-optimization-solution"><span class="math display">\[\mu^*=\mu+\beta \omega_{t^+} \quad \text{and} \quad \Sigma^*=\Sigma + \frac{\beta}{\gamma} I_N. \tag{7}\]</span></span> As a result, adjusting for transaction costs implies a standard mean-variance optimal portfolio choice with adjusted return parameters <span class="math inline">\(\Sigma^*\)</span> and <span class="math inline">\(\mu^*\)</span>: <span id="eq-tc-weights"><span class="math display">\[\omega^*_{t+1} = \frac{1}{\gamma}\left(\Sigma^{*-1} - \frac{1}{\iota' \Sigma^{*-1}\iota }\Sigma^{*-1}\iota\iota' \Sigma^{*-1} \right) \mu^* + \frac{1}{\iota' \Sigma^{*-1} \iota }\Sigma^{*-1} \iota. \tag{8}\]</span></span></p>
<p>An alternative formulation of the optimal portfolio can be derived as follows: <span id="eq-tc-alternative-weights"><span class="math display">\[\omega_{t+1} ^*=\arg\max
\omega'\left(\mu+\beta\left(\omega_{t^+} - \frac{1}{N}\iota\right)\right) - \frac{\gamma}{2}\omega'\Sigma^* \omega \text{ s.t. } \iota'\omega=1. \tag{9}\]</span></span> The optimal weights correspond to a mean-variance portfolio, where the vector of expected returns is such that assets that currently exhibit a higher weight are considered as delivering a higher expected return.</p>
</section>
<section id="optimal-portfolio-choice" class="level2">
<h2 class="anchored" data-anchor-id="optimal-portfolio-choice">Optimal Portfolio Choice</h2>
<p>The function below implements the efficient portfolio weights in its general form, allowing for transaction costs (conditional on the holdings <em>before</em> reallocation). For <span class="math inline">\(\beta=0\)</span>, the computation resembles the standard mean-variance efficient framework. <code>gamma</code> denotes the coefficient of risk aversion <span class="math inline">\(\gamma\)</span>, <code>beta</code> is the transaction cost parameter <span class="math inline">\(\beta\)</span> and <code>w_prev</code> are the weights before rebalancing <span class="math inline">\(\omega_{t^+}\)</span>.</p>
<div id="a937a8a2" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_efficient_weight(sigma, </span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>                             mu, </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>                             gamma<span class="op">=</span><span class="dv">2</span>, </span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>                             beta<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>                             w_prev<span class="op">=</span>np.ones(sigma.shape[<span class="dv">1</span>])<span class="op">/</span>sigma.shape[<span class="dv">1</span>]):</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute efficient portfolio weights."""</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> sigma.shape[<span class="dv">1</span>]</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    iota <span class="op">=</span> np.ones(n)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    sigma_processed <span class="op">=</span> sigma<span class="op">+</span>(beta<span class="op">/</span>gamma)<span class="op">*</span>np.eye(n)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    mu_processed <span class="op">=</span> mu<span class="op">+</span>beta<span class="op">*</span>w_prev</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    sigma_inverse <span class="op">=</span> np.linalg.inv(sigma_processed)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    w_mvp <span class="op">=</span> sigma_inverse <span class="op">@</span> iota</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    w_mvp <span class="op">=</span> w_mvp<span class="op">/</span>np.<span class="bu">sum</span>(w_mvp)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    w_opt <span class="op">=</span> w_mvp<span class="op">+</span>(<span class="dv">1</span><span class="op">/</span>gamma)<span class="op">*\</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>        (sigma_inverse<span class="op">-</span>np.outer(w_mvp, iota) <span class="op">@</span> sigma_inverse) <span class="op">@</span> mu_processed</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> w_opt</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>w_efficient <span class="op">=</span> compute_efficient_weight(sigma, mu)</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>weights_efficient <span class="op">=</span> pd.DataFrame({</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Industry"</span>: industry_returns.columns.tolist(),</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Efficient portfolio"</span>: w_efficient</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>weights_efficient.<span class="bu">round</span>(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Industry</th>
<th data-quarto-table-cell-role="th">Efficient portfolio</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>nodur</td>
<td>1.469</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>durbl</td>
<td>0.205</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>manuf</td>
<td>-1.482</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>enrgy</td>
<td>0.663</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>hitec</td>
<td>0.400</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>telcm</td>
<td>-0.423</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>shops</td>
<td>0.607</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>hlth</td>
<td>0.389</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>utils</td>
<td>-0.216</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>other</td>
<td>-0.613</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>The portfolio weights above indicate the efficient portfolio for an investor with risk aversion coefficient <span class="math inline">\(\gamma=2\)</span> in the absence of transaction costs. Some of the positions are negative, which implies short-selling, and most of the positions are rather extreme. For instance, a position of <span class="math inline">\(-1\)</span> implies that the investor takes a short position worth their entire wealth to lever long positions in other assets. What is the effect of transaction costs or different levels of risk aversion on the optimal portfolio choice? The following few lines of code analyze the distance between the minimum variance portfolio and the portfolio implemented by the investor for different values of the transaction cost parameter <span class="math inline">\(\beta\)</span> and risk aversion <span class="math inline">\(\gamma\)</span>.</p>
<div id="ae0c970b" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>gammas <span class="op">=</span> [<span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">8</span>, <span class="dv">20</span>]</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>betas <span class="op">=</span> <span class="dv">20</span><span class="op">*</span>expon.ppf(np.arange(<span class="dv">1</span>, <span class="dv">100</span>)<span class="op">/</span><span class="dv">100</span>, scale<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>transaction_costs <span class="op">=</span> (pd.DataFrame(</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">list</span>(product(gammas, betas)), </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>[<span class="st">"gamma"</span>, <span class="st">"beta"</span>]</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  .assign(</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    weights<span class="op">=</span><span class="kw">lambda</span> x: x.<span class="bu">apply</span>(<span class="kw">lambda</span> y:</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>      compute_efficient_weight(</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>        sigma, mu, gamma<span class="op">=</span>y[<span class="st">"gamma"</span>], beta<span class="op">=</span>y[<span class="st">"beta"</span>]<span class="op">/</span><span class="dv">10000</span>, w_prev<span class="op">=</span>w_mvp), </span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>      axis<span class="op">=</span><span class="dv">1</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    concentration<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"weights"</span>].<span class="bu">apply</span>(</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>      <span class="kw">lambda</span> x: np.<span class="bu">sum</span>(np.<span class="bu">abs</span>(x<span class="op">-</span>w_mvp))</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The code chunk above computes the optimal weight in the presence of transaction cost for different values of <span class="math inline">\(\beta\)</span> and <span class="math inline">\(\gamma\)</span> but with the same initial allocation, the theoretical optimal minimum variance portfolio. Starting from the initial allocation, the investor chooses their optimal allocation along the efficient frontier to reflect their own risk preferences. If transaction costs were absent, the investor would simply implement the mean-variance efficient allocation. If transaction costs make it costly to rebalance, their optimal portfolio choice reflects a shift toward the efficient portfolio, whereas their current portfolio anchors their investment.</p>
<div id="cell-fig-1701" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>rebalancing_plot <span class="op">=</span> (</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    ggplot(transaction_costs, </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>           aes(x<span class="op">=</span><span class="st">"beta"</span>, y<span class="op">=</span><span class="st">"concentration"</span>,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>               color<span class="op">=</span><span class="st">"factor(gamma)"</span>, linetype<span class="op">=</span><span class="st">"factor(gamma)"</span>)) <span class="op">+</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    geom_line() <span class="op">+</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    guides(linetype<span class="op">=</span><span class="va">None</span>) <span class="op">+</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    labs(x<span class="op">=</span><span class="st">"Transaction cost parameter"</span>, y<span class="op">=</span><span class="st">"Distance from MVP"</span>,</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>         color<span class="op">=</span><span class="st">"Risk aversion"</span>,</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>         title<span class="op">=</span>(<span class="st">"Portfolio weights for different risk aversion and "</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>                <span class="st">"transaction cost"</span>))</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>rebalancing_plot.draw()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<div id="fig-1701" class="quarto-float quarto-figure quarto-figure-center anchored" alt="Title: Portfolio weights for different risk aversion and transaction cost. The figure shows four lines that indicate that rebalancing from the initial portfolio decreases for higher transaction costs and for higher risk aversion." data-fig-pos="htb">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-1701-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="constrained-optimization-and-backtesting_files/figure-html/fig-1701-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="Figure&nbsp;1: The figure shows portfolio weights for different risk aversion and transaction cost. The horizontal axis indicates the distance from the empirical minimum variance portfolio weight, measured by the sum of the absolute deviations of the chosen portfolio from the benchmark."><img src="constrained-optimization-and-backtesting_files/figure-html/fig-1701-output-1.png" data-fig-pos="htb" alt="Title: Portfolio weights for different risk aversion and transaction cost. The figure shows four lines that indicate that rebalancing from the initial portfolio decreases for higher transaction costs and for higher risk aversion." width="640" height="400" class="figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-1701-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: The figure shows portfolio weights for different risk aversion and transaction cost. The horizontal axis indicates the distance from the empirical minimum variance portfolio weight, measured by the sum of the absolute deviations of the chosen portfolio from the benchmark.
</figcaption>
</figure>
</div>
</div>
</div>
<p><a href="#fig-1701" class="quarto-xref">Figure&nbsp;1</a> shows rebalancing from the initial portfolio (which we always set to the minimum variance portfolio weights in this example). The higher the transaction costs parameter <span class="math inline">\(\beta\)</span>, the smaller is the rebalancing from the initial portfolio. In addition, if risk aversion <span class="math inline">\(\gamma\)</span> increases, the efficient portfolio is closer to the minimum variance portfolio weights such that the investor desires less rebalancing from the initial holdings.</p>
</section>
<section id="constrained-optimization" class="level2">
<h2 class="anchored" data-anchor-id="constrained-optimization">Constrained Optimization</h2>
<p>Next, we introduce constraints to the above optimization procedure. Very often, typical constraints such as short-selling restrictions prevent analytical solutions for optimal portfolio weights (short-selling restrictions simply imply that negative weights are not allowed such that we require that <span class="math inline">\(w_i \geq 0\,\forall i\)</span>). However, numerical optimization allows computing the solutions to such constrained problems.</p>
<p>We rely on the powerful <code>scipy.optimize</code> package, which provides a common interface to a number of different optimization routines. In particular, we employ the Sequential Least-Squares Quadratic Programming (SLSQP) algorithm of <span class="citation" data-cites="Kraft1994">Kraft (<a href="#ref-Kraft1994" role="doc-biblioref">1994</a>)</span> because it is able to handle multiple equality and inequality constraints at the same time and is typically used for problems where the objective function and the constraints are twice continuously differentiable. We have to provide the algorithm with the objective function and its gradient, as well as the constraints and their Jacobian.</p>
<p>We illustrate the use of <code>minimize()</code> by replicating the analytical solutions for the minimum variance and efficient portfolio weights from above. Note that the equality constraint for both solutions is given by the requirement that the weights must sum up to one. In addition, we supply a vector of equal weights as an initial value for the algorithm in all applications. We verify that the output is equal to the above solution. Note that <code>np.allclose()</code> is a safe way to compare two vectors for pairwise equality. The alternative <code>==</code> is sensitive to small differences that may occur due to the representation of floating points on a computer, while <code>np.allclose()</code> has a built-in tolerance. It returns <code>True</code> if both are equal, which is the case in both applications below.</p>
<div id="976a7da9" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>w_initial <span class="op">=</span> np.ones(n_industries)<span class="op">/</span>n_industries</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> objective_mvp(w):</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fl">0.5</span><span class="op">*</span>w.T <span class="op">@</span> sigma <span class="op">@</span> w</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> gradient_mvp(w):</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> sigma <span class="op">@</span> w</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> equality_constraint(w):</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.<span class="bu">sum</span>(w)<span class="op">-</span><span class="dv">1</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> jacobian_equality(w):</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.ones_like(w)</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>constraints <span class="op">=</span> (</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>  {<span class="st">"type"</span>: <span class="st">"eq"</span>, <span class="st">"fun"</span>: equality_constraint, <span class="st">"jac"</span>: jacobian_equality}</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>options <span class="op">=</span> {</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>  <span class="st">"tol"</span>:<span class="fl">1e-20</span>,</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>  <span class="st">"maxiter"</span>: <span class="dv">10000</span>,</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>  <span class="st">"method"</span>:<span class="st">"SLSQP"</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>w_mvp_numerical <span class="op">=</span> minimize(</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>  x0<span class="op">=</span>w_initial,</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>  fun<span class="op">=</span>objective_mvp,</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>  jac<span class="op">=</span>gradient_mvp,</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>  constraints<span class="op">=</span>constraints,</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>  tol<span class="op">=</span>options[<span class="st">"tol"</span>],</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>  options<span class="op">=</span>{<span class="st">"maxiter"</span>: options[<span class="st">"maxiter"</span>]},</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>  method<span class="op">=</span>options[<span class="st">"method"</span>]</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>np.allclose(w_mvp, w_mvp_numerical.x, atol<span class="op">=</span><span class="fl">1e-3</span>)</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> objective_efficient(w):</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">2</span><span class="op">*</span><span class="fl">0.5</span><span class="op">*</span>w.T <span class="op">@</span> sigma <span class="op">@</span> w<span class="op">-</span>(<span class="dv">1</span><span class="op">+</span>mu) <span class="op">@</span> w</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> gradient_efficient(w):</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">2</span><span class="op">*</span>sigma <span class="op">@</span> w<span class="op">-</span>(<span class="dv">1</span><span class="op">+</span>mu)</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>w_efficient_numerical <span class="op">=</span> minimize(</span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>  x0<span class="op">=</span>w_initial,</span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>  fun<span class="op">=</span>objective_efficient,</span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>  jac<span class="op">=</span>gradient_efficient,</span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>  constraints<span class="op">=</span>constraints,</span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>  tol<span class="op">=</span>options[<span class="st">"tol"</span>],</span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>  options<span class="op">=</span>{<span class="st">"maxiter"</span>: options[<span class="st">"maxiter"</span>]},</span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>  method<span class="op">=</span>options[<span class="st">"method"</span>]</span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>np.allclose(w_efficient, w_efficient_numerical.x, atol <span class="op">=</span> <span class="fl">1e-3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The result above shows that the numerical procedure indeed recovered the optimal weights for a scenario where we already know the analytic solution.</p>
<p>Next, we approach problems where no analytical solutions exist. First, we additionally impose short-sale constraints, which implies <span class="math inline">\(N\)</span> inequality constraints of the form <span class="math inline">\(\omega_i &gt;=0\)</span>. We can implement the short-sale constraints by imposing a vector of lower bounds <code>lb = rep(0, n_industries)</code>.</p>
<div id="6ecd1066" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>w_no_short_sale <span class="op">=</span> minimize(</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  x0<span class="op">=</span>w_initial,</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  fun<span class="op">=</span>objective_efficient,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  jac<span class="op">=</span>gradient_efficient,</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  constraints<span class="op">=</span>constraints,</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  bounds<span class="op">=</span>((<span class="dv">0</span>, <span class="va">None</span>), )<span class="op">*</span>n_industries,</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  tol<span class="op">=</span>options[<span class="st">"tol"</span>],</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  options<span class="op">=</span>{<span class="st">"maxiter"</span>: options[<span class="st">"maxiter"</span>]},</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  method<span class="op">=</span>options[<span class="st">"method"</span>]</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>weights_no_short_sale <span class="op">=</span> pd.DataFrame({</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Industry"</span>: industry_returns.columns.tolist(),</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">"No short-sale"</span>: w_no_short_sale.x</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>weights_no_short_sale.<span class="bu">round</span>(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Industry</th>
<th data-quarto-table-cell-role="th">No short-sale</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>nodur</td>
<td>0.462</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>durbl</td>
<td>0.000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>manuf</td>
<td>0.000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>enrgy</td>
<td>0.205</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>hitec</td>
<td>0.000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>telcm</td>
<td>0.000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>shops</td>
<td>0.146</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>hlth</td>
<td>0.187</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>utils</td>
<td>0.000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>other</td>
<td>0.000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>As expected, the resulting portfolio weights are all positive (up to numerical precision). Typically, the holdings in the presence of short-sale constraints are concentrated among way fewer assets than in the unrestricted case. You can verify that <code>np.sum(w_no_short_sale.x)</code> returns 1. In other words, <code>minimize()</code> provides the numerical solution to a portfolio choice problem for a mean-variance investor with risk aversion <code>gamma = 2</code>, where negative holdings are forbidden.</p>
<p><code>minimize()</code> can also handle more complex problems. As an example, we show how to compute optimal weights, subject to the so-called <a href="https://en.wikipedia.org/wiki/Regulation_T">Regulation-T constraint,</a> which requires that the sum of all absolute portfolio weights is smaller than 1.5, that is <span class="math inline">\(\sum_{i=1}^N |\omega_i| \leq 1.5\)</span>. The constraint enforces that a maximum of 50 percent of the allocated wealth can be allocated to short positions, thus implying an initial margin requirement of 50 percent. Imposing such a margin requirement reduces portfolio risks because extreme portfolio weights are not attainable anymore. The implementation of Regulation-T rules is numerically interesting because the margin constraints imply a non-linear constraint on the portfolio weights. </p>
<div id="2265dff3" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>reg_t <span class="op">=</span> <span class="fl">1.5</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> inequality_constraint(w):</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> reg_t<span class="op">-</span>np.<span class="bu">sum</span>(np.<span class="bu">abs</span>(w))</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> jacobian_inequality(w):</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span>np.sign(w)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> objective_reg_t(w):</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span>w <span class="op">@</span> (<span class="dv">1</span><span class="op">+</span>mu)<span class="op">+</span><span class="dv">2</span><span class="op">*</span><span class="fl">0.5</span><span class="op">*</span>w.T <span class="op">@</span> sigma <span class="op">@</span> w</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> gradient_reg_t(w):</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span>(<span class="dv">1</span><span class="op">+</span>mu)<span class="op">+</span><span class="dv">2</span><span class="op">*</span>np.dot(sigma, w)</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>constraints <span class="op">=</span> (</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>  {<span class="st">"type"</span>: <span class="st">"eq"</span>, <span class="st">"fun"</span>: equality_constraint, <span class="st">"jac"</span>: jacobian_equality},</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>  {<span class="st">"type"</span>: <span class="st">"ineq"</span>, <span class="st">"fun"</span>: inequality_constraint, <span class="st">"jac"</span>: jacobian_inequality}</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>w_reg_t <span class="op">=</span> minimize(</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>  x0<span class="op">=</span>w_initial,</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>  fun<span class="op">=</span>objective_reg_t,</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>  jac<span class="op">=</span>gradient_reg_t,</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>  constraints<span class="op">=</span>constraints,</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>  tol<span class="op">=</span>options[<span class="st">"tol"</span>],</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>  options<span class="op">=</span>{<span class="st">"maxiter"</span>: options[<span class="st">"maxiter"</span>]},</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>  method<span class="op">=</span>options[<span class="st">"method"</span>]</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>weights_reg_t <span class="op">=</span> pd.DataFrame({</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Industry"</span>: industry_returns.columns.tolist(),</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Regulation-T"</span>: w_reg_t.x</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>weights_reg_t.<span class="bu">round</span>(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Industry</th>
<th data-quarto-table-cell-role="th">Regulation-T</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>nodur</td>
<td>0.531</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>durbl</td>
<td>-0.000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>manuf</td>
<td>-0.180</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>enrgy</td>
<td>0.254</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>hitec</td>
<td>0.014</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>telcm</td>
<td>-0.031</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>shops</td>
<td>0.235</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>hlth</td>
<td>0.215</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>utils</td>
<td>0.000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>other</td>
<td>-0.038</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p><a href="#fig-1702" class="quarto-xref">Figure&nbsp;2</a> shows the optimal allocation weights across all <code>python len(industry_returns.columns)</code> industries for the four different strategies considered so far: minimum variance, efficient portfolio with <span class="math inline">\(\gamma\)</span> = 2, efficient portfolio with short-sale constraints, and the Regulation-T constrained portfolio.</p>
<div id="cell-fig-1702" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>weights <span class="op">=</span> (weights_mvp</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  .merge(weights_efficient)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  .merge(weights_no_short_sale)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  .merge(weights_reg_t)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  .melt(id_vars<span class="op">=</span><span class="st">"Industry"</span>, var_name<span class="op">=</span><span class="st">"Strategy"</span>, value_name<span class="op">=</span><span class="st">"weights"</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>weights_plot <span class="op">=</span> (</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  ggplot(weights,</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>         aes(x<span class="op">=</span><span class="st">"Industry"</span>, y<span class="op">=</span><span class="st">"weights"</span>, fill<span class="op">=</span><span class="st">"Strategy"</span>)) <span class="op">+</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  geom_bar(stat<span class="op">=</span><span class="st">"identity"</span>, position<span class="op">=</span><span class="st">"dodge"</span>, width<span class="op">=</span><span class="fl">0.7</span>) <span class="op">+</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>  coord_flip() <span class="op">+</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>  labs(y<span class="op">=</span><span class="st">"Allocation weight"</span>, fill<span class="op">=</span><span class="st">""</span>,</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>       title<span class="op">=</span><span class="st">"Optimal allocations for different strategies"</span>) <span class="op">+</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>  scale_y_continuous(labels<span class="op">=</span>percent_format())</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>weights_plot.draw()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<div id="fig-1702" class="quarto-float quarto-figure quarto-figure-center anchored" alt="Title: Optimal allocations for different strategies. The figure shows the portfolio weights for the four different strategies across the ten different industries. The figures indicate extreme long and short positions for the efficient portfolio." data-fig-pos="htb">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-1702-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="constrained-optimization-and-backtesting_files/figure-html/fig-1702-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2" title="Figure&nbsp;2: The figure shows optimal allocation weights for the ten industry portfolios and the four different allocation strategies."><img src="constrained-optimization-and-backtesting_files/figure-html/fig-1702-output-1.png" data-fig-pos="htb" alt="Title: Optimal allocations for different strategies. The figure shows the portfolio weights for the four different strategies across the ten different industries. The figures indicate extreme long and short positions for the efficient portfolio." width="640" height="400" class="figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-1702-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: The figure shows optimal allocation weights for the ten industry portfolios and the four different allocation strategies.
</figcaption>
</figure>
</div>
</div>
</div>
<p>The results clearly indicate the effect of imposing additional constraints: the extreme holdings the investor implements if they follow the (theoretically optimal) efficient portfolio vanish under, e.g., the Regulation-T constraint. You may wonder why an investor would deviate from what is theoretically the optimal portfolio by imposing potentially arbitrary constraints. The short answer is: the <em>efficient portfolio</em> is only efficient if the true parameters of the data-generating process correspond to the estimated parameters <span class="math inline">\(\hat\Sigma\)</span> and <span class="math inline">\(\hat\mu\)</span>. Estimation uncertainty may thus lead to inefficient allocations. By imposing restrictions, we implicitly shrink the set of possible weights and prevent extreme allocations, which could result from <em>error-maximization</em> due to estimation uncertainty <span class="citation" data-cites="Jagannathan2003">(<a href="#ref-Jagannathan2003" role="doc-biblioref">Jagannathan and Ma 2003</a>)</span>.</p>
<p>Before we move on, we want to propose a final allocation strategy, which reflects a somewhat more realistic structure of transaction costs instead of the quadratic specification used above. The function below computes efficient portfolio weights while adjusting for transaction costs of the form <span class="math inline">\(\beta\sum_{i=1}^N |(\omega_{i, t+1} - \omega_{i, t^+})|\)</span>. No closed-form solution exists, and we rely on non-linear optimization procedures.</p>
<div id="f71c542e" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_efficient_weight_L1_TC(mu, sigma, gamma, beta, initial_weights):</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute efficient portfolio weights with L1 constraint."""</span>       </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> objective(w):</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> (gamma<span class="op">*</span><span class="fl">0.5</span><span class="op">*</span>w.T <span class="op">@</span> sigma <span class="op">@</span> w<span class="op">-</span>(<span class="dv">1</span><span class="op">+</span>mu) <span class="op">@</span> w</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>               <span class="op">+</span>(beta<span class="op">/</span><span class="dv">10000</span>)<span class="op">/</span><span class="dv">2</span><span class="op">*</span>np.<span class="bu">sum</span>(np.<span class="bu">abs</span>(w<span class="op">-</span>initial_weights)))</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> gradient(w):</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> (<span class="op">-</span>mu<span class="op">+</span>gamma<span class="op">*</span>sigma <span class="op">@</span> w </span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>              <span class="op">+</span>(beta<span class="op">/</span><span class="dv">10000</span>)<span class="op">*</span><span class="fl">0.5</span><span class="op">*</span>np.sign(w<span class="op">-</span>initial_weights))</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    constraints <span class="op">=</span> (</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>      {<span class="st">"type"</span>: <span class="st">"eq"</span>, <span class="st">"fun"</span>: equality_constraint, <span class="st">"jac"</span>: jacobian_equality}</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> minimize(</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>        x0<span class="op">=</span>initial_weights,</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>        fun<span class="op">=</span>objective,</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>        jac<span class="op">=</span>gradient,</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>        constraints<span class="op">=</span>constraints,</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>        tol<span class="op">=</span>options[<span class="st">"tol"</span>],</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>        options<span class="op">=</span>{<span class="st">"maxiter"</span>: options[<span class="st">"maxiter"</span>]},</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>        method<span class="op">=</span>options[<span class="st">"method"</span>]</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result.x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="out-of-sample-backtesting" class="level2">
<h2 class="anchored" data-anchor-id="out-of-sample-backtesting">Out-of-Sample Backtesting</h2>
<p>For the sake of simplicity, we committed one fundamental error in computing portfolio weights above: we used the full sample of the data to determine the optimal allocation <span class="citation" data-cites="Harvey2019">(<a href="#ref-Harvey2019" role="doc-biblioref">Arnott, Harvey, and Markowitz 2019</a>)</span>. To implement this strategy at the beginning of the 2000s, you will need to know how the returns will evolve until 2021. While interesting from a methodological point of view, we cannot evaluate the performance of the portfolios in a reasonable out-of-sample fashion. We do so next in a backtesting application for three strategies. For the backtest, we recompute optimal weights just based on past available data.</p>
<p>The few lines below define the general setup. We consider 120 periods from the past to update the parameter estimates before recomputing portfolio weights. Then, we update portfolio weights, which is costly and affects the performance. The portfolio weights determine the portfolio return. A period later, the current portfolio weights have changed and form the foundation for transaction costs incurred in the next period. We consider three different competing strategies: the mean-variance efficient portfolio, the mean-variance efficient portfolio with ex-ante adjustment for transaction costs, and the naive portfolio, which allocates wealth equally across the different assets.</p>
<div id="40786cac" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>window_length <span class="op">=</span> <span class="dv">120</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>periods <span class="op">=</span> industry_returns.shape[<span class="dv">0</span>]<span class="op">-</span>window_length</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>beta <span class="op">=</span> <span class="dv">50</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>gamma <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>performance_values <span class="op">=</span> np.empty((periods, <span class="dv">3</span>))</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>performance_values[:] <span class="op">=</span> np.nan</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>performance_values <span class="op">=</span> {</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"MV (TC)"</span>: performance_values.copy(), </span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Naive"</span>: performance_values.copy(), </span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">"MV"</span>: performance_values.copy()</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>n_industries <span class="op">=</span> industry_returns.shape[<span class="dv">1</span>]</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>w_prev_1 <span class="op">=</span> w_prev_2 <span class="op">=</span> w_prev_3 <span class="op">=</span> np.ones(n_industries)<span class="op">/</span>n_industries</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We also define two helper functions: One to adjust the weights due to returns and one for performance evaluation, where we compute realized returns net of transaction costs.</p>
<div id="4d52cc67" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> adjust_weights(w, next_return):</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    w_prev <span class="op">=</span> <span class="dv">1</span><span class="op">+</span>w<span class="op">*</span>next_return</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.array(w_prev<span class="op">/</span>np.<span class="bu">sum</span>(np.array(w_prev)))</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> evaluate_performance(w, w_previous, next_return, beta<span class="op">=</span><span class="dv">50</span>):</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Calculate portfolio evaluation measures."""</span>  </span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    raw_return <span class="op">=</span> np.dot(next_return, w)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    turnover <span class="op">=</span> np.<span class="bu">sum</span>(np.<span class="bu">abs</span>(w<span class="op">-</span>w_previous))</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    net_return <span class="op">=</span> raw_return<span class="op">-</span>beta<span class="op">/</span><span class="dv">10000</span><span class="op">*</span>turnover</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.array([raw_return, turnover, net_return])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The following code chunk performs a rolling-window estimation, which we implement in a loop. In each period, the estimation window contains the returns available up to the current period. Note that we use the sample variance-covariance matrix and ignore the estimation of <span class="math inline">\(\hat\mu\)</span> entirely, but you might use more advanced estimators in practice.</p>
<div id="d17ccb4e" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> <span class="bu">range</span>(periods):</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    returns_window <span class="op">=</span> industry_returns.iloc[p:(p<span class="op">+</span>window_length<span class="op">-</span><span class="dv">1</span>), :]</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    next_return <span class="op">=</span> industry_returns.iloc[p<span class="op">+</span>window_length, :]</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    sigma_window <span class="op">=</span> np.array(returns_window.cov())</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    mu <span class="op">=</span> <span class="dv">0</span><span class="op">*</span>np.array(returns_window.mean())</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Transaction-cost adjusted portfolio</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    w_1 <span class="op">=</span> compute_efficient_weight_L1_TC(</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>      mu<span class="op">=</span>mu, sigma<span class="op">=</span>sigma_window, </span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>      beta<span class="op">=</span>beta, </span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>      gamma<span class="op">=</span>gamma, </span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>      initial_weights<span class="op">=</span>w_prev_1</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    performance_values[<span class="st">"MV (TC)"</span>][p, :] <span class="op">=</span> evaluate_performance(</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>      w_1, w_prev_1, next_return, beta<span class="op">=</span>beta</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    w_prev_1 <span class="op">=</span> adjust_weights(w_1, next_return)</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Naive portfolio</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>    w_2 <span class="op">=</span> np.ones(n_industries)<span class="op">/</span>n_industries</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>    performance_values[<span class="st">"Naive"</span>][p, :] <span class="op">=</span> evaluate_performance(</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>      w_2, w_prev_2, next_return</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>    w_prev_2 <span class="op">=</span> adjust_weights(w_2, next_return)</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Mean-variance efficient portfolio (w/o transaction costs)</span></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>    w_3 <span class="op">=</span> compute_efficient_weight(sigma<span class="op">=</span>sigma_window, mu<span class="op">=</span>mu, gamma<span class="op">=</span>gamma)</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>    performance_values[<span class="st">"MV"</span>][p, :] <span class="op">=</span> evaluate_performance(</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>      w_3, w_prev_3, next_return</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>    w_prev_3 <span class="op">=</span> adjust_weights(w_3, next_return)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, we get to the evaluation of the portfolio strategies <em>net-of-transaction costs</em>. Note that we compute annualized returns and standard deviations. </p>
<div id="613f25a1" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>performance <span class="op">=</span> pd.DataFrame()</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">enumerate</span>(performance_values.keys()):</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    tmp_data <span class="op">=</span> pd.DataFrame(</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>      performance_values[i[<span class="dv">1</span>]], </span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>      columns<span class="op">=</span>[<span class="st">"raw_return"</span>, <span class="st">"turnover"</span>, <span class="st">"net_return"</span>]</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    tmp_data[<span class="st">"strategy"</span>] <span class="op">=</span> i[<span class="dv">1</span>]</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    performance <span class="op">=</span> pd.concat([performance, tmp_data], axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>length_year <span class="op">=</span> <span class="dv">12</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>performance_table <span class="op">=</span> (performance</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>  .groupby(<span class="st">"strategy"</span>)</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>  .aggregate(</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    mean<span class="op">=</span>(<span class="st">"net_return"</span>, <span class="kw">lambda</span> x: length_year<span class="op">*</span><span class="dv">100</span><span class="op">*</span>x.mean()),</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    sd<span class="op">=</span>(<span class="st">"net_return"</span>, <span class="kw">lambda</span> x: np.sqrt(length_year)<span class="op">*</span><span class="dv">100</span><span class="op">*</span>x.std()),</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>    sharpe_ratio<span class="op">=</span>(<span class="st">"net_return"</span>, <span class="kw">lambda</span> x: (</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>      (length_year<span class="op">*</span><span class="dv">100</span><span class="op">*</span>x.mean())<span class="op">/</span>(np.sqrt(length_year)<span class="op">*</span><span class="dv">100</span><span class="op">*</span>x.std()) </span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> x.mean() <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> np.nan)</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>    turnover<span class="op">=</span>(<span class="st">"turnover"</span>, <span class="kw">lambda</span> x: <span class="dv">100</span><span class="op">*</span>x.mean())</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>  .reset_index()</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>performance_table.<span class="bu">round</span>(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">strategy</th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">sd</th>
<th data-quarto-table-cell-role="th">sharpe_ratio</th>
<th data-quarto-table-cell-role="th">turnover</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>MV</td>
<td>-1.104</td>
<td>12.588</td>
<td>NaN</td>
<td>210.654</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>MV (TC)</td>
<td>11.973</td>
<td>15.186</td>
<td>0.788</td>
<td>0.002</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Naive</td>
<td>11.953</td>
<td>15.188</td>
<td>0.787</td>
<td>0.236</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>The results clearly speak against mean-variance optimization. Turnover is huge when the investor only considers their portfolio’s expected return and variance. Effectively, the mean-variance portfolio generates a <em>negative</em> annualized return after adjusting for transaction costs. At the same time, the naive portfolio turns out to perform very well. In fact, the performance gains of the transaction-cost adjusted mean-variance portfolio are small. The out-of-sample Sharpe ratio is slightly higher than for the naive portfolio. Note the extreme effect of turnover penalization on turnover: <em>MV (TC)</em> effectively resembles a buy-and-hold strategy which only updates the portfolio once the estimated parameters <span class="math inline">\(\hat\mu_t\)</span> and <span class="math inline">\(\hat\Sigma_t\)</span> indicate that the current allocation is too far away from the optimal theoretical portfolio.</p>
</section>
<section id="exercises" class="level2">
<h2 class="anchored" data-anchor-id="exercises">Exercises</h2>
<ol type="1">
<li>Consider the portfolio choice problem for transaction-cost adjusted certainty equivalent maximization with risk aversion parameter <span class="math inline">\(\gamma\)</span> <span id="eq-individual-tc-problem"><span class="math display">\[\omega_{t+1} ^* = \arg\max_{\omega \in \mathbb{R}^N, \iota'\omega = 1} \omega'\mu - \nu_t (\omega, \beta) - \frac{\gamma}{2}\omega'\Sigma\omega \tag{10}\]</span></span> where <span class="math inline">\(\Sigma\)</span> and <span class="math inline">\(\mu\)</span> are (estimators of) the variance-covariance matrix of the returns and the vector of expected returns. Assume for now that transaction costs are quadratic in rebalancing <em>and</em> proportional to stock illiquidity such that <span id="eq-amihud-definition"><span class="math display">\[\nu_t\left(\omega, B\right) = \frac{\beta}{2} \left(\omega - \omega_{t^+}\right)'B\left(\omega - \omega_{t^+}\right) \tag{11}\]</span></span> where <span class="math inline">\(B = \text{diag}(ill_1, \ldots, ill_N)\)</span> is a diagonal matrix, where <span class="math inline">\(ill_1, \ldots, ill_N\)</span>. Derive a closed-form solution for the mean-variance efficient portfolio <span class="math inline">\(\omega_{t+1} ^*\)</span> based on the transaction cost specification above. Discuss the effect of illiquidity <span class="math inline">\(ill_i\)</span> on the individual portfolio weights relative to an investor that myopically ignores transaction costs in their decision.</li>
<li>Use the solution from the previous exercise to update the function <code>compute_efficient_weight()</code> such that you can compute optimal weights conditional on a matrix <span class="math inline">\(B\)</span> with illiquidity measures.</li>
<li>Illustrate the evolution of the <em>optimal</em> weights from the naive portfolio to the efficient portfolio in the mean-standard deviation diagram.</li>
<li>Is it always optimal to choose the same <span class="math inline">\(\beta\)</span> in the optimization problem than the value used in evaluating the portfolio performance? In other words, can it be optimal to choose theoretically sub-optimal portfolios based on transaction cost considerations that do not reflect the actual incurred costs? Evaluate the out-of-sample Sharpe ratio after transaction costs for a range of different values of imposed <span class="math inline">\(\beta\)</span> values.</li>
</ol>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-Harvey2019" class="csl-entry" role="listitem">
Arnott, Rob, Campbell R. Harvey, and Harry Markowitz. 2019. <span>“<span class="nocase">A backtesting protocol in the era of machine learning</span>.”</span> <em><span>The Journal of Financial Data Science</span></em> 1 (1): 64–74. <a href="https://doi.org/10.3905/jfds.2019.1.064">https://doi.org/10.3905/jfds.2019.1.064</a>.
</div>
<div id="ref-Balduzzi1999" class="csl-entry" role="listitem">
Balduzzi, Pierluigi, and Anthony W Lynch. 1999. <span>“<span class="nocase">Transaction costs and predictability: Some utility cost calculations</span>.”</span> <em><span>Journal of Financial Economics</span></em> 52 (1): 47–78. <a href="https://doi.org/10.1016/S0304-405X(99)00004-5">https://doi.org/10.1016/S0304-405X(99)00004-5</a>.
</div>
<div id="ref-Balduzzi2000" class="csl-entry" role="listitem">
———. 2000. <span>“<span class="nocase">Predictability and transaction costs: The impact on rebalancing rules and behavior</span>.”</span> <em><span>The Journal of Finance</span></em> 55 (5): 2285–2309. <a href="https://www.jstor.org/stable/222490">https://www.jstor.org/stable/222490</a>.
</div>
<div id="ref-Brown1976" class="csl-entry" role="listitem">
Brown, Stephen J. 1976. <span>“<span class="nocase">Optimal portfolio choice under uncertainty: A Bayesian approach</span>.”</span> PhD Thesis, University of Chicago.
</div>
<div id="ref-Chopra1993" class="csl-entry" role="listitem">
Chopra, Vijay Kumar, and William T. Ziemba. 1993. <span>“<span class="nocase">The effect of errors in means, variances, and covariances on optimal portfolio choice</span>.”</span> <em><span>Journal of Portfolio Management</span></em> 19 (2): 6–11. <a href="https://doi.org/10.3905/jpm.1993.409440">https://doi.org/10.3905/jpm.1993.409440</a>.
</div>
<div id="ref-Davis1990" class="csl-entry" role="listitem">
Davis, Mark H. A., and Andrew R. Norman. 1990. <span>“<span class="nocase">Portfolio selection with transaction costs</span>.”</span> <em><span>Mathematics of Operations Research</span></em> 15 (4): 676–713. <a href="https://doi.org/10.1287/moor.15.4.676">https://doi.org/10.1287/moor.15.4.676</a>.
</div>
<div id="ref-DeMiguel2015" class="csl-entry" role="listitem">
DeMiguel, Victor, Alberto Martín-Utrera, and Francisco J. Nogales. 2015. <span>“<span class="nocase">Parameter uncertainty in multiperiod portfolio optimization with transaction costs</span>.”</span> <em><span>Journal of Financial and Quantitative Analysis</span></em> 50 (6): 1443–71. <a href="https://doi.org/10.1017/S002210901500054X">https://doi.org/10.1017/S002210901500054X</a>.
</div>
<div id="ref-DeMiguel2014" class="csl-entry" role="listitem">
DeMiguel, Victor, Francisco J. Nogales, and Raman Uppal. 2014. <span>“<span class="nocase">Stock return serial dependence and out-of-sample portfolio performance</span>.”</span> <em><span>Review of Financial Studies</span></em> 27 (4): 1031–73. <a href="https://doi.org/10.1093/rfs/hhu002">https://doi.org/10.1093/rfs/hhu002</a>.
</div>
<div id="ref-Fan2008" class="csl-entry" role="listitem">
Fan, Jianqing, Yingying Fan, and Jinchi Lv. 2008. <span>“<span class="nocase">High dimensional covariance matrix estimation using a factor model</span>.”</span> <em><span>Journal of Econometrics</span></em> 147 (1): 186–97. <a href="https://doi.org/10.1016/j.jeconom.2008.09.017">https://doi.org/10.1016/j.jeconom.2008.09.017</a>.
</div>
<div id="ref-Garlappi2007" class="csl-entry" role="listitem">
Garlappi, Lorenzo, Raman Uppal, and Tan Wang. 2007. <span>“<span class="nocase">Portfolio selection with parameter and model uncertainty: A multi-prior approach</span>.”</span> <em><span>Review of Financial Studies</span></em> 20 (1): 41–81. <a href="https://doi.org/10.1093/rfs/hhl003">https://doi.org/10.1093/rfs/hhl003</a>.
</div>
<div id="ref-Garleanu2013" class="csl-entry" role="listitem">
Gârleanu, Nicolae, and Lasse Heje Pedersen. 2013. <span>“<span class="nocase">Dynamic trading with predictable returns and transaction costs</span>.”</span> <em><span>The Journal of Finance</span></em> 68 (6): 2309–40. <a href="https://doi.org/10.1111/jofi.12080">https://doi.org/10.1111/jofi.12080</a>.
</div>
<div id="ref-Hautsch2015" class="csl-entry" role="listitem">
Hautsch, Nikolaus, Lada M. Kyj, and Peter Malec. 2015. <span>“<span class="nocase">Do high-frequency data improve high-dimensional portfolio allocations?</span>”</span> <em><span>Journal of Applied Econometrics</span></em> 30 (2): 263–90. <a href="https://doi.org/10.1002/jae.2361">https://doi.org/10.1002/jae.2361</a>.
</div>
<div id="ref-Hautsch2019" class="csl-entry" role="listitem">
Hautsch, Nikolaus, and Stefan Voigt. 2019. <span>“<span class="nocase">Large-scale portfolio allocation under transaction costs and model uncertainty</span>.”</span> <em><span>Journal of Econometrics</span></em> 212 (1): 221–40. <a href="https://doi.org/10.1016/j.jeconom.2019.04.028">https://doi.org/10.1016/j.jeconom.2019.04.028</a>.
</div>
<div id="ref-Jagannathan2003" class="csl-entry" role="listitem">
Jagannathan, Ravi, and Tongshu Ma. 2003. <span>“<span class="nocase">Risk reduction in large portfolios: Why imposing the wrong constraints helps</span>.”</span> <em><span>The Journal of Finance</span></em> 58 (4): 1651–84. <a href="https://doi.org/10.1111/1540-6261.00580">https://doi.org/10.1111/1540-6261.00580</a>.
</div>
<div id="ref-Jobson1980" class="csl-entry" role="listitem">
Jobson, David J., and Bob Korkie. 1980. <span>“<span class="nocase">Estimation for Markowitz efficient portfolios</span>.”</span> <em><span>Journal of the American Statistical Association</span></em> 75 (371): 544–54. <a href="https://doi.org/10.1080/01621459.1980.10477507">https://doi.org/10.1080/01621459.1980.10477507</a>.
</div>
<div id="ref-Jorion1986" class="csl-entry" role="listitem">
Jorion, Philippe. 1986. <span>“<span class="nocase">Bayes-Stein estimation for portfolio analysis</span>.”</span> <em><span>Journal of Financial and Quantitative Analysis</span></em> 21 (03): 279–92. <a href="https://doi.org/10.2307/2331042">https://doi.org/10.2307/2331042</a>.
</div>
<div id="ref-Kan2007" class="csl-entry" role="listitem">
Kan, Raymond, and Guofu Zhou. 2007. <span>“<span class="nocase">Optimal portfolio choice with parameter uncertainty</span>.”</span> <em><span>Journal of Financial and Quantitative Analysis</span></em> 42 (3): 621–56. <a href="https://doi.org/10.1017/s0022109000004129">https://doi.org/10.1017/s0022109000004129</a>.
</div>
<div id="ref-Kraft1994" class="csl-entry" role="listitem">
Kraft, Dieter. 1994. <span>“<span class="nocase">Algorithm 733: TOMP–Fortran Modules for Optimal Control Calculations</span>.”</span> <em>ACM Trans. Math. Softw.</em> 20 (3): 262–81. <a href="https://doi.org/10.1145/192115.192124">https://doi.org/10.1145/192115.192124</a>.
</div>
<div id="ref-Ledoit2003" class="csl-entry" role="listitem">
Ledoit, Olivier, and Michael Wolf. 2003. <span>“<span class="nocase">Improved estimation of the covariance matrix of stock returns with an application to portfolio selection</span>.”</span> <em><span>Journal of Empirical Finance</span></em> 10 (5): 603–21. <a href="https://doi.org/10.1016/S0927-5398(03)00007-0">https://doi.org/10.1016/S0927-5398(03)00007-0</a>.
</div>
<div id="ref-Ledoit2004" class="csl-entry" role="listitem">
———. 2004. <span>“<span class="nocase">Honey, I shrunk the sample covariance matrix</span>.”</span> <em><span>The Journal of Portfolio Management</span></em> 30 (4): 110–19. <a href="https://doi.org/10.3905/jpm.2004.110">https://doi.org/10.3905/jpm.2004.110</a>.
</div>
<div id="ref-Ledoit2012" class="csl-entry" role="listitem">
———. 2012. <span>“<span class="nocase">Nonlinear shrinkage estimation of large-dimensional covariance matrices</span>.”</span> <em><span>The Annals of Statistics</span></em> 40 (2): 1024–60. <a href="https://doi.org/10.1214/12-AOS989">https://doi.org/10.1214/12-AOS989</a>.
</div>
<div id="ref-Magill1976" class="csl-entry" role="listitem">
Magill, Michael J P, and George M. Constantinides. 1976. <span>“<span class="nocase">Portfolio selection with transactions costs</span>.”</span> <em><span>Journal of Economic Theory</span></em> 13 (2): 245–63. <a href="https://doi.org/10.1016/0022-0531(76)90018-1">https://doi.org/10.1016/0022-0531(76)90018-1</a>.
</div>
<div id="ref-Pflug2012" class="csl-entry" role="listitem">
Pflug, Georg, Alois Pichler, and David Wozabal. 2012. <span>“<span class="nocase">The 1/N investment strategy is optimal under high model ambiguity</span>.”</span> <em><span>Journal of Banking &amp; Finance</span></em> 36 (2): 410–17. <a href="https://doi.org/10.1016/j.jbankfin.2011.07.018">https://doi.org/10.1016/j.jbankfin.2011.07.018</a>.
</div>
<div id="ref-Wang2005" class="csl-entry" role="listitem">
Wang, Zhenyu. 2005. <span>“<span class="nocase">A shrinkage approach to model uncertainty and asset allocation</span>.”</span> <em><span>Review of Financial Studies</span></em> 18 (2): 673–705. <a href="https://www.jstor.org/stable/3598049">https://www.jstor.org/stable/3598049</a>.
</div>
</div></section></div></main> <!-- /main -->
<div class="custom-footer">
  <div class="copyright">© Christoph Frey, Christoph Scheuch, Stefan Voigt &amp; Patrick Weiss</div>
  <a href="disclaimer.html">Disclaimer</a>
  <a href="#" id="open_preferences_center">Cookie Preferences</a>
</div>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("^(?:http:|https:)\/\/www\.tidy-finance\.org");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
          // target, if specified
          link.setAttribute("target", "_blank");
          if (link.getAttribute("rel") === null) {
            link.setAttribute("rel", "noopener");
          }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../python/parametric-portfolio-policies.html" class="pagination-link" aria-label="Parametric Portfolio Policies">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Parametric Portfolio Policies</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../python/wrds-dummy-data.html" class="pagination-link" aria-label="WRDS Dummy Data">
        <span class="nav-page-text">WRDS Dummy Data</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">

<div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/tidy-finance/website/blob/main/python/constrained-optimization-and-backtesting.qmd" class="toc-action"><i class="bi bi-github"></i>View source</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>
<script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>




<script src="../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>