<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.538">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Evaluate portfolio allocation strategies based on Brandt, Santa-Clara, and Valkanov (2009) using the programming language Python.">

<title>Parametric Portfolio Policies with Python</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../python/constrained-optimization-and-backtesting.html" rel="next">
<link href="../python/option-pricing-via-machine-learning.html" rel="prev">
<link href="../assets/img/favicon.png" rel="icon" type="image/png">
<script src="../site_libs/cookie-consent/cookie-consent.js"></script>
<link href="../site_libs/cookie-consent/cookie-consent.css" rel="stylesheet">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-DH3KZSMJ5W"></script>

<script type="text/plain" cookie-consent="tracking">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-DH3KZSMJ5W', { 'anonymize_ip': true});
</script>

<script type="text/javascript" charset="UTF-8">
document.addEventListener('DOMContentLoaded', function () {
cookieconsent.run({
  "notice_banner_type":"interstitial",
  "consent_type":"express",
  "palette":"light",
  "language":"en",
  "page_load_consent_levels":["strictly-necessary"],
  "notice_banner_reject_button_hide":false,
  "preferences_center_close_button_hide":false,
  "website_name":""
  ,
"language":"en"
  });
});
</script> 
  
<style>html{ scroll-behavior: smooth; }</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../assets/css/global.css">
<meta property="og:title" content="Parametric Portfolio Policies with Python">
<meta property="og:description" content="An opinionated approach on empirical research in financial economics">
<meta property="og:image" content="https://www.tidy-finance.org/python/assets/img/cover.png">
<meta property="og:site_name" content="Tidy Finance">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../assets/img/logo-website-white.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Tidy Finance</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../r/index.html"> 
<span class="menu-text">R</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../python/index.html" aria-current="page"> 
<span class="menu-text">Python</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../blog.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../contribute.html"> 
<span class="menu-text">Contribute</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../support.html"> 
<span class="menu-text">Support</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.etsy.com/shop/tidyswag/?etsrc=sdt&amp;utm_source=tidy-finance.org"> 
<span class="menu-text">Swag</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="../blog.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <a class="flex-grow-1 no-decor" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
          <h1 class="quarto-secondary-nav-title">Parametric Portfolio Policies</h1>
        </a>     
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Tidy Finance with Python</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tidy Finance with Python</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Getting Started</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/setting-up-your-environment.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Setting Up Your Environment</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/introduction-to-tidy-finance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction to Tidy Finance</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Financial Data</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/accessing-and-managing-financial-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Accessing and Managing Financial Data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/wrds-crsp-and-compustat.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">WRDS, CRSP, and Compustat</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/trace-and-fisd.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">TRACE and FISD</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/other-data-providers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Other Data Providers</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">Asset Pricing</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/beta-estimation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Beta Estimation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/univariate-portfolio-sorts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Univariate Portfolio Sorts</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/size-sorts-and-p-hacking.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Size Sorts and p-Hacking</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/value-and-bivariate-sorts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Value and Bivariate Sorts</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/replicating-fama-and-french-factors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Replicating Fama-French Factors</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/fama-macbeth-regressions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Fama-MacBeth Regressions</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
 <span class="menu-text">Modeling and Machine Learning</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/fixed-effects-and-clustered-standard-errors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Fixed Effects and Clustered Standard Errors</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/difference-in-differences.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Difference in Differences</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/factor-selection-via-machine-learning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Factor Selection via Machine Learning</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/option-pricing-via-machine-learning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Option Pricing via Machine Learning</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">
 <span class="menu-text">Portfolio Optimization</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/parametric-portfolio-policies.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Parametric Portfolio Policies</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/constrained-optimization-and-backtesting.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Constrained Optimization and Backtesting</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true">
 <span class="menu-text">Appendix</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/wrds-dummy-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">WRDS Dummy Data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/cover-image.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Cover Image</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/clean-enhanced-trace-with-python.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Clean Enhanced TRACE with Python</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/proofs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Proofs</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../python/colophon.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Colophon</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#data-preparation" id="toc-data-preparation" class="nav-link active" data-scroll-target="#data-preparation">Data Preparation</a></li>
  <li><a href="#parametric-portfolio-policies" id="toc-parametric-portfolio-policies" class="nav-link" data-scroll-target="#parametric-portfolio-policies">Parametric Portfolio Policies</a></li>
  <li><a href="#computing-portfolio-weights" id="toc-computing-portfolio-weights" class="nav-link" data-scroll-target="#computing-portfolio-weights">Computing Portfolio Weights</a></li>
  <li><a href="#portfolio-performance" id="toc-portfolio-performance" class="nav-link" data-scroll-target="#portfolio-performance">Portfolio Performance</a></li>
  <li><a href="#optimal-parameter-choice" id="toc-optimal-parameter-choice" class="nav-link" data-scroll-target="#optimal-parameter-choice">Optimal Parameter Choice</a></li>
  <li><a href="#more-model-specifications" id="toc-more-model-specifications" class="nav-link" data-scroll-target="#more-model-specifications">More Model Specifications</a></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises">Exercises</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/tidy-finance/website/blob/main/python/parametric-portfolio-policies.qmd" class="toc-action"><i class="bi bi-github"></i>View source</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">Parametric Portfolio Policies</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>You are reading <strong>Tidy Finance with Python</strong>. You can find the equivalent chapter for the sibling <strong>Tidy Finance with R</strong> <a href="../r/parametric-portfolio-policies.html">here</a>.</p>
</div>
</div>
<p>In this chapter, we apply different portfolio performance measures to evaluate and compare portfolio allocation strategies. For this purpose, we introduce a direct way to estimate optimal portfolio weights for large-scale cross-sectional applications. More precisely, the approach of <span class="citation" data-cites="Brandt2009">Brandt, Santa-Clara, and Valkanov (<a href="#ref-Brandt2009" role="doc-biblioref">2009</a>)</span> proposes to parametrize the optimal portfolio weights as a function of stock characteristics instead of estimating the stock’s expected return, variance, and covariances with other stocks in a prior step. We choose weights as a function of characteristics that maximize the expected utility of the investor. This approach is feasible for large portfolio dimensions (such as the entire CRSP universe) and has been proposed by <span class="citation" data-cites="Brandt2009">Brandt, Santa-Clara, and Valkanov (<a href="#ref-Brandt2009" role="doc-biblioref">2009</a>)</span>. See the review paper <span class="citation" data-cites="Brandt2010">Brandt (<a href="#ref-Brandt2010" role="doc-biblioref">2010</a>)</span> for an excellent treatment of related portfolio choice methods.</p>
<p>The current chapter relies on the following set of Python packages:</p>
<div id="95b88fcd" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sqlite3</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.formula.api <span class="im">as</span> smf</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> itertools <span class="im">import</span> product, starmap</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.optimize <span class="im">import</span> minimize</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Compared to previous chapters, we introduce the <code>scipy.optimize</code> module from the <code>scipy</code> <span class="citation" data-cites="scipy">(<a href="#ref-scipy" role="doc-biblioref">Virtanen et al. 2020</a>)</span> for solving optimization problems.</p>
<section id="data-preparation" class="level2">
<h2 class="anchored" data-anchor-id="data-preparation">Data Preparation</h2>
<p>To get started, we load the monthly CRSP file, which forms our investment universe. We load the data from our SQLite database introduced in <a href="../python/accessing-and-managing-financial-data.html">Accessing and Managing Financial Data</a> and <a href="../python/wrds-crsp-and-compustat.html">WRDS, CRSP, and Compustat</a> .</p>
<div id="2f59a120" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>tidy_finance <span class="op">=</span> sqlite3.<span class="ex">connect</span>(database<span class="op">=</span><span class="st">"data/tidy_finance_python.sqlite"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>crsp_monthly <span class="op">=</span> (pd.read_sql_query(</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    sql<span class="op">=</span>(<span class="st">"SELECT permno, month, ret_excess, mktcap, mktcap_lag "</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>         <span class="st">"FROM crsp_monthly"</span>),</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    parse_dates<span class="op">=</span>{<span class="st">"month"</span>})</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  .dropna()</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To evaluate the performance of portfolios, we further use monthly market returns as a benchmark to compute CAPM alphas.</p>
<div id="1bcccf78" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>factors_ff_monthly <span class="op">=</span> pd.read_sql_query(</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  sql<span class="op">=</span><span class="st">"SELECT month, mkt_excess FROM factors_ff3_monthly"</span>,</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  con<span class="op">=</span>tidy_finance,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  parse_dates<span class="op">=</span>{<span class="st">"month"</span>}</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, we retrieve some stock characteristics that have been shown to have an effect on the expected returns or expected variances (or even higher moments) of the return distribution. In particular, we record the lagged one-year return momentum (<code>momentum_lag</code>), defined as the compounded return between months <span class="math inline">\(t-13\)</span> and <span class="math inline">\(t-2\)</span> for each firm. In finance, momentum is the empirically observed tendency for rising asset prices to rise further and falling prices to keep falling <span class="citation" data-cites="Jegadeesh1993">(<a href="#ref-Jegadeesh1993" role="doc-biblioref">Jegadeesh and Titman 1993</a>)</span>. The second characteristic is the firm’s market equity (<code>size_lag</code>), defined as the log of the price per share times the number of shares outstanding <span class="citation" data-cites="Banz1981">(<a href="#ref-Banz1981" role="doc-biblioref">Banz 1981</a>)</span>. To construct the correct lagged values, we use the approach introduced in <a href="../python/wrds-crsp-and-compustat.html">WRDS, CRSP, and Compustat</a>.</p>
<div id="d8a25300" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>crsp_monthly_lags <span class="op">=</span> (crsp_monthly</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  .assign(month<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"month"</span>]<span class="op">+</span>pd.DateOffset(months<span class="op">=</span><span class="dv">13</span>))</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  .get([<span class="st">"permno"</span>, <span class="st">"month"</span>, <span class="st">"mktcap"</span>])</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>crsp_monthly <span class="op">=</span> (crsp_monthly</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  .merge(crsp_monthly_lags, </span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>         how<span class="op">=</span><span class="st">"inner"</span>, on<span class="op">=</span>[<span class="st">"permno"</span>, <span class="st">"month"</span>], suffixes<span class="op">=</span>[<span class="st">""</span>, <span class="st">"_13"</span>])</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>data_portfolios <span class="op">=</span> (crsp_monthly</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  .assign(</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    momentum_lag<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"mktcap_lag"</span>]<span class="op">/</span>x[<span class="st">"mktcap_13"</span>],</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    size_lag<span class="op">=</span><span class="kw">lambda</span> x: np.log(x[<span class="st">"mktcap_lag"</span>])</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>  .dropna(subset<span class="op">=</span>[<span class="st">"momentum_lag"</span>, <span class="st">"size_lag"</span>])</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="parametric-portfolio-policies" class="level2">
<h2 class="anchored" data-anchor-id="parametric-portfolio-policies">Parametric Portfolio Policies</h2>
<p>The basic idea of parametric portfolio weights is as follows. Suppose that at each date <span class="math inline">\(t\)</span>, we have <span class="math inline">\(N_t\)</span> stocks in the investment universe, where each stock <span class="math inline">\(i\)</span> has a return of <span class="math inline">\(r_{i, t+1}\)</span> and is associated with a vector of firm characteristics <span class="math inline">\(x_{i, t}\)</span> such as time-series momentum or the market capitalization. The investor’s problem is to choose portfolio weights <span class="math inline">\(w_{i,t}\)</span> to maximize the expected utility of the portfolio return: <span id="eq-expected-utility"><span class="math display">\[\begin{aligned}
\max_{\omega} E_t\left(u(r_{p, t+1})\right) = E_t\left[u\left(\sum\limits_{i=1}^{N_t}\omega_{i,t}\cdot r_{i,t+1}\right)\right]
\end{aligned} \tag{1}\]</span></span> where <span class="math inline">\(u(\cdot)\)</span> denotes the utility function.</p>
<p>Where do the stock characteristics show up? We parameterize the optimal portfolio weights as a function of the stock characteristic <span class="math inline">\(x_{i,t}\)</span> with the following linear specification for the portfolio weights: <span id="eq-portfolio-policy"><span class="math display">\[\omega_{i,t} = \bar{\omega}_{i,t} + \frac{1}{N_t}\theta'\hat{x}_{i,t}, \tag{2}\]</span></span> where <span class="math inline">\(\bar{\omega}_{i,t}\)</span> is a stock’s weight in a benchmark portfolio (we use the value-weighted or naive portfolio in the application below), <span class="math inline">\(\theta\)</span> is a vector of coefficients which we are going to estimate, and <span class="math inline">\(\hat{x}_{i,t}\)</span> are the characteristics of stock <span class="math inline">\(i\)</span>, cross-sectionally standardized to have zero mean and unit standard deviation.</p>
<p>Intuitively, the portfolio strategy is a form of active portfolio management relative to a performance benchmark. Deviations from the benchmark portfolio are derived from the individual stock characteristics. Note that by construction, the weights sum up to one as <span class="math inline">\(\sum_{i=1}^{N_t}\hat{x}_{i,t} = 0\)</span> due to the standardization. Moreover, the coefficients are constant across assets and over time. The implicit assumption is that the characteristics fully capture all aspects of the joint distribution of returns that are relevant for forming optimal portfolios.</p>
<p>We first implement cross-sectional standardization for the entire CRSP universe. We also keep track of (lagged) relative market capitalization <code>relative_mktcap</code>, which will represent the value-weighted benchmark portfolio, while <code>n</code> denotes the number of traded assets <span class="math inline">\(N_t\)</span>, which we use to construct the naive portfolio benchmark.</p>
<div id="52d96b5f" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>data_portfolios <span class="op">=</span> (data_portfolios</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  .groupby(<span class="st">"month"</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  .<span class="bu">apply</span>(<span class="kw">lambda</span> x: x.assign(</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>      relative_mktcap<span class="op">=</span>x[<span class="st">"mktcap_lag"</span>]<span class="op">/</span>x[<span class="st">"mktcap_lag"</span>].<span class="bu">sum</span>()</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  .reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  .set_index(<span class="st">"month"</span>)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  .groupby(level<span class="op">=</span><span class="st">"month"</span>)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  .transform(</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: (x<span class="op">-</span>x.mean())<span class="op">/</span>x.std() <span class="cf">if</span> x.name.endswith(<span class="st">"lag"</span>) <span class="cf">else</span> x</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  .reset_index()</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  .drop([<span class="st">"mktcap_lag"</span>], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="computing-portfolio-weights" class="level2">
<h2 class="anchored" data-anchor-id="computing-portfolio-weights">Computing Portfolio Weights</h2>
<p>Next, we move on to identify optimal choices of <span class="math inline">\(\theta\)</span>. We rewrite the optimization problem together with the weight parametrization and can then estimate <span class="math inline">\(\theta\)</span> to maximize the objective function based on our sample <span id="eq-empirical-expected-utility"><span class="math display">\[\begin{aligned}
E_t\left(u(r_{p, t+1})\right) = \frac{1}{T}\sum\limits_{t=0}^{T-1}u\left(\sum\limits_{i=1}^{N_t}\left(\bar{\omega}_{i,t} + \frac{1}{N_t}\theta'\hat{x}_{i,t}\right)r_{i,t+1}\right).
\end{aligned} \tag{3}\]</span></span> The allocation strategy is straightforward because the number of parameters to estimate is small. Instead of a tedious specification of the <span class="math inline">\(N_t\)</span> dimensional vector of expected returns and the <span class="math inline">\(N_t(N_t+1)/2\)</span> free elements of the covariance matrix, all we need to focus on in our application is the vector <span class="math inline">\(\theta\)</span>. <span class="math inline">\(\theta\)</span> contains only two elements in our application - the relative deviation from the benchmark due to <em>size</em> and <em>momentum</em>.</p>
<p>To get a feeling for the performance of such an allocation strategy, we start with an arbitrary initial vector <span class="math inline">\(\theta_0\)</span>. The next step is to choose <span class="math inline">\(\theta\)</span> optimally to maximize the objective function. We automatically detect the number of parameters by counting the number of columns with lagged values. Note that the value for <span class="math inline">\(\theta\)</span> of 1.5 is an arbitrary choice.</p>
<div id="fc5d6d5b" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>lag_columns <span class="op">=</span> [i <span class="cf">for</span> i <span class="kw">in</span> data_portfolios.columns <span class="cf">if</span> <span class="st">"lag"</span> <span class="kw">in</span> i]</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>n_parameters <span class="op">=</span> <span class="bu">len</span>(lag_columns)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>theta <span class="op">=</span> pd.DataFrame({<span class="st">"theta"</span>: [<span class="fl">1.5</span>]<span class="op">*</span>n_parameters}, index<span class="op">=</span>lag_columns)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The function <code>compute_portfolio_weights()</code> below computes the portfolio weights <span class="math inline">\(\bar{\omega}_{i,t} + \frac{1}{N_t}\theta'\hat{x}_{i,t}\)</span> according to our parametrization for a given value <span class="math inline">\(\theta_0\)</span>. Everything happens within a single pipeline. Hence, we provide a short walk-through.</p>
<p>We first compute <code>characteristic_tilt</code>, the tilting values <span class="math inline">\(\frac{1}{N_t}\theta'\hat{x}_{i, t}\)</span> which resemble the deviation from the benchmark portfolio. Next, we compute the benchmark portfolio <code>weight_benchmark</code>, which can be any reasonable set of portfolio weights. In our case, we choose either the value or equal-weighted allocation. <code>weight_tilt</code> completes the picture and contains the final portfolio weights <code>weight_tilt = weight_benchmark + characteristic_tilt</code>, which deviate from the benchmark portfolio depending on the stock characteristics.</p>
<p>The final few lines go a bit further and implement a simple version of a no-short sale constraint. While it is generally not straightforward to ensure portfolio weight constraints via parameterization, we simply normalize the portfolio weights such that they are enforced to be positive. Finally, we make sure that the normalized weights sum up to one again: <span id="eq-short-sale-constraint"><span class="math display">\[\omega_{i,t}^+ = \frac{\max(0, \omega_{i,t})}{\sum_{j=1}^{N_t}\max(0, \omega_{i,t})}. \tag{4}\]</span></span></p>
<p>The following function computes the optimal portfolio weights in the way just described.</p>
<div id="780f3a06" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_portfolio_weights(theta, </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>                              data,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>                              value_weighting<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>                              allow_short_selling<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute portfolio weights for different strategies."""</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    lag_columns <span class="op">=</span> [i <span class="cf">for</span> i <span class="kw">in</span> data.columns <span class="cf">if</span> <span class="st">"lag"</span> <span class="kw">in</span> i]</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    theta <span class="op">=</span> pd.DataFrame(theta, index<span class="op">=</span>lag_columns)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> (data</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>      .groupby(<span class="st">"month"</span>)</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>      .<span class="bu">apply</span>(<span class="kw">lambda</span> x: x.assign(</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>          characteristic_tilt<span class="op">=</span>x[theta.index] <span class="op">@</span> theta <span class="op">/</span> x.shape[<span class="dv">0</span>]</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>      .reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>      .assign(</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>        weight_benchmark<span class="op">=</span><span class="kw">lambda</span> x: </span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>          x[<span class="st">"relative_mktcap"</span>] <span class="cf">if</span> value_weighting <span class="cf">else</span> <span class="dv">1</span><span class="op">/</span>x.shape[<span class="dv">0</span>],</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>        weight_tilt<span class="op">=</span><span class="kw">lambda</span> x: </span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>          x[<span class="st">"weight_benchmark"</span>] <span class="op">+</span> x[<span class="st">"characteristic_tilt"</span>]</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>      .drop(columns<span class="op">=</span>[<span class="st">"characteristic_tilt"</span>])</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> allow_short_selling:</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>        data <span class="op">=</span> (data</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>          .assign(weight_tilt<span class="op">=</span><span class="kw">lambda</span> x: np.maximum(<span class="dv">0</span>, x[<span class="st">"weight_tilt"</span>]))</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> (data</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>      .groupby(<span class="st">"month"</span>)</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>      .<span class="bu">apply</span>(<span class="kw">lambda</span> x: x.assign(</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>        weight_tilt<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"weight_tilt"</span>]<span class="op">/</span>x[<span class="st">"weight_tilt"</span>].<span class="bu">sum</span>()))</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>      .reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the next step, we compute the portfolio weights for the arbitrary vector <span class="math inline">\(\theta_0\)</span>. In the example below, we use the value-weighted portfolio as a benchmark and allow negative portfolio weights.</p>
<div id="f8c9ce4d" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>weights_crsp <span class="op">=</span> compute_portfolio_weights(</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  theta,</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  data_portfolios,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  value_weighting<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  allow_short_selling<span class="op">=</span><span class="va">True</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="portfolio-performance" class="level2">
<h2 class="anchored" data-anchor-id="portfolio-performance">Portfolio Performance</h2>
<p> Are the computed weights optimal in any way? Most likely not, as we picked <span class="math inline">\(\theta_0\)</span> arbitrarily. To evaluate the performance of an allocation strategy, one can think of many different approaches. In their original paper, <span class="citation" data-cites="Brandt2009">Brandt, Santa-Clara, and Valkanov (<a href="#ref-Brandt2009" role="doc-biblioref">2009</a>)</span> focus on a simple evaluation of the hypothetical utility of an agent equipped with a power utility function <span id="eq-power-utility"><span class="math display">\[u_\gamma(r) = \frac{(1 + r)^{(1-\gamma)}}{1-\gamma}, \tag{5}\]</span></span> where <span class="math inline">\(\gamma\)</span> is the risk aversion factor.</p>
<div id="e80e3469" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> power_utility(r, gamma<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Calculate power utility for given risk aversion."""</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    utility <span class="op">=</span> ((<span class="dv">1</span><span class="op">+</span>r)<span class="op">**</span>(<span class="dv">1</span><span class="op">-</span>gamma))<span class="op">/</span>(<span class="dv">1</span><span class="op">-</span>gamma)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> utility</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We want to note that <span class="citation" data-cites="Gehrig2020">Gehrig, Sögner, and Westerkamp (<a href="#ref-Gehrig2020" role="doc-biblioref">2020</a>)</span> warn that, in the leading case of constant relative risk aversion (CRRA), strong assumptions on the properties of the returns, the variables used to implement the parametric portfolio policy, and the parameter space are necessary to obtain a well-defined optimization problem.</p>
<p>No doubt, there are many other ways to evaluate a portfolio. The function below provides a summary of all kinds of interesting measures that can be considered relevant. Do we need all these evaluation measures? It depends: The original paper <span class="citation" data-cites="Brandt2009">Brandt, Santa-Clara, and Valkanov (<a href="#ref-Brandt2009" role="doc-biblioref">2009</a>)</span> only cares about the expected utility to choose <span class="math inline">\(\theta\)</span>. However, if you want to choose optimal values that achieve the highest performance while putting some constraints on your portfolio weights, it is helpful to have everything in one function.</p>
<div id="60a38f51" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> evaluate_portfolio(weights_data,</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>                       full_evaluation<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>                       capm_evaluation<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>                       length_year<span class="op">=</span><span class="dv">12</span>):</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Calculate portfolio evaluation measures."""</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    evaluation <span class="op">=</span> (weights_data</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">"month"</span>)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> x: pd.Series(</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>          np.average(x[[<span class="st">"ret_excess"</span>, <span class="st">"ret_excess"</span>]],</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>                     weights<span class="op">=</span>x[[<span class="st">"weight_tilt"</span>, <span class="st">"weight_benchmark"</span>]],</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>                     axis<span class="op">=</span><span class="dv">0</span>),</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>          [<span class="st">"return_tilt"</span>, <span class="st">"return_benchmark"</span>])</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>        .melt(id_vars<span class="op">=</span><span class="st">"month"</span>, var_name<span class="op">=</span><span class="st">"model"</span>,</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>              value_vars<span class="op">=</span>[<span class="st">"return_tilt"</span>, <span class="st">"return_benchmark"</span>],</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>              value_name<span class="op">=</span><span class="st">"portfolio_return"</span>)</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>        .assign(model<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"model"</span>].<span class="bu">str</span>.replace(<span class="st">"return_"</span>, <span class="st">""</span>))</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    evaluation_stats <span class="op">=</span> (evaluation</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">"model"</span>)[<span class="st">"portfolio_return"</span>]</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>        .aggregate([</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>          (<span class="st">"Expected utility"</span>, <span class="kw">lambda</span> x: np.mean(power_utility(x))),</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>          (<span class="st">"Average return"</span>, <span class="kw">lambda</span> x: np.mean(length_year<span class="op">*</span>x)<span class="op">*</span><span class="dv">100</span>),</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>          (<span class="st">"SD return"</span>, <span class="kw">lambda</span> x: np.std(x)<span class="op">*</span>np.sqrt(length_year)<span class="op">*</span><span class="dv">100</span>),</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>          (<span class="st">"Sharpe ratio"</span>, <span class="kw">lambda</span> x: (np.mean(x)<span class="op">/</span>np.std(x)<span class="op">*</span> </span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>                                        np.sqrt(length_year)))</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>        ])</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> capm_evaluation:</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>        evaluation_capm <span class="op">=</span> (evaluation</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>            .merge(factors_ff_monthly, how<span class="op">=</span><span class="st">"left"</span>, on<span class="op">=</span><span class="st">"month"</span>)</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>            .groupby(<span class="st">"model"</span>)</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>            .<span class="bu">apply</span>(<span class="kw">lambda</span> x: </span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>              smf.ols(formula<span class="op">=</span><span class="st">"portfolio_return ~ 1 + mkt_excess"</span>, data<span class="op">=</span>x)</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>              .fit().params</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>            .rename(columns<span class="op">=</span>{<span class="st">"const"</span>: <span class="st">"CAPM alpha"</span>,</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>                             <span class="st">"mkt_excess"</span>: <span class="st">"Market beta"</span>})</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>        evaluation_stats <span class="op">=</span> (evaluation_stats</span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>          .merge(evaluation_capm, how<span class="op">=</span><span class="st">"left"</span>, on<span class="op">=</span><span class="st">"model"</span>)</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> full_evaluation:</span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>        evaluation_weights <span class="op">=</span> (weights_data</span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>          .melt(id_vars<span class="op">=</span><span class="st">"month"</span>, var_name<span class="op">=</span><span class="st">"model"</span>,</span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>                value_vars<span class="op">=</span>[<span class="st">"weight_benchmark"</span>, <span class="st">"weight_tilt"</span>],</span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>                value_name<span class="op">=</span><span class="st">"weight"</span>)</span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>          .groupby([<span class="st">"model"</span>, <span class="st">"month"</span>])[<span class="st">"weight"</span>]</span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>          .aggregate([</span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>            (<span class="st">"Mean abs. weight"</span>, <span class="kw">lambda</span> x: np.mean(<span class="bu">abs</span>(x))),</span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>            (<span class="st">"Max. weight"</span>, <span class="kw">lambda</span> x: <span class="bu">max</span>(x)),</span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>            (<span class="st">"Min. weight"</span>, <span class="kw">lambda</span> x: <span class="bu">min</span>(x)),</span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>            (<span class="st">"Avg. sum of neg. weights"</span>, <span class="kw">lambda</span> x: <span class="op">-</span>np.<span class="bu">sum</span>(x[x <span class="op">&lt;</span> <span class="dv">0</span>])),</span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>            (<span class="st">"Avg. share of neg. weights"</span>, <span class="kw">lambda</span> x: np.mean(x <span class="op">&lt;</span> <span class="dv">0</span>))</span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a>          ])</span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a>          .reset_index()</span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a>          .drop(columns<span class="op">=</span>[<span class="st">"month"</span>])</span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a>          .groupby([<span class="st">"model"</span>])</span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a>          .aggregate(<span class="kw">lambda</span> x: np.average(x)<span class="op">*</span><span class="dv">100</span>)</span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a>          .reset_index()</span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a>          .assign(model<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"model"</span>].<span class="bu">str</span>.replace(<span class="st">"weight_"</span>, <span class="st">""</span>))</span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a>        evaluation_stats <span class="op">=</span> (evaluation_stats</span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a>          .merge(evaluation_weights, how<span class="op">=</span><span class="st">"left"</span>, on<span class="op">=</span><span class="st">"model"</span>)</span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a>          .set_index(<span class="st">"model"</span>)</span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true" tabindex="-1"></a>    evaluation_stats <span class="op">=</span> (evaluation_stats</span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true" tabindex="-1"></a>      .transpose()</span>
<span id="cb10-75"><a href="#cb10-75" aria-hidden="true" tabindex="-1"></a>      .rename_axis(columns<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb10-76"><a href="#cb10-76" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-77"><a href="#cb10-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-78"><a href="#cb10-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> evaluation_stats</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p> Let us take a look at the different portfolio strategies and evaluation measures.</p>
<div id="1f060007" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>evaluate_portfolio(weights_crsp).<span class="bu">round</span>(<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">benchmark</th>
<th data-quarto-table-cell-role="th">tilt</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">Expected utility</td>
<td>-0.25</td>
<td>-0.26</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Average return</td>
<td>6.65</td>
<td>0.19</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">SD return</td>
<td>15.46</td>
<td>21.11</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Sharpe ratio</td>
<td>0.43</td>
<td>0.01</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Intercept</td>
<td>0.00</td>
<td>-0.01</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Market beta</td>
<td>0.99</td>
<td>0.95</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Mean abs. weight</td>
<td>0.03</td>
<td>0.08</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Max. weight</td>
<td>4.05</td>
<td>4.22</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Min. weight</td>
<td>0.00</td>
<td>-0.17</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Avg. sum of neg. weights</td>
<td>0.00</td>
<td>78.03</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Avg. share of neg. weights</td>
<td>0.00</td>
<td>49.08</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>The value-weighted portfolio delivers an annualized return of more than six percent and clearly outperforms the tilted portfolio, irrespective of whether we evaluate expected utility, the Sharpe ratio, or the CAPM alpha. We can conclude the market beta is close to one for both strategies (naturally almost identically one for the value-weighted benchmark portfolio). When it comes to the distribution of the portfolio weights, we see that the benchmark portfolio weight takes less extreme positions (lower average absolute weights and lower maximum weight). By definition, the value-weighted benchmark does not take any negative positions, while the tilted portfolio also takes short positions.</p>
</section>
<section id="optimal-parameter-choice" class="level2">
<h2 class="anchored" data-anchor-id="optimal-parameter-choice">Optimal Parameter Choice</h2>
<p>Next, we move to a choice of <span class="math inline">\(\theta\)</span> that actually aims to improve some (or all) of the performance measures. We first define the helper function <code>compute_objective_function()</code>, which we then pass to an optimizer.</p>
<div id="32881aa5" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> objective_function(theta,</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>                       data,</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>                       objective_measure<span class="op">=</span><span class="st">"Expected utility"</span>,</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>                       value_weighting<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>                       allow_short_selling<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Define portfolio objective function."""</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    processed_data <span class="op">=</span> compute_portfolio_weights(</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>      theta, data, value_weighting, allow_short_selling</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    objective_function <span class="op">=</span> evaluate_portfolio(</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>      processed_data, </span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>      capm_evaluation<span class="op">=</span><span class="va">False</span>, </span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>      full_evaluation<span class="op">=</span><span class="va">False</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>    objective_function <span class="op">=</span> <span class="op">-</span>objective_function.loc[objective_measure, <span class="st">"tilt"</span>]</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> objective_function</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You may wonder why we return the negative value of the objective function. This is simply due to the common convention for optimization procedures to search for minima as a default. By minimizing the negative value of the objective function, we get the maximum value as a result. In its most basic form, Python optimization uses the function <code>minimize()</code>. As main inputs, the function requires an initial guess of the parameters and the objective function to minimize. Now, we are fully equipped to compute the optimal values of <span class="math inline">\(\hat\theta\)</span>, which maximize the hypothetical expected utility of the investor.</p>
<div id="be23b7bf" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>optimal_theta <span class="op">=</span> minimize(</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  fun<span class="op">=</span>objective_function,</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  x0<span class="op">=</span>[<span class="fl">1.5</span>]<span class="op">*</span>n_parameters,</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  args<span class="op">=</span>(data_portfolios, <span class="st">"Expected utility"</span>, <span class="va">True</span>, <span class="va">True</span>),</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  method<span class="op">=</span><span class="st">"Nelder-Mead"</span>,</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  tol<span class="op">=</span><span class="fl">1e-2</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>(pd.DataFrame(</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  optimal_theta.x,</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  columns<span class="op">=</span>[<span class="st">"Optimal Theta"</span>],</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  index<span class="op">=</span>[<span class="st">"momentum_lag"</span>, <span class="st">"size_lag"</span>]).T.<span class="bu">round</span>(<span class="dv">3</span>)</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">momentum_lag</th>
<th data-quarto-table-cell-role="th">size_lag</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">Optimal Theta</td>
<td>0.344</td>
<td>-1.827</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>The resulting values of <span class="math inline">\(\hat\theta\)</span> are easy to interpret: intuitively, expected utility increases by tilting weights from the value-weighted portfolio toward smaller stocks (negative coefficient for size) and toward past winners (positive value for momentum). Both findings are in line with the well-documented size effect <span class="citation" data-cites="Banz1981">(<a href="#ref-Banz1981" role="doc-biblioref">Banz 1981</a>)</span> and the momentum anomaly <span class="citation" data-cites="Jegadeesh1993">(<a href="#ref-Jegadeesh1993" role="doc-biblioref">Jegadeesh and Titman 1993</a>)</span>.</p>
</section>
<section id="more-model-specifications" class="level2">
<h2 class="anchored" data-anchor-id="more-model-specifications">More Model Specifications</h2>
<p>How does the portfolio perform for different model specifications? For this purpose, we compute the performance of a number of different modeling choices based on the entire CRSP sample. The next code chunk performs all the heavy lifting.</p>
<div id="936647fa" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> evaluate_optimal_performance(data,</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>                                 objective_measure<span class="op">=</span><span class="st">"Expected utility"</span>,</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>                                 value_weighting<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>                                 allow_short_selling<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Calculate optimal portfolio performance."""</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    optimal_theta <span class="op">=</span> minimize(</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>      fun<span class="op">=</span>objective_function,</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>      x0<span class="op">=</span>[<span class="fl">1.5</span>]<span class="op">*</span>n_parameters,</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>      args<span class="op">=</span>(data, objective_measure, value_weighting, allow_short_selling),</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>      method<span class="op">=</span><span class="st">"Nelder-Mead"</span>,</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>      tol<span class="op">=</span><span class="fl">10e-2</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    ).x</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    processed_data <span class="op">=</span> compute_portfolio_weights(</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>      optimal_theta, data, </span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>      value_weighting, allow_short_selling</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    portfolio_evaluation <span class="op">=</span> evaluate_portfolio(processed_data)</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>    weight_text <span class="op">=</span> <span class="st">"VW"</span> <span class="cf">if</span> value_weighting <span class="cf">else</span> <span class="st">"EW"</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>    short_text <span class="op">=</span> <span class="st">""</span> <span class="cf">if</span> allow_short_selling <span class="cf">else</span> <span class="st">" (no s.)"</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>    strategy_name_dict <span class="op">=</span> {</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>      <span class="st">"benchmark"</span>: weight_text,</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>      <span class="st">"tilt"</span>: <span class="ss">f"</span><span class="sc">{</span>weight_text<span class="sc">}</span><span class="ss"> Optimal</span><span class="sc">{</span>short_text<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>    portfolio_evaluation.columns <span class="op">=</span> [</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>      strategy_name_dict[i] <span class="cf">for</span> i <span class="kw">in</span> portfolio_evaluation.columns</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>(portfolio_evaluation)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, we can compare the results. The table below shows summary statistics for all possible combinations: equal- or value-weighted benchmark portfolio, with or without short-selling constraints, and tilted toward maximizing expected utility.</p>
<div id="c18409b8" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> [data_portfolios]</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>value_weighting <span class="op">=</span> [<span class="va">True</span>, <span class="va">False</span>]</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>allow_short_selling <span class="op">=</span> [<span class="va">True</span>, <span class="va">False</span>]</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>objective_measure <span class="op">=</span> [<span class="st">"Expected utility"</span>]</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>permutations <span class="op">=</span> product(</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  data, objective_measure,</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  value_weighting, allow_short_selling</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> <span class="bu">list</span>(starmap(</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  evaluate_optimal_performance, </span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>  permutations</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>performance_table <span class="op">=</span> (pd.concat(results, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>  .T.drop_duplicates().T.<span class="bu">round</span>(<span class="dv">3</span>)</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>performance_table.get([<span class="st">"EW"</span>, <span class="st">"VW"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">EW</th>
<th data-quarto-table-cell-role="th">VW</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">Expected utility</td>
<td>-0.251</td>
<td>-0.250</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Average return</td>
<td>10.009</td>
<td>6.649</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">SD return</td>
<td>20.352</td>
<td>15.462</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Sharpe ratio</td>
<td>0.492</td>
<td>0.430</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Intercept</td>
<td>0.002</td>
<td>0.000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Market beta</td>
<td>1.125</td>
<td>0.994</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Mean abs. weight</td>
<td>0.000</td>
<td>0.030</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Max. weight</td>
<td>0.000</td>
<td>4.053</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Min. weight</td>
<td>0.000</td>
<td>0.000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Avg. sum of neg. weights</td>
<td>0.000</td>
<td>0.000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Avg. share of neg. weights</td>
<td>0.000</td>
<td>0.000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="a9e18f7e" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>performance_table.get([<span class="st">"EW Optimal"</span>, <span class="st">"VW Optimal"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">EW Optimal</th>
<th data-quarto-table-cell-role="th">VW Optimal</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">Expected utility</td>
<td>-5.840</td>
<td>-0.261</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Average return</td>
<td>-4948.462</td>
<td>0.194</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">SD return</td>
<td>14729.881</td>
<td>21.106</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Sharpe ratio</td>
<td>-0.336</td>
<td>0.009</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Intercept</td>
<td>-3.697</td>
<td>-0.005</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Market beta</td>
<td>-78.566</td>
<td>0.952</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Mean abs. weight</td>
<td>62.166</td>
<td>0.077</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Max. weight</td>
<td>1119.202</td>
<td>4.216</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Min. weight</td>
<td>-221.305</td>
<td>-0.174</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Avg. sum of neg. weights</td>
<td>77916.229</td>
<td>78.025</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Avg. share of neg. weights</td>
<td>51.878</td>
<td>49.076</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cb429521" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>performance_table.get([<span class="st">"EW Optimal (no s.)"</span>, <span class="st">"VW Optimal (no s.)"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">EW Optimal (no s.)</th>
<th data-quarto-table-cell-role="th">VW Optimal (no s.)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">Expected utility</td>
<td>-0.252</td>
<td>-0.250</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Average return</td>
<td>7.962</td>
<td>7.301</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">SD return</td>
<td>19.126</td>
<td>16.700</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Sharpe ratio</td>
<td>0.416</td>
<td>0.437</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Intercept</td>
<td>0.000</td>
<td>0.000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Market beta</td>
<td>1.136</td>
<td>1.055</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Mean abs. weight</td>
<td>0.030</td>
<td>0.030</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Max. weight</td>
<td>1.309</td>
<td>2.332</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Min. weight</td>
<td>0.000</td>
<td>0.000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Avg. sum of neg. weights</td>
<td>0.000</td>
<td>0.000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Avg. share of neg. weights</td>
<td>0.000</td>
<td>0.000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>The results indicate that the average annualized Sharpe ratio of the equal-weighted portfolio exceeds the Sharpe ratio of the value-weighted benchmark portfolio. Nevertheless, starting with the weighted value portfolio as a benchmark and tilting optimally with respect to momentum and small stocks yields the highest Sharpe ratio across all specifications. Finally, imposing no short-sale constraints does not improve the performance of the portfolios in our application.</p>
</section>
<section id="exercises" class="level2">
<h2 class="anchored" data-anchor-id="exercises">Exercises</h2>
<ol type="1">
<li>How do the estimated parameters <span class="math inline">\(\hat\theta\)</span> and the portfolio performance change if your objective is to maximize the Sharpe ratio instead of the hypothetical expected utility?</li>
<li>The code above is very flexible in the sense that you can easily add new firm characteristics. Construct a new characteristic of your choice and evaluate the corresponding coefficient <span class="math inline">\(\hat\theta_i\)</span>.</li>
<li>Tweak the function <code>optimal_theta()</code> such that you can impose additional performance constraints in order to determine <span class="math inline">\(\hat\theta\)</span>, which maximizes expected utility under the constraint that the market beta is below 1.</li>
<li>Does the portfolio performance resemble a realistic out-of-sample backtesting procedure? Verify the robustness of the results by first estimating <span class="math inline">\(\hat\theta\)</span> based on <em>past data</em> only. Then, use more recent periods to evaluate the actual portfolio performance.</li>
<li>By formulating the portfolio problem as a statistical estimation problem, you can easily obtain standard errors for the coefficients of the weight function. <span class="citation" data-cites="Brandt2009">Brandt, Santa-Clara, and Valkanov (<a href="#ref-Brandt2009" role="doc-biblioref">2009</a>)</span> provide the relevant derivations in their paper in Equation (10). Implement a small function that computes standard errors for <span class="math inline">\(\hat\theta\)</span>.</li>
</ol>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-Banz1981" class="csl-entry" role="listitem">
Banz, Rolf W. 1981. <span>“<span class="nocase">The relationship between return and market value of common stocks</span>.”</span> <em><span>Journal of Financial Economics</span></em> 9 (1): 3–18. <a href="https://doi.org/10.1016/0304-405X(81)90018-0">https://doi.org/10.1016/0304-405X(81)90018-0</a>.
</div>
<div id="ref-Brandt2010" class="csl-entry" role="listitem">
Brandt, Michael W. 2010. <span>“<span class="nocase">Portfolio choice problems</span>.”</span> In <em>Handbook of Financial Econometrics: Tools and Techniques</em>, edited by Yacine Ait-Sahalia and Lars Peter Hansen, 1:269–336. Handbooks in Finance. North-Holland. <a href="https://doi.org/10.1016/B978-0-444-50897-3.50008-0">https://doi.org/10.1016/B978-0-444-50897-3.50008-0</a>.
</div>
<div id="ref-Brandt2009" class="csl-entry" role="listitem">
Brandt, Michael W, Pedro Santa-Clara, and Rossen Valkanov. 2009. <span>“<span class="nocase">Parametric portfolio policies: Exploiting characteristics in the cross-section of equity returns</span>.”</span> <em><span>Review of Financial Studies</span></em> 22 (9): 3411–47. <a href="https://doi.org/10.1093/rfs/hhp003">https://doi.org/10.1093/rfs/hhp003</a>.
</div>
<div id="ref-Gehrig2020" class="csl-entry" role="listitem">
Gehrig, Thomas, Leopold Sögner, and Arne Westerkamp. 2020. <span>“<span class="nocase">Making portfolio policies work</span>.”</span> <em><span>Working Paper</span></em>. <a href="http://dx.doi.org/10.2139/ssrn.3081100">http://dx.doi.org/10.2139/ssrn.3081100</a>.
</div>
<div id="ref-Jegadeesh1993" class="csl-entry" role="listitem">
Jegadeesh, Narasimhan, and Sheridan Titman. 1993. <span>“<span class="nocase">Returns to buying winners and selling losers: Implications for stock market efficiency</span>.”</span> <em><span>The Journal of Finance</span></em> 48 (1): 65–91. <a href="https://doi.org/10.1111/j.1540-6261.1993.tb04702.x">https://doi.org/10.1111/j.1540-6261.1993.tb04702.x</a>.
</div>
<div id="ref-scipy" class="csl-entry" role="listitem">
Virtanen, Pauli, Ralf Gommers, Travis E. Oliphant, Matt Haberland, Tyler Reddy, David Cournapeau, Evgeni Burovski, et al. 2020. <span>“<span class="nocase"><span>SciPy</span> 1.0: Fundamental Algorithms for Scientific Computing in Python</span>.”</span> <em>Nature Methods</em> 17: 261–72. <a href="https://doi.org/10.1038/s41592-019-0686-2">https://doi.org/10.1038/s41592-019-0686-2</a>.
</div>
</div></section></div></main> <!-- /main -->
<div class="custom-footer">
  <div class="copyright">© Christoph Frey, Christoph Scheuch, Stefan Voigt &amp; Patrick Weiss</div>
  <a href="disclaimer.html">Disclaimer</a>
  <a href="#" id="open_preferences_center">Cookie Preferences</a>
</div>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("^(?:http:|https:)\/\/www\.tidy-finance\.org");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
          if (link.getAttribute("rel") === null) {
            link.setAttribute("rel", "noopener");
          }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      return note.innerHTML;
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../python/option-pricing-via-machine-learning.html" class="pagination-link  aria-label=" option="" pricing="" via="" machine="" learning"="">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Option Pricing via Machine Learning</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../python/constrained-optimization-and-backtesting.html" class="pagination-link" aria-label="Constrained Optimization and Backtesting">
        <span class="nav-page-text">Constrained Optimization and Backtesting</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">

<div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/tidy-finance/website/blob/main/python/parametric-portfolio-policies.qmd" class="toc-action"><i class="bi bi-github"></i>View source</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




<script src="../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>