<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 8 Bivariate Sorts: Replication of Fama &amp; French Factors | Tidy Finance</title>
<meta name="author" content="Christoph Scheuch, Patrick Weiss and Stefan Voigt">
<meta name="description" content="The Fama and French three-factor model (see CITATION) is a cornerstone of asset pricing. On top of the market factor represented by the traditional CAPM beta, the model includes the factors size...">
<meta name="generator" content="bookdown 0.24.4 with bs4_book()">
<meta property="og:title" content="Chapter 8 Bivariate Sorts: Replication of Fama &amp; French Factors | Tidy Finance">
<meta property="og:type" content="book">
<meta property="og:description" content="The Fama and French three-factor model (see CITATION) is a cornerstone of asset pricing. On top of the market factor represented by the traditional CAPM beta, the model includes the factors size...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 8 Bivariate Sorts: Replication of Fama &amp; French Factors | Tidy Finance">
<meta name="twitter:description" content="The Fama and French three-factor model (see CITATION) is a cornerstone of asset pricing. On top of the market factor represented by the traditional CAPM beta, the model includes the factors size...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.11/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS -->
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Tidy Finance</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"><span class="header-section-number">1</span> Welcome</a></li>
<li><a class="" href="introduction-to-tidy-finance.html"><span class="header-section-number">2</span> Introduction to Tidy Finance</a></li>
<li><a class="" href="accessing-managing-financial-data.html"><span class="header-section-number">3</span> Accessing &amp; Managing Financial Data</a></li>
<li><a class="" href="beta-estimation.html"><span class="header-section-number">4</span> Beta Estimation</a></li>
<li><a class="" href="univariate-sorts.html"><span class="header-section-number">5</span> Univariate Sorts</a></li>
<li><a class="" href="univariate-sorts-firm-size.html"><span class="header-section-number">6</span> Univariate Sorts: Firm Size</a></li>
<li><a class="" href="bivariate-sorts-value.html"><span class="header-section-number">7</span> Bivariate Sorts: Value</a></li>
<li><a class="active" href="bivariate-sorts-replication-of-fama-french-factors.html"><span class="header-section-number">8</span> Bivariate Sorts: Replication of Fama &amp; French Factors</a></li>
<li><a class="" href="factor-selection-via-machine-learning.html"><span class="header-section-number">9</span> Factor selection via machine learning</a></li>
<li><a class="" href="option-pricing-via-machine-learning-methods.html"><span class="header-section-number">10</span> Option Pricing via Machine learning methods</a></li>
<li><a class="" href="parametric-portfolio-policies.html"><span class="header-section-number">11</span> Parametric Portfolio Policies</a></li>
<li><a class="" href="constraint-optimization-and-portfolio-backtesting.html"><span class="header-section-number">12</span> Constraint Optimization and Portfolio Backtesting</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="bivariate-sorts-replication-of-fama-french-factors" class="section level1" number="8">
<h1>
<span class="header-section-number">8</span> Bivariate Sorts: Replication of Fama &amp; French Factors<a class="anchor" aria-label="anchor" href="#bivariate-sorts-replication-of-fama-french-factors"><i class="fas fa-link"></i></a>
</h1>
<p>The Fama and French three-factor model (see CITATION) is a cornerstone of asset pricing. On top of the market factor represented by the traditional CAPM beta, the model includes the factors size and value. We did introduce both factors in the previous section, and their definition remains the same. Size is the SMB factor (small-minus-big) that is long small firms and short large firms. The value factor is HML (high-minus-low) and is long in high book-to-market firms and short the low book-to-market counterparts. While we demonstrated the main idea of portfolio sorts, we also want to show how to replicate these significant factors. However, we do not aim at a perfect replication but want to show the main ideas.</p>
<p>The current section relies on this set of packages.</p>
<div class="sourceCode" id="cb167"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rsqlite.r-dbi.org">RSQLite</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org">lubridate</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://sandwich.R-Forge.R-project.org/">sandwich</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">lmtest</span><span class="op">)</span></code></pre></div>
<div id="databases" class="section level2" number="8.1">
<h2>
<span class="header-section-number">8.1</span> Databases<a class="anchor" aria-label="anchor" href="#databases"><i class="fas fa-link"></i></a>
</h2>
<p>We use the same data sources CRSP and compustat, as we need exactly the same variables to compute the size and value factors in the way Fama and French do it. Hence, there is nothing new below.</p>
<div class="sourceCode" id="cb168"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Load data from database</span>
<span class="va">tidy_finance</span> <span class="op">&lt;-</span> <span class="fu">dbConnect</span><span class="op">(</span><span class="fu"><a href="https://rsqlite.r-dbi.org/reference/SQLite.html">SQLite</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"data/tidy_finance.sqlite"</span>, extended_types <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="va">crsp_monthly</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html">tbl</a></span><span class="op">(</span><span class="va">tidy_finance</span>, <span class="st">"crsp_monthly"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html">collect</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">factors_ff_monthly</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html">tbl</a></span><span class="op">(</span><span class="va">tidy_finance</span>, <span class="st">"factors_ff_monthly"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html">collect</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">compustat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html">tbl</a></span><span class="op">(</span><span class="va">tidy_finance</span>, <span class="st">"compustat"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html">collect</a></span><span class="op">(</span><span class="op">)</span>

<span class="co"># Keep only relevant data</span>
<span class="va">data_ff</span> <span class="op">&lt;-</span> <span class="va">crsp_monthly</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">factors_ff_monthly</span>, by <span class="op">=</span> <span class="st">"month"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">permno</span>, <span class="va">gvkey</span>, <span class="va">month</span>, <span class="va">ret_excess</span>, <span class="va">mkt_excess</span>, <span class="va">mktcap</span>, <span class="va">mktcap_lag</span>, <span class="va">exchange</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="op">)</span>

<span class="co"># Compustat data</span>
<span class="va">be</span> <span class="op">&lt;-</span> <span class="va">compustat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">gvkey</span>, <span class="va">datadate</span>, <span class="va">be</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
</div>
<div id="data-preparation-3" class="section level2" number="8.2">
<h2>
<span class="header-section-number">8.2</span> Data Preparation<a class="anchor" aria-label="anchor" href="#data-preparation-3"><i class="fas fa-link"></i></a>
</h2>
<p>Yet when we start merging our data set for computing the premiums, there are a few differences to the previous sections. First, Fama and French form their portfolios in June of year <span class="math inline">\(t\)</span>, whereby the returns of July are the first monthly return for the respective portfolio. For firm size, they consequently use the market capitalization recorded for June. It is then held constant until June of year <span class="math inline">\(t+1\)</span>.</p>
<p>Second, Fama and French also have a different protocol for computing the book-to-market ratio. They use market equity as of the end of year <span class="math inline">\(t - 1\)</span> and the book equity reported in year <span class="math inline">\(t-1\)</span>, i.e., the <code>datadate</code> is within the last year. Hence, the book-to-market ratio can be based on accounting information that is up to 18 months old. Market equity also does not necessarily reflect the same time point as book equity.</p>
<p>To implement all these time lags, we again employ the temporary <code>sorting_date</code>-column. Notice that when we combine the information, we want to have a single observation per year and stock since we are only interested in computing the breakpoints held constant for the entire year. We ensure this by a call of <code><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct()</a></code> at the end of the chunk below.</p>
<div class="sourceCode" id="cb169"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Market equity</span>
<span class="va">ff_me</span> <span class="op">&lt;-</span> <span class="va">data_ff</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/month.html">month</a></span><span class="op">(</span><span class="va">month</span><span class="op">)</span> <span class="op">==</span> <span class="fl">6</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>sorting_date <span class="op">=</span> <span class="va">month</span> <span class="op"><a href="https://lubridate.tidyverse.org/reference/mplus.html">%m+%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/weekday.POSIXt.html">months</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">permno</span>, <span class="va">sorting_date</span>, ff_me <span class="op">=</span> <span class="va">mktcap</span><span class="op">)</span>

<span class="co"># Book-to-market</span>
<span class="co">## December market equity</span>
<span class="va">ff_me_dec</span> <span class="op">&lt;-</span> <span class="va">data_ff</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/month.html">month</a></span><span class="op">(</span><span class="va">month</span><span class="op">)</span> <span class="op">==</span> <span class="fl">12</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>sorting_date <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">month</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span>, <span class="st">"07-01)"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">permno</span>, <span class="va">gvkey</span>, <span class="va">sorting_date</span>, bm_me <span class="op">=</span> <span class="va">mktcap</span><span class="op">)</span>

<span class="co">## Book to market</span>
<span class="va">ff_bm</span> <span class="op">&lt;-</span> <span class="va">be</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="co"># be from year before</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>sorting_date <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">datadate</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span>, <span class="st">"07-01"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">gvkey</span>, <span class="va">sorting_date</span>, bm_be <span class="op">=</span> <span class="va">be</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">ff_me_dec</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"gvkey"</span>, <span class="st">"sorting_date"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>ff_bm <span class="op">=</span> <span class="va">bm_be</span><span class="op">/</span><span class="va">bm_me</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">permno</span>, <span class="va">sorting_date</span>, <span class="va">ff_bm</span><span class="op">)</span>

<span class="co"># Combine factors</span>
<span class="va">ff_variables</span> <span class="op">&lt;-</span> <span class="va">ff_me</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">ff_bm</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"permno"</span>, <span class="st">"sorting_date"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="va">permno</span>, <span class="va">sorting_date</span>, .keep_all <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
</div>
<div id="breakpoints" class="section level2" number="8.3">
<h2>
<span class="header-section-number">8.3</span> Breakpoints<a class="anchor" aria-label="anchor" href="#breakpoints"><i class="fas fa-link"></i></a>
</h2>
<p>Before we attach the sorting variables to our returns, we compute the breakpoints separately. Matching everything before computing the breakpoints would be possible but less efficient. Regarding the other choice variables, Fama and French rely on NYSE-specific breakpoints, they form two portfolios in the size dimension at the median and three portfolios in the dimension of book-to-market at the 30%- and 70%-percentiles, and they use independent sorts. Additionally, we perform an <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join()</a></code> with our return data to ensure that we only use traded stocks when computing the breakpoints as a first step.</p>
<div class="sourceCode" id="cb170"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ff_breakpoints</span> <span class="op">&lt;-</span> <span class="va">ff_variables</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">data_ff</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"permno"</span> <span class="op">=</span> <span class="st">"permno"</span>, <span class="st">"sorting_date"</span> <span class="op">=</span> <span class="st">"month"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">exchange</span> <span class="op">==</span> <span class="st">"NYSE"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">sorting_date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>ff_me_50 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">ff_me</span><span class="op">)</span>,
            ff_bm_30 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">ff_bm</span>, <span class="fl">0.3</span>, names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,
            ff_bm_70 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">ff_bm</span>, <span class="fl">0.7</span>, names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Next, we merge the June breakpoints to the return data. To implement this step, we create a new column <code>sorting_date</code> in our return data by setting the date to sort on to July of <span class="math inline">\(t-1\)</span> if the month is June (of year <span class="math inline">\(t\)</span>) or earlier or to July of year <span class="math inline">\(t\)</span> if the month is July or later. Doing so ensures that we form portfolios based on the information assigned to June of year <span class="math inline">\(t\)</span>. In principle, we will still form portfolios on a monthly basis, but this is only incorrect to a few stocks that drop out during the year.</p>
<div class="sourceCode" id="cb171"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ff_portfolios</span> <span class="op">&lt;-</span> <span class="va">data_ff</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>sorting_date <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/month.html">month</a></span><span class="op">(</span><span class="va">month</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="fl">6</span> <span class="op">~</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">month</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>, <span class="st">"0701"</span><span class="op">)</span><span class="op">)</span>,
                                  <span class="fu"><a href="https://lubridate.tidyverse.org/reference/month.html">month</a></span><span class="op">(</span><span class="va">month</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="fl">7</span> <span class="op">~</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">month</span><span class="op">)</span>, <span class="st">"0701"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">ff_variables</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"permno"</span>, <span class="st">"sorting_date"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">ff_breakpoints</span>, by <span class="op">=</span> <span class="st">"sorting_date"</span><span class="op">)</span></code></pre></div>
</div>
<div id="fama-and-french-factor-returns" class="section level2" number="8.4">
<h2>
<span class="header-section-number">8.4</span> Fama and French Factor Returns<a class="anchor" aria-label="anchor" href="#fama-and-french-factor-returns"><i class="fas fa-link"></i></a>
</h2>
<p>We can now use our returns alongside the breakpoints to assign the portfolios. We do so slightly differently by using the <code><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when()</a></code>-function. We assign the portfolios by adding numbers that result in the respective portfolio. The base portfolio of small growth stocks gets the value of 11. We add 10 for large firms and 1 and 2 for higher book-to-market ratios. In the end, we add the letter p to indicate that these are portfolio numbers. Overall, this procedure is potentially less intuitive but suitable for this exercise given the low number of portfolios.</p>
<p>After forming the monthly value-weighted return per portfolio, we use the function <code><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider()</a></code>. This function is useful in various scenarios. In our case, we use it to transform the data containing portfolio-months in each row into a data frame with one row for each month and columns that indicate the portfolio returns. The argument <code>id_cols</code> defines how to identify the new observations uniquely, <code>names_from</code> indicates which column of the old structure defines the new setâ€™s column names, and <code>values_from</code> gives the column that contains the data to be stored in the created columns.</p>
<p>Finally, we can then compute the equal-weighted monthly returns of the size and value factors. The size premium results from going long the three small portfolios (i.e., portfolios 11, 12, and 13) and shorting large portfolios (i.e., portfolios 21, 22, and 23). The value premium is achieved by investing in the two high book-to-market portfolios (i.e., portfolios 13 and 23) and shorting the growth portfolios (i.e., portfolios 11 and 21).</p>
<div class="sourceCode" id="cb172"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ff_factors</span> <span class="op">&lt;-</span> <span class="va">ff_portfolios</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>portfolio <span class="op">=</span> <span class="fl">10</span>,
         portfolio <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span><span class="va">ff_me</span> <span class="op">&lt;</span> <span class="va">ff_me_50</span> <span class="op">~</span> <span class="va">portfolio</span>,
                               <span class="va">ff_me</span> <span class="op">&gt;=</span> <span class="va">ff_me_50</span> <span class="op">~</span> <span class="va">portfolio</span> <span class="op">+</span> <span class="fl">10</span><span class="op">)</span>,
         portfolio <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span><span class="va">ff_bm</span> <span class="op">&lt;</span> <span class="va">ff_bm_30</span> <span class="op">~</span> <span class="va">portfolio</span> <span class="op">+</span> <span class="fl">1</span>,
                               <span class="va">ff_bm</span> <span class="op">&gt;=</span> <span class="va">ff_bm_30</span> <span class="op">&amp;</span> <span class="va">ff_bm</span> <span class="op">&lt;</span> <span class="va">ff_bm_70</span> <span class="op">~</span> <span class="va">portfolio</span> <span class="op">+</span> <span class="fl">2</span>,
                               <span class="va">ff_bm</span> <span class="op">&gt;=</span> <span class="va">ff_bm_70</span> <span class="op">~</span> <span class="va">portfolio</span> <span class="op">+</span> <span class="fl">3</span><span class="op">)</span>,
         portfolio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"p"</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">portfolio</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">portfolio</span>, <span class="va">month</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>ret <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html">weighted.mean</a></span><span class="op">(</span><span class="va">ret_excess</span>, <span class="va">mktcap_lag</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>id_cols <span class="op">=</span> <span class="va">month</span>, names_from <span class="op">=</span> <span class="va">portfolio</span>, values_from <span class="op">=</span> <span class="va">ret</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>ff_SMB <span class="op">=</span> <span class="op">(</span><span class="va">p11</span> <span class="op">+</span> <span class="va">p12</span> <span class="op">+</span> <span class="va">p13</span><span class="op">)</span> <span class="op">/</span> <span class="fl">3</span> <span class="op">-</span> <span class="op">(</span><span class="va">p21</span> <span class="op">+</span> <span class="va">p22</span> <span class="op">+</span> <span class="va">p23</span><span class="op">)</span> <span class="op">/</span> <span class="fl">3</span>,
         ff_HML <span class="op">=</span> <span class="op">(</span><span class="va">p13</span> <span class="op">+</span> <span class="va">p23</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span> <span class="op">-</span> <span class="op">(</span><span class="va">p11</span> <span class="op">+</span> <span class="va">p21</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">month</span>, <span class="va">ff_SMB</span>, <span class="va">ff_HML</span><span class="op">)</span></code></pre></div>
</div>
<div id="correlation-tests" class="section level2" number="8.5">
<h2>
<span class="header-section-number">8.5</span> Correlation Tests<a class="anchor" aria-label="anchor" href="#correlation-tests"><i class="fas fa-link"></i></a>
</h2>
<p>In the last step, we replicated the size and value premiums following the procedure outlined by Fama and French. However, we did not follow their procedure strictly. The final question is then; how close did we get? We answer this question by looking at the two time-series estimates in a correlation analysis using the function <code><a href="https://rdrr.io/r/stats/cor.test.html">cor.test()</a></code> and a test of means using the function <code><a href="https://rdrr.io/r/stats/t.test.html">t.test()</a></code>.</p>
<p>We can see that we reject the null hypothesis for both premiums in the correlation tests, i.e., the hypothesis that the time series are uncorrelated is rejected. Moreover, we cannot reject the hypothesis that the means of the Fama and French factors and our replication results are different. Hence, we can conclude that we did a relatively good job in replicating their premiums.</p>
<div class="sourceCode" id="cb173"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">test</span> <span class="op">&lt;-</span> <span class="va">factors_ff_monthly</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">ff_factors</span>, by <span class="op">=</span> <span class="st">"month"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>ff_SMB <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">ff_SMB</span>, <span class="fl">4</span><span class="op">)</span>,
         ff_HML <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">ff_HML</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/stats/cor.test.html">cor.test</a></span><span class="op">(</span><span class="va">test</span><span class="op">$</span><span class="va">ff_SMB</span>, <span class="va">test</span><span class="op">$</span><span class="va">smb</span><span class="op">)</span> </code></pre></div>
<pre><code>## 
##  Pearson's product-moment correlation
## 
## data:  test$ff_SMB and test$smb
## t = 216.1, df = 712, p-value &lt; 2.2e-16
## alternative hypothesis: true correlation is not equal to 0
## 95 percent confidence interval:
##  0.9912746 0.9934900
## sample estimates:
##      cor 
## 0.992463</code></pre>
<div class="sourceCode" id="cb175"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/stats/cor.test.html">cor.test</a></span><span class="op">(</span><span class="va">test</span><span class="op">$</span><span class="va">ff_HML</span>, <span class="va">test</span><span class="op">$</span><span class="va">hml</span><span class="op">)</span></code></pre></div>
<pre><code>## 
##  Pearson's product-moment correlation
## 
## data:  test$ff_HML and test$hml
## t = 129.46, df = 712, p-value &lt; 2.2e-16
## alternative hypothesis: true correlation is not equal to 0
## 95 percent confidence interval:
##  0.9761907 0.9822018
## sample estimates:
##       cor 
## 0.9794122</code></pre>
<div class="sourceCode" id="cb177"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/stats/t.test.html">t.test</a></span><span class="op">(</span><span class="va">test</span><span class="op">$</span><span class="va">ff_SMB</span>, <span class="va">test</span><span class="op">$</span><span class="va">smb</span><span class="op">)</span> </code></pre></div>
<pre><code>## 
##  Welch Two Sample t-test
## 
## data:  test$ff_SMB and test$smb
## t = 0.084818, df = 1426, p-value = 0.9324
## alternative hypothesis: true difference in means is not equal to 0
## 95 percent confidence interval:
##  -0.002996805  0.003267673
## sample estimates:
##   mean of x   mean of y 
## 0.001945378 0.001809944</code></pre>
<div class="sourceCode" id="cb179"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/stats/t.test.html">t.test</a></span><span class="op">(</span><span class="va">test</span><span class="op">$</span><span class="va">ff_HML</span>, <span class="va">test</span><span class="op">$</span><span class="va">hml</span><span class="op">)</span></code></pre></div>
<pre><code>## 
##  Welch Two Sample t-test
## 
## data:  test$ff_HML and test$hml
## t = -0.11467, df = 1425.4, p-value = 0.9087
## alternative hypothesis: true difference in means is not equal to 0
## 95 percent confidence interval:
##  -0.003147035  0.002799416
## sample estimates:
##   mean of x   mean of y 
## 0.002485714 0.002659524</code></pre>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="bivariate-sorts-value.html"><span class="header-section-number">7</span> Bivariate Sorts: Value</a></div>
<div class="next"><a href="factor-selection-via-machine-learning.html"><span class="header-section-number">9</span> Factor selection via machine learning</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#bivariate-sorts-replication-of-fama-french-factors"><span class="header-section-number">8</span> Bivariate Sorts: Replication of Fama &amp; French Factors</a></li>
<li><a class="nav-link" href="#databases"><span class="header-section-number">8.1</span> Databases</a></li>
<li><a class="nav-link" href="#data-preparation-3"><span class="header-section-number">8.2</span> Data Preparation</a></li>
<li><a class="nav-link" href="#breakpoints"><span class="header-section-number">8.3</span> Breakpoints</a></li>
<li><a class="nav-link" href="#fama-and-french-factor-returns"><span class="header-section-number">8.4</span> Fama and French Factor Returns</a></li>
<li><a class="nav-link" href="#correlation-tests"><span class="header-section-number">8.5</span> Correlation Tests</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Tidy Finance</strong>" was written by Christoph Scheuch, Patrick Weiss and Stefan Voigt. It was last built on 2022-01-26.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
