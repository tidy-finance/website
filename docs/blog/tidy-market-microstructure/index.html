<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Björn Hagströmer">
<meta name="author" content="Niklas Landsberg">
<meta name="dcterms.date" content="2024-01-04">
<meta name="description" content="A beginner’s guide to market quality measurement in high-frequency data using R.">

<title>Tidy Market Microstructure – Tidy Finance</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../assets/img/favicon.png" rel="icon" type="image/png">
<script src="../../site_libs/cookie-consent/cookie-consent.js"></script>
<link href="../../site_libs/cookie-consent/cookie-consent.css" rel="stylesheet">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-99a8851848bcfc05e6486f9d9e6d6ff3.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="../../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-DH3KZSMJ5W"></script>

<script type="text/plain" cookie-consent="tracking">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-DH3KZSMJ5W', { 'anonymize_ip': true});
</script>

<script type="text/javascript" charset="UTF-8">
document.addEventListener('DOMContentLoaded', function () {
cookieconsent.run({
  "notice_banner_type":"interstitial",
  "consent_type":"express",
  "palette":"light",
  "language":"en",
  "page_load_consent_levels":["strictly-necessary"],
  "notice_banner_reject_button_hide":false,
  "preferences_center_close_button_hide":false,
  "website_name":""
  ,
"language":"en"
  });
});
</script> 
  
<style>html{ scroll-behavior: smooth; }</style>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../assets/css/global.css">
<meta property="og:title" content="Tidy Market Microstructure – Tidy Finance">
<meta property="og:description" content="A beginner’s guide to market quality measurement in high-frequency data using R.">
<meta property="og:image" content="https://www.tidy-finance.org/blog/tidy-market-microstructure/thumbnail.jpeg">
<meta property="og:site_name" content="Tidy Finance">
<meta property="og:image:alt" content="Cartoon of robots and humans trying to make sense of green stock price charts on black background. Created with DALL-E 3.">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../assets/img/logo-website-white.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Tidy Finance</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../r/index.html"> 
<span class="menu-text">R</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../python/index.html"> 
<span class="menu-text">Python</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../contribute.html"> 
<span class="menu-text">Contribute</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../support.html"> 
<span class="menu-text">Support</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://talks.tidy-finance.org"> 
<span class="menu-text">Talks</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../workshops/reproducible-research-workflows.html"> 
<span class="menu-text">Workshops</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Tidy Market Microstructure</h1>
                  <div>
        <div class="description">
          A beginner’s guide to market quality measurement in high-frequency data using R.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">Market microstructure</div>
                <div class="quarto-category">R</div>
                <div class="quarto-category">data.table</div>
              </div>
                  </div>
  </div>
    
  <div class="quarto-title-meta-author">
    <div class="quarto-title-meta-heading">Authors</div>
    <div class="quarto-title-meta-heading">Affiliations</div>
    
      <div class="quarto-title-meta-contents">
      <p class="author"><a href="https://hagstromer.org/">Björn Hagströmer</a> </p>
    </div>
    <div class="quarto-title-meta-contents">
          <p class="affiliation">
              Stockholm Business School
            </p>
        </div>
      <div class="quarto-title-meta-contents">
      <p class="author"><a href="https://www.kuleuven.be/wieiswie/en/person/00167120">Niklas Landsberg</a> </p>
    </div>
    <div class="quarto-title-meta-contents">
          <p class="affiliation">
              KU Leuven
            </p>
        </div>
    </div>

  <div class="quarto-title-meta">

        
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">January 4, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#programming" id="toc-programming" class="nav-link active" data-scroll-target="#programming">Programming</a></li>
  <li><a href="#data" id="toc-data" class="nav-link" data-scroll-target="#data">Data</a></li>
  <li><a href="#quote-based-liquidity" id="toc-quote-based-liquidity" class="nav-link" data-scroll-target="#quote-based-liquidity">Quote-based liquidity</a>
  <ul class="collapse">
  <li><a href="#quote-data-inspection-and-preparation" id="toc-quote-data-inspection-and-preparation" class="nav-link" data-scroll-target="#quote-data-inspection-and-preparation">Quote data inspection and preparation</a>
  <ul class="collapse">
  <li><a href="#dates" id="toc-dates" class="nav-link" data-scroll-target="#dates">Dates</a></li>
  <li><a href="#timestamps" id="toc-timestamps" class="nav-link" data-scroll-target="#timestamps">Timestamps</a></li>
  <li><a href="#prices-and-depths" id="toc-prices-and-depths" class="nav-link" data-scroll-target="#prices-and-depths">Prices and depths</a></li>
  <li><a href="#screening" id="toc-screening" class="nav-link" data-scroll-target="#screening">Screening</a></li>
  </ul></li>
  <li><a href="#liquidity-measures" id="toc-liquidity-measures" class="nav-link" data-scroll-target="#liquidity-measures">Liquidity measures</a>
  <ul class="collapse">
  <li><a href="#duration-weighted-liquidity" id="toc-duration-weighted-liquidity" class="nav-link" data-scroll-target="#duration-weighted-liquidity">Duration-weighted liquidity</a></li>
  </ul></li>
  <li><a href="#consolidated-liquidity-in-fragmented-markets" id="toc-consolidated-liquidity-in-fragmented-markets" class="nav-link" data-scroll-target="#consolidated-liquidity-in-fragmented-markets">Consolidated liquidity in fragmented markets</a>
  <ul class="collapse">
  <li><a href="#retaining-only-the-last-quote-update-in-each-interval" id="toc-retaining-only-the-last-quote-update-in-each-interval" class="nav-link" data-scroll-target="#retaining-only-the-last-quote-update-in-each-interval">Retaining only the last quote update in each interval</a></li>
  <li><a href="#merging-quotes-from-different-venues" id="toc-merging-quotes-from-different-venues" class="nav-link" data-scroll-target="#merging-quotes-from-different-venues">Merging quotes from different venues</a></li>
  <li><a href="#fundamental-value" id="toc-fundamental-value" class="nav-link" data-scroll-target="#fundamental-value">Fundamental value</a></li>
  <li><a href="#screening-1" id="toc-screening-1" class="nav-link" data-scroll-target="#screening-1">Screening</a></li>
  <li><a href="#consolidated-liquidity-measures" id="toc-consolidated-liquidity-measures" class="nav-link" data-scroll-target="#consolidated-liquidity-measures">Consolidated liquidity measures</a></li>
  </ul></li>
  <li><a href="#data-export" id="toc-data-export" class="nav-link" data-scroll-target="#data-export">Data export</a></li>
  </ul></li>
  <li><a href="#trade-based-liquidity" id="toc-trade-based-liquidity" class="nav-link" data-scroll-target="#trade-based-liquidity">Trade-based liquidity</a>
  <ul class="collapse">
  <li><a href="#trade-data-inspection-and-preparation" id="toc-trade-data-inspection-and-preparation" class="nav-link" data-scroll-target="#trade-data-inspection-and-preparation">Trade data inspection and preparation</a>
  <ul class="collapse">
  <li><a href="#dates-and-timestamps" id="toc-dates-and-timestamps" class="nav-link" data-scroll-target="#dates-and-timestamps">Dates and timestamps</a></li>
  <li><a href="#trade-variables" id="toc-trade-variables" class="nav-link" data-scroll-target="#trade-variables">Trade variables</a></li>
  <li><a href="#matching-trades-to-quotes" id="toc-matching-trades-to-quotes" class="nav-link" data-scroll-target="#matching-trades-to-quotes">Matching trades to quotes</a></li>
  <li><a href="#further-screening" id="toc-further-screening" class="nav-link" data-scroll-target="#further-screening">Further screening</a></li>
  <li><a href="#direction-of-trade" id="toc-direction-of-trade" class="nav-link" data-scroll-target="#direction-of-trade">Direction of trade</a></li>
  </ul></li>
  <li><a href="#liquidity-measures-1" id="toc-liquidity-measures-1" class="nav-link" data-scroll-target="#liquidity-measures-1">Liquidity measures</a>
  <ul class="collapse">
  <li><a href="#effective-spread" id="toc-effective-spread" class="nav-link" data-scroll-target="#effective-spread">Effective spread</a></li>
  <li><a href="#price-impact-and-realized-spreads" id="toc-price-impact-and-realized-spreads" class="nav-link" data-scroll-target="#price-impact-and-realized-spreads">Price impact and realized spreads</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#market-efficiency" id="toc-market-efficiency" class="nav-link" data-scroll-target="#market-efficiency">Market efficiency</a>
  <ul class="collapse">
  <li><a href="#equispaced-returns" id="toc-equispaced-returns" class="nav-link" data-scroll-target="#equispaced-returns">Equispaced returns</a></li>
  <li><a href="#efficiency-and-volatility-measures" id="toc-efficiency-and-volatility-measures" class="nav-link" data-scroll-target="#efficiency-and-volatility-measures">Efficiency and volatility measures</a>
  <ul class="collapse">
  <li><a href="#return-autocorrelation-and-realized-volatility" id="toc-return-autocorrelation-and-realized-volatility" class="nav-link" data-scroll-target="#return-autocorrelation-and-realized-volatility">Return autocorrelation and realized volatility</a></li>
  <li><a href="#variance-ratios" id="toc-variance-ratios" class="nav-link" data-scroll-target="#variance-ratios">Variance ratios</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a>
  <ul class="collapse">
  <li><a href="#acknowledgements" id="toc-acknowledgements" class="nav-link" data-scroll-target="#acknowledgements">Acknowledgements</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/tidy-finance/website/blob/main/blog/tidy-market-microstructure/index.qmd" class="toc-action"><i class="bi bi-github"></i>View source</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p>Anyone active in market microstructure research <em>knows</em> that the devil is in the details. When clocks tick in microseconds and prices move in cents, a brief delay or a small fee discount can make a huge difference for traders. In fact, they can even be the business model of an exchange. But as much as such institutional detail is fascinating, the empirical implementation of even the most conventional microstructure concepts can be frustrating. Referring to the <em>interest of brevity</em>, many journal articles often defer the implementation details to an appendix, and even there they tend to be vague or incomplete. With the additional challenge of vast data sets, new entrants into this field face a steep challenge.</p>
<p>We provide a beginner’s guide to market quality measurement in high-frequency data, aiming to lower the barriers to entry into empirical market microstructure. We discuss economic considerations and show step-by-step how to code the most common measures of market liquidity and market efficiency. Because virtually all securities now trade at multiple venues, we also emphasize how market quality can account for market fragmentation.</p>
<p>Is this guide really needed? Well, a recent paper by Menkveld et al., (2023)<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> shows in full clarity that even small variations in methodology can lead to large differences in market quality measures. The authors assigned the same set of market microstructure hypotheses and the same data to 164 research teams. They found that the variation in results across teams, the <em>non-standard error</em>, was of a magnitude similar to the standard error. Many teams included seasoned professors, but past publication performance and seniority did not reduce the non-standard error.</p>
<p>Another question is if the cumbersome high-frequency data analysis is really worth the effort? After all, there are numerous liquidity proxies based on daily data. The answer depends on the research question. First, low-frequency proxies are designed for low-frequency applications. For example, Amihud’s (2002)<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> popular proxy was originally proposed to be measured as an annual average. Most microstructure applications require liquidity measures at higher frequencies than that. Furthermore, recent evidence by Jahan-Parvar and Zikes (2023)<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> show that many low-frequency proxies capture volatility rather than liquidity.</p>
<p>If we convinced you to take on the high-frequency data, here’s what we offer. Table 1 lists the market quality measures that we cover, as well as their underlying data type. For some measures, we include several versions and discuss the differences between them. We organize the text by the data type, as we think that is a natural work flow. We start with liquidity measures based on tick-by-tick quote data, followed by measures based on both trade and quote data. Finally, we look into a set of measures of efficiency and volatility that require equispaced quote data.</p>
<div class="cell">
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<caption>Market quality variables and data types</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Variable name</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Variable type</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Data type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Quoted bid-ask spread</td>
<td style="text-align: left;">Liquidity</td>
<td style="text-align: left;">Quote tick data</td>
</tr>
<tr class="even">
<td style="text-align: left;">Quoted depth</td>
<td style="text-align: left;">Liquidity</td>
<td style="text-align: left;">Quote tick data</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Effective bid-ask spread</td>
<td style="text-align: left;">Liquidity</td>
<td style="text-align: left;">Quote and trade tick data</td>
</tr>
<tr class="even">
<td style="text-align: left;">Trade volume</td>
<td style="text-align: left;">Volume</td>
<td style="text-align: left;">Trade tick data</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Price impact</td>
<td style="text-align: left;">Liquidity</td>
<td style="text-align: left;">Quote and trade tick data</td>
</tr>
<tr class="even">
<td style="text-align: left;">Realized spread</td>
<td style="text-align: left;">Liquidity</td>
<td style="text-align: left;">Quote and trade tick data</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Return autocorrelation</td>
<td style="text-align: left;">Efficiency</td>
<td style="text-align: left;">Equispaced quote data</td>
</tr>
<tr class="even">
<td style="text-align: left;">Realized volatility</td>
<td style="text-align: left;">Volatility</td>
<td style="text-align: left;">Equispaced quote data</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Variance ratio</td>
<td style="text-align: left;">Efficiency</td>
<td style="text-align: left;">Equispaced quote data</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Our focus is on the <em>practice</em> of empirical market microstructure. As such, we often motivate the coding choices with economic concepts. Other than that, however, readers interested in the economics underlying each metric are referred to introductory texts such as Campbell, Lo and MacKinlay (1997)<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>, Foucault, Pagano &amp; Röell (2013)<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a> and Hasbrouck (2007)<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a>.</p>
<section id="programming" class="level3">
<h3 class="anchored" data-anchor-id="programming">Programming</h3>
<p>The coding here is in R.</p>
<p>The choice of language is of course a matter of taste. When deciding on the tools to use, what is important to consider is that the data files in this field are often huge. How can we process them without crashing our laptops? The example data used in this guide are tiny, but we wrote the code to be efficient when the number of observations per day go from thousands to millions.<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a></p>
<p>Even within the world of R, there are of course different packages available to pursue the same goal. We primarily rely on <code>data.table</code>, which is a very fast package for working with the high dimensional data that characterizes microstructure. The speed benefits show when reading and sorting data, and really shine when applying functions to several groups.<a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a></p>
<p>The basic <code>data.table</code> syntax takes the form <code>DT[i, j, by]</code>, where <code>i</code> and <code>j</code> can be used to subset or reorder rows and columns much in the same way as in a <code>data.frame</code>. In addition, <code>j</code> can be used to define new variables either for the full data set or group-wise as specified in the <code>by</code> argument. We will give examples and introduce more <code>data.table</code> syntax as we go along. A more complete intro to the package can be found <a href="https://cran.r-project.org/web/packages/data.table/vignettes/datatable-intro.html">here</a>.</p>
<p>For readers following the Tidy Finance project of Scheuch et al.&nbsp;(2023)<a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a>, the <code>data.table</code> syntax can become a friction. For this reason, this guide comes in two flavors. As an alternative to <code>data.table</code>, we also show how to achieve essentially the same virtues in speed, but using the <code>tidyverse</code> syntax. The latter is based on <code>dtplyr</code>, which provides a <code>data.table</code> backend for the familiar <code>dplyr</code> package. Since the example data in this post is fairly small with around 250k rows, there are hardly any performance benefits of data.table over other packages. In practice, however, one works with billions of rows and the benefits of data.table manifest quickly.</p>
</section>
<section id="data" class="level3">
<h3 class="anchored" data-anchor-id="data">Data</h3>
<p>We use one week of quote and trade data for one stock (PRU, <a href="https://en.wikipedia.org/wiki/Prudential_plc"><em>Prudential Financial Inc.</em></a>). There is nothing special about that stock – it is chosen to be representative of large-cap stocks in general. As is typical these days, PRU is traded at several exchanges as well as off-exchange. In addition to the listing venue (London Stock Exchange, LSE), the data includes trades and quotes from the competing venue Turquoise (TQE), as well as some dark pool trades.</p>
<p>The data is loaded automatically in the scripts provided. It can also be downloaded manually <a href="http://tinyurl.com/tidymicrostructure">here</a>.</p>
<p>The data are extracted from the <em>Tick History</em> database, available from the London Stock Exchange Group (LSEG). We are grateful to LSEG for giving us permission to post the example data in the public domain. <strong>It is to be used for educational purposes only.</strong> The data set is incomplete in that it excludes quotes and trades from numerous venues where the same stock is traded. For the illustrative purpose here, however, two exchanges suffice.</p>
</section>
<section id="quote-based-liquidity" class="level1">
<h1>Quote-based liquidity</h1>
<p>The most well-known liquidity measure is probably the quoted bid-ask spread. It measures the cost of a hypothetical roundtrip trade, where an investor buys one share only to immediately sell it again. Even though such a trade is not economically sensible, the quoted spread offers a liquidity snapshot that is accessible at any time when the market is open. All that is required is the best bid and ask prices, , the highest bid price and the lowest ask price. Such data typically also come with the number of shares that is available at each price, allowing for a similar snapshot of market depth. That is, the maximum size that can be traded at the best price.</p>
<p>Quotes are expressions of interests to buy or sell securities, observable before a trading decision is made. The quotes that we access in the examples below come from limit order book (LOB) markets, but they may just as well be posted by dealers in request for quote systems, or shouted by specialists in a trading pit.</p>
<section id="quote-data-inspection-and-preparation" class="level2">
<h2 class="anchored" data-anchor-id="quote-data-inspection-and-preparation">Quote data inspection and preparation</h2>
<p>Let’s dive into it. After loading the required packages, the following code shows how to import and preview the data. We get an overview of the data by simply typing the name of the data frame in the console. It automatically abbreviates the content to show only a subset of the data.</p>
<p>The data can be downloaded directly from within <code>R</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>quotes_url <span class="ot">&lt;-</span> <span class="st">"http://tinyurl.com/pruquotes"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset" data-group="language">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true">data.table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">dtplyr</a></li></ul>
<div class="tab-content" data-group="language">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<p>To load the data we use the function ‘fread’ which is similar to <code>read.csv</code>, but much faster.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Install and load the `data.table` package</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("data.table")</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the view the quote data</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>quotes <span class="ot">&lt;-</span> <span class="fu">fread</span>(quotes_url)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The raw data looks as follows.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>quotes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           #RIC       Domain           Date-Time GMT Offset  Type Bid Price
     1:   PRU.L Market Price 2021-06-07 04:00:03          1 Quote    1450.0
     2:   PRU.L Market Price 2021-06-07 06:50:00          1 Quote    1450.0
     3:   PRU.L Market Price 2021-06-07 06:50:00          1 Quote    1450.0
     4:   PRU.L Market Price 2021-06-07 06:50:00          1 Quote    1450.0
     5:   PRU.L Market Price 2021-06-07 06:50:00          1 Quote    1450.0
    ---                                                                    
263969: PRUl.TQ Market Price 2021-06-11 15:29:59          1 Quote    1488.5
263970: PRUl.TQ Market Price 2021-06-11 15:29:59          1 Quote    1488.5
263971: PRUl.TQ Market Price 2021-06-11 15:29:59          1 Quote        NA
263972: PRUl.TQ Market Price 2021-06-11 15:30:00          1 Quote        NA
263973: PRUl.TQ Market Price 2021-06-11 15:30:00          1 Quote        NA
        Bid Size Ask Price Ask Size          Exch Time
     1:      300    1550.0      700 04:00:02.983920000
     2:     1028    1550.0      700 06:50:00.016246000
     3:     1028    1510.5     1000 06:50:00.251314000
     4:     1028    1504.5     1000 06:50:00.402760000
     5:     1028    1504.5     1009 06:50:00.547739000
    ---                                               
263969:      476    1496.0      472 15:29:59.623000000
263970:      476    1600.0      425 15:29:59.798000000
263971:       NA    1600.0      425 15:29:59.833000000
263972:       NA    1600.0      325 15:30:00.104000000
263973:       NA        NA       NA 15:30:00.104000000</code></pre>
</div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("data.table")</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("dtplyr")</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("tidyverse")</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dtplyr)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We read the data as a <code>tibble</code> using the (very fast) function <code>read_csv</code>. The call <code>lazy_dt</code> converts the tibble to a lazy <code>data.table</code> object. Lazy means that all following commands are not executed immediately but translated to <code>data.table</code> syntax first and then executed at a final stage. As a result, there should be almost no difference in execution time of the code in <code>tidyverse</code> syntax versus the <code>data.table</code> implementation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>tv_quotes <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(quotes_url, <span class="at">col_types =</span> <span class="fu">list</span>(<span class="st">`</span><span class="at">Exch Time</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">col_character</span>()))</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>tv_quotes <span class="ot">&lt;-</span> <span class="fu">lazy_dt</span>(tv_quotes)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The raw data looks as follows.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>tv_quotes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Source: local data table [263,973 x 10]
Call:   `_DT1`

  `#RIC` Domain    `Date-Time`         `GMT Offset` Type  `Bid Price` `Bid Size`
  &lt;chr&gt;  &lt;chr&gt;     &lt;dttm&gt;                     &lt;dbl&gt; &lt;chr&gt;       &lt;dbl&gt;      &lt;dbl&gt;
1 PRU.L  Market P… 2021-06-07 04:00:03            1 Quote        1450        300
2 PRU.L  Market P… 2021-06-07 06:50:00            1 Quote        1450       1028
3 PRU.L  Market P… 2021-06-07 06:50:00            1 Quote        1450       1028
4 PRU.L  Market P… 2021-06-07 06:50:00            1 Quote        1450       1028
5 PRU.L  Market P… 2021-06-07 06:50:00            1 Quote        1450       1028
6 PRU.L  Market P… 2021-06-07 06:50:05            1 Quote        1450       1035
# ℹ 263,967 more rows
# ℹ 3 more variables: `Ask Price` &lt;dbl&gt;, `Ask Size` &lt;dbl&gt;, `Exch Time` &lt;chr&gt;

# Use as.data.table()/as.data.frame()/as_tibble() to access results</code></pre>
</div>
</div>
</div>
</div>
</div>
<p>Note that we use the suffix <code>tv_</code> for every object generated using <code>tidyverse</code> syntax. This way you can execute the entire code of this guide without overwriting <code>data.table</code> objects with the <code>dtplyr</code> equivalent and vice versa.</p>
<p>The data contain four variables that describe the state of the order book (<code>Bid Price</code>, <code>Bid Size</code>, <code>Ask Price</code>, and <code>Ask Size</code>). The LOB holds orders at numerous different prices, but we only see the best price level on each side. This is sufficient for most quote-based market quality measures. We also get three variables conveying time stamps and time zone information (<code>Date-Time</code>, <code>GMT Offset</code>, and <code>Exch time</code>; discussed in detail below), and three character variables (<code>#RIC</code>, <code>Domain</code>, and <code>Type</code>).</p>
<p>Before processing the data, we rename the variables. Names containing spaces, hashes, and dashes may make sense for data vendors, but they are impractical to work with in R. Furthermore, for the order book variables, we prefer to use the term <em>depth</em> to refer to the number of shares quoted, reserving the term <em>size</em> to the number of shares changing hands in a trade.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset" data-group="language">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" role="tab" aria-controls="tabset-2-1" aria-selected="true">data.table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" role="tab" aria-controls="tabset-2-2" aria-selected="false">dtplyr</a></li></ul>
<div class="tab-content" data-group="language">
<div id="tabset-2-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-2-1-tab">
<p>The command <code>setnames</code> replaces the existing variables with our desired column names.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>raw_quote_variables <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"#RIC"</span>, <span class="st">"Date-Time"</span>, <span class="st">"GMT Offset"</span>, <span class="st">"Domain"</span>, <span class="st">"Exch Time"</span>,</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"Type"</span>, <span class="st">"Bid Price"</span>, <span class="st">"Bid Size"</span>, <span class="st">"Ask Price"</span>, <span class="st">"Ask Size"</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>new_quote_variables <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"ticker"</span>, <span class="st">"date_time"</span>, <span class="st">"gmt_offset"</span>, <span class="st">"domain"</span>, <span class="st">"exchange_time"</span>, </span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"type"</span>, <span class="st">"bid_price"</span>, <span class="st">"bid_depth"</span>, <span class="st">"ask_price"</span>, <span class="st">"ask_depth"</span>)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="fu">setnames</span>(quotes, raw_quote_variables, new_quote_variables)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-2-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>tv_quotes <span class="ot">&lt;-</span> tv_quotes<span class="sc">|&gt;</span> </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">ticker =</span> <span class="st">`</span><span class="at">#RIC</span><span class="st">`</span>,</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">domain =</span> Domain,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">date_time =</span> <span class="st">`</span><span class="at">Date-Time</span><span class="st">`</span>,</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">gmt_offset =</span> <span class="st">`</span><span class="at">GMT Offset</span><span class="st">`</span>,</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">type =</span> Type,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">bid_price =</span> <span class="st">`</span><span class="at">Bid Price</span><span class="st">`</span>, </span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">bid_depth =</span> <span class="st">`</span><span class="at">Bid Size</span><span class="st">`</span>, </span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">ask_price =</span> <span class="st">`</span><span class="at">Ask Price</span><span class="st">`</span>,</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">ask_depth =</span> <span class="st">`</span><span class="at">Ask Size</span><span class="st">`</span>,</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">exchange_time =</span> <span class="st">`</span><span class="at">Exch Time</span><span class="st">`</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lazy_dt</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p>From the output above, the character columns might look like they are the same for all rows, hence occupying more memory than necessary. The <code>data.table::table()</code> or <code>dtplyr::count()</code> functions are great to gauge the variation in categorical variables. In this case, it shows us that there is variation in the <code>ticker</code> variable. The two tickers are for the same stock, <code>PRU</code>, traded at two different exchanges, LSE and TQE. The former is more active, with 165,261 quote updates.</p>
<p>The other two character variables, <code>domain</code> and <code>type</code>, are indeed constants. We delete them to save memory.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset" data-group="language">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-3-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-1" role="tab" aria-controls="tabset-3-1" aria-selected="true">data.table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-2" role="tab" aria-controls="tabset-3-2" aria-selected="false">dtplyr</a></li></ul>
<div class="tab-content" data-group="language">
<div id="tabset-3-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-3-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Output a table of sample tickers and values of `domain` and `type`</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(quotes<span class="sc">$</span>ticker, quotes<span class="sc">$</span>type, quotes<span class="sc">$</span>domain)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>, ,  = Market Price

         
           Quote
  PRU.L   165261
  PRUl.TQ  98712</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Delete variables</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>quotes[, <span class="fu">c</span>(<span class="st">"domain"</span>, <span class="st">"type"</span>) <span class="sc">:</span><span class="er">=</span> <span class="cn">NULL</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-3-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>tv_quotes <span class="sc">|&gt;</span> </span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(ticker, type, domain)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Source: local data table [2 x 4]
Call:   `_DT2`[, .(n = .N), keyby = .(ticker, type, domain)]

  ticker  type  domain            n
  &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt;         &lt;int&gt;
1 PRU.L   Quote Market Price 165261
2 PRUl.TQ Quote Market Price  98712

# Use as.data.table()/as.data.frame()/as_tibble() to access results</code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>tv_quotes <span class="ot">&lt;-</span> tv_quotes <span class="sc">|&gt;</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>type, <span class="sc">-</span>domain)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<section id="dates" class="level3">
<h3 class="anchored" data-anchor-id="dates">Dates</h3>
<p>In the raw data, dates and times are embedded in the same variable, <code>date_time</code>, but for us it is useful to have them in separate variables. Accordingly, we now define the variable <code>date</code>.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset" data-group="language">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-4-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-1" role="tab" aria-controls="tabset-4-1" aria-selected="true">data.table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-4-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-2" role="tab" aria-controls="tabset-4-2" aria-selected="false">dtplyr</a></li></ul>
<div class="tab-content" data-group="language">
<div id="tabset-4-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-4-1-tab">
<p>Note here that the operator <code>:=</code> is used to define a new variable (<code>date</code>) within an existing <code>data.table</code>, such as <code>quotes</code> in this example. Within a <code>data.table</code>, it suffices to refer to the variable name, <code>date_time</code>, when defining the new variable. This is different to a <code>data.frame</code>, for which we would have to write <code>quotes$date_time</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Obtain dates</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>quotes[, date <span class="sc">:</span><span class="er">=</span> <span class="fu">as.Date</span>(date_time)]</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Output a table of sample dates and tickers</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(quotes<span class="sc">$</span>ticker, quotes<span class="sc">$</span>date)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         
          2021-06-07 2021-06-08 2021-06-09 2021-06-10 2021-06-11
  PRU.L        27415      38836      30962      39639      28409
  PRUl.TQ      16424      26040      18207      21170      16871</code></pre>
</div>
</div>
</div>
<div id="tabset-4-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-4-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>tv_quotes <span class="ot">&lt;-</span> tv_quotes <span class="sc">|&gt;</span> </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">as.Date</span>(date_time)) <span class="sc">|&gt;</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lazy_dt</span>()</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>tv_quotes <span class="sc">|&gt;</span> </span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(ticker, date) <span class="sc">|&gt;</span> </span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> ticker, </span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>              <span class="at">values_from =</span> n)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Source: local data table [5 x 3]
Call:   dcast(`_DT3`[, .(n = .N), keyby = .(ticker, date)], formula = date ~ 
    ticker, value.var = "n")

  date       PRU.L PRUl.TQ
  &lt;date&gt;     &lt;int&gt;   &lt;int&gt;
1 2021-06-07 27415   16424
2 2021-06-08 38836   26040
3 2021-06-09 30962   18207
4 2021-06-10 39639   21170
5 2021-06-11 28409   16871

# Use as.data.table()/as.data.frame()/as_tibble() to access results</code></pre>
</div>
</div>
</div>
</div>
</div>
<p>The table output shows that there are five trading days in the sample. The number of quote observations per stock-date varies between roughly 16,000 and 40,000. The tendency that LSE has more quotes than TQE is consistent across trading days.</p>
</section>
<section id="timestamps" class="level3">
<h3 class="anchored" data-anchor-id="timestamps">Timestamps</h3>
<p>The accuracy of timestamps is important in microstructure data. Timestamps are often matched between quote and trade data (that are not necessarily generated in the same systems), or between data from exchanges in different locations. It is thus essential to be aware of latencies that may arise due to geography or hardware, for example.</p>
<p>We have two timestamps for each observation. The <code>exchange_time</code> variable is assigned by the exchange at the time an event is recorded in the exchange matching engine. The <code>date_time</code> variable is the timestamp assigned on receipt at the data vendor, which is by definition later than the <code>exchange_time</code>. Exchanges that are located at different distances from the vendor are likely to have different reporting delays. It is then up to the researcher to determine which timestamp to rely on, and the choice may depend on the research question. In our setting, as we measure liquidity across venues, it is important that the time stamps across venues are comparable. Based on that each exchanges has strong incentives to assign accurate time stamps (to cater for low-latency participants), we choose to work with the <code>exchange_time</code> variable.</p>
<p>For US equity markets, the timestamp may reflect the matching engine time, the time when the national best bid and offer updates, or the participant timestamp. For discussions about which of these to use, see Bartlett &amp; McCrary (2019)<a href="#fn10" class="footnote-ref" id="fnref10" role="doc-noteref"><sup>10</sup></a>, Holden, Pierson &amp; Wu (2023)<a href="#fn11" class="footnote-ref" id="fnref11" role="doc-noteref"><sup>11</sup></a>, and Schwenk-Nebbe (2021)<a href="#fn12" class="footnote-ref" id="fnref12" role="doc-noteref"><sup>12</sup></a>.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset" data-group="language">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-5-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-1" role="tab" aria-controls="tabset-5-1" aria-selected="true">data.table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-5-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-5-2" role="tab" aria-controls="tabset-5-2" aria-selected="false">dtplyr</a></li></ul>
<div class="tab-content" data-group="language">
<div id="tabset-5-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-5-1-tab">
<p>When working with timestamps in microstructure applications, it is useful to convert them into a numeric format. Dedicated time formats (e.g., <code>xts</code>) are imprecise when it comes to sub-second units (see <a href="https://stackoverflow.com/questions/62366490/timestamp-r-sequence-milliseconds">here</a> and <a href="https://lubridate.tidyverse.org/reference/round_date.html">here</a>). We thus convert the timestamps to the number of seconds elapsed since midnight. For example, 8:30 am becomes 8.5 x 3,600 = 30,600, because there are 3,600 seconds per hour.</p>
<p>The code below converts <code>exchange_time</code> to numeric and adjusts it for daylight saving using the <code>gmt_offset</code> variable (which is measured in hours). Note the use of curly brackets <code>{...}</code> in the definition of the time variable, which allows us to temporarily define the variable <code>time_elements</code> within the call. Once the operation is complete, the temporary variable is automatically deleted. The variable that is retained should always be returned as a list, hence <code>list(time)</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert time stamps to numeric format, expressed in seconds past midnight</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="co"># The function `strsplit` splits a character string at the point defined by `split`</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="co"># `do.call` is a way to call a function, which in this case calls `rbind` to convert a </span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co"># list of vectors to a matrix, where each vector forms one row</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>quotes[, time <span class="sc">:</span><span class="er">=</span> {</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    time_elements <span class="ot">=</span> <span class="fu">strsplit</span>(exchange_time, <span class="at">split =</span> <span class="st">":"</span>)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    time_elements <span class="ot">=</span> <span class="fu">do.call</span>(rbind, time_elements)</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    time <span class="ot">=</span> <span class="fu">as.numeric</span>(time_elements[, <span class="dv">1</span>]) <span class="sc">*</span> <span class="dv">3600</span> <span class="sc">+</span> </span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>           <span class="fu">as.numeric</span>(time_elements[, <span class="dv">2</span>]) <span class="sc">*</span> <span class="dv">60</span> <span class="sc">+</span> </span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>           <span class="fu">as.numeric</span>(time_elements[, <span class="dv">3</span>]) <span class="sc">+</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>           gmt_offset <span class="sc">*</span> <span class="dv">3600</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(time)}]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Having made sure that dates and times are in the desired format, we can save space by dropping the raw time and date variables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>quotes[, <span class="fu">c</span>(<span class="st">"date_time"</span>, <span class="st">"exchange_time"</span>, <span class="st">"gmt_offset"</span>) <span class="sc">:</span><span class="er">=</span> <span class="cn">NULL</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-5-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-5-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>tv_quotes <span class="ot">&lt;-</span> tv_quotes <span class="sc">|&gt;</span> </span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(exchange_time, </span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"hour"</span>, <span class="st">"minute"</span>, <span class="st">"second"</span>), </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">sep=</span><span class="st">":"</span>, </span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">convert =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">time =</span> hour <span class="sc">*</span> <span class="dv">3600</span> <span class="sc">+</span> minute <span class="sc">*</span> <span class="dv">60</span> <span class="sc">+</span> second <span class="sc">+</span> gmt_offset <span class="sc">*</span> <span class="dv">3600</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Having made sure that dates and times are in the desired format, we can save space by dropping the raw time and date variables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>tv_quotes <span class="ot">&lt;-</span> tv_quotes<span class="sc">|&gt;</span> </span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(<span class="st">"date_time"</span>, <span class="st">"gmt_offset"</span>,<span class="st">"hour"</span>,<span class="st">"minute"</span>,<span class="st">"second"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</section>
<section id="prices-and-depths" class="level3">
<h3 class="anchored" data-anchor-id="prices-and-depths">Prices and depths</h3>
<p>An important feature of LOB quotes is that they remain valid until cancelled, executed or modified. Whenever there is a change to the prevailing quotes, a new quote observation is added to the data. It is irrelevant if the latest quote is from the previous millisecond or from the previous minute – it remains valid until updated. It is thus economically meaningful to forward-fill quotes that prevailed in the previous period. Trades, in contrast, are agreed upon at a fixed point in time and do not convey any information about future prices or sizes. They should not be forward-filled, see Hagströmer and Menkveld (2023)<a href="#fn13" class="footnote-ref" id="fnref13" role="doc-noteref"><sup>13</sup></a>.</p>
<p>When forward-filling quote data, it is important to restrict the procedure to the same date, stock and trading venue. For example, quotes should never be forward-filled from one day to the next, and not from one venue to another. This is ensured with the <code>by</code> argument (in <code>data.table</code>) or the <code>group_by</code> function (in <code>tidyverse</code>), which specifies that the operation is to be done <em>within</em> each combination of tickers and dates.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset" data-group="language">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-6-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-6-1" role="tab" aria-controls="tabset-6-1" aria-selected="true">data.table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-6-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-6-2" role="tab" aria-controls="tabset-6-2" aria-selected="false">dtplyr</a></li></ul>
<div class="tab-content" data-group="language">
<div id="tabset-6-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-6-1-tab">
<p>We use the <code>nafill</code> function to forward-fill, with the option <code>type = "locf"</code> (last observation carried forward) specifying the type of filling. The <code>.SD</code> inside the <code>lapply</code> command tells <code>data.table</code> to repeat the same operation for the set of variables specified by the option <code>.SDcols</code>.</p>
<p>In summary, whereas the <code>.SD</code> applies the same function across a set of variables (columns), the <code>by</code> applies it across categories of observations (rows). The same outcome could be achieved with <code>for</code> loops, but in R, that would be much slower. We discuss that further below.</p>
<p>Note here how the <code>:=</code> notation can be used to define multiple variables, using a vector of variable names on the left-hand-side and a function (in this case <code>lapply</code>) that returns a list of variables on the right-hand-side. Note also that when referring to multiple variable names within the <code>data.table</code>, they are specified as a character vector.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Forward-fill quoted prices and depths</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>lob_variables <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"bid_price"</span>, <span class="st">"bid_depth"</span>, <span class="st">"ask_price"</span>, <span class="st">"ask_depth"</span>)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>quotes[, </span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  (lob_variables) <span class="sc">:</span><span class="er">=</span> <span class="fu">lapply</span>(.SD, nafill, <span class="at">type =</span> <span class="st">"locf"</span>),    .SDcols <span class="ot">=</span> (lob_variables), </span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  by <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"ticker"</span>, <span class="st">"date"</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-6-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-6-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>tv_quotes <span class="ot">&lt;-</span> tv_quotes <span class="sc">|&gt;</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ticker, date) <span class="sc">|&gt;</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fill</span>(<span class="fu">matches</span>(<span class="st">"bid|ask"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p>When measuring market quality in continuous trading, it is common to filter out periods that may be influenced by call auctions. The LSE opens for trading with a call auction at 08:00 am, local time, and closes with another call at 4:30 pm. There is also an intraday call auction at noon, 12:00 pm. To avoid the impact of the auctions, we exclude quotes before 8:01 am and after 4:29 pm. We do <em>not</em> exclude quotes recorded around the intraday call auction, but set them as missing (<code>NA</code>). If they were instead deleted, it would give the false impression that the last observation before the excluded quotes was still valid.</p>
<p>When entering the opening hours, remember to state them for the same time zone as recorded in the data. In our case, the <code>gmt_offset</code> adjustment above makes sure that the data is stated in local (London) time.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>open_time <span class="ot">&lt;-</span> <span class="dv">8</span> <span class="sc">*</span> <span class="dv">3600</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>close_time <span class="ot">&lt;-</span> <span class="fl">16.5</span> <span class="sc">*</span> <span class="dv">3600</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>intraday_auction_time <span class="ot">&lt;-</span> <span class="dv">12</span> <span class="sc">*</span> <span class="dv">3600</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>First, we exclude quotes around the opening and closing of continuous trading. Next, we set quotes around the intraday auction to missing.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset" data-group="language">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-7-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-7-1" role="tab" aria-controls="tabset-7-1" aria-selected="true">data.table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-7-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-7-2" role="tab" aria-controls="tabset-7-2" aria-selected="false">dtplyr</a></li></ul>
<div class="tab-content" data-group="language">
<div id="tabset-7-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-7-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>quotes <span class="ot">&lt;-</span> quotes[time <span class="sc">&gt;</span> (open_time <span class="sc">+</span> <span class="dv">60</span>) <span class="sc">&amp;</span> time <span class="sc">&lt;</span> (close_time <span class="sc">-</span> <span class="dv">60</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>quotes[time <span class="sc">&gt;</span> (intraday_auction_time <span class="sc">-</span> <span class="dv">60</span>) <span class="sc">&amp;</span> time <span class="sc">&lt;</span> (intraday_auction_time <span class="sc">+</span> <span class="dv">3</span> <span class="sc">*</span> <span class="dv">60</span>), </span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  (lob_variables)] <span class="ot">&lt;-</span>  <span class="cn">NA</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-7-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-7-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>tv_quotes <span class="ot">&lt;-</span> tv_quotes <span class="sc">|&gt;</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(time <span class="sc">&gt;</span> hms<span class="sc">::</span><span class="fu">as_hms</span>(<span class="st">"08:01:00"</span>), </span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>         time <span class="sc">&lt;</span> hms<span class="sc">::</span><span class="fu">as_hms</span>(<span class="st">"16:29:00"</span>))</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>tv_quotes <span class="ot">&lt;-</span> tv_quotes <span class="sc">|&gt;</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"bid|ask"</span>), </span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>                <span class="sc">~</span><span class="fu">if_else</span>(time <span class="sc">&gt;</span> hms<span class="sc">::</span><span class="fu">as_hms</span>(<span class="st">"11:59:00"</span>) <span class="sc">&amp;</span> </span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>                         time <span class="sc">&lt;</span> hms<span class="sc">::</span><span class="fu">as_hms</span>(<span class="st">"12:03:00"</span>), <span class="cn">NA_real_</span>, .))) <span class="sc">|&gt;</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lazy_dt</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</section>
<section id="screening" class="level3">
<h3 class="anchored" data-anchor-id="screening">Screening</h3>
<p>Before turning to the market quality measurement, it is a good habit to check that the quote observations make economic sense. One way to do that is to study the variation in the bid-ask spread. The <em>nominal</em> bid-ask spread is defined as the difference between the ask price, <span class="math inline">\(P^A\)</span>, and the bid price, <span class="math inline">\(P^B\)</span>, <span class="math inline">\(\text{quoted}\_\text{spread}^{nom}= P^A - P^B\)</span>. A histogram offers a quick overview of the variation (a line plot of the prices is also useful, see Section 2.1).</p>
<p>In the output below, note that the x-axis is in units of pence (0.01 British Pounds, GBP). All quoted prices in this example data follow that convention. Note also that the bid-ask spread is strictly positive, as it should be whenever the market is open. The TQE occasionally has wider spreads than the LSE, but there are no extraordinarily large spreads. The maximum spread, GBP 0.11, corresponds to around 0.7% of the stock price.</p>
<p>Also, it is clear from the histogram that the tick size, the minimum price increment that is allowed when quoting prices, is 0.5 pence (that is, GBP 0.005). Most spreads are quoted at one or two ticks.</p>
<p>We use the package <code>ggplot2</code> to plot an histogram of the nominal quoted bid-ask spreads.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset" data-group="language">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-8-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-8-1" role="tab" aria-controls="tabset-8-1" aria-selected="true">data.table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-8-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-8-2" role="tab" aria-controls="tabset-8-2" aria-selected="false">dtplyr</a></li></ul>
<div class="tab-content" data-group="language">
<div id="tabset-8-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-8-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(quotes, </span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> ask_price <span class="sc">-</span> bid_price, <span class="at">fill =</span> ticker)) <span class="sc">+</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">100</span>) <span class="sc">+</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Histogram of nominal bid-ask spread"</span>,</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Nominal bid-ask spread (pence)"</span>,</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Count"</span>,</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1576 rows containing non-finite values (`stat_bin()`).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/unnamed-chunk-18-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="index_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="2100"></a></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-8-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-8-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>tv_quotes <span class="sc">|&gt;</span> </span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> ask_price <span class="sc">-</span> bid_price, <span class="at">fill =</span> ticker)) <span class="sc">+</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">100</span>) <span class="sc">+</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Histogram of nominal bid-ask spread"</span>,</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Nominal bid-ask spread (pence)"</span>,</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Count"</span>,</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1576 rows containing non-finite values (`stat_bin()`).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/unnamed-chunk-19-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="index_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="2100"></a></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<p>R produces a warning when plotting the nominal bid-ask spread. It mentions 1,576 rows containing “non-finite values”. The non-finite values refer either <code>NA</code>, <code>Inf</code> (infinite) or <code>-Inf</code> (negative infinite). In the timestamp section, we imposed <code>NA</code> for LOB variables during midday auction. To see if those are the cause of the warning, let’s create a histogram of the time stamps of the missing values.</p>
<p>Indeed, all missing values are around ~43,150 and ~43,350 seconds of the trading day which is the time of the midday auction (noon is <span class="math inline">\(12\times3,600=43,200\)</span> seconds past midnight). Accounting for missing spreads by plotting the histogram without <code>NA</code> removes the warning.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset" data-group="language">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-9-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-9-1" role="tab" aria-controls="tabset-9-1" aria-selected="true">data.table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-9-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-9-2" role="tab" aria-controls="tabset-9-2" aria-selected="false">dtplyr</a></li></ul>
<div class="tab-content" data-group="language">
<div id="tabset-9-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-9-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot a histogram of missing quoted spreads</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(quotes[<span class="fu">is.na</span>(ask_price <span class="sc">-</span> bid_price)], </span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">fill =</span> ticker)) <span class="sc">+</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">100</span>) <span class="sc">+</span> </span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Histogram of missing spreads"</span>,</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Time of Day (seconds past midnight)"</span>,</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Count"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/unnamed-chunk-20-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="index_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="2100"></a></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-9-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-9-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>tv_quotes <span class="sc">|&gt;</span> </span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(ask_price) <span class="sc">|</span> <span class="fu">is.na</span>(bid_price)) <span class="sc">|&gt;</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">time =</span> hms<span class="sc">::</span><span class="fu">hms</span>(time)) <span class="sc">|&gt;</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">fill =</span> ticker)) <span class="sc">+</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">100</span>) <span class="sc">+</span> </span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Histogram of missing spreads"</span>,</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Time of Day"</span>,       </span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Count"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/unnamed-chunk-21-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="index_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="2100"></a></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="liquidity-measures" class="level2">
<h2 class="anchored" data-anchor-id="liquidity-measures">Liquidity measures</h2>
<p>With all the data preparation done, we are ready for the actual liquidity measurement. For comparisons across stocks, it is useful to relate the nominal spread to the fundamental value of the security. This is done by the <em>relative</em> quoted bid-ask spread, defined as <span class="math inline">\(\text{quoted}\_\text{spread}^{rel} = (P^A - P^B)/M\)</span>, where <span class="math inline">\(M\)</span> is the midpoint (also known as the midprice; defined as the average of the best bid and the best ask prices). One can argue that the midpoint is not always representative of the fundamental value, but it has the strong advantage that it is continuously available in the quote data.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset" data-group="language">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-10-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-10-1" role="tab" aria-controls="tabset-10-1" aria-selected="true">data.table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-10-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-10-2" role="tab" aria-controls="tabset-10-2" aria-selected="false">dtplyr</a></li></ul>
<div class="tab-content" data-group="language">
<div id="tabset-10-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-10-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fundamental value</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>quotes[, midpoint <span class="sc">:</span><span class="er">=</span> (bid_price <span class="sc">+</span> ask_price) <span class="sc">/</span> <span class="dv">2</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-10-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-10-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>tv_quotes <span class="ot">&lt;-</span> tv_quotes <span class="sc">|&gt;</span> </span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">midpoint =</span> (bid_price <span class="sc">+</span> ask_price) <span class="sc">/</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p>The quoted spread can also be measured relative to the tick size. In an open market, the spread can never be below one tick. A tick refers to the tick size of a security. It is the minimum price increment a security can be quoted and traded. The tick size in the example data is half a cent at both exchanges. We refer to the average number of ticks in the bid-ask spread as the <em>tick</em> spread, <span class="math inline">\(quoted\_spread^{tic} = (P^A - P^B) / tick\_size\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>tick_size <span class="ot">&lt;-</span> <span class="fl">0.5</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Another dimension of quoted liquidity is the market depth. We measure the average depth quoted at the best bid and ask prices. It is defined as <span class="math inline">\(\text{quoted}\_\text{depth} = (Q^A + Q^B)/2\)</span>, where <span class="math inline">\(Q^A\)</span> and <span class="math inline">\(Q^B\)</span> are the depths available at the bid and ask prices.</p>
<p>In the code below, we store the liquidity measures in a new <code>data.table</code> named <code>quotes_liquidity</code>. This is because the new variables are averages, observed on a ticker-date frequency, as opposed to the tick-by-tick frequency of the <code>quotes</code> object. We multiply the quoted spread by 10,000 to express it in basis points, and divide the quoted depth by 100,000 to express it in thousand GBP.</p>
<p>The output shows that the liquidity is higher at the LSE than at the TQE. Both in nominal and relative terms, the spreads are somewhat tighter at the LSE, and there is more than three times more depth posted at the LSE.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset" data-group="language">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-11-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-11-1" role="tab" aria-controls="tabset-11-1" aria-selected="true">data.table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-11-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-11-2" role="tab" aria-controls="tabset-11-2" aria-selected="false">dtplyr</a></li></ul>
<div class="tab-content" data-group="language">
<div id="tabset-11-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-11-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Measure the average quote-based liquidity</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="co"># This step calculates the mean of each of the market quality variables, for each </span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ticker-day (as indicated in `by = c("ticker", "date")`)</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>quotes_liquidity <span class="ot">&lt;-</span> quotes[, {</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    quoted_spread <span class="ot">=</span> ask_price <span class="sc">-</span> bid_price</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">quoted_spread_nom =</span> <span class="fu">mean</span>(quoted_spread, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">quoted_spread_relative =</span> <span class="fu">mean</span>(quoted_spread <span class="sc">/</span> midpoint, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">quoted_spread_tick =</span> <span class="fu">mean</span>(quoted_spread <span class="sc">/</span> tick_size, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">quoted_depth =</span> <span class="fu">mean</span>(bid_depth <span class="sc">*</span> bid_price <span class="sc">+</span> ask_depth <span class="sc">*</span> ask_price, </span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>                             <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="dv">2</span>)},</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>    by <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"ticker"</span>, <span class="st">"date"</span>)]</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Output the liquidity measures, averaged across the five trading days for each ticker. </span></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>quotes_liquidity[, </span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">quoted_spread_nom =</span> <span class="fu">round</span>(<span class="fu">mean</span>(quoted_spread_nom), <span class="at">digits =</span> <span class="dv">2</span>),</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>         <span class="at">quoted_spread_relative =</span> <span class="fu">round</span>(<span class="fu">mean</span>(quoted_spread_relative) <span class="sc">*</span> <span class="fl">1e4</span>, <span class="at">digits =</span> <span class="dv">2</span>),</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>         <span class="at">quoted_spread_tick =</span> <span class="fu">round</span>(<span class="fu">mean</span>(quoted_spread_tick), <span class="at">digits =</span> <span class="dv">2</span>),</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>         <span class="at">quoted_depth =</span> <span class="fu">round</span>(<span class="fu">mean</span>(quoted_depth) <span class="sc">*</span> <span class="fl">1e-5</span>, <span class="at">digits =</span> <span class="dv">2</span>)), </span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>    by <span class="ot">=</span> <span class="st">"ticker"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    ticker quoted_spread_nom quoted_spread_relative quoted_spread_tick
1:   PRU.L              0.83                   5.65               1.67
2: PRUl.TQ              1.02                   6.94               2.05
   quoted_depth
1:        24.72
2:         6.65</code></pre>
</div>
</div>
</div>
<div id="tabset-11-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-11-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>tv_quotes_liquidity <span class="ot">&lt;-</span> tv_quotes <span class="sc">|&gt;</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">quoted_spread =</span> ask_price <span class="sc">-</span> bid_price) <span class="sc">|&gt;</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ticker, date) <span class="sc">|&gt;</span> </span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">quoted_spread_nom =</span> <span class="fu">mean</span>(quoted_spread, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">quoted_spread_relative =</span> <span class="fu">mean</span>(quoted_spread <span class="sc">/</span> midpoint, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> <span class="fl">1e4</span>,</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">quoted_spread_tick =</span> <span class="fu">mean</span>(quoted_spread <span class="sc">/</span> tick_size, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">quoted_depth =</span> <span class="fu">mean</span>(bid_depth <span class="sc">*</span> bid_price <span class="sc">+</span> ask_depth <span class="sc">*</span> ask_price, </span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>                                <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fl">1e-5</span>,</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>tv_quotes_liquidity <span class="sc">|&gt;</span> </span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ticker) <span class="sc">|&gt;</span></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="fu">across</span>(<span class="fu">contains</span>(<span class="st">"quoted"</span>), </span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>                   <span class="sc">~</span><span class="fu">round</span>(<span class="fu">mean</span>(.), <span class="at">digits =</span> <span class="dv">2</span>))) <span class="sc">|&gt;</span></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>ticker) <span class="sc">|&gt;</span></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> name, <span class="at">values_from =</span> value) <span class="sc">|&gt;</span> </span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 5
  ticker  quoted_depth quoted_spread_nom quoted_spread_relative
  &lt;chr&gt;          &lt;dbl&gt;             &lt;dbl&gt;                  &lt;dbl&gt;
1 PRU.L          24.7               0.83                   5.65
2 PRUl.TQ         6.65              1.02                   6.94
# ℹ 1 more variable: quoted_spread_tick &lt;dbl&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<section id="duration-weighted-liquidity" class="level3">
<h3 class="anchored" data-anchor-id="duration-weighted-liquidity">Duration-weighted liquidity</h3>
<p>The output above are straight averages, implying an assumption that all quote observations are equally important. But whereas some quotes remain valid for several minutes, many don’t last longer than a split-second. For this reason, it is common to either sample the quote data in fixed time intervals (such as at the end of each second), or to weight the observations by their duration. The duration is the time that a quote observation is in force. That is, the time elapsed until the next quote update arrives. We show the duration-weighted approach in the code below (for guidance on how to get the quotes at the end of each second, see Section 3.1).</p>
<p>Note that the <code>duration</code> variable is obtained separately for each ticker and date. Even if we are interested in the average liquidity across dates, it is important to partition by each ticker and date to avoid that duration is calculated overnight (resulting in a huge weight with negative sign, because it will be roughly the opening time minus the closing time). Except for replacing the <code>mean</code> function with the <code>weighted.mean</code>, the code below is very similar to that above.</p>
<p>In the output, we note that the differences between the duration-weighted and the equal-weighted liquidity averages are small. Nevertheless, we consider the duration-weighted average more appropriate because it is not sensitive to short-lived price and depth fluctuations.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset" data-group="language">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-12-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-12-1" role="tab" aria-controls="tabset-12-1" aria-selected="true">data.table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-12-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-12-2" role="tab" aria-controls="tabset-12-2" aria-selected="false">dtplyr</a></li></ul>
<div class="tab-content" data-group="language">
<div id="tabset-12-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-12-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate quote durations</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>quotes[, duration <span class="sc">:</span><span class="er">=</span> <span class="fu">c</span>(<span class="fu">diff</span>(time), <span class="dv">0</span>), by <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"ticker"</span>, <span class="st">"date"</span>)]</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Measure the duration-weighted average quote-based liquidity</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="co"># The specified subset excludes quotes for which no duration can be calculated</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>quotes_liquidity_dw <span class="ot">&lt;-</span> quotes[<span class="sc">!</span><span class="fu">is.na</span>(duration), {</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    quoted_spread <span class="ot">=</span> ask_price <span class="sc">-</span> bid_price</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">quoted_spread_nom =</span> <span class="fu">weighted.mean</span>(quoted_spread, </span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">w =</span> duration, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">quoted_spread_rel =</span> <span class="fu">weighted.mean</span>(quoted_spread <span class="sc">/</span> midpoint, </span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">w =</span> duration, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">quoted_spread_tic =</span> <span class="fu">weighted.mean</span>(quoted_spread <span class="sc">/</span> tick_size, </span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">w =</span> duration, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>         <span class="at">quoted_depth =</span> <span class="fu">weighted.mean</span>(bid_depth <span class="sc">*</span> bid_price <span class="sc">+</span> ask_depth <span class="sc">*</span> ask_price, </span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">w =</span> duration, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="dv">2</span>)},</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>    by <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"ticker"</span>, <span class="st">"date"</span>)]</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Output liquidity measures, averaged across the five trading days for each ticker </span></span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>quotes_liquidity_dw[, </span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">quoted_spread_nom =</span> <span class="fu">round</span>(<span class="fu">mean</span>(quoted_spread_nom), <span class="at">digits =</span> <span class="dv">2</span>),</span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>         <span class="at">quoted_spread_rel =</span> <span class="fu">round</span>(<span class="fu">mean</span>(quoted_spread_rel) <span class="sc">*</span> <span class="fl">1e4</span>, <span class="at">digits =</span> <span class="dv">2</span>),</span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>         <span class="at">quoted_spread_tic =</span> <span class="fu">round</span>(<span class="fu">mean</span>(quoted_spread_tic), <span class="at">digits =</span> <span class="dv">2</span>),</span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a>         <span class="at">quoted_depth =</span> <span class="fu">round</span>(<span class="fu">mean</span>(quoted_depth) <span class="sc">*</span> <span class="fl">1e-5</span>, <span class="at">digits =</span> <span class="dv">2</span>)), </span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>    by <span class="ot">=</span> <span class="st">"ticker"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    ticker quoted_spread_nom quoted_spread_rel quoted_spread_tic quoted_depth
1:   PRU.L              0.84              5.70              1.68        25.65
2: PRUl.TQ              0.99              6.69              1.97         7.06</code></pre>
</div>
</div>
</div>
<div id="tabset-12-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-12-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>tv_quotes <span class="ot">&lt;-</span> tv_quotes <span class="sc">|&gt;</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ticker, date) <span class="sc">|&gt;</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">duration =</span> <span class="fu">c</span>(<span class="fu">diff</span>(time), <span class="dv">0</span>)) <span class="sc">|&gt;</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>tv_quotes_liquidity <span class="ot">&lt;-</span> tv_quotes <span class="sc">|&gt;</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">quoted_spread =</span> ask_price <span class="sc">-</span> bid_price) <span class="sc">|&gt;</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ticker, date) <span class="sc">|&gt;</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">quoted_spread_nom =</span> <span class="fu">weighted.mean</span>(quoted_spread, <span class="at">w =</span> duration, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>            <span class="at">quoted_spread_relative =</span> <span class="fu">weighted.mean</span>(quoted_spread <span class="sc">/</span> midpoint, <span class="at">w =</span> duration, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> <span class="fl">1e4</span>,</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>            <span class="at">quoted_spread_tick =</span> <span class="fu">weighted.mean</span>(quoted_spread <span class="sc">/</span> tick_size, <span class="at">w =</span> duration, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>            <span class="at">quoted_depth =</span> <span class="fu">weighted.mean</span>(bid_depth <span class="sc">*</span> bid_price <span class="sc">+</span> ask_depth <span class="sc">*</span> ask_price, <span class="at">w =</span> duration, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fl">1e-5</span>,</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>tv_quotes_liquidity <span class="sc">|&gt;</span> </span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ticker) <span class="sc">|&gt;</span></span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="fu">across</span>(<span class="fu">contains</span>(<span class="st">"quoted"</span>), </span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>                   <span class="sc">~</span><span class="fu">round</span>(<span class="fu">mean</span>(.), <span class="at">digits =</span> <span class="dv">2</span>))) <span class="sc">|&gt;</span></span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>ticker) <span class="sc">|&gt;</span></span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> name, <span class="at">values_from =</span> value) <span class="sc">|&gt;</span> </span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 5
  ticker  quoted_depth quoted_spread_nom quoted_spread_relative
  &lt;chr&gt;          &lt;dbl&gt;             &lt;dbl&gt;                  &lt;dbl&gt;
1 PRU.L          25.6               0.84                   5.7 
2 PRUl.TQ         7.06              0.99                   6.69
# ℹ 1 more variable: quoted_spread_tick &lt;dbl&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="consolidated-liquidity-in-fragmented-markets" class="level2">
<h2 class="anchored" data-anchor-id="consolidated-liquidity-in-fragmented-markets">Consolidated liquidity in fragmented markets</h2>
<p>With the competition between exchanges, liquidity is dispersed across venues. For example, if there is a change to the market structure at the LSE, it is typically not sufficient to analyze liquidity at LSE alone. If liquidity is reduced at the LSE, it may simultaneously be boosted at the TQE. To assess the overall market quality, which may be most relevant for welfare, it is often necessary to consider the <em>consolidated</em> liquidity.</p>
<p>In Europe, the consolidated liquidity is sometimes referred to as the European Best Bid and Offer (EBBO). The terminology follows in the footsteps of the US market, where the <em>National</em> Best Bid and Offer (NBBO) is transmitted to the market on continuous basis. To obtain the EBBO, one needs to merge the LOB data from each relevant venue, and then determine the EBBO prices and depths. In the code below, we show step-by-step how to do that.</p>
<section id="retaining-only-the-last-quote-update-in-each-interval" class="level3">
<h3 class="anchored" data-anchor-id="retaining-only-the-last-quote-update-in-each-interval">Retaining only the last quote update in each interval</h3>
<p>Quote updates tend to cluster and it is common that several observations have identical timestamps. Multiple observations at one timestamp can be due to several investors responding to the same events, or that one market order leads to several LOB updates as it is executed against multiple limit orders. When matching quotes across venues, we need to restrict the number of observations per unit of time to one. There is no sensible way to distinguish observations with identical timestamps. In lack of a better approach, we retain the last observation in each interval.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset" data-group="language">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-13-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-13-1" role="tab" aria-controls="tabset-13-1" aria-selected="true">data.table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-13-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-13-2" role="tab" aria-controls="tabset-13-2" aria-selected="false">dtplyr</a></li></ul>
<div class="tab-content" data-group="language">
<div id="tabset-13-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-13-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Retain only the last observation per unit of time</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="co"># The function `duplicated` returns `TRUE` if the observation is a duplicate of another </span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="co"># observation based on the columns given in the `by` option, and `FALSE` otherwise.</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="co"># The option `fromLast = TRUE` ensures that the last rather than the first observation </span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="co"># in each millisecond that returns `FALSE`.</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>quotes <span class="ot">&lt;-</span> quotes[<span class="sc">!</span><span class="fu">duplicated</span>(quotes, <span class="at">fromLast =</span> <span class="cn">TRUE</span>, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ticker"</span>, <span class="st">"date"</span>, <span class="st">"time"</span>))]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-13-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-13-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>tv_quotes <span class="ot">&lt;-</span> tv_quotes <span class="sc">|&gt;</span> </span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ticker, date, time) <span class="sc">|&gt;</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="fu">n</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lazy_dt</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</section>
<section id="merging-quotes-from-different-venues" class="level3">
<h3 class="anchored" data-anchor-id="merging-quotes-from-different-venues">Merging quotes from different venues</h3>
<p>We are now ready to match the quotes from the two exchanges. First, we create separate quote data sets for the two exchanges. Second, we merge the two by matching on date and time. Third, we forward-fill quotes from both venues, such that for each LSE quote we know the prevailing TQE quote, and vice versa. The validity of this is ensured by the option <code>sort = TRUE</code> in the <code>merge</code> function, which returns a data.table that is sorted on the matching variables.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset" data-group="language">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-14-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-14-1" role="tab" aria-controls="tabset-14-1" aria-selected="true">data.table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-14-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-14-2" role="tab" aria-controls="tabset-14-2" aria-selected="false">dtplyr</a></li></ul>
<div class="tab-content" data-group="language">
<div id="tabset-14-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-14-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge quotes from two venues trading the same security</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="co"># In the `merge` function, we add exchange suffixes to the variable names to keep track of </span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="co"># which quote comes from which exchange, using the option `suffixes`. </span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a><span class="co"># The option `all = TRUE` specifies that unmatched observations from both sets of quotes </span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="co"># should be retained (known as an outer join). </span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>venues <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"_lse"</span>, <span class="st">"_tqe"</span>)</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>quotes_lse <span class="ot">&lt;-</span> quotes[ticker <span class="sc">==</span> <span class="st">"PRU.L"</span>, .SD, .SDcols <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"date"</span>, <span class="st">"time"</span>, lob_variables)]</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>quotes_tqe <span class="ot">&lt;-</span> quotes[ticker <span class="sc">==</span> <span class="st">"PRUl.TQ"</span>, .SD, .SDcols <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"date"</span>, <span class="st">"time"</span>, lob_variables)]</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>quotes_ebbo <span class="ot">&lt;-</span> <span class="fu">merge</span>(quotes_lse, quotes_tqe, </span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>                     <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"date"</span>, <span class="st">"time"</span>), </span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>                     <span class="at">suffixes =</span> venues, </span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>                     <span class="at">all =</span> <span class="cn">TRUE</span>, <span class="at">sort =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, we forward-fill the quoted prices and depth for each exchange.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>local_lob_variables <span class="ot">&lt;-</span> <span class="fu">paste0</span>(lob_variables, <span class="fu">rep</span>(venues, <span class="at">each =</span> <span class="dv">4</span>))</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>quotes_ebbo[, (local_lob_variables) <span class="sc">:</span><span class="er">=</span> <span class="fu">lapply</span>(.SD, nafill, <span class="at">type =</span> <span class="st">"locf"</span>), </span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>  .SDcols <span class="ot">=</span> (local_lob_variables),</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>    by <span class="ot">=</span> <span class="st">"date"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-14-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-14-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>tv_quotes_ebbo <span class="ot">&lt;-</span> tv_quotes <span class="sc">|&gt;</span> </span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>midpoint, <span class="sc">-</span>duration) <span class="sc">|&gt;</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ticker =</span> <span class="fu">case_when</span>(ticker <span class="sc">==</span> <span class="st">"PRUl.TQ"</span> <span class="sc">~</span> <span class="st">"tqe"</span>,</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>                            ticker <span class="sc">==</span> <span class="st">"PRU.L"</span> <span class="sc">~</span> <span class="st">"lse"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> ticker, </span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">values_from =</span> <span class="fu">matches</span>(<span class="st">"bid|ask"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(date, time)</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>tv_quotes_ebbo <span class="ot">&lt;-</span> tv_quotes_ebbo <span class="sc">|&gt;</span></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(date) <span class="sc">|&gt;</span></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fill</span>(<span class="fu">matches</span>(<span class="st">"bid|ask"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p>The best bid price at each point in time is the <em>maximum</em> of the best bid at the LSE and the best bid at the TQE. Similarly, the best ask is the <em>minimum</em> of the best ask prices at the two venues. We calculate the best bid using the parallel maxima function, <code>pmax</code>, which returns the highest value in each row. The best ask is obtained in the same way, using the parallel minima function, <code>pmin</code>.</p>
<p>Note that it would also be possible to obtain the EBBO using a <code>for</code> loop, checking row-wise which is the highest bid and lowest ask. When working with large data sets in R, however, loops become extremely slow. It is strongly encouraged to run vectorised operations for the whole column at once (like we do here), or to apply functions repeatedly to blocks of data (like we have done several times above).</p>
<p>We obtain the depth at the best prices by summing the depth of the individual venues. When doing this, we should only consider both venues at times when they are both at the best price. When the two venues have the same best bid, for example, we calculate the consolidated bid depth as the sum of the two. To code this, we use the feature that a logical variable (with values <code>FALSE</code> or <code>TRUE</code>; such as <code>bid_price_lse  == best_bid_price</code>) works as a binary variable (with values <code>0</code> or <code>1</code>) when used in multiplication.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset" data-group="language">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-15-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-15-1" role="tab" aria-controls="tabset-15-1" aria-selected="true">data.table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-15-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-15-2" role="tab" aria-controls="tabset-15-2" aria-selected="false">dtplyr</a></li></ul>
<div class="tab-content" data-group="language">
<div id="tabset-15-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-15-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Obtain the EBBO prices and depths</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>quotes_ebbo[, best_bid_price <span class="sc">:</span><span class="er">=</span> <span class="fu">pmax</span>(bid_price_lse, bid_price_tqe, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)]</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>quotes_ebbo[, best_ask_price <span class="sc">:</span><span class="er">=</span> <span class="fu">pmin</span>(ask_price_lse, ask_price_tqe, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)]</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>quotes_ebbo[, best_bid_depth <span class="sc">:</span><span class="er">=</span> bid_depth_lse <span class="sc">*</span> (bid_price_lse <span class="sc">==</span> best_bid_price) <span class="sc">+</span> </span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>              bid_depth_tqe <span class="sc">*</span> (bid_price_tqe <span class="sc">==</span> best_bid_price)]</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>quotes_ebbo[, best_ask_depth <span class="sc">:</span><span class="er">=</span> ask_depth_lse <span class="sc">*</span> (ask_price_lse <span class="sc">==</span> best_ask_price) <span class="sc">+</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>              ask_depth_tqe <span class="sc">*</span> (ask_price_tqe <span class="sc">==</span> best_ask_price)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, we drop local exchange variables and objects</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>quotes_ebbo[, (local_lob_variables) <span class="sc">:</span><span class="er">=</span> <span class="cn">NULL</span>]</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(quotes_lse, quotes_tqe, quotes, local_lob_variables)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-15-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-15-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>tv_quotes_ebbo <span class="ot">&lt;-</span> tv_quotes_ebbo <span class="sc">|&gt;</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">best_bid_price =</span> <span class="fu">pmax</span>(bid_price_lse, bid_price_tqe, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">best_ask_price =</span> <span class="fu">pmin</span>(ask_price_lse, ask_price_tqe, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">best_bid_depth =</span> bid_depth_lse <span class="sc">*</span> (bid_price_lse <span class="sc">==</span> best_bid_price) <span class="sc">+</span> </span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>         bid_depth_tqe <span class="sc">*</span> (bid_price_tqe <span class="sc">==</span> best_bid_price),</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">best_ask_depth =</span> ask_depth_lse <span class="sc">*</span> (ask_price_lse <span class="sc">==</span> best_ask_price) <span class="sc">+</span> </span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>         ask_depth_tqe <span class="sc">*</span> (ask_price_tqe <span class="sc">==</span> best_ask_price)</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, we drop local exchange variables and objects</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>tv_quotes_ebbo <span class="ot">&lt;-</span> tv_quotes_ebbo <span class="sc">|&gt;</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(date, time, <span class="fu">contains</span>(<span class="st">"best"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lazy_dt</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</section>
<section id="fundamental-value" class="level3">
<h3 class="anchored" data-anchor-id="fundamental-value">Fundamental value</h3>
<p>We can now obtain EBBO midpoints, as a proxy of fundamental value that factors in liquidity posted at multiple exchanges.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset" data-group="language">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-16-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-16-1" role="tab" aria-controls="tabset-16-1" aria-selected="true">data.table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-16-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-16-2" role="tab" aria-controls="tabset-16-2" aria-selected="false">dtplyr</a></li></ul>
<div class="tab-content" data-group="language">
<div id="tabset-16-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-16-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate EBBO midpoints</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>quotes_ebbo[, midpoint <span class="sc">:</span><span class="er">=</span> (best_bid_price <span class="sc">+</span> best_ask_price) <span class="sc">/</span> <span class="dv">2</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-16-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-16-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>tv_quotes_ebbo <span class="ot">&lt;-</span> tv_quotes_ebbo <span class="sc">|&gt;</span> </span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">midpoint =</span> (best_bid_price <span class="sc">+</span> best_ask_price) <span class="sc">/</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</section>
<section id="screening-1" class="level3">
<h3 class="anchored" data-anchor-id="screening-1">Screening</h3>
<p>As above, we check that the EBBO quotes are economically meaningful by tabulating the counts of nominal spread levels. This exercise shows us that the consolidated spread is not strictly positive. There are numerous cases of zeroes, known as <em>locked</em> quotes, and also many negatives, referred to <em>crossed</em> quotes. This is possible because orders at the LSE and the TQE are never executed against each other – it takes arbitrageurs to step in and act on crossed markets. Locked and crossed spreads are not uncommon in consolidated data. For an analysis of the incidence in US markets, see Shkilko, van Ness &amp; van Ness, 2008<a href="#fn14" class="footnote-ref" id="fnref14" role="doc-noteref"><sup>14</sup></a>.</p>
<p>It is also notable from the table that the maximum consolidated spread is 2.5, as compared to the spreads of up to 11 recorded in the single-venue analysis. By definition, the EBBO quoted spread is never wider than at the single venues.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset" data-group="language">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-17-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-17-1" role="tab" aria-controls="tabset-17-1" aria-selected="true">data.table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-17-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-17-2" role="tab" aria-controls="tabset-17-2" aria-selected="false">dtplyr</a></li></ul>
<div class="tab-content" data-group="language">
<div id="tabset-17-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-17-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Output an overview of the EBBO nominal quoted bid-ask spread </span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(quotes_ebbo<span class="sc">$</span>best_ask_price <span class="sc">-</span> quotes_ebbo<span class="sc">$</span>best_bid_price)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    -1   -0.5      0    0.5      1    1.5      2    2.5    3.5 
     2    127   6367 104351 103265   4668    637     51      1 </code></pre>
</div>
</div>
</div>
<div id="tabset-17-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-17-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>tv_quotes_ebbo <span class="sc">|&gt;</span> </span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(<span class="at">ebbo_nominal_spread =</span> best_ask_price <span class="sc">-</span> best_bid_price) <span class="sc">|&gt;</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(ebbo_nominal_spread) <span class="sc">|&gt;</span> </span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 2
  ebbo_nominal_spread      n
                &lt;dbl&gt;  &lt;int&gt;
1                -1        2
2                -0.5    127
3                 0     6367
4                 0.5 104351
5                 1   103265
6                 1.5   4668
7                 2      637
8                 2.5     51
9                 3.5      1</code></pre>
</div>
</div>
</div>
</div>
</div>
<p>Observations with locked or crossed quotes are usually excluded when measuring market quality. It is also common to exclude bid-ask spread observations that are unrealistically high. We have no such cases in this sample, but, for illustration, we include a filter that would capture spreads that relative to the share price are wider than 5%.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>threshold <span class="ot">&lt;-</span> <span class="fl">0.05</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the procedure below, we flag the problematic quotes, but we do not exclude them. If they were deleted, it would imply that the last observation before the excluded spread was still in force, which may mislead subsequent analysis.</p>
<p>The output shows that 2.90% of the quote observations are locked, while 0.06% are crossed.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset" data-group="language">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-18-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-18-1" role="tab" aria-controls="tabset-18-1" aria-selected="true">data.table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-18-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-18-2" role="tab" aria-controls="tabset-18-2" aria-selected="false">dtplyr</a></li></ul>
<div class="tab-content" data-group="language">
<div id="tabset-18-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-18-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Flag problematic consolidated quotes</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>quotes_ebbo[, <span class="fu">c</span>(<span class="st">"crossed"</span>, <span class="st">"locked"</span>, <span class="st">"large"</span>) <span class="sc">:</span><span class="er">=</span> {</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>    quoted_spread <span class="ot">=</span> (best_ask_price <span class="sc">-</span> best_bid_price)</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(quoted_spread <span class="sc">&lt;</span> <span class="dv">0</span>, quoted_spread <span class="sc">==</span> <span class="dv">0</span>, quoted_spread <span class="sc">/</span> midpoint <span class="sc">&gt;</span> threshold)}]</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Count the incidence of the consolidated quote flags</span></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>quotes_ebbo_filters  <span class="ot">&lt;-</span> quotes_ebbo[, </span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">crossed =</span> <span class="fu">mean</span>(crossed, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">locked =</span> <span class="fu">mean</span>(locked, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">large =</span> <span class="fu">mean</span>(large, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))]</span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Output the fraction of quotes that is flagged</span></span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>quotes_ebbo_filters[, </span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lapply</span>(.SD <span class="sc">*</span> <span class="dv">100</span>, round, <span class="at">digits =</span> <span class="dv">2</span>), .SDcols <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"crossed"</span>, <span class="st">"locked"</span>, <span class="st">"large"</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   crossed locked large
1:    0.06    2.9     0</code></pre>
</div>
</div>
</div>
<div id="tabset-18-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-18-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>tv_quotes_ebbo <span class="ot">&lt;-</span> tv_quotes_ebbo <span class="sc">|&gt;</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">quoted_spread =</span> best_ask_price <span class="sc">-</span> best_bid_price,</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">crossed =</span> quoted_spread <span class="sc">&lt;</span> <span class="dv">0</span>,</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">locked =</span> quoted_spread <span class="sc">==</span> <span class="dv">0</span>,</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">large =</span> quoted_spread <span class="sc">/</span> midpoint <span class="sc">&gt;</span> threshold) <span class="sc">|&gt;</span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lazy_dt</span>()</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>tv_quotes_ebbo <span class="sc">|&gt;</span></span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="fu">across</span>(<span class="fu">c</span>(crossed, locked, large), </span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>                   <span class="sc">~</span><span class="fu">round</span>(<span class="dv">100</span> <span class="sc">*</span> <span class="fu">mean</span>(.),<span class="dv">2</span>))) <span class="sc">|&gt;</span></span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  crossed locked large
    &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
1    0.06    2.9     0</code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="consolidated-liquidity-measures" class="level3">
<h3 class="anchored" data-anchor-id="consolidated-liquidity-measures">Consolidated liquidity measures</h3>
<p>We obtain duration-weighted measures of consolidated liquidity in the same way as above. The only difference here is that we subset the quotes to filter out crossed and locked markets.</p>
<p>The consolidated relative quoted bid-ask spread is 5.59 basis points, as compared to 5.70 and 6.69 basis points at LSE and TQE locally. The consolidated depth, 3.14 million GBP, is somewhat lower than the sum of the local depths seen above. This is to be expected, as some of the local depth is posted at price levels that are inferior to the EBBO.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset" data-group="language">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-19-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-19-1" role="tab" aria-controls="tabset-19-1" aria-selected="true">data.table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-19-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-19-2" role="tab" aria-controls="tabset-19-2" aria-selected="false">dtplyr</a></li></ul>
<div class="tab-content" data-group="language">
<div id="tabset-19-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-19-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Measure the duration-weighted consolidated quotes liquidity</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Because this is the EBBO, there is no variation across tickers, but different averages </span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="co"># across dates are considered</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>quotes_ebbo[, duration <span class="sc">:</span><span class="er">=</span> <span class="fu">c</span>(<span class="fu">diff</span>(time), <span class="dv">0</span>), by <span class="ot">=</span> <span class="st">"date"</span>]</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Note that the subset used here excludes crossed and locked quotes</span></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>quotes_liquidity_ebbo_dw <span class="ot">&lt;-</span> quotes_ebbo[<span class="sc">!</span>crossed <span class="sc">&amp;</span> <span class="sc">!</span>locked <span class="sc">&amp;</span> <span class="sc">!</span>large, {</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>    quoted_spread <span class="ot">=</span> best_ask_price <span class="sc">-</span> best_bid_price</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">quoted_spread_nom =</span> <span class="fu">weighted.mean</span>(quoted_spread, </span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">w =</span> duration, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">quoted_spread_relative =</span> <span class="fu">weighted.mean</span>(quoted_spread <span class="sc">/</span> midpoint, </span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">w =</span> duration, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>         <span class="at">quoted_spread_tick =</span> <span class="fu">weighted.mean</span>(quoted_spread <span class="sc">/</span> tick_size,</span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">w =</span> duration, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a>         <span class="at">quoted_depth =</span> <span class="fu">weighted.mean</span>(best_bid_depth <span class="sc">*</span> best_bid_price <span class="sc">+</span> </span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a>                                      best_ask_depth <span class="sc">*</span> best_ask_price, </span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">w =</span> duration, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="dv">2</span>)}, </span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a>    by <span class="ot">=</span> <span class="st">"date"</span>]</span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-21"><a href="#cb68-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Output the liquidity measures, averaged across the five trading days </span></span>
<span id="cb68-22"><a href="#cb68-22" aria-hidden="true" tabindex="-1"></a>quotes_liquidity_ebbo_dw[, </span>
<span id="cb68-23"><a href="#cb68-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">quoted_spread_nom =</span> <span class="fu">round</span>(<span class="fu">mean</span>(quoted_spread_nom), <span class="at">digits =</span> <span class="dv">2</span>),</span>
<span id="cb68-24"><a href="#cb68-24" aria-hidden="true" tabindex="-1"></a>         <span class="at">quoted_spread_relative =</span> <span class="fu">round</span>(<span class="fu">mean</span>(quoted_spread_relative <span class="sc">*</span> <span class="fl">1e4</span>), <span class="at">digits =</span> <span class="dv">2</span>),</span>
<span id="cb68-25"><a href="#cb68-25" aria-hidden="true" tabindex="-1"></a>         <span class="at">quoted_spread_tick =</span> <span class="fu">round</span>(<span class="fu">mean</span>(quoted_spread_tick), <span class="at">digits =</span> <span class="dv">2</span>),</span>
<span id="cb68-26"><a href="#cb68-26" aria-hidden="true" tabindex="-1"></a>         <span class="at">quoted_depth =</span> <span class="fu">round</span>(<span class="fu">mean</span>(quoted_depth <span class="sc">*</span> <span class="fl">1e-6</span>), <span class="at">digits =</span> <span class="dv">2</span>))]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   quoted_spread_nom quoted_spread_relative quoted_spread_tick quoted_depth
1:              0.82                   5.59               1.65         3.14</code></pre>
</div>
</div>
</div>
<div id="tabset-19-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-19-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>tv_quotes_ebbo <span class="ot">&lt;-</span> tv_quotes_ebbo <span class="sc">|&gt;</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(date)<span class="sc">|&gt;</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">duration =</span> <span class="fu">c</span>(<span class="fu">diff</span>(time), <span class="dv">0</span>)) <span class="sc">|&gt;</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>tv_quotes_liquidity_ebbo_dw <span class="ot">&lt;-</span> tv_quotes_ebbo <span class="sc">|&gt;</span></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(date) <span class="sc">|&gt;</span></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">quoted_spread =</span> best_ask_price <span class="sc">-</span> best_bid_price) <span class="sc">|&gt;</span></span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>crossed, <span class="sc">!</span>locked, <span class="sc">!</span>large) <span class="sc">|&gt;</span></span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">quoted_spread_nom =</span> <span class="fu">weighted.mean</span>(quoted_spread, <span class="at">w =</span> duration, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>            <span class="at">quoted_spread_relative =</span> <span class="fu">weighted.mean</span>(quoted_spread <span class="sc">/</span> midpoint, <span class="at">w =</span> duration, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> <span class="fl">1e4</span>,</span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>            <span class="at">quoted_spread_tick =</span> <span class="fu">weighted.mean</span>(quoted_spread <span class="sc">/</span> tick_size, <span class="at">w =</span> duration, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">quoted_depth =</span> <span class="fu">weighted.mean</span>(best_bid_depth <span class="sc">*</span> best_bid_price <span class="sc">+</span> best_ask_depth <span class="sc">*</span> best_ask_price, <span class="at">w =</span> duration, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fl">1e-5</span>)</span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a>tv_quotes_liquidity_ebbo_dw <span class="sc">|&gt;</span></span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="fu">across</span>(<span class="fu">contains</span>(<span class="st">"quoted"</span>), </span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a>                   <span class="sc">~</span><span class="fu">round</span>(<span class="fu">mean</span>(.), <span class="at">digits =</span> <span class="dv">2</span>))) <span class="sc">|&gt;</span></span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 4
  quoted_spread_nom quoted_spread_relative quoted_spread_tick quoted_depth
              &lt;dbl&gt;                  &lt;dbl&gt;              &lt;dbl&gt;        &lt;dbl&gt;
1              0.82                   5.59               1.65         31.4</code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="data-export" class="level2">
<h2 class="anchored" data-anchor-id="data-export">Data export</h2>
<p>As we will reuse the consolidated quotes in the applications below, we save the <code>quotes_ebbo</code> object to disk.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset" data-group="language">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-20-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-20-1" role="tab" aria-controls="tabset-20-1" aria-selected="true">data.table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-20-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-20-2" role="tab" aria-controls="tabset-20-2" aria-selected="false">dtplyr</a></li></ul>
<div class="tab-content" data-group="language">
<div id="tabset-20-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-20-1-tab">
<p>We export the consolidated quotes using <code>fwrite</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fwrite</span>(quotes_ebbo, <span class="at">file =</span> <span class="st">"quotes_ebbo.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-20-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-20-2-tab">
<p>We export the consolidated quotes using <code>write_csv</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(<span class="fu">as_tibble</span>(tv_quotes_ebbo), <span class="at">file =</span> <span class="st">"tv_quotes_ebbo.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="trade-based-liquidity" class="level1">
<h1>Trade-based liquidity</h1>
<p>A shortcoming of the quoted bid-ask spread is that it can only be measured for liquidity that is visible in the quote data. That is not always the full picture. For example, limit order books typically allow hidden liquidity, and dealers often offer price improvements on their quotes. Outside the exchanges, trades execute extensively at venues without quotes, such as dark pools. The effective bid-ask spread is a good alternative because it uses the trade price (the <em>effective</em> price) instead of the quoted price, and benchmarks it to the spread midpoint holding at the time of the trade.</p>
<p>Whenever there is a trade, the price tends to move in the direction of the trade. This is known as <em>price impact</em>, and is an aspect of market depth. Whereas the quoted depth measure above captures depth in a mechanic sense (how much can you trade without changing the price), <em>price impact</em> also captures other traders’ response to a trade. The response may be either that the LOB is refilled (if the trade is viewed as uninformative), or that liquidity is withdrawn (if the trade is viewed as a signal of more to come).</p>
<p>For the market makers, who makes a living from the bid-ask spread, price impact undermines the profits. A more relevant measure for them may be the <em>realized</em> spread, which accounts for price impact by evaluating the trade price relative to the midpoint some time later. The three trade-based liquidity measures are closely related: the realized spread equals the effective spread minus the price impact.</p>
<section id="trade-data-inspection-and-preparation" class="level2">
<h2 class="anchored" data-anchor-id="trade-data-inspection-and-preparation">Trade data inspection and preparation</h2>
<p>We load the trade data and view the data structure. The ticker, date, and time variables follow the same structure as in quotes data, so we can proceed with the same date and time transformations as above.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>trades_url <span class="ot">&lt;-</span> <span class="st">"http://tinyurl.com/prutrades"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There are three more variables: <code>Price</code>, <code>Volume</code>, and <code>MMT Classification</code>. As discussed above, we refer to the number of shares executed in a trade as “size” (we reserve the term “volume” to the sum of trade sizes in a given interval). We rename the <code>Volume</code> variable accordingly, and also alter the other variable names to make them easier to work with in R.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset" data-group="language">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-21-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-21-1" role="tab" aria-controls="tabset-21-1" aria-selected="true">data.table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-21-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-21-2" role="tab" aria-controls="tabset-21-2" aria-selected="false">dtplyr</a></li></ul>
<div class="tab-content" data-group="language">
<div id="tabset-21-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-21-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the trade data</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>trades <span class="ot">&lt;-</span> <span class="fu">fread</span>(trades_url)</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a><span class="co"># View the trade data</span></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>trades</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          #RIC       Domain           Date-Time GMT Offset  Type  Price Volume
    1:   PRU.L Market Price 2021-06-07 07:00:09          1 Trade 1481.5  11379
    2:   PRU.L Market Price 2021-06-07 07:00:12          1 Trade 1477.5    703
    3:   PRU.L Market Price 2021-06-07 07:00:12          1 Trade 1477.5    327
    4:   PRU.L Market Price 2021-06-07 07:00:12          1 Trade 1477.5    650
    5:   PRU.L Market Price 2021-06-07 07:00:12          1 Trade 1478.0    327
   ---                                                                        
34513: PRUl.TQ Market Price 2021-06-11 15:28:56          1 Trade 1492.0    315
34514: PRUl.TQ Market Price 2021-06-11 15:28:56          1 Trade 1491.5     50
34515: PRUl.TQ Market Price 2021-06-11 15:28:56          1 Trade 1491.5    170
34516: PRUl.TQ Market Price 2021-06-11 15:28:58          1 Trade 1492.0      6
34517: PRUl.TQ Market Price 2021-06-11 15:29:06          1 Trade 1492.0      9
                Exch Time MMT Classification
    1: 07:00:09.478177000     1O-------P----
    2: 07:00:12.859753000     12-------PH---
    3: 07:00:12.859753000     12-------PH---
    4: 07:00:12.859753000     12-------PH---
    5: 07:00:12.860655000     12-------PH---
   ---                                      
34513: 15:28:56.202000000     12-------PH---
34514: 15:28:56.218000000     12-------PH---
34515: 15:28:56.413000000     12-------PH---
34516: 15:28:58.062128000     32D---S--PH---
34517: 15:29:06.141081000     32D---S--PH---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Rename the variables</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>raw_trade_variables <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"#RIC"</span>, <span class="st">"Date-Time"</span>, <span class="st">"Exch Time"</span>, <span class="st">"GMT Offset"</span>, </span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"Price"</span>, <span class="st">"Volume"</span>, <span class="st">"MMT Classification"</span>)</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>new_trade_variables <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"ticker"</span>, <span class="st">"date_time"</span>, <span class="st">"exchange_time"</span>, <span class="st">"gmt_offset"</span>,</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"price"</span>, <span class="st">"size"</span>, <span class="st">"mmt"</span>)</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a><span class="fu">setnames</span>(trades,</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">old =</span> raw_trade_variables, </span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">new =</span> new_trade_variables)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, we remove the columns <code>Domain</code> and <code>Type</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>trades[, <span class="fu">c</span>(<span class="st">"Domain"</span>, <span class="st">"Type"</span>) <span class="sc">:</span><span class="er">=</span> <span class="cn">NULL</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-21-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-21-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>tv_trades <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(trades_url, <span class="at">col_types =</span> <span class="fu">list</span>(<span class="st">`</span><span class="at">Exch Time</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">col_character</span>()))</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>tv_trades <span class="ot">&lt;-</span> <span class="fu">lazy_dt</span>(tv_trades)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The raw data looks as follows.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>tv_trades</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Source: local data table [34,517 x 9]
Call:   `_DT17`

  `#RIC` Domain  `Date-Time`         `GMT Offset` Type  Price Volume `Exch Time`
  &lt;chr&gt;  &lt;chr&gt;   &lt;dttm&gt;                     &lt;dbl&gt; &lt;chr&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;      
1 PRU.L  Market… 2021-06-07 07:00:09            1 Trade 1482.  11379 07:00:09.4…
2 PRU.L  Market… 2021-06-07 07:00:12            1 Trade 1478.    703 07:00:12.8…
3 PRU.L  Market… 2021-06-07 07:00:12            1 Trade 1478.    327 07:00:12.8…
4 PRU.L  Market… 2021-06-07 07:00:12            1 Trade 1478.    650 07:00:12.8…
5 PRU.L  Market… 2021-06-07 07:00:12            1 Trade 1478     327 07:00:12.8…
6 PRU.L  Market… 2021-06-07 07:00:12            1 Trade 1478     201 07:00:12.8…
# ℹ 34,511 more rows
# ℹ 1 more variable: `MMT Classification` &lt;chr&gt;

# Use as.data.table()/as.data.frame()/as_tibble() to access results</code></pre>
</div>
</div>
<p>We rename the variables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>tv_trades <span class="ot">&lt;-</span> tv_trades <span class="sc">|&gt;</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">ticker =</span> <span class="st">`</span><span class="at">#RIC</span><span class="st">`</span>,</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">date_time =</span> <span class="st">`</span><span class="at">Date-Time</span><span class="st">`</span>,</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">gmt_offset =</span> <span class="st">`</span><span class="at">GMT Offset</span><span class="st">`</span>,</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">price =</span> Price, </span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">size =</span> Volume, </span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">exchange_time =</span> <span class="st">`</span><span class="at">Exch Time</span><span class="st">`</span>,</span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">mmt =</span> <span class="st">`</span><span class="at">MMT Classification</span><span class="st">`</span></span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(<span class="st">"Domain"</span>, <span class="st">"Type"</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<section id="dates-and-timestamps" class="level3">
<h3 class="anchored" data-anchor-id="dates-and-timestamps">Dates and timestamps</h3>
<p>As above, we filter out the first and last minute of continuous trading, as well as the minutes surrounding the intraday auction. Note here that filtered trades are excluded, not just set as missing. This is OK, because we won’t do any forward-filling for the trade data.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset" data-group="language">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-22-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-22-1" role="tab" aria-controls="tabset-22-1" aria-selected="true">data.table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-22-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-22-2" role="tab" aria-controls="tabset-22-2" aria-selected="false">dtplyr</a></li></ul>
<div class="tab-content" data-group="language">
<div id="tabset-22-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-22-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract dates</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>trades[, date <span class="sc">:</span><span class="er">=</span> <span class="fu">as.Date</span>(date_time)]</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert time stamps to numeric format, expressed in seconds past midnight</span></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>trades[, time <span class="sc">:</span><span class="er">=</span> {</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>    time_elements <span class="ot">=</span> <span class="fu">strsplit</span>(exchange_time, <span class="at">split =</span> <span class="st">":"</span>)</span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>    time_elements <span class="ot">=</span> <span class="fu">do.call</span>(rbind, time_elements)</span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>    time <span class="ot">=</span> <span class="fu">as.numeric</span>(time_elements[, <span class="dv">1</span>]) <span class="sc">*</span> <span class="dv">3600</span> <span class="sc">+</span> </span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.numeric</span>(time_elements[, <span class="dv">2</span>]) <span class="sc">*</span> <span class="dv">60</span> <span class="sc">+</span> </span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.numeric</span>(time_elements[, <span class="dv">3</span>]) <span class="sc">+</span></span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a>      gmt_offset <span class="sc">*</span> <span class="dv">3600</span></span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(time)}]</span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Delete raw time variables</span></span>
<span id="cb83-15"><a href="#cb83-15" aria-hidden="true" tabindex="-1"></a>trades[, <span class="fu">c</span>(<span class="st">"date_time"</span>, <span class="st">"exchange_time"</span>, <span class="st">"gmt_offset"</span>) <span class="sc">:</span><span class="er">=</span> <span class="cn">NULL</span>]</span>
<span id="cb83-16"><a href="#cb83-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-17"><a href="#cb83-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Retain trades from the continuous trading sessions</span></span>
<span id="cb83-18"><a href="#cb83-18" aria-hidden="true" tabindex="-1"></a>trades <span class="ot">&lt;-</span> trades[time <span class="sc">&gt;</span> (open_time <span class="sc">+</span> <span class="dv">60</span>) <span class="sc">&amp;</span> time <span class="sc">&lt;</span> (close_time <span class="sc">-</span> <span class="dv">60</span>) <span class="sc">&amp;</span> </span>
<span id="cb83-19"><a href="#cb83-19" aria-hidden="true" tabindex="-1"></a>                    (time <span class="sc">&lt;</span> (intraday_auction_time <span class="sc">-</span> <span class="dv">60</span>) <span class="sc">|</span> </span>
<span id="cb83-20"><a href="#cb83-20" aria-hidden="true" tabindex="-1"></a>                     time <span class="sc">&gt;</span> (intraday_auction_time <span class="sc">+</span> <span class="dv">3</span> <span class="sc">*</span> <span class="dv">60</span>))]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-22-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-22-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>tv_trades <span class="ot">&lt;-</span> tv_trades <span class="sc">|&gt;</span> </span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(exchange_time, </span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"hour"</span>, <span class="st">"minute"</span>, <span class="st">"second"</span>), </span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">sep=</span><span class="st">":"</span>, </span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">convert =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">as.Date</span>(date_time),</span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">time =</span> hour <span class="sc">*</span> <span class="dv">3600</span> <span class="sc">+</span> minute <span class="sc">*</span> <span class="dv">60</span> <span class="sc">+</span> second <span class="sc">+</span> gmt_offset <span class="sc">*</span> <span class="dv">3600</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Having made sure that dates and times are in the desired format, we can save space by dropping the raw time and date variables. Further, we only retain trades from the continuous trading sessions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>tv_trades <span class="ot">&lt;-</span> tv_trades<span class="sc">|&gt;</span> </span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(<span class="st">"date_time"</span>, <span class="st">"gmt_offset"</span>,<span class="st">"hour"</span>,<span class="st">"minute"</span>,<span class="st">"second"</span>))</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>tv_trades <span class="ot">&lt;-</span> tv_trades <span class="sc">|&gt;</span></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(time <span class="sc">&gt;</span> hms<span class="sc">::</span><span class="fu">as_hms</span>(<span class="st">"08:01:00"</span>), </span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>         time <span class="sc">&lt;</span> hms<span class="sc">::</span><span class="fu">as_hms</span>(<span class="st">"16:29:00"</span>),</span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>         time <span class="sc">&lt;</span> hms<span class="sc">::</span><span class="fu">as_hms</span>(<span class="st">"11:59:00"</span>) <span class="sc">|</span> time <span class="sc">&gt;</span> hms<span class="sc">::</span><span class="fu">as_hms</span>(<span class="st">"12:03:00"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lazy_dt</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</section>
<section id="trade-variables" class="level3">
<h3 class="anchored" data-anchor-id="trade-variables">Trade variables</h3>
<p>A line plot offers a good overview of price data. In the figure below, we see that the trade prices are plagued by outliers that seem to be close to zero. The out-of-sequence prices are recorded on all trading dates and at virtually all times of the day. These outliers need to be addressed before we can proceed with the analysis.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset" data-group="language">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-23-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-23-1" role="tab" aria-controls="tabset-23-1" aria-selected="true">data.table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-23-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-23-2" role="tab" aria-controls="tabset-23-2" aria-selected="false">dtplyr</a></li></ul>
<div class="tab-content" data-group="language">
<div id="tabset-23-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-23-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the trade prices</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>trades <span class="sc">|&gt;</span> </span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> price)) <span class="sc">+</span> </span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>date, <span class="at">ncol=</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Trade prices"</span>,  <span class="at">y =</span> <span class="st">"Price"</span>, <span class="at">x =</span> <span class="st">"Time (seconds past midnight)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/Trade price plot-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5"><img src="index_files/figure-html/Trade price plot-1.png" class="img-fluid figure-img" width="2100"></a></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-23-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-23-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>tv_trades <span class="sc">|&gt;</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> </span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> hms<span class="sc">::</span><span class="fu">hms</span>(time), <span class="at">y =</span> price)) <span class="sc">+</span> </span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>date, <span class="at">ncol=</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Trade prices"</span>,  <span class="at">y =</span> <span class="st">"Price"</span>, <span class="at">x =</span> <span class="st">"Time (seconds past midnight)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/unnamed-chunk-46-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6"><img src="index_files/figure-html/unnamed-chunk-46-1.png" class="img-fluid figure-img" width="2100"></a></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<p>There are various ways to handle outliers, but the best way is to understand them. In trade data sets, there is often information provided about the trade circumstances (for quote observations, such information is often sparse). In the current data set, the best piece of supporting information is the MMT code. MMT, short for Market Model Typology, is a rich set of flags reported for trades in Europe in recent years. For details, see the website of the <a href="https://www.fixtrading.org/mmt/">Fix Trading Community</a>.</p>
<p>The MMT code is a 14-character string, where each position corresponds to one flag. The first character specifies the type of market mechanism. For example, “1” tells us that the trade was recorded in an LOB market, “3” indicates dark pools, “4” is for off-book trading, and “5” is for periodic auctions. The second character indicates the trading mode, where, for example, continuous trading is indicated by “2”.</p>
<p>An overview of the populated values shows in the first column that the LOB market with continuous trading (“12”) is by far the most common combination remaining after applying the filters above, followed by dark pool continuous trading (“32”).</p>
<p>The low-priced trades are captured in the second column. All those trades are off-book, as indicated by the first digit being “4”. The second digit holds information about how the off-book trades are reported (“5” is for on-exchange, “6” is for off-exchange, and “7” indicates systematic internalisers).</p>
<div class="tabset-margin-container"></div><div class="panel-tabset" data-group="language">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-24-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-24-1" role="tab" aria-controls="tabset-24-1" aria-selected="true">data.table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-24-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-24-2" role="tab" aria-controls="tabset-24-2" aria-selected="false">dtplyr</a></li></ul>
<div class="tab-content" data-group="language">
<div id="tabset-24-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-24-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Output an overview of the MMT codes</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a><span class="co"># The function `substr` is used here to extract the first two characters of the MMT code</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(<span class="fu">substr</span>(trades[, mmt], <span class="at">start =</span> <span class="dv">1</span>, <span class="at">stop =</span> <span class="dv">2</span>), trades[, price] <span class="sc">&lt;</span> <span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    
     FALSE  TRUE
  12 27737     0
  32  3383     0
  3U   114     0
  45  1221    28
  46     0    41
  47  1023   236
  5U    88     0</code></pre>
</div>
</div>
</div>
<div id="tabset-24-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-24-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>tv_trades <span class="sc">|&gt;</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">message =</span> <span class="fu">str_extract</span>(mmt, <span class="st">"^.{2}"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">small_price =</span> price <span class="sc">&lt;</span> <span class="dv">100</span>) <span class="sc">|&gt;</span></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(message, small_price)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Source: local data table [10 x 3]
Call:   copy(`_DT18`)[, `:=`(message = str_extract(mmt, "^.{2}"))][, 
    `:=`(small_price = price &lt; 100)][, .(n = .N), keyby = .(message, 
    small_price)]

  message small_price     n
  &lt;chr&gt;   &lt;lgl&gt;       &lt;int&gt;
1 12      FALSE       27737
2 32      FALSE        3383
3 3U      FALSE         114
4 45      NA              4
5 45      FALSE        1221
6 45      TRUE           28
# ℹ 4 more rows

# Use as.data.table()/as.data.frame()/as_tibble() to access results</code></pre>
</div>
</div>
</div>
</div>
</div>
<p>In this analysis we are focusing on liquidity at the exchanges. Accordingly, we use the MMT codes to filter out trades from other trading venues. Restricting the trades to continuous trading at the exchanges, we obtain price plots that are free from outliers.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset" data-group="language">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-25-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-25-1" role="tab" aria-controls="tabset-25-1" aria-selected="true">data.table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-25-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-25-2" role="tab" aria-controls="tabset-25-2" aria-selected="false">dtplyr</a></li></ul>
<div class="tab-content" data-group="language">
<div id="tabset-25-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-25-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a subset with continuous trades only</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>LOB_continuous_trades <span class="ot">&lt;-</span> <span class="fu">substr</span>(trades[, mmt], <span class="at">start =</span> <span class="dv">1</span>, <span class="at">stop =</span> <span class="dv">2</span>) <span class="sc">==</span> <span class="st">"12"</span></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the prices of continuous trades</span></span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(trades[LOB_continuous_trades], </span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> price)) <span class="sc">+</span> </span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>date, <span class="at">ncol =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Trade prices"</span>, <span class="at">y =</span> <span class="st">"Price"</span>, <span class="at">x =</span> <span class="st">"Time (seconds past midnight)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/Trade filtering MMT plot-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7"><img src="index_files/figure-html/Trade filtering MMT plot-1.png" class="img-fluid figure-img" width="2100"></a></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-25-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-25-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>tv_trades <span class="sc">|&gt;</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">str_extract</span>(mmt, <span class="st">"^.{2}"</span>) <span class="sc">==</span> <span class="st">"12"</span>) <span class="sc">|&gt;</span></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> hms<span class="sc">::</span><span class="fu">hms</span>(time), <span class="at">y =</span> price)) <span class="sc">+</span> </span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>date, <span class="at">ncol =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Trade prices"</span>, <span class="at">y =</span> <span class="st">"Price"</span>, <span class="at">x =</span> <span class="st">"Time (seconds past midnight)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/unnamed-chunk-48-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-8"><img src="index_files/figure-html/unnamed-chunk-48-1.png" class="img-fluid figure-img" width="2100"></a></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<p>Further detective work reveals that the trade price outliers are not erroneous, they are just stated in pounds rather than in pence. This is clear because the outliers are priced 100 times lower than the other trades. Apparently, some off-exchange trades follow a different price reporting convention.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="co"># View trades with low prices</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>trades[price <span class="sc">&lt;</span> <span class="dv">100</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     ticker    price size            mmt       date     time
  1:  PRU.L 14.80000  635 47------MP---- 2021-06-07 29102.70
  2:  PRU.L 14.86625  400 45------MP---- 2021-06-07 31868.09
  3:  PRU.L 14.86062  204 45------MP---- 2021-06-07 32331.08
  4:  PRU.L 14.85125  540 45------MP---- 2021-06-07 32466.05
  5:  PRU.L 14.83875 1042 45------MP---- 2021-06-07 39062.65
 ---                                                        
301:  PRU.L 14.88500    1 47------MP---- 2021-06-11 57966.07
302:  PRU.L 14.87000  434 47------MP---- 2021-06-11 58540.00
303:  PRU.L 14.91500  870 47------MP---- 2021-06-11 59286.00
304:  PRU.L 14.92000 1463 46------MP---- 2021-06-11 59336.00
305:  PRU.L 14.92000 1463 46------MP---- 2021-06-11 59336.00</code></pre>
</div>
</div>
<p>Quirks in the data are not unusual, and if they go unnoticed they can have strong impact on the market quality measures. The take-away from the outlier analysis is that there is often an explanation for why their prices are off. It is not always as straightforward as here, but it is worthwhile to try to find out what the cause of the deviations is. Other potential explanations are that the time stamps are off (possibly due to delayed reporting) or that the pricing is not done at the market (but in accordance to some derivative contract).</p>
<p>For the analysis below, we want to focus on exchange trades. Accordingly, we filter out all trades that are not from the on-exchange continuous trading sessions.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset" data-group="language">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-26-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-26-1" role="tab" aria-controls="tabset-26-1" aria-selected="true">data.table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-26-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-26-2" role="tab" aria-controls="tabset-26-2" aria-selected="false">dtplyr</a></li></ul>
<div class="tab-content" data-group="language">
<div id="tabset-26-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-26-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Retain continuous LOB trades only</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>trades <span class="ot">&lt;-</span> trades[LOB_continuous_trades]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-26-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-26-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>tv_trades <span class="ot">&lt;-</span> tv_trades <span class="sc">|&gt;</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">str_extract</span>(mmt, <span class="st">"^.{2}"</span>) <span class="sc">==</span> <span class="st">"12"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</section>
<section id="matching-trades-to-quotes" class="level3">
<h3 class="anchored" data-anchor-id="matching-trades-to-quotes">Matching trades to quotes</h3>
<p>To evaluate the cost of trading, we want to compare the trade price to the fundamental value at the time of trade, as implied by the bid-ask quotes.</p>
<p>The objective of matching trades and quotes is to obtain the quotes that prevailed just before the trade. This is straightforward in settings where the trades and quotes are recorded at the same point, such that they are correctly sequenced. In other settings, the timestamps may need to be adjusted due to reporting latencies, or the trade size needs to be matched to changes in quoted depth (Jurkatis, 2021)<a href="#fn15" class="footnote-ref" id="fnref15" role="doc-noteref"><sup>15</sup></a>.</p>
<p>For US data, the most common approach is to match trades to the last quotes available in the millisecond or microsecond before the trade, as prescribed by Holden and Jacobsen (2014)<a href="#fn16" class="footnote-ref" id="fnref16" role="doc-noteref"><sup>16</sup></a>. There is, however, an active debate <em>which</em> timestamp to use. Several recent papers advocate the use of <em>participant</em> time stamps in trade and quote matching, see references about US timestamps above.</p>
<p>In lack of specific guidance for stocks traded in the UK, we match trades to quotes prevailing just before the trade. Based on the assumption that the combined liquidity from LSE and TQE offers the best fundamental value approximation, we match trades from all venues to the EBBO.</p>
<p>The merge function in <code>data.table</code> can be called as above by <code>merge(dt1, dt2)</code> (for two data.tables named <code>dt1</code> and <code>dt2</code>), or simply <code>dt1[dt2]</code>. We use the latter approach here because it allows us to specify what to do when the timestamps do not match exactly. The option <code>roll = TRUE</code> specifies that each observation in <code>trades</code> should be matched to the <code>quotes_ebbo</code> observation with the latest timestamp that is equal or earlier than the trade timestamp. However, we don’t want <em>equal</em> matches, because the quote observation should always be <em>before</em> the trade. To avoid matching to contemporaneous quotes, which may be updated to reflect the impact of the trade itself, we add one microsecond to the quote timestamps before running the merge function. For further understanding and illustration of the rolling join, we refer to the blog post by <a href="https://www.r-bloggers.com/2016/06/understanding-data-table-rolling-joins/">R-Bloggers</a>.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset" data-group="language">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-27-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-27-1" role="tab" aria-controls="tabset-27-1" aria-selected="true">data.table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-27-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-27-2" role="tab" aria-controls="tabset-27-2" aria-selected="false">dtplyr</a></li></ul>
<div class="tab-content" data-group="language">
<div id="tabset-27-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-27-1-tab">
<p>For the sake of completeness, you can load the EBBO quote data which we stored at an intermediate step above as follows.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>quotes_ebbo <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="at">file =</span> <span class="st">"quotes_ebbo.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Adjust quote time stamps by one microsecond</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a><span class="fu">setnames</span>(quotes_ebbo, <span class="at">old =</span> <span class="st">"time"</span>, <span class="at">new =</span> <span class="st">"quote_time"</span>)</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>quotes_ebbo[, time <span class="sc">:</span><span class="er">=</span> quote_time <span class="sc">+</span> <span class="fl">0.000001</span>]</span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort trades and quotes (this specifies the matching criteria for the merge function)</span></span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a><span class="fu">setkeyv</span>(trades, <span class="at">cols =</span> <span class="fu">c</span>(<span class="st">"date"</span>, <span class="st">"time"</span>))</span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a><span class="fu">setkeyv</span>(quotes_ebbo, <span class="at">cols =</span> <span class="fu">c</span>(<span class="st">"date"</span>, <span class="st">"time"</span>))</span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Match trades to quotes prevailing at the time of trade </span></span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a><span class="co"># The rolling is done only for the last of the matching variables, in this case "time"</span></span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a><span class="co"># `mult = "last"` specifies that if there are multiple matches with identical timestamps, </span></span>
<span id="cb99-12"><a href="#cb99-12" aria-hidden="true" tabindex="-1"></a><span class="co"># the last match is retained</span></span>
<span id="cb99-13"><a href="#cb99-13" aria-hidden="true" tabindex="-1"></a>trades <span class="ot">&lt;-</span> quotes_ebbo[trades, roll <span class="ot">=</span> <span class="cn">TRUE</span>, mult <span class="ot">=</span> <span class="st">"last"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-27-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-27-2-tab">
<p>For the sake of completeness, you can load the EBBO quote data which we stored at an intermediate step above as follows.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>tv_quotes_ebbo <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"tv_quotes_ebbo.csv"</span>)</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>tv_quotes_ebbo <span class="ot">&lt;-</span> tv_quotes_ebbo <span class="sc">|&gt;</span></span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">time =</span> time <span class="sc">+</span> <span class="fl">0.000001</span>) <span class="sc">|&gt;</span></span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(date, time) <span class="sc">|&gt;</span> </span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>()</span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a>tv_trades <span class="ot">&lt;-</span> tv_trades <span class="sc">|&gt;</span></span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(date, time) <span class="sc">|&gt;</span> </span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>()</span>
<span id="cb100-11"><a href="#cb100-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-12"><a href="#cb100-12" aria-hidden="true" tabindex="-1"></a>tv_trades <span class="ot">&lt;-</span> tv_trades <span class="sc">|&gt;</span></span>
<span id="cb100-13"><a href="#cb100-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(tv_quotes_ebbo, <span class="fu">join_by</span>(date, <span class="fu">closest</span>(time <span class="sc">&gt;=</span> time)), <span class="at">suffix =</span> <span class="fu">c</span>(<span class="st">""</span>, <span class="st">"_quotes"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb100-14"><a href="#cb100-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lazy_dt</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</section>
<section id="further-screening" class="level3">
<h3 class="anchored" data-anchor-id="further-screening">Further screening</h3>
<p>As some trades may be matched to crossed or locked quotes, another round of data screening is required. Because such quotes are not considered reliable, we do not include those trades in the liquidity measurement. Furthermore, if there are trades that could not be matched to any quotes, or that lack information on price or size, they should be excluded too.</p>
<p>The output shows that 88.5% of the trades at LSE are eligible for the liquidity analysis, and 96.8% of the trades at TQE. The criterion that drives virtually all exclusions in the sample is the locked quotes.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset" data-group="language">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-28-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-28-1" role="tab" aria-controls="tabset-28-1" aria-selected="true">data.table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-28-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-28-2" role="tab" aria-controls="tabset-28-2" aria-selected="false">dtplyr</a></li></ul>
<div class="tab-content" data-group="language">
<div id="tabset-28-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-28-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Flag trades that should be included</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>trades[, include <span class="sc">:</span><span class="er">=</span> <span class="sc">!</span>crossed <span class="sc">&amp;</span> <span class="sc">!</span>locked <span class="sc">&amp;</span> <span class="sc">!</span>large <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(size) <span class="sc">&amp;</span> size <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span>  </span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>                    <span class="sc">!</span><span class="fu">is.na</span>(price) <span class="sc">&amp;</span> price <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(midpoint) <span class="sc">&amp;</span> midpoint <span class="sc">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Report trade filtering stats</span></span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>trades_filters <span class="ot">&lt;-</span> trades[, </span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">crossed =</span> <span class="fu">mean</span>(crossed, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">locked =</span> <span class="fu">mean</span>(locked, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">large =</span> <span class="fu">mean</span>(large, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">no_price =</span> <span class="fu">mean</span>(<span class="fu">is.na</span>(price) <span class="sc">|</span> price <span class="sc">==</span> <span class="dv">0</span>),</span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">no_size =</span> <span class="fu">mean</span>(<span class="fu">is.na</span>(size) <span class="sc">|</span> size <span class="sc">==</span> <span class="dv">0</span>),</span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">no_quotes =</span> <span class="fu">mean</span>(<span class="fu">is.na</span>(midpoint) <span class="sc">|</span> midpoint <span class="sc">&lt;=</span> <span class="dv">0</span>),</span>
<span id="cb101-13"><a href="#cb101-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">included =</span> <span class="fu">mean</span>(include)), </span>
<span id="cb101-14"><a href="#cb101-14" aria-hidden="true" tabindex="-1"></a>    by <span class="ot">=</span> <span class="st">"ticker"</span>]</span>
<span id="cb101-15"><a href="#cb101-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-16"><a href="#cb101-16" aria-hidden="true" tabindex="-1"></a>trades_filters[,</span>
<span id="cb101-17"><a href="#cb101-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(.SD <span class="sc">*</span> <span class="dv">100</span>, round, <span class="at">digits =</span> <span class="dv">2</span>), </span>
<span id="cb101-18"><a href="#cb101-18" aria-hidden="true" tabindex="-1"></a>  .SDcols <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"crossed"</span>, <span class="st">"locked"</span>, <span class="st">"large"</span>, <span class="st">"no_price"</span>, <span class="st">"no_size"</span>, <span class="st">"no_quotes"</span>, <span class="st">"included"</span>),</span>
<span id="cb101-19"><a href="#cb101-19" aria-hidden="true" tabindex="-1"></a>  by <span class="ot">=</span> <span class="st">"ticker"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    ticker crossed locked large no_price no_size no_quotes included
1:   PRU.L    0.30  11.20     0        0       0      0.00    88.50
2: PRUl.TQ    0.07   3.05     0        0       0      0.02    96.85</code></pre>
</div>
</div>
</div>
<div id="tabset-28-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-28-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>tv_trades <span class="ot">&lt;-</span> tv_trades <span class="sc">|&gt;</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">include =</span> <span class="sc">!</span>crossed <span class="sc">&amp;</span> <span class="sc">!</span>locked <span class="sc">&amp;</span> <span class="sc">!</span>large <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(size) <span class="sc">&amp;</span> size <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span></span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>           <span class="sc">!</span><span class="fu">is.na</span>(price) <span class="sc">&amp;</span> price <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(midpoint) <span class="sc">&amp;</span> midpoint <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>trades_filters <span class="ot">&lt;-</span> tv_trades <span class="sc">|&gt;</span></span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ticker) <span class="sc">|&gt;</span></span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">crossed =</span> <span class="fu">mean</span>(crossed, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">locked =</span> <span class="fu">mean</span>(locked, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb103-10"><a href="#cb103-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">large =</span> <span class="fu">mean</span>(large, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb103-11"><a href="#cb103-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">no_price =</span> <span class="fu">mean</span>(<span class="fu">is.na</span>(price) <span class="sc">|</span> price <span class="sc">==</span> <span class="dv">0</span>),</span>
<span id="cb103-12"><a href="#cb103-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">no_size =</span> <span class="fu">mean</span>(<span class="fu">is.na</span>(size) <span class="sc">|</span> size <span class="sc">==</span> <span class="dv">0</span>),</span>
<span id="cb103-13"><a href="#cb103-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">no_quotes =</span> <span class="fu">mean</span>(<span class="fu">is.na</span>(midpoint) <span class="sc">|</span> midpoint <span class="sc">&lt;=</span> <span class="dv">0</span>),</span>
<span id="cb103-14"><a href="#cb103-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">included =</span> <span class="fu">mean</span>(include)</span>
<span id="cb103-15"><a href="#cb103-15" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb103-16"><a href="#cb103-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-17"><a href="#cb103-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Round percentages and display</span></span>
<span id="cb103-18"><a href="#cb103-18" aria-hidden="true" tabindex="-1"></a>trades_filters <span class="sc">|&gt;</span></span>
<span id="cb103-19"><a href="#cb103-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(crossed<span class="sc">:</span>included, <span class="sc">~</span><span class="fu">round</span>(. <span class="sc">*</span> <span class="dv">100</span>, <span class="at">digits =</span> <span class="dv">2</span>))) <span class="sc">|&gt;</span></span>
<span id="cb103-20"><a href="#cb103-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(ticker, crossed, locked, large, no_price, no_size, no_quotes, included) <span class="sc">|&gt;</span> </span>
<span id="cb103-21"><a href="#cb103-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 8
  ticker  crossed locked large no_price no_size no_quotes included
  &lt;chr&gt;     &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
1 PRU.L      0.3   11.2      0        0       0      0        88.5
2 PRUl.TQ    0.07   3.05     0        0       0      0.02     96.8</code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="direction-of-trade" class="level3">
<h3 class="anchored" data-anchor-id="direction-of-trade">Direction of trade</h3>
<p>In empirical market microstructure, we often need to determine the direction of trade. If a trade happens following a buy market order, it is said to be buyer-initiated, and vice versa.</p>
<p>The most common tool to determine the direction of trade is the algorithm prescribed by Lee and Ready (1991)<a href="#fn17" class="footnote-ref" id="fnref17" role="doc-noteref"><sup>17</sup></a>. They primarily recommend the <em>quote rule</em>, saying that a trade is buyer-initiated if the trade price is above the prevailing midpoint, and seller-initiated if it is below. When the price equals the midpoint, Lee and Ready propose the <em>tick rule</em>. It specifies that a trade is buyer-initiated (seller-initiated) if the price is higher (lower) than the closest previous trade with a different price.</p>
<p>The quote rule is straightforward to implement using the <code>sign</code> function, which returns <code>+1</code> when the price deviation from the midpoint is positive and <code>-1</code> if it is negative. The tick rule, in contrast, requires several steps of code. We create a new <code>data.table</code>, named <code>price_tick</code>, which in addition to date and time observations for each trade, indicates whether a trade is priced higher (<code>+1</code>), lower (<code>-1</code>), or the same (<code>0</code>) as the previous one. We then exclude all trades that don’t imply a price change. Finally, we merge the <code>price_tick</code> and the <code>trades</code> objects, such that each trade is associated with the latest previous price change.</p>
<p>The direction of trade can now be determined, using primarily the quote rule, and secondarily the tick rule. The output shows that, in this sample, seller-initiated trades are somewhat more common than buyer-initiated.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset" data-group="language">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-29-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-29-1" role="tab" aria-controls="tabset-29-1" aria-selected="true">data.table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-29-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-29-2" role="tab" aria-controls="tabset-29-2" aria-selected="false">dtplyr</a></li></ul>
<div class="tab-content" data-group="language">
<div id="tabset-29-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-29-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Quote rule (the trade price is compared to the midpoint at the time of the trade)</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>trades[, quote_diff <span class="sc">:</span><span class="er">=</span> <span class="fu">sign</span>(price <span class="sc">-</span> midpoint)]</span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Tick rule (each trade is matched to the closest preceding trade price change)</span></span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>price_tick <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">date =</span> trades<span class="sc">$</span>date,</span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>                         <span class="at">time =</span> trades<span class="sc">$</span>time,</span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>                         <span class="at">price_change =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="fu">sign</span>(<span class="fu">diff</span>(trades<span class="sc">$</span>price))))</span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Retain trades that imply a trade price change</span></span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a>price_tick <span class="ot">&lt;-</span> price_tick[price_change <span class="sc">!=</span> <span class="dv">0</span>]</span>
<span id="cb105-11"><a href="#cb105-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-12"><a href="#cb105-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge trades and trade price changes</span></span>
<span id="cb105-13"><a href="#cb105-13" aria-hidden="true" tabindex="-1"></a><span class="fu">setkeyv</span>(trades, <span class="fu">c</span>(<span class="st">"date"</span>, <span class="st">"time"</span>))</span>
<span id="cb105-14"><a href="#cb105-14" aria-hidden="true" tabindex="-1"></a><span class="fu">setkeyv</span>(price_tick, <span class="fu">c</span>(<span class="st">"date"</span>, <span class="st">"time"</span>))</span>
<span id="cb105-15"><a href="#cb105-15" aria-hidden="true" tabindex="-1"></a>trades <span class="ot">&lt;-</span> price_tick[trades, roll <span class="ot">=</span> <span class="cn">TRUE</span>, mult <span class="ot">=</span> <span class="st">"last"</span>]</span>
<span id="cb105-16"><a href="#cb105-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-17"><a href="#cb105-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the Lee-Ready (1991) algorithm</span></span>
<span id="cb105-18"><a href="#cb105-18" aria-hidden="true" tabindex="-1"></a>trades[, dir <span class="sc">:</span><span class="er">=</span> {</span>
<span id="cb105-19"><a href="#cb105-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 1st step: quote rule</span></span>
<span id="cb105-20"><a href="#cb105-20" aria-hidden="true" tabindex="-1"></a>  direction <span class="ot">=</span> quote_diff</span>
<span id="cb105-21"><a href="#cb105-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 2nd step: tick rule</span></span>
<span id="cb105-22"><a href="#cb105-22" aria-hidden="true" tabindex="-1"></a>  no_direction <span class="ot">=</span> <span class="fu">is.na</span>(direction) <span class="sc">|</span> direction <span class="sc">==</span> <span class="dv">0</span></span>
<span id="cb105-23"><a href="#cb105-23" aria-hidden="true" tabindex="-1"></a>    direction[no_direction] <span class="ot">=</span> price_change[no_direction] </span>
<span id="cb105-24"><a href="#cb105-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb105-25"><a href="#cb105-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(direction)},</span>
<span id="cb105-26"><a href="#cb105-26" aria-hidden="true" tabindex="-1"></a>    by <span class="ot">=</span> <span class="st">"date"</span>]</span>
<span id="cb105-27"><a href="#cb105-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-28"><a href="#cb105-28" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(trades<span class="sc">$</span>ticker, trades<span class="sc">$</span>dir)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         
             -1     1
  PRU.L   10854  8821
  PRUl.TQ  4222  3840</code></pre>
</div>
</div>
</div>
<div id="tabset-29-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-29-2-tab">
<p>First, we compute the sign of the price change based on the quote rule (the trade price is compared to the midpoint at the time of the trade).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>tv_trades <span class="ot">&lt;-</span> tv_trades <span class="sc">|&gt;</span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">quote_diff =</span> <span class="fu">sign</span>(price <span class="sc">-</span> midpoint))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Second, each trade is matched to the closest preceding trade price change.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>price_tick <span class="ot">&lt;-</span> tv_trades <span class="sc">|&gt;</span></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(date, time, <span class="at">price_change =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="fu">sign</span>(<span class="fu">diff</span>(price)))) <span class="sc">|&gt;</span></span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(price_change <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">|&gt;</span> </span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(date,time)<span class="sc">|&gt;</span> </span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="fu">n</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We merge the <code>price_tick</code> and the <code>trades</code> objects, such that each trade is associated with the latest previous price change.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>tv_trades <span class="ot">&lt;-</span> tv_trades <span class="sc">|&gt;</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span></span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(price_tick, <span class="fu">join_by</span>(date, <span class="fu">closest</span>(time<span class="sc">&gt;=</span>time)), <span class="at">suffix =</span> <span class="fu">c</span>(<span class="st">""</span>, <span class="st">"_tick"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fill</span>(price_change, <span class="at">.direction =</span> <span class="st">"up"</span>) <span class="sc">|&gt;</span></span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lazy_dt</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, we apply the Lee-Ready (1991) algorithm</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>tv_trades <span class="ot">&lt;-</span> tv_trades <span class="sc">|&gt;</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(date) <span class="sc">|&gt;</span></span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dir =</span> <span class="fu">case_when</span>(<span class="sc">!</span><span class="fu">is.na</span>(quote_diff) <span class="sc">&amp;</span> quote_diff <span class="sc">!=</span> <span class="dv">0</span> <span class="sc">~</span> quote_diff,</span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>                         <span class="cn">TRUE</span> <span class="sc">~</span> price_change)</span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lazy_dt</span>()</span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a>tv_trades <span class="sc">|&gt;</span> </span>
<span id="cb110-10"><a href="#cb110-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(ticker, dir) <span class="sc">|&gt;</span> </span>
<span id="cb110-11"><a href="#cb110-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 3
  ticker    dir     n
  &lt;chr&gt;   &lt;dbl&gt; &lt;int&gt;
1 PRU.L      -1 10854
2 PRU.L       1  8821
3 PRUl.TQ    -1  4222
4 PRUl.TQ     1  3840</code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="liquidity-measures-1" class="level2">
<h2 class="anchored" data-anchor-id="liquidity-measures-1">Liquidity measures</h2>
<section id="effective-spread" class="level3">
<h3 class="anchored" data-anchor-id="effective-spread">Effective spread</h3>
<p>The relative effective spread is defined as <span class="math inline">\(\text{effective}\_\text{spread}^{rel} = 2 D(P - M)/M\)</span>, where <span class="math inline">\(P\)</span> is the trade price and <span class="math inline">\(D\)</span> is the direction of trade. The multiplication by two is to make the effective spread comparable to the quoted spread. As is common in the literature, we use trade size weights when calculating the average effective spread. We multiply the effective spread by 10,000 to express it in basis points.</p>
<p>We also calculate the dollar volume, which is simply <span class="math inline">\(\text{dollar}\_\text{volume} = P \times \text{size}\)</span>, with <span class="math inline">\(\text{size}\)</span> denoting the trade size. The trading volume is commonly referred to as liquidity in popular press, but in academic papers it rarely used as a liquidity measure. One reason for that is that spikes in volume are usually due to news rather than liquidity shocks. We still include trading volume here, because it often included as a control variable in microstructure event studies. To express the dollar volume in million GBP, we multiply it by <span class="math inline">\(10^{-8}\)</span>.</p>
<p>Consistent with the quote-based measures, the effective spread indicates that PRU is more liquid at LSE than at TQE. The LSE effective spread is 4.18 bps, more than 25% lower than the LSE quoted spread at 5.70 bps. The large difference may be due to trades executed at prices better than visible in the LOB, the effective spreads benchmarked to the consolidated midpoint rather than the respective venue midpoint, or the calculation of the effective spread at times of trade rather than continuously throughout the day. If investors time their trades to reduce trading costs, it makes sense that the effective spread is on average lower than the quoted spread. The interested reader can find out which of these differences drive the wedge between the two measures, by altering the way the average quoted spread is obtained.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset" data-group="language">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-30-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-30-1" role="tab" aria-controls="tabset-30-1" aria-selected="true">data.table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-30-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-30-2" role="tab" aria-controls="tabset-30-2" aria-selected="false">dtplyr</a></li></ul>
<div class="tab-content" data-group="language">
<div id="tabset-30-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-30-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Measure average liquidity for each stock-day</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a><span class="co"># First order the table</span></span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a><span class="fu">setorder</span>(trades, ticker, date, time)</span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>trades_liquidity <span class="ot">&lt;-</span> trades[include <span class="sc">==</span> <span class="cn">TRUE</span>, {             </span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">effective_spread =</span> <span class="fu">weighted.mean</span>(<span class="dv">2</span> <span class="sc">*</span> dir <span class="sc">*</span> (price <span class="sc">-</span> midpoint) <span class="sc">/</span> midpoint, </span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">w =</span> size),</span>
<span id="cb112-9"><a href="#cb112-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">volume =</span> <span class="fu">sum</span>(price <span class="sc">*</span> size))</span>
<span id="cb112-10"><a href="#cb112-10" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb112-11"><a href="#cb112-11" aria-hidden="true" tabindex="-1"></a>    by <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"ticker"</span>, <span class="st">"date"</span>)]</span>
<span id="cb112-12"><a href="#cb112-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-13"><a href="#cb112-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Output liquidity measures, averaged across the five trading days for each ticker</span></span>
<span id="cb112-14"><a href="#cb112-14" aria-hidden="true" tabindex="-1"></a>trades_liquidity[, </span>
<span id="cb112-15"><a href="#cb112-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">effective_spread =</span> <span class="fu">round</span>(<span class="fu">mean</span>(effective_spread <span class="sc">*</span> <span class="fl">1e4</span>), <span class="at">digits =</span> <span class="dv">2</span>),</span>
<span id="cb112-16"><a href="#cb112-16" aria-hidden="true" tabindex="-1"></a>         <span class="at">volume =</span> <span class="fu">round</span>(<span class="fu">mean</span>(volume <span class="sc">*</span> <span class="fl">1e-8</span>), <span class="at">digits =</span> <span class="dv">2</span>)), </span>
<span id="cb112-17"><a href="#cb112-17" aria-hidden="true" tabindex="-1"></a>    by <span class="ot">=</span> <span class="st">"ticker"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    ticker effective_spread volume
1:   PRU.L             4.18  13.64
2: PRUl.TQ             4.52   3.19</code></pre>
</div>
</div>
</div>
<div id="tabset-30-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-30-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>tv_trades <span class="ot">&lt;-</span> tv_trades <span class="sc">|&gt;</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(ticker, date, time)</span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a>tv_trades_liquidity <span class="ot">&lt;-</span> tv_trades <span class="sc">|&gt;</span></span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(include <span class="sc">==</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ticker, date) <span class="sc">|&gt;</span></span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb114-8"><a href="#cb114-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">effective_spread =</span> <span class="fu">weighted.mean</span>(<span class="dv">2</span> <span class="sc">*</span> dir <span class="sc">*</span> (price <span class="sc">-</span> midpoint) <span class="sc">/</span> midpoint, <span class="at">w =</span> size),</span>
<span id="cb114-9"><a href="#cb114-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">volume =</span> <span class="fu">sum</span>(price <span class="sc">*</span> size),</span>
<span id="cb114-10"><a href="#cb114-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb114-11"><a href="#cb114-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb114-12"><a href="#cb114-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-13"><a href="#cb114-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Output liquidity measures, averaged across the five trading days for each ticker</span></span>
<span id="cb114-14"><a href="#cb114-14" aria-hidden="true" tabindex="-1"></a>tv_trades_liquidity <span class="sc">|&gt;</span></span>
<span id="cb114-15"><a href="#cb114-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ticker) <span class="sc">|&gt;</span></span>
<span id="cb114-16"><a href="#cb114-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb114-17"><a href="#cb114-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">effective_spread =</span> <span class="fu">round</span>(<span class="fu">mean</span>(effective_spread <span class="sc">*</span> <span class="fl">1e4</span>), <span class="at">digits =</span> <span class="dv">2</span>),</span>
<span id="cb114-18"><a href="#cb114-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">volume =</span> <span class="fu">round</span>(<span class="fu">mean</span>(volume <span class="sc">*</span> <span class="fl">1e-8</span>), <span class="at">digits =</span> <span class="dv">2</span>)</span>
<span id="cb114-19"><a href="#cb114-19" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb114-20"><a href="#cb114-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 3
  ticker  effective_spread volume
  &lt;chr&gt;              &lt;dbl&gt;  &lt;dbl&gt;
1 PRU.L               4.18  13.6 
2 PRUl.TQ             4.52   3.19</code></pre>
</div>
</div>
</div>
</div>
</div>
<p>Is the midpoint really a good proxy for the fundamental value of the security? Hagströmer (2021)<a href="#fn18" class="footnote-ref" id="fnref18" role="doc-noteref"><sup>18</sup></a> shows that the reliance on the midpoint introduces bias in the effective spread. The bias is because traders are more likely to buy the security when the fundamental value is closer to the ask price, and more inclined to sell when the true value is close to the bid price. To capture this, we also consider the weighted midpoint, which is a proxy that allows the true value to lie anywhere between the best bid and ask prices. It is defined as <span class="math inline">\(M_w=(P^BQ^A+P^AQ^B) / (Q^A+Q^B)\)</span>, and denoted <code>midpoint_w</code> in the code below. The weighted midpoint equals the midpoint when <span class="math inline">\(Q^A=Q^B\)</span>.</p>
<p>In line with Hagströmer (2021), we find that the weighted midpoint version of the effective spread is lower than the conventional measure. At TQE, the difference is about 15%. This is noteworthy, as it overturns the previous finding that the TQE is less liquid than the LSE. Although the quoted spread at the TQE is wider, the results indicate that the traders at TQE are better at timing their trades in accordance to the fundamental value.</p>
<p>The reason for that the choice of effective spread measure matters for PRU is that its trading is constrained by the tick size (the quoted spread is almost always one or two ticks). Stocks that are not tick-constrained tend to show smaller differences between the effective spread measures.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset" data-group="language">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-31-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-31-1" role="tab" aria-controls="tabset-31-1" aria-selected="true">data.table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-31-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-31-2" role="tab" aria-controls="tabset-31-2" aria-selected="false">dtplyr</a></li></ul>
<div class="tab-content" data-group="language">
<div id="tabset-31-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-31-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Measure average liquidity for each stock-day, including the effective spread </span></span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a><span class="co"># relative to the weighted midpoint</span></span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>trades_liquidity <span class="ot">&lt;-</span> trades[include <span class="sc">==</span> <span class="cn">TRUE</span>, {</span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>  midpoint_w <span class="ot">=</span> (best_bid_price <span class="sc">*</span> best_ask_depth <span class="sc">+</span> best_ask_price <span class="sc">*</span> best_bid_depth) <span class="sc">/</span> </span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>                 (best_ask_depth <span class="sc">+</span> best_bid_depth)</span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">effective_spread =</span> <span class="fu">weighted.mean</span>(<span class="dv">2</span> <span class="sc">*</span> dir <span class="sc">*</span> (price <span class="sc">-</span> midpoint) <span class="sc">/</span> midpoint, </span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">w =</span> size,</span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb116-9"><a href="#cb116-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">effective_spread_w =</span> <span class="fu">weighted.mean</span>(<span class="dv">2</span> <span class="sc">*</span> dir <span class="sc">*</span> (price <span class="sc">-</span> midpoint_w) <span class="sc">/</span> midpoint, </span>
<span id="cb116-10"><a href="#cb116-10" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">w =</span> size,</span>
<span id="cb116-11"><a href="#cb116-11" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">na.rm =</span> <span class="cn">TRUE</span>))},</span>
<span id="cb116-12"><a href="#cb116-12" aria-hidden="true" tabindex="-1"></a>    by <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"ticker"</span>, <span class="st">"date"</span>)]</span>
<span id="cb116-13"><a href="#cb116-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-14"><a href="#cb116-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Output liquidity measures, averaged across the five trading days for each ticker</span></span>
<span id="cb116-15"><a href="#cb116-15" aria-hidden="true" tabindex="-1"></a>trades_liquidity[, </span>
<span id="cb116-16"><a href="#cb116-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">effective_spread =</span> <span class="fu">round</span>(<span class="fu">mean</span>(effective_spread <span class="sc">*</span> <span class="fl">1e4</span>), <span class="at">digits =</span> <span class="dv">2</span>),</span>
<span id="cb116-17"><a href="#cb116-17" aria-hidden="true" tabindex="-1"></a>         <span class="at">effective_spread_w =</span> <span class="fu">round</span>(<span class="fu">mean</span>(effective_spread_w <span class="sc">*</span> <span class="fl">1e4</span>), <span class="at">digits =</span> <span class="dv">2</span>)), </span>
<span id="cb116-18"><a href="#cb116-18" aria-hidden="true" tabindex="-1"></a>    by <span class="ot">=</span> <span class="st">"ticker"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    ticker effective_spread effective_spread_w
1:   PRU.L             4.18               4.08
2: PRUl.TQ             4.52               3.94</code></pre>
</div>
</div>
</div>
<div id="tabset-31-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-31-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>tv_trades_liquidity <span class="ot">&lt;-</span> tv_trades <span class="sc">|&gt;</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(include <span class="sc">==</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ticker, date) <span class="sc">|&gt;</span></span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">midpoint_w =</span> (best_bid_price <span class="sc">*</span> best_ask_depth <span class="sc">+</span> best_ask_price <span class="sc">*</span> best_bid_depth) <span class="sc">/</span></span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>           (best_ask_depth <span class="sc">+</span> best_bid_depth)) <span class="sc">|&gt;</span></span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">effective_spread =</span> <span class="fu">weighted.mean</span>(<span class="dv">2</span> <span class="sc">*</span> dir <span class="sc">*</span> (price <span class="sc">-</span> midpoint) <span class="sc">/</span> midpoint, <span class="at">w =</span> size, </span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">effective_spread_w =</span> <span class="fu">weighted.mean</span>(<span class="dv">2</span> <span class="sc">*</span> dir <span class="sc">*</span> (price <span class="sc">-</span> midpoint_w) <span class="sc">/</span> midpoint, <span class="at">w =</span> size,</span>
<span id="cb118-10"><a href="#cb118-10" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb118-11"><a href="#cb118-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb118-12"><a href="#cb118-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb118-13"><a href="#cb118-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-14"><a href="#cb118-14" aria-hidden="true" tabindex="-1"></a>tv_trades_liquidity <span class="sc">|&gt;</span></span>
<span id="cb118-15"><a href="#cb118-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ticker) <span class="sc">|&gt;</span></span>
<span id="cb118-16"><a href="#cb118-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb118-17"><a href="#cb118-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">effective_spread =</span> <span class="fu">round</span>(<span class="fu">mean</span>(effective_spread <span class="sc">*</span> <span class="fl">1e4</span>), <span class="at">digits =</span> <span class="dv">2</span>),</span>
<span id="cb118-18"><a href="#cb118-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">effective_spread_w =</span> <span class="fu">round</span>(<span class="fu">mean</span>(effective_spread_w <span class="sc">*</span> <span class="fl">1e4</span>), <span class="at">digits =</span> <span class="dv">2</span>)</span>
<span id="cb118-19"><a href="#cb118-19" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb118-20"><a href="#cb118-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 3
  ticker  effective_spread effective_spread_w
  &lt;chr&gt;              &lt;dbl&gt;              &lt;dbl&gt;
1 PRU.L               4.18               4.08
2 PRUl.TQ             4.52               3.94</code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="price-impact-and-realized-spreads" class="level3">
<h3 class="anchored" data-anchor-id="price-impact-and-realized-spreads">Price impact and realized spreads</h3>
<p>The price impact is defined as <span class="math inline">\(\text{price}\_\text{impact}^{rel} = 2 D(M_{t+\Delta}-M)/M\)</span>, where <span class="math inline">\(M_{t+\Delta}\)</span> is the midpoint holding <span class="math inline">\(\Delta\)</span> seconds after the trade. It thus captures the signed price change following a trade.</p>
<p>The realized spread is defined as <span class="math inline">\(\text{realized}\_\text{spread}^{rel} = 2 D(P - M_{t+\Delta})/M\)</span>. Note that the price impact and the realized spread may be viewed as two components of the effective spread, as <span class="math inline">\(\text{effective}\_\text{spread}^{rel}=\text{price}\_\text{impact}^{rel}+\text{realized}\_\text{spread}^{rel}\)</span>.</p>
<p>The choice of horizon (<span class="math inline">\(\Delta\)</span>) for the price impact and realized spread is arbitrary but can be important. The most common choice has traditionally been five minutes, but in modern markets that may even exceed the holding period of short-term investors. For a detailed discussion of this parameter, see Conrad &amp; Wahal (2020).<a href="#fn19" class="footnote-ref" id="fnref19" role="doc-noteref"><sup>19</sup></a></p>
<p>The code below prepares the variables needed to calculate the realized spread and the price impact at a 60 second horizon (setting <span class="math inline">\(\Delta=60\)</span>). It loads the consolidated quotes, subtracts 60 seconds to their timestamps, and merges them with the trades. In this way, we have trades that are matched to quotes prevailing just before the trade (from the previous matching) as well as to future quotes.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset" data-group="language">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-32-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-32-1" role="tab" aria-controls="tabset-32-1" aria-selected="true">data.table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-32-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-32-2" role="tab" aria-controls="tabset-32-2" aria-selected="false">dtplyr</a></li></ul>
<div class="tab-content" data-group="language">
<div id="tabset-32-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-32-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Adjust quote time stamps by 60 seconds</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>quotes_ebbo <span class="ot">&lt;-</span> quotes_ebbo[, time <span class="sc">:</span><span class="er">=</span> quote_time <span class="sc">-</span> <span class="dv">60</span>]</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Rename variables to indicate that they correspond to quotes 1 minute after the trade</span></span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a><span class="co"># The function `paste0` adds the suffix "_1min" to each variable</span></span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a><span class="fu">setnames</span>(quotes_ebbo, </span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">old =</span> <span class="fu">c</span>(<span class="st">"midpoint"</span>, <span class="st">"crossed"</span>, <span class="st">"locked"</span>, <span class="st">"large"</span>), </span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">new =</span> <span class="fu">paste0</span>(<span class="fu">c</span>(<span class="st">"midpoint"</span>, <span class="st">"crossed"</span>, <span class="st">"locked"</span>, <span class="st">"large"</span>), <span class="st">"_1min"</span>))</span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge trades and quotes</span></span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a><span class="fu">setkeyv</span>(quotes_ebbo, <span class="at">cols =</span> <span class="fu">c</span>(<span class="st">"date"</span>, <span class="st">"time"</span>))</span>
<span id="cb120-12"><a href="#cb120-12" aria-hidden="true" tabindex="-1"></a><span class="fu">setkeyv</span>(trades, <span class="at">cols =</span> <span class="fu">c</span>(<span class="st">"date"</span>, <span class="st">"time"</span>))</span>
<span id="cb120-13"><a href="#cb120-13" aria-hidden="true" tabindex="-1"></a>trades <span class="ot">&lt;-</span> quotes_ebbo[trades, roll <span class="ot">=</span> <span class="cn">TRUE</span>, mult <span class="ot">=</span> <span class="st">"last"</span>]</span>
<span id="cb120-14"><a href="#cb120-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-15"><a href="#cb120-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Flag valid future quotes</span></span>
<span id="cb120-16"><a href="#cb120-16" aria-hidden="true" tabindex="-1"></a>trades[, include_1min <span class="sc">:</span><span class="er">=</span> <span class="sc">!</span>crossed_1min <span class="sc">&amp;</span> <span class="sc">!</span>locked_1min <span class="sc">&amp;</span> <span class="sc">!</span>large_1min]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-32-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-32-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>tv_quotes_ebbo <span class="ot">&lt;-</span> tv_quotes_ebbo <span class="sc">|&gt;</span></span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">time =</span> time <span class="sc">-</span> <span class="dv">60</span>)</span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Rename variables to indicate that they correspond to quotes 1 minute after the trade</span></span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a><span class="co"># The function `paste0` adds the suffix "_1min" to each variable</span></span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a>tv_quotes_ebbo <span class="ot">&lt;-</span> tv_quotes_ebbo <span class="sc">|&gt;</span> </span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">c</span>(midpoint, crossed, locked, large), </span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a>                <span class="sc">~</span>., </span>
<span id="cb121-9"><a href="#cb121-9" aria-hidden="true" tabindex="-1"></a>                <span class="at">.names=</span><span class="st">"{col}_1min"</span>))</span>
<span id="cb121-10"><a href="#cb121-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-11"><a href="#cb121-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge trades and quotes</span></span>
<span id="cb121-12"><a href="#cb121-12" aria-hidden="true" tabindex="-1"></a>tv_trades <span class="ot">&lt;-</span> tv_trades <span class="sc">|&gt;</span></span>
<span id="cb121-13"><a href="#cb121-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span></span>
<span id="cb121-14"><a href="#cb121-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(tv_quotes_ebbo <span class="sc">|&gt;</span> <span class="fu">select</span>(date, time, <span class="fu">contains</span>(<span class="st">"_1min"</span>)), </span>
<span id="cb121-15"><a href="#cb121-15" aria-hidden="true" tabindex="-1"></a>            <span class="fu">join_by</span>(date, <span class="fu">closest</span>(time<span class="sc">&gt;=</span>time)), <span class="at">suffix =</span> <span class="fu">c</span>(<span class="st">""</span>, <span class="st">"_quotes"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb121-16"><a href="#cb121-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(ticker, date, time) <span class="sc">|&gt;</span></span>
<span id="cb121-17"><a href="#cb121-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ticker, date) <span class="sc">|&gt;</span></span>
<span id="cb121-18"><a href="#cb121-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fill</span>(midpoint_1min, crossed_1min, locked_1min, large_1min, <span class="at">.direction =</span> <span class="st">"down"</span>)</span>
<span id="cb121-19"><a href="#cb121-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-20"><a href="#cb121-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Flag valid future quotes</span></span>
<span id="cb121-21"><a href="#cb121-21" aria-hidden="true" tabindex="-1"></a>tv_trades <span class="ot">&lt;-</span> tv_trades <span class="sc">|&gt;</span></span>
<span id="cb121-22"><a href="#cb121-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">include_1min =</span> <span class="sc">!</span>crossed_1min <span class="sc">&amp;</span> <span class="sc">!</span>locked_1min <span class="sc">&amp;</span> <span class="sc">!</span>large_1min) <span class="sc">|&gt;</span></span>
<span id="cb121-23"><a href="#cb121-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lazy_dt</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p>The next step calculates the liquidity measures. The results show that the price impact exceeds the effective spread. The realized spread is then negative, implying that liquidity providers on average lose money. How can that be? Wouldn’t the market makers who incur losses simply refrain from trading? It could be that the 60-second evaluation does not reflect the market makers’ trading horizon. More likely, perhaps, is that not all traders who post limit orders are in the market to earn the bid-ask spread. It could also be liquidity traders or informed investors who use limit orders to save on transaction costs. Relative to paying the effective spread, earning a negative realized spread may well be an attractive alternative.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset" data-group="language">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-33-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-33-1" role="tab" aria-controls="tabset-33-1" aria-selected="true">data.table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-33-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-33-2" role="tab" aria-controls="tabset-33-2" aria-selected="false">dtplyr</a></li></ul>
<div class="tab-content" data-group="language">
<div id="tabset-33-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-33-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Measure trade-based liquidity</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>effective_spread_decomposition <span class="ot">&lt;-</span> trades[include <span class="sc">&amp;</span> include_1min, {</span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">effective_spread =</span> <span class="fu">weighted.mean</span>(<span class="dv">2</span> <span class="sc">*</span> dir <span class="sc">*</span> (price <span class="sc">-</span> midpoint) <span class="sc">/</span> midpoint, </span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">w =</span> size),</span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">price_impact =</span> <span class="fu">weighted.mean</span>(<span class="dv">2</span> <span class="sc">*</span> dir <span class="sc">*</span> (midpoint_1min <span class="sc">-</span> midpoint) <span class="sc">/</span> midpoint, </span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">w =</span> size),</span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">realized_spread =</span> <span class="fu">weighted.mean</span>(<span class="dv">2</span> <span class="sc">*</span> dir <span class="sc">*</span> (price <span class="sc">-</span> midpoint_1min) <span class="sc">/</span> midpoint, </span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">w =</span> size))}, </span>
<span id="cb122-9"><a href="#cb122-9" aria-hidden="true" tabindex="-1"></a>    by <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"ticker"</span>, <span class="st">"date"</span>)]</span>
<span id="cb122-10"><a href="#cb122-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-11"><a href="#cb122-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Output the average liquidity measures</span></span>
<span id="cb122-12"><a href="#cb122-12" aria-hidden="true" tabindex="-1"></a>effective_spread_decomposition[, </span>
<span id="cb122-13"><a href="#cb122-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">effective_spread =</span> <span class="fu">round</span>(<span class="fu">mean</span>(effective_spread <span class="sc">*</span> <span class="fl">1e4</span>), <span class="at">digits =</span> <span class="dv">2</span>),</span>
<span id="cb122-14"><a href="#cb122-14" aria-hidden="true" tabindex="-1"></a>         <span class="at">price_impact =</span> <span class="fu">round</span>(<span class="fu">mean</span>(price_impact <span class="sc">*</span> <span class="fl">1e4</span>), <span class="at">digits =</span> <span class="dv">2</span>),</span>
<span id="cb122-15"><a href="#cb122-15" aria-hidden="true" tabindex="-1"></a>         <span class="at">realized_spread =</span> <span class="fu">round</span>(<span class="fu">mean</span>(realized_spread <span class="sc">*</span> <span class="fl">1e4</span>), <span class="at">digits =</span> <span class="dv">2</span>)), </span>
<span id="cb122-16"><a href="#cb122-16" aria-hidden="true" tabindex="-1"></a>    by <span class="ot">=</span> <span class="st">"ticker"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    ticker effective_spread price_impact realized_spread
1:   PRU.L             4.18         4.75           -0.57
2: PRUl.TQ             4.52         6.13           -1.61</code></pre>
</div>
</div>
</div>
<div id="tabset-33-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-33-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>tv_effective_spread_decomposition <span class="ot">&lt;-</span> tv_trades <span class="sc">|&gt;</span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(include <span class="sc">==</span> <span class="cn">TRUE</span> <span class="sc">&amp;</span> include_1min <span class="sc">==</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ticker, date) <span class="sc">|&gt;</span></span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">effective_spread =</span> <span class="fu">weighted.mean</span>(<span class="dv">2</span> <span class="sc">*</span> dir <span class="sc">*</span> (price <span class="sc">-</span> midpoint) <span class="sc">/</span> midpoint, </span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">w =</span> size),</span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">price_impact =</span> <span class="fu">weighted.mean</span>(<span class="dv">2</span> <span class="sc">*</span> dir <span class="sc">*</span> (midpoint_1min <span class="sc">-</span> midpoint) <span class="sc">/</span> midpoint, </span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">w =</span> size),</span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a>              <span class="at">realized_spread =</span> <span class="fu">weighted.mean</span>(<span class="dv">2</span> <span class="sc">*</span> dir <span class="sc">*</span> (price <span class="sc">-</span> midpoint_1min) <span class="sc">/</span> midpoint, </span>
<span id="cb124-9"><a href="#cb124-9" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">w =</span> size),</span>
<span id="cb124-10"><a href="#cb124-10" aria-hidden="true" tabindex="-1"></a>              <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb124-11"><a href="#cb124-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-12"><a href="#cb124-12" aria-hidden="true" tabindex="-1"></a>tv_effective_spread_decomposition <span class="sc">|&gt;</span></span>
<span id="cb124-13"><a href="#cb124-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ticker) <span class="sc">|&gt;</span></span>
<span id="cb124-14"><a href="#cb124-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb124-15"><a href="#cb124-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">effective_spread =</span> <span class="fu">round</span>(<span class="fu">mean</span>(effective_spread <span class="sc">*</span> <span class="fl">1e4</span>), <span class="at">digits =</span> <span class="dv">2</span>),</span>
<span id="cb124-16"><a href="#cb124-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">price_impact =</span> <span class="fu">round</span>(<span class="fu">mean</span>(price_impact <span class="sc">*</span> <span class="fl">1e4</span>), <span class="at">digits =</span> <span class="dv">2</span>),</span>
<span id="cb124-17"><a href="#cb124-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">realized_spread =</span> <span class="fu">round</span>(<span class="fu">mean</span>(realized_spread <span class="sc">*</span> <span class="fl">1e4</span>), <span class="at">digits =</span> <span class="dv">2</span>)</span>
<span id="cb124-18"><a href="#cb124-18" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb124-19"><a href="#cb124-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 4
  ticker  effective_spread price_impact realized_spread
  &lt;chr&gt;              &lt;dbl&gt;        &lt;dbl&gt;           &lt;dbl&gt;
1 PRU.L               4.18         4.75           -0.57
2 PRUl.TQ             4.52         6.13           -1.61</code></pre>
</div>
</div>
</div>
</div>
</div>
<p>The accuracy of the effective spread decomposition may be improved by replacing the midpoint by the weighted midpoint. We leave the implementation of that to the interested reader.</p>
</section>
</section>
</section>
<section id="market-efficiency" class="level1">
<h1>Market efficiency</h1>
<p>In efficient markets, future price moves are unpredictable, but it is well-known that frictions can cause deviations from that view. This insight is the starting point for measurement of the degree of market efficiency. We consider two measures, the autocorrelation of returns and the variance ratio. We also include the <em>realized volatility</em>, the mean squared returns, which is a common control variable in microstructure research.</p>
<p>For each of these measures, rather than the tick data that we worked with above, we need <em>equispaced returns</em>. That is, we want to calculate price changes between fixed points in time, such as second by second. As this does not correspond to the LOB updates, we need to transform the data to the desired frequency.</p>
<section id="equispaced-returns" class="level2">
<h2 class="anchored" data-anchor-id="equispaced-returns">Equispaced returns</h2>
<p>To get started, we again rely on the consolidated quote data. For the applications below, we drop all LOB variables except the midpoint and the filtering flags.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset" data-group="language">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-34-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-34-1" role="tab" aria-controls="tabset-34-1" aria-selected="true">data.table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-34-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-34-2" role="tab" aria-controls="tabset-34-2" aria-selected="false">dtplyr</a></li></ul>
<div class="tab-content" data-group="language">
<div id="tabset-34-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-34-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>quotes_ebbo <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="at">file =</span> <span class="st">"quotes_ebbo.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Delete variables</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>quotes_ebbo[, <span class="fu">c</span>(<span class="st">"best_bid_price"</span>, <span class="st">"best_bid_depth"</span>, <span class="st">"best_ask_price"</span>, </span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>                <span class="st">"best_ask_depth"</span>, <span class="st">"duration"</span>) <span class="sc">:</span><span class="er">=</span> <span class="cn">NULL</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-34-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-34-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>tv_quotes_ebbo <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"tv_quotes_ebbo.csv"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(date, time, midpoint, crossed, locked , large) <span class="sc">|&gt;</span></span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lazy_dt</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p>To obtain equispaced observations, we create a time grid with one observation per second. As above, we exclude the first and last minute when setting the opening and closing times. We use the <code>expand.grid</code> function to create a grid of second-by-second observations for each sample date, and then convert it to a <code>data.table</code>.</p>
<p>First we create an equispaced time grid.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>sampling_freq  <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>open_time <span class="ot">&lt;-</span> <span class="dv">8</span> <span class="sc">*</span> <span class="dv">3600</span></span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a>close_time <span class="ot">&lt;-</span> <span class="fl">16.5</span> <span class="sc">*</span> <span class="dv">3600</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The function <code>seq</code> creates a sequence of discrete numbers the <code>by</code> option defines the increment of the sequence, which is here 1 second</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>time_grid <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from =</span> open_time <span class="sc">+</span> <span class="dv">60</span>, <span class="at">to =</span> close_time <span class="sc">-</span> <span class="dv">60</span>, <span class="at">by =</span> sampling_freq)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset" data-group="language">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-35-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-35-1" role="tab" aria-controls="tabset-35-1" aria-selected="true">data.table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-35-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-35-2" role="tab" aria-controls="tabset-35-2" aria-selected="false">dtplyr</a></li></ul>
<div class="tab-content" data-group="language">
<div id="tabset-35-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-35-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Repeat the time grid for each date and sort it by date and time</span></span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>dates <span class="ot">&lt;-</span> <span class="fu">unique</span>(quotes_ebbo<span class="sc">$</span>date)</span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a>quotes_1sec <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">date =</span> dates, <span class="at">time =</span> time_grid)</span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Make it a data.table</span></span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a>quotes_1sec <span class="ot">&lt;-</span> <span class="fu">data.table</span>(quotes_1sec, <span class="at">key =</span> <span class="fu">c</span>(<span class="st">"date"</span>, <span class="st">"time"</span>))</span>
<span id="cb131-7"><a href="#cb131-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-8"><a href="#cb131-8" aria-hidden="true" tabindex="-1"></a><span class="co"># View the time grid</span></span>
<span id="cb131-9"><a href="#cb131-9" aria-hidden="true" tabindex="-1"></a>quotes_1sec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              date  time
     1: 2021-06-07 28860
     2: 2021-06-07 28861
     3: 2021-06-07 28862
     4: 2021-06-07 28863
     5: 2021-06-07 28864
    ---                 
152401: 2021-06-11 59336
152402: 2021-06-11 59337
152403: 2021-06-11 59338
152404: 2021-06-11 59339
152405: 2021-06-11 59340</code></pre>
</div>
</div>
</div>
<div id="tabset-35-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-35-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>tv_quotes_1sec <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(</span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">date =</span> tv_quotes_ebbo <span class="sc">|&gt;</span> <span class="fu">pull</span>(date) <span class="sc">|&gt;</span>  <span class="fu">unique</span>(), </span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">time =</span> time_grid</span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p>For each point in the grid, we want to find the prevailing quote. That is, the last quote update preceding or coinciding with the time in question. Because quotes are valid until cancelled, the same quote may be matched to several consecutive seconds. To avoid bid-ask bounce in the market efficiency measures, we use the midpoint rather than the bid or ask prices.</p>
<p>In the same way as we matched trades to quotes above, we use the rolling merge to match the grid times to quotes. Once the merge is done, it is straightforward to set prices that are flagged as problematic to <code>NA</code>, and to calculate returns. We use log-diff returns expressed in basis points (i.e., multiplied by 10,000).</p>
<div class="tabset-margin-container"></div><div class="panel-tabset" data-group="language">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-36-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-36-1" role="tab" aria-controls="tabset-36-1" aria-selected="true">data.table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-36-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-36-2" role="tab" aria-controls="tabset-36-2" aria-selected="false">dtplyr</a></li></ul>
<div class="tab-content" data-group="language">
<div id="tabset-36-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-36-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort the quotes</span></span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a><span class="fu">setkeyv</span>(quotes_ebbo, <span class="at">cols =</span> <span class="fu">c</span>(<span class="st">"date"</span>, <span class="st">"time"</span>))</span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge the time grid with the quotes</span></span>
<span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a>quotes_1sec <span class="ot">&lt;-</span> quotes_ebbo[quotes_1sec, roll <span class="ot">=</span> <span class="cn">TRUE</span>]</span>
<span id="cb134-6"><a href="#cb134-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-7"><a href="#cb134-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Set problematic quotes to NA</span></span>
<span id="cb134-8"><a href="#cb134-8" aria-hidden="true" tabindex="-1"></a>quotes_1sec<span class="sc">$</span>midpoint[quotes_1sec<span class="sc">$</span>crossed<span class="sc">|</span>quotes_1sec<span class="sc">$</span>locked<span class="sc">|</span> quotes_1sec<span class="sc">$</span>large] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb134-9"><a href="#cb134-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-10"><a href="#cb134-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate returns, expressed in basis points</span></span>
<span id="cb134-11"><a href="#cb134-11" aria-hidden="true" tabindex="-1"></a><span class="co"># The function `diff` returns the first difference of a time series, which in this case </span></span>
<span id="cb134-12"><a href="#cb134-12" aria-hidden="true" tabindex="-1"></a><span class="co"># is the log of the midpoint. </span></span>
<span id="cb134-13"><a href="#cb134-13" aria-hidden="true" tabindex="-1"></a><span class="co"># For each date, a leading `NA` is added to make the resulting vector fit the number of </span></span>
<span id="cb134-14"><a href="#cb134-14" aria-hidden="true" tabindex="-1"></a><span class="co"># observations in `quotes_1sec`. </span></span>
<span id="cb134-15"><a href="#cb134-15" aria-hidden="true" tabindex="-1"></a>quotes_1sec[, return <span class="sc">:</span><span class="er">=</span> <span class="fl">1e4</span> <span class="sc">*</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="fu">diff</span>(<span class="fu">log</span>(midpoint))), by <span class="ot">=</span> <span class="st">"date"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-36-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-36-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a>tv_quotes_1sec <span class="ot">&lt;-</span> tv_quotes_1sec <span class="sc">|&gt;</span> </span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(tv_quotes_ebbo <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>(), <span class="fu">join_by</span>(date, <span class="fu">closest</span>(time<span class="sc">&gt;=</span>time)), <span class="at">suffix =</span> <span class="fu">c</span>(<span class="st">""</span>, <span class="st">"_quotes"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">midpoint =</span> <span class="fu">na_if</span>(midpoint, locked<span class="sc">|</span>crossed<span class="sc">|</span>large)) <span class="sc">|&gt;</span></span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(date) <span class="sc">|&gt;</span></span>
<span id="cb135-5"><a href="#cb135-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">return =</span> <span class="fl">1e4</span> <span class="sc">*</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="fu">diff</span>(<span class="fu">log</span>(midpoint)))) <span class="sc">|&gt;</span></span>
<span id="cb135-6"><a href="#cb135-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lazy_dt</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
</section>
<section id="efficiency-and-volatility-measures" class="level2">
<h2 class="anchored" data-anchor-id="efficiency-and-volatility-measures">Efficiency and volatility measures</h2>
<section id="return-autocorrelation-and-realized-volatility" class="level3">
<h3 class="anchored" data-anchor-id="return-autocorrelation-and-realized-volatility">Return autocorrelation and realized volatility</h3>
<p>We obtain the return autocorrelation by applying the <code>cor</code> function to returns and lagged returns. The latter are generated using the <code>shift</code> function with one lag. We account for missing values by specifying the option <code>use = "complete.obs"</code>. The return autocorrelation comes out at 0.02, a very low number. This is not surprising, as the sample stock is a large firm with high trading activity – two characteristics associated with high market efficiency.</p>
<p>Realized volatility is defined as the mean of squared returns. We also obtain the return variance to be able to calculate the variance ratio below. Although their definitions differ, the realized volatility and the return variance are almost identical in this data set, 0.32. This is because the mean return is close to zero.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset" data-group="language">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-37-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-37-1" role="tab" aria-controls="tabset-37-1" aria-selected="true">data.table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-37-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-37-2" role="tab" aria-controls="tabset-37-2" aria-selected="false">dtplyr</a></li></ul>
<div class="tab-content" data-group="language">
<div id="tabset-37-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-37-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Measure market efficiency and volatility </span></span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>efficiency_1sec <span class="ot">&lt;-</span> quotes_1sec[<span class="fu">order</span>(date, time), </span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">return_corr_1sec =</span> <span class="fu">cor</span>(return, <span class="fu">shift</span>(return, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">type =</span> <span class="st">"lag"</span>), </span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a>                              <span class="at">use =</span> <span class="st">"complete.obs"</span>),</span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">realized_vol_1sec =</span> <span class="fu">mean</span>(return<span class="sc">^</span><span class="dv">2</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb136-6"><a href="#cb136-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">return_var_1sec =</span> <span class="fu">var</span>(return, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)), </span>
<span id="cb136-7"><a href="#cb136-7" aria-hidden="true" tabindex="-1"></a>    by <span class="ot">=</span> <span class="st">"date"</span>]</span>
<span id="cb136-8"><a href="#cb136-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-9"><a href="#cb136-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Output an overview of the average efficiency and volatility </span></span>
<span id="cb136-10"><a href="#cb136-10" aria-hidden="true" tabindex="-1"></a>efficiency_1sec[, </span>
<span id="cb136-11"><a href="#cb136-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">return_corr_1sec =</span> <span class="fu">round</span>(<span class="fu">mean</span>(return_corr_1sec), <span class="at">digits =</span> <span class="dv">2</span>),</span>
<span id="cb136-12"><a href="#cb136-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">realized_vol_1sec =</span> <span class="fu">round</span>(<span class="fu">mean</span>(realized_vol_1sec), <span class="at">digits =</span> <span class="dv">2</span>),</span>
<span id="cb136-13"><a href="#cb136-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">return_var_1sec =</span> <span class="fu">round</span>(<span class="fu">mean</span>(return_var_1sec), <span class="at">digits =</span> <span class="dv">2</span>))]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   return_corr_1sec realized_vol_1sec return_var_1sec
1:             0.02              0.32            0.32</code></pre>
</div>
</div>
</div>
<div id="tabset-37-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-37-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a>tv_efficiency_1sec <span class="ot">&lt;-</span> tv_quotes_1sec <span class="sc">|&gt;</span></span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(date, time) <span class="sc">|&gt;</span></span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(date) <span class="sc">|&gt;</span></span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">return_corr_1sec =</span> <span class="fu">cor</span>(return, <span class="fu">lag</span>(return), <span class="at">use =</span> <span class="st">"complete.obs"</span>),</span>
<span id="cb138-5"><a href="#cb138-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">vol_1sec =</span> <span class="fu">mean</span>(return<span class="sc">^</span><span class="dv">2</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb138-6"><a href="#cb138-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">return_var_1sec =</span> <span class="fu">var</span>(return, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb138-7"><a href="#cb138-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-8"><a href="#cb138-8" aria-hidden="true" tabindex="-1"></a>tv_efficiency_1sec <span class="sc">|&gt;</span></span>
<span id="cb138-9"><a href="#cb138-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), </span>
<span id="cb138-10"><a href="#cb138-10" aria-hidden="true" tabindex="-1"></a>                   <span class="sc">~</span><span class="fu">round</span>(<span class="fu">mean</span>(.), <span class="at">digits =</span> <span class="dv">2</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Source: local data table [1 x 4]
Call:   `_DT26`[order(date, time)][, .(return_corr_1sec = cor(return, 
    shift(return, type = "lag"), use = "complete.obs"), vol_1sec = mean(return^2, 
    na.rm = TRUE), return_var_1sec = var(return, na.rm = TRUE)), 
    keyby = .(date)][, .(date = round(mean(date), digits = 2), 
    return_corr_1sec = round(mean(return_corr_1sec), digits = 2), 
    vol_1sec = round(mean(vol_1sec), digits = 2), return_var_1sec = round(mean(return_var_1sec), 
        digits = 2))]

  date       return_corr_1sec vol_1sec return_var_1sec
  &lt;date&gt;                &lt;dbl&gt;    &lt;dbl&gt;           &lt;dbl&gt;
1 2021-06-09             0.02     0.32            0.32

# Use as.data.table()/as.data.frame()/as_tibble() to access results</code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="variance-ratios" class="level3">
<h3 class="anchored" data-anchor-id="variance-ratios">Variance ratios</h3>
<p>The variance ratio is defined as <span class="math inline">\(var\_ratio_{\tau_{1}, \tau_{2}} = (Var(R_{\tau_{1}}) \tau_2) / (Var(R_{\tau_{2}})  \tau_1)\)</span>, where <span class="math inline">\(\tau_{1}\)</span> and <span class="math inline">\(\tau_{2}\)</span> are two return sampling frequencies, and <span class="math inline">\(Var(R_{\tau_{i}})\)</span> is the variance of returns sampled at frequency <span class="math inline">\(\tau_{i}\)</span>. Under market efficiency, the variance ratio should be equal to one. Negative and positive deviations from unity are due to frictions. It is usually the absolute deviation from unity that is used as an efficiency measure.</p>
<p>We measure the variance ratio for 1-second and 10-second returns. To get the 10-second return variance, the first step is to obtain the 10-second price grid. To do so, we simply take a subset of the grid obtained for the 1-second frequency. We then proceed with the calculation of returns and the return variance in the same way as above.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a>sampling_freq <span class="ot">&lt;-</span> <span class="dv">10</span> <span class="co"># 10 second grid</span></span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a>time_grid <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from =</span> open_time <span class="sc">+</span> <span class="dv">60</span>, <span class="at">to =</span> close_time <span class="sc">-</span> <span class="dv">60</span>, <span class="at">by =</span> sampling_freq)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset" data-group="language">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-38-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-38-1" role="tab" aria-controls="tabset-38-1" aria-selected="true">data.table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-38-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-38-2" role="tab" aria-controls="tabset-38-2" aria-selected="false">dtplyr</a></li></ul>
<div class="tab-content" data-group="language">
<div id="tabset-38-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-38-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Subset the 1-second price grid to get the 10-second price grid </span></span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a>quotes_10sec <span class="ot">&lt;-</span> quotes_1sec[time <span class="sc">%in%</span> time_grid,]</span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate returns at the 10-second frequency, expressed in basis points</span></span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a>quotes_10sec[, return <span class="sc">:</span><span class="er">=</span> <span class="fl">1e4</span> <span class="sc">*</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="fu">diff</span>(<span class="fu">log</span>(midpoint))), by <span class="ot">=</span> <span class="st">"date"</span>]</span>
<span id="cb141-6"><a href="#cb141-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-7"><a href="#cb141-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the return variance at the 10-second frequency, daily</span></span>
<span id="cb141-8"><a href="#cb141-8" aria-hidden="true" tabindex="-1"></a>efficiency_10sec <span class="ot">&lt;-</span> quotes_10sec[, </span>
<span id="cb141-9"><a href="#cb141-9" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">list</span>(<span class="at">return_var_10sec =</span> <span class="fu">var</span>(return, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)), </span>
<span id="cb141-10"><a href="#cb141-10" aria-hidden="true" tabindex="-1"></a>                      by <span class="ot">=</span> <span class="st">"date"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-38-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-38-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a>tv_quotes_10sec <span class="ot">&lt;-</span> tv_quotes_1sec <span class="sc">|&gt;</span></span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(<span class="fu">tibble</span>(<span class="at">time =</span> time_grid)) <span class="sc">|&gt;</span></span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(date) <span class="sc">|&gt;</span></span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">return =</span> <span class="fl">1e4</span> <span class="sc">*</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="fu">diff</span>(<span class="fu">log</span>(midpoint))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining, by = "time"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a>tv_efficiency_10sec <span class="ot">&lt;-</span> tv_quotes_10sec <span class="sc">|&gt;</span></span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(date) <span class="sc">|&gt;</span></span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">return_var_10sec =</span> <span class="fu">var</span>(return, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</div>
<p>Finally, we merge the 10-second return variance with the 1-second frequency efficiency measures and calculate the variance ratio. The output shows that the 10-second return variance is slightly higher than ten times the 1-second return variance, resulting in a variance ratio that exceeds the efficiency benchmark (unity) by 8%.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset" data-group="language">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-39-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-39-1" role="tab" aria-controls="tabset-39-1" aria-selected="true">data.table</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-39-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-39-2" role="tab" aria-controls="tabset-39-2" aria-selected="false">dtplyr</a></li></ul>
<div class="tab-content" data-group="language">
<div id="tabset-39-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-39-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge the efficiency measures of different return sampling frequencies</span></span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a>efficiency <span class="ot">&lt;-</span> efficiency_1sec[efficiency_10sec]</span>
<span id="cb145-3"><a href="#cb145-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-4"><a href="#cb145-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Obtain the variance ratio</span></span>
<span id="cb145-5"><a href="#cb145-5" aria-hidden="true" tabindex="-1"></a>efficiency[, var_ratio <span class="sc">:</span><span class="er">=</span> return_var_10sec <span class="sc">/</span> (<span class="dv">10</span> <span class="sc">*</span> return_var_1sec)]</span>
<span id="cb145-6"><a href="#cb145-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-7"><a href="#cb145-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Output an overview of the average variance ratio</span></span>
<span id="cb145-8"><a href="#cb145-8" aria-hidden="true" tabindex="-1"></a>efficiency[, </span>
<span id="cb145-9"><a href="#cb145-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">return_var_1sec =</span> <span class="fu">round</span>(<span class="fu">mean</span>(return_var_1sec), <span class="at">digits =</span> <span class="dv">3</span>),</span>
<span id="cb145-10"><a href="#cb145-10" aria-hidden="true" tabindex="-1"></a>       <span class="at">return_var_10sec =</span> <span class="fu">round</span>(<span class="fu">mean</span>(return_var_10sec), <span class="at">digits =</span> <span class="dv">3</span>),</span>
<span id="cb145-11"><a href="#cb145-11" aria-hidden="true" tabindex="-1"></a>       <span class="at">var_ratio =</span> <span class="fu">round</span>(<span class="fu">mean</span>(var_ratio), <span class="at">digits =</span> <span class="dv">3</span>))]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   return_var_1sec return_var_10sec var_ratio
1:           0.318            3.442     1.081</code></pre>
</div>
</div>
</div>
<div id="tabset-39-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-39-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a>tv_efficiency <span class="ot">&lt;-</span> tv_efficiency_1sec <span class="sc">|&gt;</span></span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(tv_efficiency_10sec) <span class="sc">|&gt;</span></span>
<span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">var_ratio =</span> return_var_10sec <span class="sc">/</span> (<span class="dv">10</span> <span class="sc">*</span> return_var_1sec)) <span class="sc">|&gt;</span></span>
<span id="cb147-4"><a href="#cb147-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lazy_dt</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining, by = "date"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a>tv_efficiency <span class="sc">|&gt;</span></span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="fu">across</span>(<span class="fu">c</span>(return_var_1sec, return_var_10sec, var_ratio), <span class="sc">~</span><span class="fu">round</span>(<span class="fu">mean</span>(.), <span class="at">digits =</span> <span class="dv">3</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Source: local data table [1 x 3]
Call:   `_DT29`[, .(return_var_1sec = round(mean(return_var_1sec), digits = 3), 
    return_var_10sec = round(mean(return_var_10sec), digits = 3), 
    var_ratio = round(mean(var_ratio), digits = 3))]

  return_var_1sec return_var_10sec var_ratio
            &lt;dbl&gt;            &lt;dbl&gt;     &lt;dbl&gt;
1            0.32             3.44      1.08

# Use as.data.table()/as.data.frame()/as_tibble() to access results</code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<p>This guide offers a glimpse into the world of empirical market microstructure. A world characterized by intriguing questions, vast data and implementation details that matter greatly – both for real-world outcomes of market structure reforms and for market quality measures. If the guide lowers the threshold and triggers your interest to enter this fascinating world, its aim is fulfilled.</p>
<p>A key point throughout this guide is to try to monitor and understand the data. It is a good habit to inspect, plot, and summarize the data for each step of the processing. Extreme observations can often be understood with the aid of flags in the data in combination with institutional knowledge. The latter is case-specific, so make sure to study the nitty gritty details of order types, priority rules, and block trade reporting. Once we understand the market, we can understand the data points, and make informed decisions about outliers.</p>
<p>The format necessarily imposes limitations. We don’t cover all market quality measures and not all variations in methodology, but aim to convey what we consider to be good practice when calculating the most common measures. If you disagree, find bugs, or have other feedback, don’t hesitate to send us an email at <a href="mailto:bjh@sbs.su.se">bjh@sbs.su.se</a> and <a href="mailto:niklas.landsberg@kuleuven.be">niklas.landsberg@kuleuven.be</a>.</p>
<p>To cite our work, please use the following reference information: Hagströmer, B. and Landsberg, N. (2024). Tidy Market Microstructure. URL: <a href="www.tidy-finance.org/blog/tidy-market-microstructure">www.tidy-finance.org/blog/tidy-market-microstructure</a></p>
<section id="acknowledgements" class="level3">
<h3 class="anchored" data-anchor-id="acknowledgements">Acknowledgements</h3>
<p>We thank Christoph Scheuch, Stefan Voigt, and Darya Yuferova for helpful comments. This project received financial support from the Jan Wallander and Tom Hedelius Foundation.</p>


</section>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Menkveld, A. J., et al.&nbsp;(342 coauthors) (2023). Non-standard errors. Forthcoming in <em>Journal of Finance</em>. <a href="https://papers.ssrn.com/sol3/Papers.cfm?abstract_id=3961574">https://papers.ssrn.com/sol3/Papers.cfm?abstract_id=3961574</a><a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>Amihud, Y. (2002). Illiquidity and stock returns: Cross-section and time-series effects. <em>Journal of Financial Markets</em>, 5(1), 31-56. <a href="https://doi.org/10.1016/S1386-4181(01)00024-6">https://doi.org/10.1016/S1386-4181(01)00024-6</a><a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>Jahan-Parvar, M. R., &amp; Zikes, F. (2023). When Do Low-Frequency Measures Really Measure Effective Spreads? Evidence from Equity and Foreign Exchange Markets. <em>Review of Financial Studies</em>, 36(10), 4190-4232. <a href="https://doi.org/10.1093/rfs/hhad028">https://doi.org/10.1093/rfs/hhad028</a><a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>Campbell, J. Y., Lo, A. W., &amp; MacKinlay, A. C. (1998). <em>The Econometrics of Financial Markets</em>. Princeton University Press.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>Foucault, T., Pagano, M., &amp; Röell, A. (2013). <em>Market liquidity: Theory, evidence, and policy</em>. Oxford University Press, USA.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6"><p>Hasbrouck, J. (2007). <em>Empirical market microstructure: The institutions, economics, and econometrics of securities trading</em>. Oxford University Press.<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7"><p>A previous guide to microstructure programming (in SAS) is provided by Boehmer, Broussard and Kallunki (2002): Boehmer, E., Broussard, J. P., &amp; Kallunki, J. P. (2002). <em>Using SAS in financial research</em>. SAS Publishing.<a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn8"><p>Part of the <code>data.table</code> speed advantage is that it uses parallel processing by default. Consequently, one has to be cautious to use it in parallelization, as improper specification may lead to <a href="https://towardsdatascience.com/parallelization-caveats-in-r-1-the-basics-multiprocessing-and-multithreading-performance-eb584b7e850e">over-parallelization</a> and undermine the performance benefits.<a href="#fnref8" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn9"><p>Scheuch, C., Voigt, S., &amp; Weiss P. (2023). <em>Tidy finance with {R}</em>. Chapman and Hall/CRC. https://doi.org/10.1201/b23237 and <a href="https://tidy-finance.org/">https://tidy-finance.org/</a><a href="#fnref9" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn10"><p>Bartlett, R. P., &amp; McCrary, J. (2019). How rigged are stock markets? Evidence from microsecond timestamps. <em>Journal of Financial Markets</em>, <em>45</em>, 37-60. <a href="https://doi.org/10.1016/j.finmar.2019.06.003">https://doi.org/10.1016/j.finmar.2019.06.003</a><a href="#fnref10" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn11"><p>Holden, C. W., Pierson, M., &amp; Wu, J. (2023). In the blink of an eye: Exchange-to-SIP latency and trade classification accuracy. <em>Working paper</em>. <a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=4441422">https://papers.ssrn.com/sol3/papers.cfm?abstract_id=4441422</a><a href="#fnref11" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn12"><p>Schwenk-Nebbe, S. (2022). The participant timestamp: Get the most out of TAQ data. <em>Working paper</em>. <a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3984827">https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3984827</a><a href="#fnref12" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn13"><p>Hagströmer, B., &amp; Menkveld, A. J. (2023). Trades, quotes, and information shares. Working paper. <a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=4356262">https://papers.ssrn.com/sol3/papers.cfm?abstract_id=4356262</a><a href="#fnref13" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn14"><p>Shkilko, A. V., Van Ness, B. F., &amp; Van Ness, R. A. (2008). Locked and crossed markets on NASDAQ and the NYSE. <em>Journal of Financial Markets</em>, <em>11</em>(3), 308-337. <a href="https://www.sciencedirect.com/science/article/pii/S1386418107000031?casa_token=GIqJQiPKyisAAAAA:ZVbaf4SPC0IzxFFLWqgI2papSw2MrEf_lPXCL9OlT_ZnKgA6-pGTl4EYisKuIUaFdx8JY1p3d7o">https://www.sciencedirect.com/science/article/pii/S1386418107000031?casa_token=GIqJQiPKyisAAAAA:ZVbaf4SPC0IzxFFLWqgI2papSw2MrEf_lPXCL9OlT_ZnKgA6-pGTl4EYisKuIUaFdx8JY1p3d7o</a><a href="#fnref14" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn15"><p>Jurkatis, S. (2022). Inferring trade directions in fast markets. <em>Journal of Financial Markets</em>, <em>58</em>, 100635. <a href="https://doi.org/10.1016/j.finmar.2021.100635">https://doi.org/10.1016/j.finmar.2021.100635</a><a href="#fnref15" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn16"><p>Holden, C. W., &amp; Jacobsen, S. (2014). Liquidity measurement problems in fast, competitive markets: Expensive and cheap solutions. <em>Journal of Finance</em>, 69(4), 1747-1785. <a href="https://doi.org/10.1111/jofi.12127">https://doi.org/10.1111/jofi.12127</a><a href="#fnref16" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn17"><p>Lee, C. M., &amp; Ready, M. J. (1991). Inferring trade direction from intraday data. <em>Journal of Finance</em>, 46(2), 733-746. <a href="https://onlinelibrary.wiley.com/doi/full/10.1111/j.1540-6261.1991.tb02683.x">https://onlinelibrary.wiley.com/doi/full/10.1111/j.1540-6261.1991.tb02683.x</a><a href="#fnref17" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn18"><p>Hagströmer, B. (2021). Bias in the effective bid-ask spread. <em>Journal of Financial Economics</em>, 142(1), 314-337. <a href="https://doi.org/10.1016/j.jfineco.2021.04.018">https://doi.org/10.1016/j.jfineco.2021.04.018</a><a href="#fnref18" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn19"><p>Conrad, J., &amp; Wahal, S. (2020). The term structure of liquidity provision. <em>Journal of Financial Economics</em>, 136(1), 239-259. <a href="https://doi.org/10.1016/j.jfineco.2019.09.008">https://doi.org/10.1016/j.jfineco.2019.09.008</a><a href="#fnref19" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<div class="custom-footer">
  <div class="copyright">© Christoph Frey, Christoph Scheuch, Stefan Voigt &amp; Patrick Weiss</div>
  <a href="disclaimer.html">Disclaimer</a>
  <a href="#" id="open_preferences_center">Cookie Preferences</a>
</div>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("^(?:http:|https:)\/\/www\.tidy-finance\.org");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // target, if specified
            link.setAttribute("target", "_blank");
            if (link.getAttribute("rel") === null) {
              link.setAttribute("rel", "noopener");
            }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">

<div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/tidy-finance/website/blob/main/blog/tidy-market-microstructure/index.qmd" class="toc-action"><i class="bi bi-github"></i>View source</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>
<script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>




<script src="../../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>