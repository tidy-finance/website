<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 11 Constraint Optimization and Portfolio Backtesting | Tidy Finance</title>
<meta name="author" content="Christoph Scheuch, Patrick Weiss and Stefan Voigt">
<meta name="description" content="In this section we conduct portfolio backtesting procedures in more realistic settings with transaction costs and investment constraints such as no-short selling rules. We start with standard...">
<meta name="generator" content="bookdown 0.24.4 with bs4_book()">
<meta property="og:title" content="Chapter 11 Constraint Optimization and Portfolio Backtesting | Tidy Finance">
<meta property="og:type" content="book">
<meta property="og:description" content="In this section we conduct portfolio backtesting procedures in more realistic settings with transaction costs and investment constraints such as no-short selling rules. We start with standard...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 11 Constraint Optimization and Portfolio Backtesting | Tidy Finance">
<meta name="twitter:description" content="In this section we conduct portfolio backtesting procedures in more realistic settings with transaction costs and investment constraints such as no-short selling rules. We start with standard...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.11/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS -->
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Tidy Finance</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"><span class="header-section-number">1</span> Prerequisites</a></li>
<li><a class="" href="introduction-to-tidy-finance.html"><span class="header-section-number">2</span> Introduction to Tidy Finance</a></li>
<li><a class="" href="accessing-managing-financial-data.html"><span class="header-section-number">3</span> Accessing &amp; Managing Financial Data</a></li>
<li><a class="" href="estimating-beta.html"><span class="header-section-number">4</span> Estimating Beta</a></li>
<li><a class="" href="univariate-sorts.html"><span class="header-section-number">5</span> Univariate Sorts</a></li>
<li><a class="" href="univariate-sorts-firm-size.html"><span class="header-section-number">6</span> Univariate Sorts: Firm Size</a></li>
<li><a class="" href="bivariate-sorts-value.html"><span class="header-section-number">7</span> Bivariate Sorts: Value</a></li>
<li><a class="" href="factor-selection-via-machine-learning.html"><span class="header-section-number">8</span> Factor selection via machine learning</a></li>
<li><a class="" href="option-pricing-via-machine-learning-methods.html"><span class="header-section-number">9</span> Option Pricing via Machine learning methods</a></li>
<li><a class="" href="parametric-portfolio-policies.html"><span class="header-section-number">10</span> Parametric Portfolio Policies</a></li>
<li><a class="active" href="constraint-optimization-and-portfolio-backtesting.html"><span class="header-section-number">11</span> Constraint Optimization and Portfolio Backtesting</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="constraint-optimization-and-portfolio-backtesting" class="section level1" number="11">
<h1>
<span class="header-section-number">11</span> Constraint Optimization and Portfolio Backtesting<a class="anchor" aria-label="anchor" href="#constraint-optimization-and-portfolio-backtesting"><i class="fas fa-link"></i></a>
</h1>
<p>In this section we conduct portfolio backtesting procedures in more realistic settings with transaction costs and investment constraints such as no-short selling rules.
We start with <em>standard</em> mean-variance efficient portfolios and then introduce further constraints step-by-step. Numerical constrained optimization is done with the packages <code>quadprog</code> (for quadratic objective functions such as in typical mean-variance framework) and <code>alabama</code> (for more general, non-linear objectives and constraints).</p>
<div class="sourceCode" id="cb183"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rsqlite.r-dbi.org">RSQLite</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">quadprog</span><span class="op">)</span> <span class="co"># Optimization (mean-variance)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">alabama</span><span class="op">)</span>  <span class="co"># Advanced optimization (non-linear objective or constraints)</span></code></pre></div>
<p>We start by loading the required data. In our application we will restrict our investment universe to the monthly Fama-French industry portfolio returns.</p>
<div class="sourceCode" id="cb184"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tidy_finance</span> <span class="op">&lt;-</span> <span class="fu">dbConnect</span><span class="op">(</span><span class="fu"><a href="https://rsqlite.r-dbi.org/reference/SQLite.html">SQLite</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"data/tidy_finance.sqlite"</span>, extended_types <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="co"># Load industry data</span>
<span class="va">industry_returns</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html">tbl</a></span><span class="op">(</span><span class="va">tidy_finance</span>, <span class="st">"industries_ff_monthly"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html">collect</a></span><span class="op">(</span><span class="op">)</span> 

<span class="va">industry_returns</span> <span class="op">&lt;-</span> <span class="va">industry_returns</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">month</span><span class="op">)</span>

<span class="va">N</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">industry_returns</span><span class="op">)</span> <span class="co"># Number of assets</span></code></pre></div>
<p>First a brief recap. A common objective for portfolio optimization is to choose mean-variance efficient portfolio, that is the allocation which delivers the lowest possible return variance for a given minimum level of expected returns. In the most extreme case where the investor is only concerned about portfolio variance, she may choose to implement the minimum variance portfolio weights which are given by the solution to
<span class="math display">\[\arg\min w'\Sigma w \text{ s.t. } w'\iota = 1\]</span>
where <span class="math inline">\(\Sigma\)</span> is the <span class="math inline">\((N \times N)\)</span> variance covariance matrix of the returns. The optimal weights <span class="math inline">\(\omega_\text{mvp}\)</span> can be found analytically and are <span class="math inline">\(\omega_\text{mvp} = \frac{\Sigma^{-1}\iota}{\iota'\Sigma^{-1}\iota}\)</span>. In code, this is equivalent to the following:</p>
<div class="sourceCode" id="cb185"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">Sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cov</a></span><span class="op">(</span><span class="va">industry_returns</span><span class="op">)</span>

<span class="va">w_mvp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/solve-methods.html">solve</a></span><span class="op">(</span><span class="va">Sigma</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">Sigma</span><span class="op">)</span><span class="op">)</span>
<span class="va">w_mvp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">w_mvp</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">w_mvp</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Next, consider now an investor who aims to achieve minimum variance <em>given a minimum desired expected return</em> <span class="math inline">\(\bar{\mu}\)</span> such that she chooses
<span class="math display">\[\arg\min w'\Sigma w \text{ s.t. } w'\iota = 1 \text{ and } \omega'\mu \geq \bar{\mu}.\]</span>
The Lagrangian reads <span class="math display">\[ \mathcal{L}(\omega) = w'\Sigma w - \lambda(w'\iota - 1) - \tilde{\lambda}(\omega'\mu - \bar{\mu}) \]</span>. Solving the first order conditions yields
<span class="math display">\[
\begin{aligned}
2\Sigma w &amp;= \lambda\iota + \tilde\lambda \mu\\
\omega &amp;= \frac{\lambda}{2}\Sigma^{-1}\iota + \frac{\tilde\lambda}{2}\Sigma^{-1}\mu
\end{aligned}
\]</span>
The constraints imply
<span class="math display">\[
\begin{aligned}
1 &amp;= \iota'\omega = \frac{\lambda}{2}\underbrace{\iota'\Sigma^{-1}\iota}_{C} + \frac{\tilde\lambda}{2}\underbrace{\iota'\Sigma^{-1}\mu}_D
\Rightarrow \lambda = \frac{2 - \tilde\lambda D}{C}\\
\bar\mu &amp;= \frac{\lambda}{2}\underbrace{\mu'\Sigma^{-1}\iota}_{D} + \frac{\tilde\lambda}{2}\underbrace{\mu'\Sigma^{-1}\mu}_E = \frac{1}{2}\left(\frac{2 - \tilde\lambda D}{C}\right)D+\frac{\tilde\lambda}{2}E  \\&amp;=\frac{D}{C}+\frac{\tilde\lambda}{2}\left(E - \frac{D^2}{C}\right)\\
\Rightarrow \tilde\lambda &amp;= 2\frac{\bar\mu - D/C}{E-D^2/C}\\
\end{aligned}
\]</span>
As a result, the efficient portfolio weight takes the form
<span class="math display">\[w_\text{eff} = \omega_\text{mvp} + \frac{\tilde\lambda}{2}\left(\Sigma^{-1}\mu -\frac{D}{C}\Sigma^{-1}\iota \right)\]</span>
Note that <span class="math display">\[\iota'\left(\Sigma^{-1}\mu -\frac{D}{C}\Sigma^{-1}\iota \right) = D - D = 0\text{ so }\iota'\omega_\text{eff} = \iota'\omega_\text{mvp} = 1\]</span> and <span class="math display">\[\mu'\omega_\text{eff} = \frac{D}{C} + \bar\mu - \frac{D}{C} = \bar\mu\]</span>. As a result, the efficient portfolio allocates wealth in the minimum variance portfolio <span class="math inline">\(\omega_\text{mvp}\)</span> and a levered (self-financing) portfolio to increase the expected return.</p>
<p>You can rewrite the optimal portfolio weights as follows:
<span class="math display">\[\begin{aligned}
 \omega^*_{t+1} &amp; = \frac{1}{\gamma}\left(\Sigma_t^{-1} - \frac{1}{\iota' \Sigma_t^{-1}\iota }\Sigma_t^{-1}\iota\iota' \Sigma_t^{-1} \right) \mu_t  + \frac{1}{\iota' \Sigma_t^{-1} \iota }\Sigma_t^{-1} \iota
 \end{aligned}\]</span>
Empirically this classical solution imposes many problems: Especially the estimates of <span class="math inline">\(\mu_t\)</span> are noisy over short horizons, the (<span class="math inline">\(N \times N\)</span>) matrix <span class="math inline">\(\Sigma_t\)</span> contains <span class="math inline">\(N(N-1)/2\)</span> distinct elements and thus, estimation error is huge. Even worse, if the asset universe contains more assets (<span class="math inline">\(N\)</span>) than available time periods (<span class="math inline">\(T\)</span>), the sample variance covariance matrix is not longer positive definite such that the inverse <span class="math inline">\(\Sigma^{-1}\)</span> does not exist anymore.
The empirical evidence regarding the performance of a mean-variance optimization procedure in which you simply plugin some sample estimates <span class="math inline">\(\hat \mu_t\)</span> and <span class="math inline">\(\hat \Sigma_t\)</span> can be summarised rather easily: Mean-variance optimization performs badly! The literature brought forward a lot of proposal to overcome these empirical issues, for instance, impose some form of regularization of <span class="math inline">\(\Sigma\)</span>, to rely on Bayesian priors inspired by theoretical asset pricing models, to use high-frequency data to improve forecasting (which are not captured in this book). One unifying framework that works easily, effective (even for large dimensions) and is purely inspired by economic arguments is an ex-ante adjustment for transaction costs:</p>
<p>Assume that returns are multivariate normal distributed such that: <span class="math inline">\(p_t({r}_{t+1}|\mathcal{M})=N(\mu,\Sigma)\)</span>. Additionally we assume quadtratic transaction costs which penalize rebalancing such that <span class="math display">\[\begin{aligned}
\nu\left(\omega_{t+1},\omega_{t^+}, \beta\right) :=\nu_t\left(\omega_{t+1}, \beta\right) = \frac{\beta}{2} \left(\omega_{t+1} - \omega_{t^+}\right)'\left(\omega_{t+1}- \omega_{t^+}\right),
\end{aligned}\]</span>
with cost parameter <span class="math inline">\(\beta&gt;0\)</span> and <span class="math inline">\(\omega_{t^+} := {\omega_t \circ (1 +r_{t})}/{\iota' (\omega_t \circ (1 + r_{t}))}\)</span>. Note: <span class="math inline">\(\omega_{t^+}\)</span> differs mechanically from <span class="math inline">\(\omega_t\)</span> due to the returns in the past period.</p>
<p>Then, the optimal portfolio choice is
<span class="math display">\[\begin{aligned}
\omega_{t+1} ^* :=&amp;  \arg\max_{\omega \in \mathbb{R}^N,  \iota'\omega = 1} \omega'\mu - \nu_t (\omega,\omega_{t^+}, \beta) - \frac{\gamma}{2}\omega'\Sigma\omega \\
=&amp;\arg\max_{\omega\in\mathbb{R}^N,\text{ }  \iota'\omega=1}
\omega'\color{red}{\mu^*} - \frac{\gamma}{2}\omega'\color{red}{\Sigma^*} \omega ,
\end{aligned}\]</span>
where
<span class="math display">\[\begin{aligned}
\color{red}{\mu^*:=\mu+\beta \omega_{t^+}} \quad  \text{and} \quad \color{red}{\Sigma^*:=\Sigma + \frac{\beta}{\gamma} I_N}.
\end{aligned}\]</span>
As a result, adjusting for transaction costs implies a standard mean-variance optimal portfolio choice with adjusted return parameters <span class="math inline">\(\Sigma^*\)</span> and <span class="math inline">\(\mu^*\)</span>: <span class="math display">\[\begin{aligned}
 \omega^*_{t+1} &amp; = \frac{1}{\gamma}\left(\Sigma^{*-1} - \frac{1}{\iota' \Sigma^{*-1}\iota }\Sigma^{*-1}\iota\iota' \Sigma^{*-1} \right) \mu^*  + \frac{1}{\iota' \Sigma^{*-1} \iota }\Sigma^{*-1} \iota.
 \end{aligned}\]</span></p>
<p>An alternative formulation of the optimal portfolio can be derived as follows:
<span class="math display">\[\begin{aligned}
\omega_{t+1} ^*=\arg\max_{\omega\in\mathbb{R}^N,\text{ }  \iota'\omega=1}
\omega'\left(\mu+\beta\left(\omega_{t^+} - \frac{1}{N}\iota\right)\right) - \frac{\gamma}{2}\omega'\Sigma^* \omega .
\end{aligned}\]</span>
The optimal weights correspond to a mean-variance portfolio where the vector of expected returns is such that assets that currently exhibit a higher weight are considered as delivering an higher expected return.</p>
<p>The function below implements the efficient portfolio weight in its general form which also allows to reflect transaction costs (conditional on the holdings <em>before</em> reallocation):</p>
<div class="sourceCode" id="cb186"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">compute_efficient_weight</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">Sigma</span>,
                                     <span class="va">mu</span>,
                                     <span class="va">gamma</span> <span class="op">=</span> <span class="fl">2</span>, <span class="co"># risk-aversion</span>
                                     <span class="va">beta</span> <span class="op">=</span> <span class="fl">0</span>, <span class="co"># transaction costs</span>
                                     <span class="va">w_prev</span> <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">Sigma</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">Sigma</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span> <span class="co"># weights before rebalancing</span>

  <span class="va">iota</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">Sigma</span><span class="op">)</span><span class="op">)</span>
  <span class="va">Sigma_processed</span> <span class="op">&lt;-</span> <span class="va">Sigma</span> <span class="op">+</span> <span class="va">beta</span> <span class="op">/</span> <span class="va">gamma</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">Sigma</span><span class="op">)</span><span class="op">)</span>
  <span class="va">mu_processed</span> <span class="op">&lt;-</span> <span class="va">mu</span> <span class="op">+</span> <span class="va">beta</span> <span class="op">*</span> <span class="va">w_prev</span>
  
  <span class="va">Sigma_inverse</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/solve-methods.html">solve</a></span><span class="op">(</span><span class="va">Sigma_processed</span><span class="op">)</span>
  
  <span class="va">w_mvp</span> <span class="op">&lt;-</span> <span class="va">Sigma_inverse</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html">%*%</a></span> <span class="va">iota</span>
  <span class="va">w_mvp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">w_mvp</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">w_mvp</span><span class="op">)</span><span class="op">)</span>
  <span class="va">w_opt</span> <span class="op">&lt;-</span> <span class="va">w_mvp</span>  <span class="op">+</span> <span class="fl">1</span><span class="op">/</span><span class="va">gamma</span> <span class="op">*</span> <span class="op">(</span><span class="va">Sigma_inverse</span> <span class="op">-</span> <span class="fl">1</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">Sigma_inverse</span><span class="op">)</span> <span class="op">*</span> <span class="va">Sigma_inverse</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html">%*%</a></span> <span class="va">iota</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">iota</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html">%*%</a></span> <span class="va">Sigma_inverse</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html">%*%</a></span> <span class="va">mu_processed</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">w_opt</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html">colMeans</a></span><span class="op">(</span><span class="va">industry_returns</span><span class="op">)</span>
<span class="fu">compute_efficient_weight</span><span class="op">(</span><span class="va">Sigma</span>, <span class="va">mu</span><span class="op">)</span></code></pre></div>
<pre><code>##  [1]  1.4307987  0.2701363 -1.3024366  0.3742729  0.3093118 -0.1521964
##  [7]  0.5378376  0.4712071 -0.1669907 -0.7719408</code></pre>
<p>What is the effect of transaction costs or different levels of risk aversion on the optimal portfolio choice? The following few lines of code analyse the distance between the minimum variance portfolio and the portfolio implemented by the investor for different values of the transaction cost parameter <span class="math inline">\(\beta\)</span> and risk aversion <span class="math inline">\(\gamma\)</span>.</p>
<div class="sourceCode" id="cb188"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">transaction_costs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/expand_grid.html">expand_grid</a></span><span class="op">(</span>gamma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">4</span>, <span class="fl">8</span>, <span class="fl">20</span><span class="op">)</span>,
                                 beta <span class="op">=</span> <span class="fl">20</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html">qexp</a></span><span class="op">(</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">99</span><span class="op">)</span><span class="op">/</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co"># transaction costs in basis points</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>weights <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html">map2</a></span><span class="op">(</span>.x <span class="op">=</span> <span class="va">gamma</span>, 
                        .y <span class="op">=</span> <span class="va">beta</span>,
                        <span class="op">~</span><span class="fu">compute_efficient_weight</span><span class="op">(</span><span class="va">Sigma</span>,
                                                        <span class="va">mu</span>,
                                                        gamma <span class="op">=</span> <span class="va">.x</span>,
                                                        beta <span class="op">=</span> <span class="va">.y</span> <span class="op">/</span> <span class="fl">10000</span>,
                                                  w_prev <span class="op">=</span> <span class="va">w_mvp</span><span class="op">)</span><span class="op">)</span>,
         concentration <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="va">weights</span>, <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">.</span> <span class="op">-</span> <span class="va">w_mvp</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="va">transaction_costs</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>`Risk aversion` <span class="op">=</span> <span class="fu"><a href="https://forcats.tidyverse.org/reference/as_factor.html">as_factor</a></span><span class="op">(</span><span class="va">gamma</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">beta</span>, y <span class="op">=</span> <span class="va">concentration</span>, color <span class="op">=</span> <span class="va">`Risk aversion`</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_sqrt</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Transaction cost parameter"</span>, 
       y <span class="op">=</span> <span class="st">"Distance from MVP"</span>,
       title <span class="op">=</span> <span class="st">"Optimal portfolio weights for different risk aversion and transaction cost values"</span>,
       caption <span class="op">=</span> <span class="st">"Initial portfolio is always the (sample) minimum variance portfolio. Distance is measured as the sum of absolute deviations. "</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></code></pre></div>
<p><img src="51_constrained_optimization_and_backtesting_files/figure-html/unnamed-chunk-6-1.png" width="768" style="display: block; margin: auto;">
The figure illustrates: the higher the transaction costs parameter <span class="math inline">\(\beta\)</span>, the smaller rebalancing from the initial portfolio (always set to the minimum variance portfolio weights in this example). Further, if risk aversion <span class="math inline">\(\gamma\)</span> increases, the efficient portfolio is closer to the minimum variance portfolio weights such that the investor desires less rebalancing from the initial holdings.</p>
<p>Next we introduce constrained optimization. Very often, typical constraints such as no-short selling rules prevent analytical solutions for optimal portfolio weights. However, numerical optimization allows to compute the solutions to such constrained problems. For the purpose of mean-variance optimization we rely on <code>solve.QP</code> from <code>quadprog</code>. First, we start with an <em>unconstrained</em> problem to replicate the analytical solutions for the minimum variance and efficient portfolio weights from above.</p>
<div class="sourceCode" id="cb189"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># (Constrained) optimization in R ----</span>
<span class="co"># To get started: replicate minimum variance portfolio as numerical solution</span>
<span class="va">w_mvp_numerical</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/quadprog/man/solve.QP.html">solve.QP</a></span><span class="op">(</span>Dmat <span class="op">=</span> <span class="va">Sigma</span>,
                            dvec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">N</span><span class="op">)</span>, <span class="co"># no vector of expected returns for MVP </span>
                            Amat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">N</span><span class="op">)</span><span class="op">)</span>, <span class="co"># Matrix A has one column which is a vector of ones</span>
                            bvec <span class="op">=</span> <span class="fl">1</span>, <span class="co"># bvec is 1 and enforces the constraint that weights sum up to one</span>
                            meq <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="co"># there is one (out of one) equality constraint</span>

<span class="co"># Check that w and w_numerical are the same (up to numerical instabilities)</span>
<span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">w_mvp</span>, <span class="va">w_mvp_numerical</span><span class="op">$</span><span class="va">solution</span><span class="op">)</span></code></pre></div>
<pre><code>##              w_mvp             
##  [1,]  0.218217861  0.218217861
##  [2,] -0.024598381 -0.024598381
##  [3,]  0.132583584  0.132583584
##  [4,]  0.061873595  0.061873595
##  [5,]  0.009580795  0.009580795
##  [6,]  0.247523928  0.247523928
##  [7,]  0.090240088  0.090240088
##  [8,]  0.145530839  0.145530839
##  [9,]  0.493397247  0.493397247
## [10,] -0.374349557 -0.374349557</code></pre>
<div class="sourceCode" id="cb191"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">w_efficient_numerical</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/quadprog/man/solve.QP.html">solve.QP</a></span><span class="op">(</span>Dmat <span class="op">=</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">Sigma</span>,
                            dvec <span class="op">=</span> <span class="va">mu</span>, <span class="co"># no vector of expected returns for MVP </span>
                            Amat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">N</span><span class="op">)</span><span class="op">)</span>, <span class="co"># Matrix A has one column which is a vector of ones</span>
                            bvec <span class="op">=</span> <span class="fl">1</span>, <span class="co"># bvec is 1 and enforces the constraint that weights sum up to one</span>
                            meq <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="co"># there is one (out of one) equality constraint</span>

<span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fu">compute_efficient_weight</span><span class="op">(</span><span class="va">Sigma</span>, <span class="va">mu</span><span class="op">)</span>, <span class="va">w_efficient_numerical</span><span class="op">$</span><span class="va">solution</span><span class="op">)</span></code></pre></div>
<pre><code>##             [,1]       [,2]
##  [1,]  1.4307987  1.4307987
##  [2,]  0.2701363  0.2701363
##  [3,] -1.3024366 -1.3024366
##  [4,]  0.3742729  0.3742729
##  [5,]  0.3093118  0.3093118
##  [6,] -0.1521964 -0.1521964
##  [7,]  0.5378376  0.5378376
##  [8,]  0.4712071  0.4712071
##  [9,] -0.1669907 -0.1669907
## [10,] -0.7719408 -0.7719408</code></pre>
<p>The function <code>solve.QP</code> from package <code>quadprog</code> delivers numerical solution to quadratic programming problem of the form
<span class="math display">\[\min(-\mu \omega + 1/2 \omega' \Sigma \omega) \text{ s.t. } A' \omega &gt;= b_0.\]</span>
The function takes one argument (<code>meq</code>) for the number of equality constraints. Therefore, above matrix <span class="math inline">\(A\)</span> is simply a vector of ones to ensure that the weights sum up to one. In the case of no-short selling, the matrix <span class="math inline">\(A\)</span> is of the form
<span class="math display">\[\begin{aligned}A = \begin{pmatrix}1 &amp; 1&amp; \ldots&amp;1 \\1 &amp; 0 &amp;\ldots&amp;0\\0 &amp; 1 &amp;\ldots&amp;0\\\vdots&amp;&amp;\ddots&amp;\vdots\\0&amp;0&amp;\ldots&amp;1\end{pmatrix}'\qquad b_0 = \begin{pmatrix}1\\0\\\vdots\\0\end{pmatrix}\end{aligned}.\]</span>
For more complex optimization routines, <a href="https://cran.r-project.org/web/views/Optimization.html">this link (optimization task view)</a> helps</p>
<p>Next (here is where analytical solutions stop): we additionally impose no short-sale constraints which implies <span class="math inline">\(N\)</span> additional inequality constraints: <span class="math inline">\(w_i &gt;=0\)</span>.</p>
<div class="sourceCode" id="cb193"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">A</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span> <span class="co"># Matrix of constraints t(A) &gt;= bvec = c(1, rep(0, N))</span>

<span class="co"># Introduce short-selling constraint: no element of w is allowed to be negative</span>
<span class="va">w_no_short_sale</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/quadprog/man/solve.QP.html">solve.QP</a></span><span class="op">(</span>Dmat <span class="op">=</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">Sigma</span>, <span class="co"># Efficient portfolio with risk aversion gamma = 2</span>
                            dvec <span class="op">=</span> <span class="va">mu</span>, 
                            Amat <span class="op">=</span> <span class="va">A</span>, 
                            bvec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">N</span><span class="op">)</span><span class="op">)</span>, 
                            meq <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">$</span><span class="va">solution</span></code></pre></div>
<p><code>solve.QP</code> is fast because it benefits from a very clear structure with a quadratic objective and linear constraints. Often, however, optimization requires more flexibility. As one example, we show below how to compute optimal weights which are subject to the so-called regulation T-constraint which requires that the sum of all absolute portfolio weights is smaller than 1.5. This clearly is a non-linear objective function, thus we cannot longer rely on <code>solve.QP</code>. Instead, we rely on the package <code>alabama</code> which requires us to define the objective and constraint functions individually.</p>
<div class="sourceCode" id="cb194"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">w</span>, <span class="va">gamma</span> <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">w</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html">%*%</a></span> <span class="va">mu</span> <span class="op">+</span> <span class="va">gamma</span> <span class="op">/</span> <span class="fl">2</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">w</span><span class="op">)</span><span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html">%*%</a></span><span class="va">Sigma</span><span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html">%*%</a></span><span class="va">w</span> <span class="co"># Objective function which we minimize</span>
<span class="va">hin</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">w</span>, <span class="va">reg_t</span> <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">reg_t</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">w</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co"># inequality constraints such that reg_t &gt; sum(abs(w))</span>
<span class="va">heq</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">w</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">w</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="co"># equality constraint</span>

<span class="va">w_reg_t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/alabama/man/constrOptim.nl.html">constrOptim.nl</a></span><span class="op">(</span> <span class="co"># from alabama package</span>
  par <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="va">N</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">N</span><span class="op">)</span>,<span class="co"># Initial set of weights</span>
  hin <span class="op">=</span> <span class="va">hin</span>,
  fn <span class="op">=</span> <span class="va">fn</span>, 
  heq <span class="op">=</span> <span class="va">heq</span>,
  control.outer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>trace <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">par</span> <span class="co"># omit optimization output</span></code></pre></div>
<p>The figure below shows the optimal allocation weights across all 10 industries for the four different strategies considered so far: minimum variance, efficient portfolio with <span class="math inline">\(\gamma\)</span> = 2, efficient portfolio with a no-short sale constraint and the Reg-T constrained portfolio.</p>
<div class="sourceCode" id="cb195"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>`No short-sale` <span class="op">=</span> <span class="va">w_no_short_sale</span>, 
       `Minimum Variance` <span class="op">=</span> <span class="va">w_mvp</span>, 
       `Efficient portfolio` <span class="op">=</span> <span class="fu">compute_efficient_weight</span><span class="op">(</span><span class="va">Sigma</span>, <span class="va">mu</span><span class="op">)</span>,
       `Regulation-T` <span class="op">=</span> <span class="va">w_reg_t</span>,
       Industry <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">industry_returns</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="va">Industry</span>, 
               names_to <span class="op">=</span> <span class="st">"Strategy"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">Strategy</span>, 
                 y <span class="op">=</span> <span class="fl">100</span> <span class="op">*</span> <span class="va">value</span>, 
                 x <span class="op">=</span> <span class="va">Industry</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span>position<span class="op">=</span><span class="st">"dodge"</span>, stat<span class="op">=</span><span class="st">"identity"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Allocation weight (in percent)"</span>,
       title <span class="op">=</span><span class="st">"Optimal allocations for different investment rules"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span> </code></pre></div>
<div class="inline-figure"><img src="51_constrained_optimization_and_backtesting_files/figure-html/unnamed-chunk-10-1.png" width="768" style="display: block; margin: auto;"></div>
<p>Before moving on, we propose a final allocation strategy which reflects a somewhat more realistict structure of transaction costs instead of the quadratic specification used above. The function below computes efficient portfolio weights while adjusting for <span class="math inline">\(L_1\)</span> transaction costs <span class="math inline">\(\beta\sum\limits_{i=1}^N |(w_{i, t+1} - w_{i, t^+})|\)</span>. No closed-form solution exists, thus we rely on non-linear optimization procedures (however, the interpretation of transaction costs as a form of shrinkage is still valid, see Hautsch and Voigt (2019)).</p>
<div class="sourceCode" id="cb196"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">compute_efficient_weight_L1_TC</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mu</span>,
                                          <span class="va">Sigma</span>, 
                                          <span class="va">gamma</span> <span class="op">=</span> <span class="fl">2</span>, 
                                          <span class="va">beta</span> <span class="op">=</span> <span class="fl">0</span>, <span class="co"># in basis points</span>
                                          <span class="va">w_prev</span> <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">sigma</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">sigma</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  
  <span class="co"># Define objective function </span>
  <span class="va">fn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">w</span><span class="op">)</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">w</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html">%*%</a></span> <span class="va">mu</span> <span class="op">+</span> <span class="va">gamma</span> <span class="op">/</span> <span class="fl">2</span><span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">w</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html">%*%</a></span> <span class="va">Sigma</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html">%*%</a></span> <span class="va">w</span> <span class="op">+</span> <span class="op">(</span><span class="va">beta</span> <span class="op">/</span> <span class="fl">10000</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">w</span> <span class="op">-</span> <span class="va">w_prev</span><span class="op">)</span><span class="op">)</span>

  <span class="va">w_optimal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/alabama/man/constrOptim.nl.html">constrOptim.nl</a></span><span class="op">(</span>
    par <span class="op">=</span> <span class="va">w_prev</span>,<span class="co"># Initial set of weights</span>
    fn <span class="op">=</span> <span class="va">fn</span>, 
    heq <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">w</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">w</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">}</span>,
    control.outer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>trace <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">par</span> <span class="co"># To omit optimization output</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">w_optimal</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>You may have noticed that, for the sake of keeping things easy, we committed one fundamental error in computing portfolio weights above: We used the full sample of the data to determine the optimal allocation. In other words, in order to implement this strategy in the beginning of the 2000s, you will need to know in advance how the returns will evolve until 2020. Instead, while interesting from a methodological point of view, we cannot evaluate the performance of the portfolios in a reasonable out-of-sample fashion. We will do so next in a backtesting exercise. For the backtest we recompute optimal weights just based on past available data.</p>
<div class="sourceCode" id="cb197"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">window_length</span> <span class="op">&lt;-</span> <span class="fl">120</span> <span class="co"># Estimation window (length of past available data)</span>
<span class="va">periods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">industry_returns</span><span class="op">)</span> <span class="op">-</span> <span class="va">window_length</span> <span class="co"># total number of out-of-sample periods</span>

<span class="va">beta</span> <span class="op">&lt;-</span> <span class="fl">50</span> <span class="co"># Transaction costs in basis points</span>
<span class="va">gamma</span> <span class="op">&lt;-</span> <span class="fl">2</span> <span class="co"># Risk aversion</span>

<span class="va">performance_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, 
                     nrow <span class="op">=</span> <span class="va">periods</span>, 
                     ncol <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="co"># A matrix to collect all returns</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">performance_values</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"raw_return"</span>, <span class="st">"turnover"</span>, <span class="st">"net_return"</span><span class="op">)</span> <span class="co"># we implement 3 strategies</span>

<span class="va">performance_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"MV (TC)"</span> <span class="op">=</span> <span class="va">performance_values</span>, 
                           <span class="st">"Naive"</span> <span class="op">=</span> <span class="va">performance_values</span>, 
                           <span class="st">"MV"</span> <span class="op">=</span> <span class="va">performance_values</span><span class="op">)</span>

<span class="va">w_prev_1</span> <span class="op">&lt;-</span> <span class="va">w_prev_2</span> <span class="op">&lt;-</span> <span class="va">w_prev_3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="va">N</span> ,<span class="va">N</span><span class="op">)</span> <span class="co"># Every strategy starts with naive portfolio</span>

<span class="co"># Two small helper functions: Weight adjustments due to returns and evaluation</span>
<span class="va">adjust_weights</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">w</span>, <span class="va">next_return</span><span class="op">)</span><span class="op">{</span>
  <span class="va">w_prev</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">w</span> <span class="op">*</span> <span class="va">next_return</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">w_prev</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">w_prev</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">evaluate_performance</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">w</span>, <span class="va">w_previous</span>, <span class="va">next_return</span>, <span class="va">beta</span> <span class="op">=</span> <span class="fl">50</span><span class="op">)</span><span class="op">{</span>
  <span class="va">raw_return</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">next_return</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html">%*%</a></span> <span class="va">w</span>
  <span class="va">turnover</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">w</span> <span class="op">-</span> <span class="va">w_previous</span><span class="op">)</span><span class="op">)</span>
  <span class="co"># Realized returns net of TC</span>
  <span class="va">net_return</span> <span class="op">&lt;-</span> <span class="va">raw_return</span> <span class="op">-</span> <span class="va">beta</span> <span class="op">/</span> <span class="fl">10000</span> <span class="op">*</span> <span class="va">turnover</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">raw_return</span>, <span class="va">turnover</span>, <span class="va">net_return</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>The lines above define the general setup: We consider 120 periods from the past to update the parameter estimates before recomputing portfolio weights. Then, portfolio weights are updated which is costly and affects the net performance. The portfolio weights determine the portfolio return. A period later, the current portfolio weights have changed and form the foundation for transaction costs incurred in the next period. We consider three different competing strategies: the mean-variance efficient portfolio, mean-variance efficient portfolio with ex-ante adjustment for transaction costs and the naive portfolio which simply allocates wealth equally across the different assets.</p>
<div class="sourceCode" id="cb198"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">periods</span><span class="op">)</span><span class="op">{</span> <span class="co"># Rolling window</span>
  
  <span class="co"># Estimation window</span>
  <span class="va">returns_window</span> <span class="op">&lt;-</span> <span class="va">industry_returns</span><span class="op">[</span><span class="va">i</span> <span class="op">:</span> <span class="op">(</span><span class="va">i</span> <span class="op">+</span> <span class="va">window_length</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>,<span class="op">]</span> <span class="co"># the last X returns available up to date t</span>
  <span class="va">next_return</span> <span class="op">&lt;-</span> <span class="va">industry_returns</span><span class="op">[</span><span class="va">i</span> <span class="op">+</span> <span class="va">window_length</span>, <span class="op">]</span> <span class="co"># Out-of-sample return in the next period</span>
  
  <span class="co"># Sample moments (in practice: replace mu or sigma with more advanced methods) </span>
  <span class="va">Sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cov</a></span><span class="op">(</span><span class="va">returns_window</span><span class="op">)</span> 
  <span class="va">mu</span> <span class="op">&lt;-</span> <span class="fl">0</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html">colMeans</a></span><span class="op">(</span><span class="va">returns_window</span><span class="op">)</span> <span class="co"># Note: We essentially perform MV optimization </span>
  
  <span class="co"># TC robust portfolio</span>
  <span class="va">w_1</span> <span class="op">&lt;-</span> <span class="fu">compute_efficient_weight_L1_TC</span><span class="op">(</span>mu <span class="op">=</span> <span class="va">mu</span>, 
                                     Sigma <span class="op">=</span> <span class="va">Sigma</span>, 
                                     beta <span class="op">=</span> <span class="va">beta</span>, 
                                     gamma <span class="op">=</span> <span class="va">gamma</span>,
                                     w_prev <span class="op">=</span> <span class="va">w_prev_1</span><span class="op">)</span>

  <span class="co"># Evaluation</span>
  <span class="va">performance_values</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">evaluate_performance</span><span class="op">(</span><span class="va">w_1</span>, 
                                               <span class="va">w_prev_1</span>, 
                                               <span class="va">next_return</span>, 
                                               beta <span class="op">=</span> <span class="va">beta</span><span class="op">)</span>
  
  <span class="co">#Computes adjusted weights based on the weights and next period returns</span>
  <span class="va">w_prev_1</span> <span class="op">&lt;-</span> <span class="fu">adjust_weights</span><span class="op">(</span><span class="va">w_1</span>, <span class="va">next_return</span><span class="op">)</span>

  <span class="co"># Naive Portfolio </span>
  <span class="va">w_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="va">N</span>, <span class="va">N</span><span class="op">)</span>
  
  <span class="co"># Evaluation</span>
  <span class="va">performance_values</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">evaluate_performance</span><span class="op">(</span><span class="va">w_2</span>, 
                                               <span class="va">w_prev_2</span>, 
                                               <span class="va">next_return</span><span class="op">)</span>
  
  <span class="co">#Computes adjusted weights based on the weights and next period returns</span>
  <span class="va">w_prev_2</span> <span class="op">&lt;-</span> <span class="fu">adjust_weights</span><span class="op">(</span><span class="va">w_2</span>, <span class="va">next_return</span><span class="op">)</span>
  
  <span class="co"># Mean-variance efficient portfolio (ignoring transaction costs)</span>
  <span class="va">w_3</span> <span class="op">&lt;-</span> <span class="fu">compute_efficient_weight</span><span class="op">(</span>Sigma <span class="op">=</span> <span class="va">Sigma</span>,
                                  mu <span class="op">=</span> <span class="va">mu</span>, 
                                  gamma <span class="op">=</span> <span class="va">gamma</span><span class="op">)</span>
  <span class="co"># Evaluation</span>
  <span class="va">performance_values</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">evaluate_performance</span><span class="op">(</span><span class="va">w_3</span>, 
                                               <span class="va">w_prev_3</span>, 
                                               <span class="va">next_return</span><span class="op">)</span>
  
  <span class="co">#Computes adjusted weights based on the weights and next period returns</span>
  <span class="va">w_prev_3</span> <span class="op">&lt;-</span> <span class="fu">adjust_weights</span><span class="op">(</span><span class="va">w_3</span>, <span class="va">next_return</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Finally we get to the evalation of the portfolio strategies <em>net-of-transaction costs</em>.</p>
<div class="sourceCode" id="cb199"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">performance</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">performance_values</span>, <span class="va">as_tibble</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span>.id <span class="op">=</span> <span class="st">"strategy"</span><span class="op">)</span>

<span class="va">performance</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">strategy</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>Mean <span class="op">=</span> <span class="fl">12</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fl">100</span> <span class="op">*</span> <span class="va">net_return</span><span class="op">)</span>, <span class="co"># Annualized returns</span>
            SD <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fl">12</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="fl">100</span> <span class="op">*</span> <span class="va">net_return</span><span class="op">)</span>, <span class="co"># Annualized standard deviation</span>
            Sharpe <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">Mean</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="va">Mean</span><span class="op">/</span><span class="va">SD</span>, <span class="cn">NA_real_</span><span class="op">)</span>,
            Turnover <span class="op">=</span> <span class="fl">100</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">turnover</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></code></pre></div>
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th align="left">strategy</th>
<th align="right">Mean</th>
<th align="right">SD</th>
<th align="right">Sharpe</th>
<th align="right">Turnover</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">MV</td>
<td align="right">-0.6359</td>
<td align="right">12.3858</td>
<td align="right">NA</td>
<td align="right">214.2307</td>
</tr>
<tr class="even">
<td align="left">MV (TC)</td>
<td align="right">12.1046</td>
<td align="right">15.0896</td>
<td align="right">0.8022</td>
<td align="right">0.0310</td>
</tr>
<tr class="odd">
<td align="left">Naive</td>
<td align="right">12.0872</td>
<td align="right">15.0929</td>
<td align="right">0.8009</td>
<td align="right">0.2287</td>
</tr>
</tbody>
</table></div>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Goyal2008" class="csl-entry">
Welch, Ivo, and Amit Goyal. 2008. <span><span class="nocase">A Comprehensive Look at The Empirical Performance of Equity Premium Prediction</span>.</span> <em>Review of Financial Studies</em> 21 (4).
</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="parametric-portfolio-policies.html"><span class="header-section-number">10</span> Parametric Portfolio Policies</a></div>
<div class="empty"></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav"><li><a class="nav-link" href="#constraint-optimization-and-portfolio-backtesting"><span class="header-section-number">11</span> Constraint Optimization and Portfolio Backtesting</a></li></ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Tidy Finance</strong>" was written by Christoph Scheuch, Patrick Weiss and Stefan Voigt. It was last built on 2022-01-18.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
