<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 1 Introduction to Tidy Finance | Tidy Finance with R</title>
<meta name="author" content="Christoph Scheuch, wikifolio Financial Technologies">
<meta name="author" content="Stefan Voigt, University of Copenhagen and Danish Finance Institute">
<meta name="author" content="Patrick Weiss, Vienna University of Economics and Business">
<meta name="description" content="The main aim of this chapter is to familiarize yourself with the tidyverse. We start by downloading and visualizing stock data before we move to a simple portfolio choice problem. These examples...">
<meta name="generator" content="bookdown 0.24.4 with bs4_book()">
<meta property="og:title" content="Chapter 1 Introduction to Tidy Finance | Tidy Finance with R">
<meta property="og:type" content="book">
<meta property="og:url" content="https://www.tidy-finance.org/introduction-to-tidy-finance.html">
<meta property="og:image" content="https://www.tidy-finance.org/cover.jpg">
<meta property="og:description" content="The main aim of this chapter is to familiarize yourself with the tidyverse. We start by downloading and visualizing stock data before we move to a simple portfolio choice problem. These examples...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 1 Introduction to Tidy Finance | Tidy Finance with R">
<meta name="twitter:description" content="The main aim of this chapter is to familiarize yourself with the tidyverse. We start by downloading and visualizing stock data before we move to a simple portfolio choice problem. These examples...">
<meta name="twitter:image" content="https://www.tidy-finance.org/cover.jpg">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.11/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-DH3KZSMJ5W"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-DH3KZSMJ5W');
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><link rel="stylesheet" href="style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Tidy Finance with R</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Preface</a></li>
<li class="book-part">Getting started</li>
<li><a class="active" href="introduction-to-tidy-finance.html"><span class="header-section-number">1</span> Introduction to Tidy Finance</a></li>
<li class="book-part">Financial data</li>
<li><a class="" href="accessing-managing-financial-data.html"><span class="header-section-number">2</span> Accessing &amp; managing financial data</a></li>
<li class="book-part">Asset pricing</li>
<li><a class="" href="beta-estimation.html"><span class="header-section-number">3</span> Beta estimation</a></li>
<li><a class="" href="univariate-portfolio-sorts.html"><span class="header-section-number">4</span> Univariate portfolio sorts</a></li>
<li><a class="" href="size-sorts-and-p-hacking.html"><span class="header-section-number">5</span> Size sorts and p-hacking</a></li>
<li><a class="" href="value-and-bivariate-sorts.html"><span class="header-section-number">6</span> Value and bivariate sorts</a></li>
<li><a class="" href="replicating-fama-french-factors.html"><span class="header-section-number">7</span> Replicating Fama &amp; French factors</a></li>
<li class="book-part">Modeling &amp; machine learning</li>
<li><a class="" href="factor-selection-via-machine-learning.html"><span class="header-section-number">8</span> Factor selection via machine learning</a></li>
<li><a class="" href="option-pricing-via-machine-learning.html"><span class="header-section-number">9</span> Option pricing via machine learning</a></li>
<li class="book-part">Portfolio optimization</li>
<li><a class="" href="parametric-portfolio-policies.html"><span class="header-section-number">10</span> Parametric portfolio policies</a></li>
<li><a class="" href="constrained-optimization-and-backtesting.html"><span class="header-section-number">11</span> Constrained optimization and backtesting</a></li>
<li><a class="" href="references.html">References</a></li>
<li class="book-part">Appendix</li>
<li><a class="" href="cover-design.html"><span class="header-section-number">A</span> Cover design</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/voigtstefan/tidy_finance">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="introduction-to-tidy-finance" class="section level1" number="1">
<h1>
<span class="header-section-number">1</span> Introduction to Tidy Finance<a class="anchor" aria-label="anchor" href="#introduction-to-tidy-finance"><i class="fas fa-link"></i></a>
</h1>
<p>The main aim of this chapter is to familiarize yourself with the <code>tidyverse</code>. We start by downloading and visualizing stock data before we move to a simple portfolio choice problem. These examples introduce you to our approach of <em>Tidy Finance</em>.</p>
<div id="working-with-stock-market-data" class="section level2" number="1.1">
<h2>
<span class="header-section-number">1.1</span> Working with stock market data<a class="anchor" aria-label="anchor" href="#working-with-stock-market-data"><i class="fas fa-link"></i></a>
</h2>
<p>At the start of each session, we load the required packages.
Throughout the entire book we always use the package <code>tidyverse</code>.
In this chapter we load the convenient <code>tidyquant</code> package to download price data.
You typically have to install a package once before you can load it. In case you have not done this yet, call <code>install.packages("tidyquant")</code>.
If you have trouble using <code>tidyquant</code>, check out the <a href="https://cran.r-project.org/web/packages/tidyquant/vignettes/TQ01-core-functions-in-tidyquant.html#yahoo-finance">documentation</a>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/business-science/tidyquant">tidyquant</a></span><span class="op">)</span></code></pre></div>
<p>We first download daily prices for one stock market ticker, e.g., <em>AAPL</em>, directly from the data provider Yahoo!Finance.
To download the data, you can use the command <code>tq_get</code>. If you do not know how to use it, make sure you read the help file by calling <code><a href="https://rdrr.io/pkg/tidyquant/man/tq_get.html">?tq_get</a></code>.
We especially recommend taking a look at the documentation’s examples section.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">prices</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tidyquant/man/tq_get.html">tq_get</a></span><span class="op">(</span><span class="st">"AAPL"</span>, get <span class="op">=</span> <span class="st">"stock.prices"</span><span class="op">)</span>
<span class="va">prices</span></code></pre></div>
<pre><code>## # A tibble: 2,552 x 8
##   symbol date        open  high   low close    volume adjusted
##   &lt;chr&gt;  &lt;date&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
## 1 AAPL   2012-01-03  14.6  14.7  14.6  14.7 302220800     12.6
## 2 AAPL   2012-01-04  14.6  14.8  14.6  14.8 260022000     12.6
## 3 AAPL   2012-01-05  14.8  14.9  14.7  14.9 271269600     12.8
## 4 AAPL   2012-01-06  15.0  15.1  15.0  15.1 318292800     12.9
## 5 AAPL   2012-01-09  15.2  15.3  15.0  15.1 394024400     12.9
## # ... with 2,547 more rows</code></pre>
<p><code>tq_get</code> downloads stock market data from Yahoo!Finance if you do not specify another data source. The function returns a tibble with eight quite self-explanatory columns: <em>symbol</em>, <em>date</em>, the market prices at the <em>open, high, low</em> and <em>close</em>, the daily <em>volume</em> (in number of traded shares), and the <em>adjusted</em> price in USD. The adjusted prices are corrected for anything that might affect the stock price after the market closes, e.g., stock splits and dividends. These actions do affect the quoted prices, but they have no direct impact on the investors who hold the stock.</p>
<p>Next, we use <code>ggplot2</code> to visualize the time series of adjusted prices.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">prices</span> <span class="op"><a href="https://rdrr.io/pkg/tidyquant/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">adjusted</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>
    x <span class="op">=</span> <span class="cn">NULL</span>, 
    y <span class="op">=</span> <span class="cn">NULL</span>,
    title <span class="op">=</span> <span class="st">"AAPL stock prices"</span>,
    subtitle <span class="op">=</span> <span class="st">"Prices in USD, adjusted for dividend payments and stock splits"</span>
  <span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="10_introduction_files/figure-html/unnamed-chunk-3-1.png" width="672" style="display: block; margin: auto;"></div>
<p>Instead of analyzing prices, we compute daily returns defined as <span class="math inline">\((p_t - p_{t-1}) / p_{t-1}\)</span> where <span class="math inline">\(p_t\)</span> is the adjusted day <span class="math inline">\(t\)</span> price. The function <code>lag</code> computes the previous value in a vector.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">returns</span> <span class="op">&lt;-</span> <span class="va">prices</span> <span class="op"><a href="https://rdrr.io/pkg/tidyquant/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/tidyquant/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>ret <span class="op">=</span> <span class="op">(</span><span class="va">adjusted</span> <span class="op">-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">adjusted</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">adjusted</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/tidyquant/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">symbol</span>, <span class="va">date</span>, <span class="va">ret</span><span class="op">)</span>
<span class="va">returns</span></code></pre></div>
<pre><code>## # A tibble: 2,552 x 3
##   symbol date            ret
##   &lt;chr&gt;  &lt;date&gt;        &lt;dbl&gt;
## 1 AAPL   2012-01-03 NA      
## 2 AAPL   2012-01-04  0.00537
## 3 AAPL   2012-01-05  0.0111 
## 4 AAPL   2012-01-06  0.0105 
## 5 AAPL   2012-01-09 -0.00159
## # ... with 2,547 more rows</code></pre>
<p>The resulting tibble contains three columns where the last contains the daily returns. Note that the first entry naturally contains <code>NA</code> because there is no previous price. Additionally, the computations require that the time series is ordered by date.
Otherwise, <code>lag</code> would be meaningless.</p>
<p>For the upcoming examples, we remove missing values as these would require separate treatment when computing, e.g., sample averages. In general, however, make sure you understand why <code>NA</code> values occur and carefully examine if you can simply get rid of these observations.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">returns</span> <span class="op">&lt;-</span> <span class="va">returns</span> <span class="op"><a href="https://rdrr.io/pkg/tidyquant/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="va">ret</span><span class="op">)</span></code></pre></div>
<p>Next, we visualize the distribution of daily returns in an histogram. For convenience, we multiply the returns by 100 to get returns in percent for the visualizations. Additionally, we also add a dashed red line that indicates the 5% quantile of the daily returns to the histogram, which is a (crude) proxy for the worst return of the stock with a probability of at least 5%.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">quantile_05</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">returns</span> <span class="op"><a href="https://rdrr.io/pkg/tidyquant/man/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">ret</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>, <span class="fl">0.05</span><span class="op">)</span>

<span class="va">returns</span> <span class="op"><a href="https://rdrr.io/pkg/tidyquant/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">ret</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span>bins <span class="op">=</span> <span class="fl">100</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">quantile_05</span><span class="op">)</span>,
    color <span class="op">=</span> <span class="st">"red"</span>,
    linetype <span class="op">=</span> <span class="st">"dashed"</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>
    x <span class="op">=</span> <span class="cn">NULL</span>, 
    y <span class="op">=</span> <span class="cn">NULL</span>,
    title <span class="op">=</span> <span class="st">"Distribution of daily AAPL returns (in percent)"</span>,
    subtitle <span class="op">=</span> <span class="st">"The dotted vertical line indicates the historical 5% quantile"</span>
  <span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="10_introduction_files/figure-html/unnamed-chunk-6-1.png" width="672" style="display: block; margin: auto;"></div>
<p>Here, <code>bins = 100</code> determines the number of bins and hence implicitly the width of the bins.
Before proceeding, make sure you understand how to use the geom <code><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline()</a></code> to add a dotted red line that indicates the 5% quantile of the daily returns.
A typical task before proceeding with <em>any</em> data is to compute summary statistics for the main variables of interest.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">returns</span> <span class="op"><a href="https://rdrr.io/pkg/tidyquant/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>ret <span class="op">=</span> <span class="va">ret</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/tidyquant/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span>
    <span class="va">ret</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
      daily_mean <span class="op">=</span> <span class="va">mean</span>,
      daily_sd <span class="op">=</span> <span class="va">sd</span>,
      daily_min <span class="op">=</span> <span class="va">min</span>,
      daily_max <span class="op">=</span> <span class="va">max</span>
    <span class="op">)</span>
  <span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 1 x 4
##   ret_daily_mean ret_daily_sd ret_daily_min ret_daily_max
##            &lt;dbl&gt;        &lt;dbl&gt;         &lt;dbl&gt;         &lt;dbl&gt;
## 1          0.117         1.79         -12.9          12.0</code></pre>
<p>We see that the maximum <em>daily</em> return was around 11.981 percent.<br>
You can also compute these summary statistics for each year by imposing <code>group_by(year = year(date))</code>, where the call <code>year(date)</code> computes the year.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">returns</span> <span class="op"><a href="https://rdrr.io/pkg/tidyquant/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>ret <span class="op">=</span> <span class="va">ret</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/tidyquant/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/tidyquant/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span>
    <span class="va">ret</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
      daily_mean <span class="op">=</span> <span class="va">mean</span>,
      daily_sd <span class="op">=</span> <span class="va">sd</span>,
      daily_min <span class="op">=</span> <span class="va">min</span>,
      daily_max <span class="op">=</span> <span class="va">max</span>
    <span class="op">)</span>,
    .names <span class="op">=</span> <span class="st">"{.fn}"</span>
  <span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 11 x 5
##    year daily_mean daily_sd daily_min daily_max
##   &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
## 1  2012    0.124       1.86     -6.44      8.87
## 2  2013    0.0472      1.80    -12.4       5.14
## 3  2014    0.145       1.36     -7.99      8.20
## 4  2015    0.00199     1.68     -6.12      5.74
## 5  2016    0.0575      1.47     -6.57      6.50
## # ... with 6 more rows</code></pre>
<p>In case you wonder: the additional argument <code>.names = "{.fn}"</code> in <code><a href="https://dplyr.tidyverse.org/reference/across.html">across()</a></code> determines how to name the output columns. The specification is rather flexible and allows almost arbitrary column names which can be useful for reporting.</p>
</div>
<div id="scaling-up-the-analysis" class="section level2" number="1.2">
<h2>
<span class="header-section-number">1.2</span> Scaling up the analysis<a class="anchor" aria-label="anchor" href="#scaling-up-the-analysis"><i class="fas fa-link"></i></a>
</h2>
<p>As a next step, we generalize the code from before such that all the computations can handle an arbitrary vector of tickers (e.g., all constituents of an index). Following tidy principles, it is quite easy to download the data, plot the price time series, and tabulate the summary statistics for an arbitrary number of assets.</p>
<p>This is where the <code>tidyverse</code> magic starts: tidy data makes it extremely easy to generalize the computations from before to as many assets you like. The following code takes any vector of tickers, e.g., <code>ticker &lt;- c("AAPL", "MMM", "BA")</code>, and automates the download as well as the plot of the price time series. In the end, we create the table of summary statistics for an arbitrary number of assets. We perform the analysis with data from all current constituents of the <a href="https://en.wikipedia.org/wiki/Dow_Jones_Industrial_Average">Dow Jones Industrial Average index</a>.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ticker</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tidyquant/man/tq_index.html">tq_index</a></span><span class="op">(</span><span class="st">"DOW"</span><span class="op">)</span> 
<span class="va">index_prices</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/tidyquant/man/tq_get.html">tq_get</a></span><span class="op">(</span><span class="va">ticker</span>,
  get <span class="op">=</span> <span class="st">"stock.prices"</span>,
  from <span class="op">=</span> <span class="st">"2000-01-01"</span>
<span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/tidyquant/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">symbol</span> <span class="op">!=</span> <span class="st">"DOW"</span><span class="op">)</span> <span class="co"># Exclude the index itself</span></code></pre></div>
<p>The resulting file contains 158374 daily observations for in total 29 different corporations. The figure below illustrates the time series of downloaded <em>adjusted</em> prices for each of the constituents of the Dow Jones index. Make sure you understand every single line of code! (What are the arguments of <code><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes()</a></code>? Which alternative geoms could you use to visualize the time series? Hint: if you do not know the answers try to change the code to see what difference your intervention causes).</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">index_prices</span> <span class="op"><a href="https://rdrr.io/pkg/tidyquant/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>
    x <span class="op">=</span> <span class="va">date</span>,
    y <span class="op">=</span> <span class="va">adjusted</span>,
    color <span class="op">=</span> <span class="va">symbol</span>
  <span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>
    x <span class="op">=</span> <span class="cn">NULL</span>,
    y <span class="op">=</span> <span class="cn">NULL</span>,
    color <span class="op">=</span> <span class="cn">NULL</span>,
    title <span class="op">=</span> <span class="st">"DOW index stock prices"</span>,
    subtitle <span class="op">=</span> <span class="st">"Prices in USD, adjusted for dividend payments and stock splits"</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="10_introduction_files/figure-html/unnamed-chunk-9-1.png" width="672" style="display: block; margin: auto;"></div>
<p>Do you notice the small differences relative to the code we used before? <code>tq_get(ticker)</code> returns a tibble for several symbols as well. All we need to do to illustrate all tickers simultaneously is to include <code>color = symbol</code> in the <code>ggplot2</code> aesthetics. In this way, we generate a separate line for each ticker. Of course, there are simply too many lines on this graph to properly identify the individual stocks, but it illustrates the point well.</p>
<p>The same holds for stock returns. Before computing the returns, we use <code>group_by(symbol)</code> such that the <code>mutate</code> command is performed for each symbol individually. The same logic applies to the computation of summary statistics: <code>group_by(symbol)</code> is the key to aggregating the time series into ticker-specific variables of interest.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">all_returns</span> <span class="op">&lt;-</span> <span class="va">index_prices</span> <span class="op"><a href="https://rdrr.io/pkg/tidyquant/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">symbol</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/tidyquant/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>ret <span class="op">=</span> <span class="va">adjusted</span> <span class="op">/</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">adjusted</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/tidyquant/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">symbol</span>, <span class="va">date</span>, <span class="va">ret</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/tidyquant/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="va">ret</span><span class="op">)</span>

<span class="va">all_returns</span> <span class="op"><a href="https://rdrr.io/pkg/tidyquant/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>ret <span class="op">=</span> <span class="va">ret</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/tidyquant/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">symbol</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/tidyquant/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span>
    <span class="va">ret</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
      daily_mean <span class="op">=</span> <span class="va">mean</span>,
      daily_sd <span class="op">=</span> <span class="va">sd</span>,
      daily_min <span class="op">=</span> <span class="va">min</span>,
      daily_max <span class="op">=</span> <span class="va">max</span>
    <span class="op">)</span>,
        .names <span class="op">=</span> <span class="st">"{.fn}"</span>
  <span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 29 x 5
##   symbol daily_mean daily_sd daily_min daily_max
##   &lt;chr&gt;       &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
## 1 AAPL       0.128      2.52     -51.9      13.9
## 2 AMGN       0.0470     1.99     -13.4      15.1
## 3 AXP        0.0574     2.30     -17.6      21.9
## 4 BA         0.0608     2.20     -23.8      24.3
## 5 CAT        0.0683     2.03     -14.5      14.7
## # ... with 24 more rows</code></pre>
<p>Note that you are now also equipped with all tools to download price data for <em>each</em> ticker listed in the S&amp;P 500 index with the same number of lines of code. Just use <code>ticker &lt;- tq_index("SP500")</code>, which provides you with a tibble that contains each symbol that is (currently) part of the S&amp;P 500. However, don’t try this if you are not prepared to wait for a couple of minutes because this is quite some data to download!</p>
</div>
<div id="other-forms-of-data-aggregation" class="section level2" number="1.3">
<h2>
<span class="header-section-number">1.3</span> Other forms of data aggregation<a class="anchor" aria-label="anchor" href="#other-forms-of-data-aggregation"><i class="fas fa-link"></i></a>
</h2>
<p>Of course, aggregation across other variables than <code>symbol</code> can make sense as well. For instance, suppose you are interested in answering the question: are days with high aggregate trading volume likely followed by days with high aggregate trading volume? To provide some initial analysis on this question, we take the downloaded prices and compute aggregate daily trading volume for all Dow Jones constituents in USD. Recall that the column <em>volume</em> is denoted in the number of traded shares. Thus, we multiply the trading volume with the daily closing price to get a proxy for the aggregate trading volume in USD. Scaling by <code>1e9</code> denotes daily trading volume in billion USD.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">volume</span> <span class="op">&lt;-</span> <span class="va">index_prices</span> <span class="op"><a href="https://rdrr.io/pkg/tidyquant/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>volume_usd <span class="op">=</span> <span class="va">volume</span> <span class="op">*</span> <span class="va">close</span> <span class="op">/</span> <span class="fl">1e9</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/tidyquant/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/tidyquant/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>volume <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">volume_usd</span><span class="op">)</span><span class="op">)</span>

<span class="va">volume</span> <span class="op"><a href="https://rdrr.io/pkg/tidyquant/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">volume</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>
    x <span class="op">=</span> <span class="cn">NULL</span>, y <span class="op">=</span> <span class="cn">NULL</span>,
    title <span class="op">=</span> <span class="st">"Aggregate daily trading volume (billion USD)"</span>
  <span class="op">)</span> </code></pre></div>
<div class="inline-figure"><img src="10_introduction_files/figure-html/unnamed-chunk-11-1.png" width="672" style="display: block; margin: auto;"></div>
<p>One way to illustrate the persistence of trading volume would be to plot volume on day <span class="math inline">\(t\)</span> against volume on day <span class="math inline">\(t-1\)</span> as in the example below. We add a 45°-line to indicate a hypothetical one-to-one relation by <code>geom_abline</code>, addressing potential differences in the axes’ scales.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">volume</span> <span class="op"><a href="https://rdrr.io/pkg/tidyquant/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">volume</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">volume</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_abline</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>intercept <span class="op">=</span> <span class="fl">0</span>, slope <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,
    color <span class="op">=</span> <span class="st">"red"</span>,
    linetype <span class="op">=</span> <span class="st">"dotted"</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>
    x <span class="op">=</span> <span class="st">"Previous day aggregate trading volume (billion USD)"</span>,
    y <span class="op">=</span> <span class="st">"Aggregate trading volume (billion USD)"</span>,
    title <span class="op">=</span> <span class="st">"Persistence of trading volume"</span>
  <span class="op">)</span></code></pre></div>
<pre><code>## Warning: Removed 1 rows containing missing values (geom_point).</code></pre>
<div class="inline-figure"><img src="10_introduction_files/figure-html/unnamed-chunk-12-1.png" width="672" style="display: block; margin: auto;"></div>
<p>Do you understand where the warning <code>## Warning: Removed 1 rows containing missing values (geom_point).</code> comes from and what it means? Purely eye-balling reveals that days with high trading volume are often followed by similarly high trading volume days.</p>
</div>
<div id="portfolio-choice-problems" class="section level2" number="1.4">
<h2>
<span class="header-section-number">1.4</span> Portfolio choice problems<a class="anchor" aria-label="anchor" href="#portfolio-choice-problems"><i class="fas fa-link"></i></a>
</h2>
<p>In the previous part, we show how to download stock market data and inspect it with graphs and summary statistics. Now, we move to a typical question in Finance, namely, how to optimally allocate wealth across different assets. The standard framework for optimal portfolio selection considers investors that prefer higher future returns but dislike future return volatility (defined as the square root of the return variance): the <em>mean-variance investor</em>.</p>
<p>An essential tool to evaluate portfolios in the mean-variance context is the <em>efficient frontier</em>, the set of portfolios which satisfy the condition that no other portfolio exists with a higher expected return but with the same volatility (i.e., the risk). We compute and visualize the efficient frontier for several stocks.
First, we extract each asset’s <em>monthly</em> returns. In order to keep things simple we work with a balanced panel and exclude tickers for which we do not observe a price on every single trading day since 2000.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">index_prices</span> <span class="op">&lt;-</span> <span class="va">index_prices</span> <span class="op"><a href="https://rdrr.io/pkg/tidyquant/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">symbol</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/tidyquant/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/tidyquant/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/tidyquant/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">n</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/tidyquant/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">n</span><span class="op">)</span>

<span class="va">returns</span> <span class="op">&lt;-</span> <span class="va">index_prices</span> <span class="op"><a href="https://rdrr.io/pkg/tidyquant/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>month <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/round_date.html">floor_date</a></span><span class="op">(</span><span class="va">date</span>, <span class="st">"month"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/tidyquant/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">symbol</span>, <span class="va">month</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/tidyquant/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>price <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nth.html">last</a></span><span class="op">(</span><span class="va">adjusted</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"drop_last"</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/tidyquant/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>ret <span class="op">=</span> <span class="va">price</span> <span class="op">/</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">price</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/tidyquant/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="va">ret</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/tidyquant/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">price</span><span class="op">)</span></code></pre></div>
<p>Next, we transform the returns from a tidy tibble into a <span class="math inline">\((T \times N)\)</span> matrix with one column for each of the <span class="math inline">\(N\)</span> tickers to compute the covariance matrix <span class="math inline">\(\Sigma\)</span> and also the expected return vector <span class="math inline">\(\mu\)</span>. We achieve this by using <code><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider()</a></code> with the new column names from the column <code>symbol</code> and set the values to <code>ret</code>.
We compute the vector of sample average returns and the sample variance-covariance matrix, which we consider as proxies for the parameters of future returns.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">returns_matrix</span> <span class="op">&lt;-</span> <span class="va">returns</span> <span class="op"><a href="https://rdrr.io/pkg/tidyquant/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>
    names_from <span class="op">=</span> <span class="va">symbol</span>,
    values_from <span class="op">=</span> <span class="va">ret</span>
  <span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/tidyquant/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">month</span><span class="op">)</span>

<span class="va">sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cov</a></span><span class="op">(</span><span class="va">returns_matrix</span><span class="op">)</span>
<span class="va">mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span><span class="op">(</span><span class="va">returns_matrix</span><span class="op">)</span></code></pre></div>
<p>Then, we compute the minimum variance portfolio weights <span class="math inline">\(\omega_\text{mvp}\)</span> as well as the expected return <span class="math inline">\(\omega_\text{mvp}'\mu\)</span> and volatility <span class="math inline">\(\sqrt{\omega_\text{mvp}'\Sigma\omega_\text{mvp}}\)</span> of this portfolio. Recall that the minimum variance portfolio is the vector of portfolio weights that are the solution to
<span class="math display">\[\omega_\text{mvp} = \arg\min w'\Sigma w \text{ s.t. } \sum\limits_{i=1}^Nw_i = 1.\]</span>
It is easy to show analytically, that <span class="math inline">\(\omega_\text{mvp} = \frac{\Sigma^{-1}\iota}{\iota'\Sigma^{-1}\iota}\)</span> where <span class="math inline">\(\iota\)</span> is a vector of ones.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">N</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">returns_matrix</span><span class="op">)</span>
<span class="va">iota</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">N</span><span class="op">)</span>
<span class="va">mvp_weights</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/solve.html">solve</a></span><span class="op">(</span><span class="va">sigma</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">iota</span>
<span class="va">mvp_weights</span> <span class="op">&lt;-</span> <span class="va">mvp_weights</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">mvp_weights</span><span class="op">)</span>

<span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>expected_ret <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">mvp_weights</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">mu</span>, volatility <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">mvp_weights</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">sigma</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">mvp_weights</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 1 x 2
##   expected_ret[,1] volatility[,1]
##              &lt;dbl&gt;          &lt;dbl&gt;
## 1          0.00826         0.0314</code></pre>
<p>Note that the <em>monthly</em> volatility of the minimum variance portfolio is of the same order of magnitude as the <em>daily</em> standard deviation of the individual components. Thus, the diversification benefits in terms of risk reduction are tremendous!</p>
<p>Next, we set out to find the weights for a portfolio that achieves three times the expected return of the minimum variance portfolio. However, mean-variance investors are not interested in any portfolio that achieves the required return, but rather in the efficient portfolio, i.e., the portfolio with the lowest standard deviation.
If you wonder where the solution <span class="math inline">\(\omega_\text{eff}\)</span> comes from: The efficient portfolio is chosen by an investor who aims to achieve minimum variance <em>given a minimum acceptable expected return</em> <span class="math inline">\(\bar{\mu}\)</span>. Hence, their objective function is to choose <span class="math inline">\(\omega_\text{eff}\)</span> as the solution to
<span class="math display">\[\omega_\text{eff}(\bar{\mu}) = \arg\min w'\Sigma w \text{ s.t. } w'\iota = 1 \text{ and } \omega'\mu \geq \bar{\mu}.\]</span>
The code below implements the analytic solution to this optimization problem for a benchmark return <span class="math inline">\(\bar\mu\)</span> which we set to 3 times the expected return of the minimum variance portfolio. We encourage you to verify that it is correct.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mu_bar</span> <span class="op">&lt;-</span> <span class="fl">3</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">mvp_weights</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">mu</span>

<span class="va">C</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">iota</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/solve.html">solve</a></span><span class="op">(</span><span class="va">sigma</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">iota</span><span class="op">)</span>
<span class="va">D</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">iota</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/solve.html">solve</a></span><span class="op">(</span><span class="va">sigma</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">mu</span><span class="op">)</span>
<span class="va">E</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">mu</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/solve.html">solve</a></span><span class="op">(</span><span class="va">sigma</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">mu</span><span class="op">)</span>

<span class="va">lambda_tilde</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="op">(</span><span class="va">mu_bar</span> <span class="op">-</span> <span class="va">D</span> <span class="op">/</span> <span class="va">C</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">E</span> <span class="op">-</span> <span class="va">D</span><span class="op">^</span><span class="fl">2</span> <span class="op">/</span> <span class="va">C</span><span class="op">)</span><span class="op">)</span>
<span class="va">efp_weights</span> <span class="op">&lt;-</span> <span class="va">mvp_weights</span> <span class="op">+</span> <span class="va">lambda_tilde</span> <span class="op">/</span> <span class="fl">2</span> <span class="op">*</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/solve.html">solve</a></span><span class="op">(</span><span class="va">sigma</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">mu</span> <span class="op">-</span> <span class="va">D</span> <span class="op">/</span> <span class="va">C</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/solve.html">solve</a></span><span class="op">(</span><span class="va">sigma</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">iota</span><span class="op">)</span></code></pre></div>
</div>
<div id="the-efficient-frontier" class="section level2" number="1.5">
<h2>
<span class="header-section-number">1.5</span> The efficient frontier<a class="anchor" aria-label="anchor" href="#the-efficient-frontier"><i class="fas fa-link"></i></a>
</h2>
<p>The two mutual fund separation theorem states that as soon as we have two efficient portfolios (such as the minimum variance portfolio and the efficient portfolio for another required level of expected returns like above), we can characterize the entire efficient frontier by combining these two portfolios. The code below implements the construction of the <em>efficient frontier</em>, which characterizes the highest expected return achievable at each level of risk. To understand the code better, make sure to familiarize yourself with the inner workings of the <code>for</code> loop.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">c</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="op">-</span><span class="fl">0.4</span>, to <span class="op">=</span> <span class="fl">1.9</span>, by <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span>
<span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>
  c <span class="op">=</span> <span class="va">c</span>,
  mu <span class="op">=</span> <span class="cn">NA</span>,
  sd <span class="op">=</span> <span class="cn">NA</span>
<span class="op">)</span>

<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">c</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">w</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">c</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="va">mvp_weights</span> <span class="op">+</span> <span class="op">(</span><span class="va">c</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="va">efp_weights</span>
  <span class="va">res</span><span class="op">$</span><span class="va">mu</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">12</span> <span class="op">*</span> <span class="fl">100</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">w</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">mu</span>
  <span class="va">res</span><span class="op">$</span><span class="va">sd</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">12</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">w</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">sigma</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">w</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Finally, it is simple to visualize the efficient frontier alongside the two efficient portfolios within one, powerful figure using <code>ggplot2</code>. We also add the individual stocks in the same call.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res</span> <span class="op"><a href="https://rdrr.io/pkg/tidyquant/man/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">sd</span>, y <span class="op">=</span> <span class="va">mu</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span> <span class="co"># locate the minimum variance and efficient portfolio</span>
    data <span class="op">=</span> <span class="va">res</span> <span class="op"><a href="https://rdrr.io/pkg/tidyquant/man/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">c</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,
    color <span class="op">=</span> <span class="st">"red"</span>,
    size <span class="op">=</span> <span class="fl">4</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span> <span class="co"># locate the individual assets</span>
    data <span class="op">=</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>mu <span class="op">=</span> <span class="fl">12</span> <span class="op">*</span> <span class="fl">100</span> <span class="op">*</span> <span class="va">mu</span>, sd <span class="op">=</span> <span class="fl">12</span> <span class="op">*</span> <span class="fl">10</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="va">sigma</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">mu</span>, x <span class="op">=</span> <span class="va">sd</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"blue"</span>, size <span class="op">=</span> <span class="fl">1</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>
    x <span class="op">=</span> <span class="st">"Annualized standard deviation (in percent)"</span>,
    y <span class="op">=</span> <span class="st">"Annualized expected return (in percent)"</span>,
    title <span class="op">=</span> <span class="st">"Dow Jones asset returns and efficient frontier"</span>,
    subtitle <span class="op">=</span> <span class="st">"Red dots indicate the location of the minimum variance and efficient tangency portfolio"</span>
  <span class="op">)</span></code></pre></div>
<p><img src="10_introduction_files/figure-html/unnamed-chunk-18-1.png" width="672" style="display: block; margin: auto;">
The black line indicates the efficient frontier: the set of portfolios a mean-variance efficient investor would choose from. Compare the performance relative to the individual assets (the blue dots) - it should become clear that diversifying yields massive performance gains (at least as long as we take the parameters <span class="math inline">\(\Sigma\)</span> and <span class="math inline">\(\mu\)</span> as given).</p>
</div>
<div id="exercises" class="section level2" number="1.6">
<h2>
<span class="header-section-number">1.6</span> Exercises<a class="anchor" aria-label="anchor" href="#exercises"><i class="fas fa-link"></i></a>
</h2>
<ol style="list-style-type: decimal">
<li>Download daily prices for another stock market ticker of your choice from Yahoo!Finance with <code>tq_get</code> from the <code>tidyquant</code> package. Plot two time series of the ticker’s un-adjusted and adjusted closing prices. Explain the differences.</li>
<li>Compute daily net returns for the asset and visualize the distribution of daily returns in a histogram. Also, use <code><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline()</a></code> to add a dashed red line that indicates the 5% quantile of the daily returns within the histogram. Compute summary statistics (mean, standard deviation, minimum and maximum) for the daily returns</li>
<li>Take your code from before and generalize it such that you can perform all the computations for an arbitrary vector of tickers (e.g., <code>ticker &lt;- c("AAPL", "MMM", "BA")</code>). Automate the download, the plot of the price time series, and create a table of return summary statistics for this arbitrary number of assets.</li>
<li>Consider the research question: Are days with high aggregate trading volume often also days with large absolute price changes? Find an appropriate visualization to analyze the question.</li>
<li>Compute monthly returns from the downloaded stock market prices. Compute the vector of historical average returns and the sample variance-covariance matrix. After you compute the minimum variance portfolio weights and the portfolio volatility and average returns, visualize the mean-variance efficient frontier. Choose one of your assets and identify the portfolio which yields the same historical volatility but achieves the highest possible average return.</li>
<li>In the portfolio choice analysis we restricted our sample to all assets that were trading on every single day since 2000. How is such a decision a problem when you want to infer future expected portfolio performance from the results?</li>
<li>The efficient frontier characterizes the portfolios with the highest expected return for different levels of risk, i.e., standard deviation. Identify the portfolio with the highest expected return per standard deviation. Hint: the ratio of expected return to standard deviation is an important concept in Finance.</li>
</ol>
</div>
</div>



  <div class="chapter-nav">
<div class="prev"><a href="index.html">Preface</a></div>
<div class="next"><a href="accessing-managing-financial-data.html"><span class="header-section-number">2</span> Accessing &amp; managing financial data</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#introduction-to-tidy-finance"><span class="header-section-number">1</span> Introduction to Tidy Finance</a></li>
<li><a class="nav-link" href="#working-with-stock-market-data"><span class="header-section-number">1.1</span> Working with stock market data</a></li>
<li><a class="nav-link" href="#scaling-up-the-analysis"><span class="header-section-number">1.2</span> Scaling up the analysis</a></li>
<li><a class="nav-link" href="#other-forms-of-data-aggregation"><span class="header-section-number">1.3</span> Other forms of data aggregation</a></li>
<li><a class="nav-link" href="#portfolio-choice-problems"><span class="header-section-number">1.4</span> Portfolio choice problems</a></li>
<li><a class="nav-link" href="#the-efficient-frontier"><span class="header-section-number">1.5</span> The efficient frontier</a></li>
<li><a class="nav-link" href="#exercises"><span class="header-section-number">1.6</span> Exercises</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/voigtstefan/tidy_finance/blob/main/docs/10_introduction.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/voigtstefan/tidy_finance/edit/main/docs/10_introduction.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Tidy Finance with R</strong>" was written by Christoph Scheuch, wikifolio Financial Technologies, Stefan Voigt, University of Copenhagen and Danish Finance Institute, Patrick Weiss, Vienna University of Economics and Business. It was last built on 2022-02-23.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
